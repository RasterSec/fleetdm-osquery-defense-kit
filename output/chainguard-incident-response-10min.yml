apiVersion: v1
kind: query
spec:
  name: "[incident_response] Account Policy Data Macos"
  description: Retrieves account policy data, such as creation time
  query: |
    SELECT
      *
    FROM
      account_policy_data;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf"
  description: Retrieves the configuration values for the Application Layer Firewall for OSX.
  query: |
    SELECT
      *
    FROM
      alf;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf Exceptions Macos"
  description: Retrieves the exceptions for the Application Layer Firewall in OSX.
  query: |
    SELECT
      *
    FROM
      alf_exceptions;
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf Explicit Auths Macos"
  description: Retrieves the list of processes with explicit authorization for the Application Layer Firewall.
  query: |
    SELECT
      *
    FROM
      alf_explicit_auths;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf Services"
  description: Retrieves the services for the Application Layer Firewall in OSX.
  query: |
    SELECT
      *
    FROM
      alf_services;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] App Schemes"
  description: Retrieves the list of application scheme/protocol-based IPC handlers.
  query: |
    SELECT
      *
    FROM
      app_schemes;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Apps"
  description: Retrieves all the currently installed applications in the target OSX system.
  query: |
    SELECT
      *
    FROM
      apps;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Authorization Mechanisms Macos"
  description: Retrieves entries from the macOS authorization mechanisms db
  query: |
    SELECT
      *
    FROM
      authorization_mechanisms;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Authorizations Macos"
  description: Retrieves entries from the macOS authorization rights db
  query: |
    SELECT
      *
    FROM
      authorizations;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Authorized Keys"
  description: Retrieves all the currently installed authorized keys on a system
  query: |
    SELECT
      authorized_keys.*
    FROM
      users
      JOIN authorized_keys ON users.uid = authorized_keys.uid;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Block Devices"
  description: Retrieves all block devices known to the system
  query: |
    SELECT
      *
    FROM
      block_devices
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Certificates"
  description: Retrieves all the currently installed certificates on a system
  query: |
    SELECT
      *
    FROM
      certificates;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Chrome Extension Content Scripts"
  description: Retrieves chrome extension cotent scripts that execute on a broad set of URLs.
  query: |
    SELECT
      chrome_extension_content_scripts.*
    FROM
      users
      JOIN chrome_extension_content_scripts ON users.uid = chrome_extension_content_scripts.uid
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Chrome Extensions"
  description: Retrieves chrome extensions that execute on a broad set of URLs.
  query: |
    SELECT
      chrome_extensions.*
    FROM
      users
      JOIN chrome_extensions ON users.uid = chrome_extensions.uid
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Crashes Macos"
  description: Retrieves crash log info per user
  query: |
    SELECT
      *
    FROM
      users
      JOIN crashes USING (uid);
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Crontab"
  description: Crontab entries
  query: |
    SELECT
      *
    FROM
      crontab
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Deb Packages"
  description: Retrieves a list of debian packages
  query: |
    SELECT
      *
    FROM
      deb_packages;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Disk Encryption"
  description: Retrieves the current disk encryption status for the target system.
  query: |
    SELECT
      *
    FROM
      disk_encryption;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Disk Events Macos"
  description: Retrieves disk image (DMG) events
  query: |
    SELECT
      *
    FROM
      disk_events;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Dns Resolvers"
  description: Return the list of configured DNS servers on this system
  query: |
    SELECT
      *
    FROM
      dns_resolvers;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Container Mounts"
  description: Return the list of mounts for Docker containers
  query: |
    SELECT
      *
    FROM
      docker_container_mounts;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Container Ports"
  description: Return the list of ports for Docker containers
  query: |
    SELECT
      *
    FROM
      docker_container_ports;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Container Processes"
  description: Return the list of processes for Docker containers
  query: |
    SELECT
      docker_container_processes.*,
      docker_containers.name
    FROM
      docker_containers
      JOIN docker_container_processes ON docker_containers.id = docker_container_processes.id;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Containers"
  description: Return the list of running Docker containers on this machine
  query: |
    SELECT
      *
    FROM
      docker_containers
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Image History"
  description: Return the Docker image history on a machine
  query: |
    SELECT
      *
    FROM
      docker_image_history
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Images"
  description: Return the list of Docker images
  query: |
    SELECT
      *
    FROM
      docker_images;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Es Process Events"
  description: Dump a list of process execution events from EndpointSecurity
  query: |
    SELECT
      *
    FROM
      es_process_events;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Etc Hosts"
  description: Retrieves all the entries in the target system /etc/hosts file.
  query: |
    SELECT
      *
    FROM
      etc_hosts;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Event Taps Macos"
  description: Retrieves software packages with access to listening in on keyboard/mouse events
  query: |
    SELECT
      *
    FROM
      event_taps;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] File Events"
  description: Return the list of watched file events (must be configured)
  query: |
    SELECT
      *
    FROM
      file_events
    WHERE
      time > (strftime('%s', 'now') -900)
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Dev"
  description: Returns a list of file information from /dev (non-hidden only)
  query: |
    SELECT
      file.*,
      magic.data
    FROM
      file
      JOIN magic ON file.path = magic.path
    WHERE
      file.path LIKE "/dev/%%";
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Downloads"
  description: Returns a list of file information from Downloads directories
  query: |
    SELECT
      file.*,
      magic.data,
      hash.sha256
    FROM
      file
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE "/home/%/Downloads/%"
        OR file.path LIKE "/Users/%/Downloads/%"
      )
      AND (
        mtime > (strftime('%s', 'now') -3600)
        OR ctime > (strftime('%s', 'now') -3600)
        OR btime > (strftime('%s', 'now') -3600)
      )
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Etc"
  description: Returns a list of file information from /etc (non-hidden only)
  query: |
    SELECT
      *
    FROM
      file
      JOIN hash ON file.path = hash.path
    WHERE
      file.path LIKE "/etc/%%";
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Recently Written"
  description: Returns a list of recently written files
  query: |
    SELECT
      *
    FROM
      file
    WHERE
      (
        path LIKE "/var/tmp/%"
        OR path LIKE "/var/tmp/%/%"
        OR path LIKE "/Applications/%"
        OR path LIKE "/Applications/%/%"
        OR path LIKE "/home/%/%"
        OR path LIKE "/home/%/.%/%"
        OR path LIKE "/home/%/.%/%/%"
        OR path LIKE "/home/%/.config/%"
        OR path LIKE "/home/%/.config/%/%"
        OR path LIKE "/Library/%/%"
        OR path LIKE "/Library/.%"
        OR path LIKE "/Library/Application Support/%"
        OR path LIKE "/Library/Application Support/.%"
        OR path LIKE "/tmp/%"
        OR path LIKE "/tmp/%/%"
        OR path LIKE "/tmp/.%/%%"
        OR path LIKE "/Users/%/%"
        OR path LIKE "/Users/%/%/%"
        OR path LIKE "/Users/%/.%/%"
        OR path LIKE "/Users/%/.%/%/%"
        OR path LIKE "/Users/Library/%"
        OR path LIKE "/Users/Library/%/%"
        OR path LIKE "/Users/Library/.%"
        OR path LIKE "/Users/Library/Application Support/%"
        OR path LIKE "/Users/Library/Application Support/%/%"
        OR path LIKE "/Users/Library/Application Support/.%"
        OR path LIKE "/var/%"
        OR path LIKE "/var/%/%"
      )
      AND (
        mtime > (strftime('%s', 'now') -3600)
        OR (
          atime > (strftime('%s', 'now') -3600)
          AND file.type = "regular"
        )
        OR ctime > (strftime('%s', 'now') -3600)
        OR btime > (strftime('%s', 'now') -3600)
      )
      AND NOT path LIKE "%/../%"
    GROUP BY
      inode;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Firefox Addons"
  description: Return the list of installed Firefox addons
  query: |
    SELECT
      firefox_addons.*
    FROM
      users
      JOIN firefox_addons ON users.uid = firefox_addons.uid;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Gatekeeper Approved Apps Macos"
  description: Retrieves all the gatekeeper exceptions on a macOS host
  query: |
    SELECT
      gap.ctime,
      gap.mtime,
      gap.path,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      gatekeeper_approved_apps AS gap
      LEFT JOIN file ON gap.path = file.path
      LEFT JOIN hash ON gap.path = hash.path
      LEFT JOIN signature ON gap.path = signature.path
    GROUP BY
      gap.requirement
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Groups"
  description: Return the list of POSIX groups on the system
  query: |
    SELECT
      *
    FROM
      groups;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Hardware Events"
  description: Return hardware events
  query: |
    SELECT
      *
    FROM
      hardware_events;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Homebrew Packages Macos"
  description: Dump a list of homebrew packages
  query: |
    SELECT
      *
    FROM
      homebrew_packages;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Interface Addresses"
  description: Return the list of interface addresses
  query: |
    SELECT
      *
    FROM
      interface_addresses;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Interface Details"
  description: Return stats on network interfaces
  query: |
    SELECT
      *
    FROM
      interface_details
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Interface Ipv6"
  description: Return the list of interface addresses (IPv6)
  query: |
    SELECT
      *
    FROM
      interface_ipv6;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Iokit Registry Macos"
  description: Retrieves IOKit registry
  query: |
    SELECT
      *
    FROM
      iokit_registry;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Ip Forwarding"
  description: Retrieves the current status of IP/IPv6 forwarding.
  query: |
    SELECT
      *
    FROM
      system_controls
    WHERE
      oid = '4.30.41.1'
    UNION
    SELECT
      *
    FROM
      system_controls
    WHERE
      oid = '4.2.0.1';
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Iptables"
  description: Retrieves the current filters and chains per filter in the target system.
  query: |
    SELECT
      *
    FROM
      iptables;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kernel Info"
  description: Return basic kernel information
  query: |
    SELECT
      *
    FROM
      kernel_info;
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kernel Modules Linux"
  description: Retrieves all the information for the current kernel modules in the target Linux system.
  query: |
    SELECT
      *
    FROM
      kernel_modules;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kernel Panics Macos"
  description: Retrieves entries from the macOS kernel panic logs
  query: |
    SELECT
      *
    FROM
      kernel_panics;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kextstat Macos"
  description: Retrieves all the information about the current kernel extensions for the target OSX system.
  query: |
    SELECT
      *
    FROM
      kernel_extensions;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Known Hosts"
  description: Retrieves chrome extensions that execute on a broad set of URLs.
  query: |
    SELECT
      known_hosts.*
    FROM
      users
      JOIN known_hosts ON users.uid = known_hosts.uid
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Last"
  description: Retrieves the list of the latest logins with PID, username and timestamp.
  query: |
    SELECT
      *
    FROM
      last;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Launchd Macos"
  description: macOS launchd entries
  query: |
    SELECT
      *
    FROM
      launchd;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Launchd Overrides Macos"
  description: Retrieves launchd override keys per user
  query: |
    SELECT
      *
    FROM
      launchd_overrides;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Listening Ports"
  description: Retrieves all the listening ports in the target system.
  query: |
    SELECT
      lp.*,
      p.name AS p_name,
      p.start_time AS p_time,
      p.path AS p_path,
      p.euid AS p_euid
    FROM
      listening_ports AS lp
      LEFT JOIN processes p ON lp.pid = p.pid;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Logged In Users"
  description: Retrieves the list of all the currently logged in users in the target system.
  query: |
    SELECT
      liu.*,
      p.name,
      p.cmdline,
      p.cwd,
      p.start_time,
      p.root
    FROM
      logged_in_users liu,
      processes p
    WHERE
      liu.pid = p.pid;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow1"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      key,
      subkey,
      value
    from
      plist
    where
      path = '/Library/Preferences/com.apple.loginwindow.plist';
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow2"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      key,
      subkey,
      value
    from
      plist
    where
      path = '/Library/Preferences/loginwindow.plist';
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow3"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      username,
      key,
      subkey,
      value
    from
      plist p,
      (
        select
          *
        from
          users
        where
          directory like '/Users/%'
      ) u
    where
      p.path = u.directory || '/Library/Preferences/com.apple.loginwindow.plist';
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow4"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      username,
      key,
      subkey,
      value
    from
      plist p,
      (
        select
          *
        from
          users
        where
          directory like '/Users/%'
      ) u
    where
      p.path = u.directory || '/Library/Preferences/loginwindow.plist';
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Memory Map"
  description: Returns the OS memory region map.
  query: |
    SELECT
      *
    FROM
      memory_map;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Mounts"
  description: Retrieves the current list of mounted drives in the target system.
  query: |
    SELECT
      *
    FROM
      mounts;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Npm Packages"
  description: Return the list of npm packages
  query: |
    SELECT
      *
    FROM
      npm_packages;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Nvram Macos"
  description: Retrieves entries from the macOS nvram database
  query: |
    SELECT
      *
    FROM
      nvram;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Open Files"
  description: Retrieves all the open files per process in the target system.
  query: |
    SELECT DISTINCT
      pof.pid,
      pof.path,
      pof.fd,
      p.name,
      p.start_time,
      p.euid,
      p.parent,
      p.uid,
      p.cmdline
    FROM
      process_open_files pof
      LEFT JOIN processes p ON pof.pid = p.pid
    WHERE
      pof.path NOT LIKE '/private/var/folders%'
      AND pof.path NOT LIKE '/System/Library/%'
      AND pof.path NOT IN ('/dev/null', '/dev/urandom', '/dev/random');
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Open Sockets"
  description: Retrieves all the open sockets per process in the target system.
  query: |
    SELECT DISTINCT
      pid,
      family,
      protocol,
      local_address,
      local_port,
      remote_address,
      remote_port,
      path
    FROM
      process_open_sockets
    WHERE
      path <> ''
      or remote_address <> '';
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Os Version"
  description: Return the OS version including patch level
  query: |
    SELECT
      *
    FROM
      os_version;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Package Install History Macos"
  description: Return macOS package install history
  query: |
    SELECT
      *
    FROM
      package_install_history;
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Package Receipts Macos"
  description: Return macOS package receipts
  query: |
    SELECT
      *
    FROM
      package_receipts;
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Platform Info"
  description: Return hardware platform info (UEFI)
  query: |
    SELECT
      *
    FROM
      platform_info
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Preferences Macos"
  description: Retrieves entries from the macOS preferences database
  query: |
    SELECT
      *
    FROM
      preferences;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Env"
  description: Retrieves all the environment variables per process in the target system.
  query: |
    SELECT
      *
    FROM
      process_envs;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Events"
  description: Recently executed programs
  query: |
    SELECT
      pe.*,
      -- pe.cwd is often blank
      p.cwd AS delayed_proc_cwd,
      pp.cwd AS delayed_parent_cwd,
      pp.path AS parent_path,
      pp.name AS delayed_parent_name
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN processes pp ON pe.parent = pp.pid
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      -- Filter out commands generated by osquery/kolide
      AND pe.cmdline NOT LIKE '/bin/ps -x -o%'
      AND parent_path NOT LIKE '/usr/local/kolide-k2/%/launcher'
    GROUP BY
      pe.pid,
      pe.eid
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Memory Map"
  description: Retrieves the memory map per process
  query: |
    SELECT
      pid,
      permissions,
    offset
    ,
      inode,
      path,
      pseudo
    FROM
      process_memory_map
    WHERE
      path != ""
    GROUP BY
      pid,
      permissions,
    offset
    ,
      inode,
      path,
      pseudo;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Open Files"
  description: Return the list of open files by process
  query: |
    SELECT
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline,
      pof.*
    FROM
      process_open_files AS pof
      LEFT JOIN processes p ON pof.pid = p.pid;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Open Pipes"
  description: Return the list of open pipes per process
  query: |
    SELECT
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline,
      pop.*
    FROM
      process_open_pipes AS pop
      LEFT JOIN processes p ON pop.pid = p.pid;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Open Sockets"
  description: Return the list of open sockets per process
  query: |
    SELECT
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline,
      pos.*
    FROM
      process_open_sockets AS pos
      LEFT JOIN processes p ON pos.pid = p.pid;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Processes"
  description: Currently running programs, only the columns that are not constantly changing
  query: |
    SELECT
      pid,
      name,
      path,
      cmdline,
      state,
      cwd,
      root,
      uid,
      gid,
      euid,
      egid,
      suid,
      sgid,
      on_disk,
      start_time,
      parent,
      pgroup,
      threads,
      nice,
      cgroup_path
    FROM
      processes
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Recent Items Macos"
  description: Retrieves the list of recent items opened in OSX by parsing the plist per user.
  query: |
    select
      username,
      key,
      value
    from
      plist p,
      (
        select
          *
        from
          users
        where
          directory like '/Users/%'
      ) u
    where
      p.path = u.directory || '/Library/Preferences/com.apple.recentitems.plist';
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Rpm Packages"
  description: Retrieves a list of RPM packages
  query: |
    SELECT
      *
    FROM
      rpm_packages;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Running Apps Macos"
  description: Retrieves currently running applications
  query: |
    SELECT
      *
    FROM
      running_apps;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Safari Extensions Macos"
  description: Return the list of installed Safari extensions
  query: |
    SELECT
      safari_extensions.*
    FROM
      users
      JOIN safari_extensions ON users.uid = safari_extensions.uid;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Sandboxes Macos"
  description: Lists the application bundle that owns a sandbox label.
  query: |
    SELECT
      *
    FROM
      sandboxes;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Seccomp Events"
  description: Return the list of seccomp events
  query: |
    SELECT
      *
    FROM
      seccomp_events;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Selinux Events"
  description: Return the list of SELinux events
  query: |
    SELECT
      *
    FROM
      selinux_events;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Shadow"
  description: Return user data from /etc/shadow
  query: |
    SELECT
      *
    FROM
      shadow;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Shared Memory"
  description: Return shared memory info
  query: |
    SELECT
      shm.*,
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline
    FROM
      shared_memory AS shm
      LEFT JOIN processes p ON shm.pid = p.pid;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Shell History"
  description: Retrieves the command history, per user, by parsing the shell history files.
  query: |
    SELECT
      *
    FROM
      users
      JOIN shell_history USING (uid);
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Sip Config"
  description: Retrieves System Integrity Protection Settings data
  query: |
    SELECT
      *
    FROM
      sip_config;
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Socket Events"
  description: Return the list of socket events
  query: |
    SELECT
      *
    FROM
      socket_events
    WHERE
      time > (strftime('%s', 'now') -600)
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Ssh Configs"
  description: Retrieves the ssh configs per user
  query: |
    SELECT
      *
    FROM
      users
      JOIN ssh_configs USING (uid);
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Startup Items"
  description: Retrieve most programs that are part of a systems startup (multi-platform)
  query: |
    SELECT
      *
    FROM
      startup_items;
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Suid Bin"
  description: Retrieves setuid-enabled executables in well-known paths
  query: |
    SELECT
      *
    FROM
      suid_bin;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Syslog Events"
  description: Return the list of syslog events
  query: |
    SELECT
      *
    FROM
      syslog_events;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] System Controls"
  description: Return the list of sysctl values
  query: |
    SELECT
      *
    FROM
      system_controls;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Systemd Units"
  description: Returns a list of systemd units
  query: |
    SELECT
      *
    FROM
      systemd_units;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Unified Log Macos"
  description: Retrieves recent entries from the macOS unified log
  query: |
    SELECT
      timestamp,
      pid,
      process,
      category,
      subsystem,
      message
    FROM
      unified_log
    WHERE
      timestamp > (strftime('%s', 'now') - 1800)
  platform: darwin
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Usb Devices"
  description: Return the list of USB devices
  query: |
    SELECT
      *
    FROM
      usb_devices;
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] User Events"
  description: Return the list of audit user events
  query: |
    SELECT
      *
    FROM
      user_events;
  platform: linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] User Ssh Keys"
  description: Retrieves the ssh keys per user
  query: |
    SELECT
      *
    FROM
      users
      JOIN user_ssh_keys USING (uid);
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Users"
  description: Returns a list of users
  query: |
    SELECT
      *
    FROM
      users
  platform: darwin,linux
  interval: 600
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Xprotect Reports"
  description: Returns a list of malware matches from macOS XProtect
  query: |
    SELECT
      *
    FROM
      xprotect_reports;
  platform: darwin
  interval: 600
  logging: snapshot
