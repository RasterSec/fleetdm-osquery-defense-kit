apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Dns Traffic Events"
  description: Catch DNS traffic going to machines other than the host-configured DNS server (event-based)
  query: |
    SELECT
      protocol,
      s.remote_port,
      s.remote_address,
      s.local_port,
      s.local_address,
      s.action,
      s.status,
      p.name,
      COALESCE(REGEX_MATCH (p.path, '.*/(.*)', 1), p.path) AS basename,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      hash.sha256
    FROM
      socket_events s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      s.time > (strftime('%s', 'now') -300)
      AND remote_port IN (53, 5353)
      AND remote_address NOT LIKE '%:%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '127.%'
      AND remote_address NOT IN (
        SELECT DISTINCT
          address
        FROM
          dns_resolvers
        WHERE
          type = 'nameserver'
          and address != ''
      )
      -- systemd-resolve sometimes shows up this way
      -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse of GROUP_CONCAT
      AND NOT (
        s.pid = -1
        AND s.remote_port = 53
        and p.parent = ''
      )
      -- Some applications hard-code a safe DNS resolver, or allow the user to configure one
      AND s.remote_address NOT IN (
        '0.0.0.0',
        '100.100.100.100', -- Tailscale Magic DNS
        '1.0.0.1', -- Cloudflare
        '1.1.1.1', -- Cloudflare
        '1.1.1.2', -- Cloudflare
        '185.125.190.31', -- Canonical
        '185.125.190.77', -- Canonical
        '208.67.220.123', -- OpenDNS FamilyShield
        '208.67.222.222', -- OpenDNS
        '34.160.111.32', -- wolfi.dev
        '68.105.28.13', -- Cox
        '75.75.75.75', -- Comcast
        '75.75.76.76', -- Comcast
        '80.248.7.1', -- 21st Century (NG)
        '3.125.36.175' -- Vercel
      )
      AND s.remote_address NOT LIKE '185.199.%' -- GitHub
      -- Local DNS servers and custom clients go here
      AND basename NOT IN (
        'adguard_dns',
        'agentbeat',
        'apk',
        'aws',
        'apko',
        'AssetCacheLocatorService',
        'Beeper Desktop',
        'brave',
        'buildkitd',
        'canonical-livep',
        'CapCut',
        'cg',
        'chainctl',
        'ChatGPT',
        'chrome',
        'chromium',
        'cloudcode_cli',
        'cosign',
        'crane',
        'git-lfs',
        'gitsign-credential-cache',
        'Code Helper (Plugin)',
        'com.apple.WebKit.Networking',
        'com.docker.backend',
        'com.docker.buil',
        'com.docker.build',
        'com.docker.vpnkit',
        'com.nordvpn.macos.helper',
        'containerd',
        'crc',
        'coredns',
        'Creative Cloud Content Manager.node',
        'distnoted',
        'docker-language-server-linux-amd64',
        'docker',
        'docker-buildx',
        'dockerd',
        'drkonqi-coredump-processor',
        'eksctl',
        'firefox-bin',
        'EpicWebHelper',
        'gcsfuse',
        'go',
        'grype',
        'gvproxy',
        'helm',
        'incusd',
        'io.tailscale.ipn.macsys.network-extension',
        'IPNExtension',
        'Jabra Direct Helper',
        'java',
        'launcher',
        'limactl',
        'librewolf',
        'mDNSResponder',
        'Meeting Center',
        'melange',
        'msedge',
        'nessusd',
        'node',
        'nuclei',
        'ollama',
        'Pieces OS',
        'plugin-container',
        'ServiceExtension',
        'Signal Helper (Renderer)',
        'signal-desktop',
        'slack',
        'snapd',
        'Socket Process',
        'syncthing',
        'systemd-resolved',
        'tailscaled',
        'Telegram',
        'terraform',
        'terraform-ls',
        'terraform-provi',
        'vunnel',
        'WebexHelper',
        'WhatsApp',
        'wolfictl',
        'yum',
        'ZaloCall',
        'zed',
        'ZoomPhone'
      )
      -- Chromium/Electron apps seem to send stray packets out like nobodies business
      AND basename NOT LIKE '% Helper'
      AND basename NOT LIKE 'terraform-provider-%'
      AND p.name != 'terraform-provi'
      AND p.path NOT LIKE '/snap/%'
      AND pp.path NOT IN ('/usr/bin/containerd-shim-runc-v2')
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
    GROUP BY
      s.remote_address,
      s.remote_port
    HAVING
      remote_address != ''
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Dns Traffic"
  description: Catch DNS traffic going to machines other than the host-configured DNS server (state-based)
  query: |
    SELECT
      s.family,
      protocol,
      s.local_port,
      s.remote_port,
      s.local_address,
      s.remote_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      s.pid,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      hash.sha256,
      GROUP_CONCAT(
        (
          SELECT DISTINCT
            address
          FROM
            dns_resolvers
          WHERE
            type = 'nameserver'
            AND address != ''
        ),
        ','
      ) AS sys_resolvers,
      CONCAT (p.name, ',', remote_address, ',', remote_port) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      remote_port IN (53, 5353)
      AND remote_address NOT LIKE '%:%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '127.%'
      AND remote_address NOT IN (
        SELECT DISTINCT
          address
        FROM
          dns_resolvers
        WHERE
          type = 'nameserver'
          and address != ''
      )
      -- systemd-resolve sometimes shows up this way
      -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse of GROUP_CONCAT
      AND NOT (
        s.pid = -1
        AND s.remote_port = 53
        and s.protocol = 17
        and p.parent = ''
      )
      -- Some applications hard-code a safe DNS resolver, or allow the user to configure one
      AND s.remote_address NOT IN (
        '1.0.0.1', -- Cloudflare
        '1.1.1.1', -- Cloudflare
        '1.1.1.2', -- Cloudflare
        '8.8.8.8', -- Google
        '8.8.4.4', -- Google (backup)
        '208.67.222.222', -- OpenDNS
        '75.75.75.75', -- Comcast
        '68.105.28.13', -- Cox
        '84.116.46.21' -- Liberty Gloval B.V. (major NL telco)
      )
      -- Other exceptions
      AND exception_key NOT IN (
        'Arc Helper,1.0.0.1,53',
        'coredns,0.0.0.0,53',
        'goland,149.112.112.10,53',
        'nessusd,50.16.123.71,53',
        'syncthing,46.162.192.181,53'
      )
      -- Local DNS servers and custom clients go here
      AND p.path NOT IN (
        '/Applications/Evernote.app/Contents/Frameworks/Evernote Helper.app/Contents/MacOS/Evernote Helper',
        '/Applications/Evernote.app/Contents/MacOS/Evernote',
        '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper',
        '/Applications/Spotify.app/Contents/Frameworks/Spotify Helper.app/Contents/MacOS/Spotify Helper',
        '/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/Contents/MacOS/IPNExtension',
        '/opt/podman/bin/gvproxy',
        '/Applications/Finch/lima/bin/limactl',
        '/sbin/apk',
        '/System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/Contents/MacOS/com.apple.WebKit.Networking',
        '/usr/bin/tailscaled',
        '/usr/lib/systemd/systemd-resolved',
        '/usr/sbin/mDNSResponder'
      )
      AND p.path NOT LIKE '%/podman/gvproxy'
      AND p.path NOT LIKE '%/eksctl'
      AND p.path NOT LIKE '/opt/homebrew/Cellar/lima/%/bin/limactl'
      AND p.path NOT LIKE '%/Steam/Steam.AppBundle/Steam/Contents/MacOS/Frameworks/Steam Helper.app/Contents/MacOS/Steam Helper'
      AND p.path NOT LIKE '/Applications/Google Chrome.app/Contents/Frameworks/Google Chrome Framework.framework/Versions/%/Helpers/Google Chrome Helper.app/Contents/MacOS/Google Chrome Helper'
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
      -- Workaround for the GROUP_CONCAT subselect adding a blank ent
    GROUP BY
      s.remote_address,
      s.remote_port
    HAVING
      remote_address != ''
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Https Linux"
  description: Unexpected programs communicating over HTTPS (state-based)
  query: |
    SELECT
      s.remote_address,
      p.name,
      p.cgroup_path,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      pp.path AS parent_path,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      s.local_address,
      s.local_port,
      s.state,
      hash.sha256,
      -- This intentionally avoids file.path, as it won't join across mount namespaces
      CONCAT (
        MIN(p.euid, 500),
        ',',
        REGEX_MATCH (p.path, '.*/(.*?)$', 1),
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g,',
        p.name
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      protocol IN (6, 17)
      AND s.remote_port = 443
      AND s.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND p.path != ''
      AND p.path NOT LIKE '/app/bin/%'
      AND p.path NOT LIKE '/usr/bin/%'
      AND p.path NOT LIKE '/usr/local/bin/%'
      AND p.path NOT LIKE '/nix/store/%/bin/%'
      AND p.path NOT LIKE '/opt/%'
      AND NOT exception_key IN (
        '0,.tailscaled-wrapped,0u,0g,.tailscaled-wra',
        '0,agentbeat,0u,0g,agentbeat',
        '0,apk,u,g,apk',
        '0,applydeltarpm,0u,0g,applydeltarpm',
        '0,bash,0u,0g,bash',
        '0,bash,0u,0g,mkinitcpio',
        '0,bash,0u,0g,sh',
        '0,canonical-livepatchd,0u,0g,canonical-livep',
        '0,chainctl,0u,0g,chainctl',
        '0,chainctl,500u,500g,chainctl',
        '0,cmake,u,g,cmake',
        '0,containerd,u,g,containerd',
        '0,dirmngr,0u,0g,dirmngr',
        '0,dockerd,0u,0g,dockerd',
        '0,elastic-agent,0u,0g,elastic-agent',
        '0,elastic-agent,u,g,elastic-agent',
        '0,elastic-endpoint,0u,0g,elastic-endpoin',
        '0,filebeat,0u,0g,filebeat',
        '0,flatpak,0u,0g,flatpak',
        '0,flatpak-system-helper,0u,0g,flatpak-system-',
        '0,git-remote-http,0u,0g,git-remote-http',
        '0,go,0u,0g,go',
        '0,gtk4-update-icon-cache,0u,0g,gtk-update-icon',
        '0,http,0u,0g,https',
        '0,incusd,0u,0g,incusd',
        '0,ir_agent,0u,0g,ir_agent',
        '0,kmod,0u,0g,depmod',
        '0,launcher,0u,0g,launcher',
        '0,launcher,500u,500g,launcher',
        '0,ldconfig,0u,0g,ldconfig',
        '0,make,0u,0g,make',
        '0,melange,500u,500g,melange',
        '0,metricbeat,0u,0g,metricbeat',
        '0,multipassd,0u,0g,multipassd',
        '0,nessusd,0u,0g,nessusd',
        '0,nix,0u,0g,nix',
        '0,nix,0u,0g,nix-daemon',
        '0,orbit,0u,0g,orbit',
        '0,osqueryd,0u,0g,osqueryd',
        '0,packagekit-dnf-refresh-repo,0u,0g,packagekit-dnf-',
        '0,packagekitd,0u,0g,packagekitd',
        '0,packetbeat,0u,0g,packetbeat',
        '0,pacman,0u,0g,pacman',
        '0,rapid7_endpoint_broker,0u,0g,rapid7_endpoint',
        '0,rpi-imager,0u,0g,rpi-imager',
        '0,skopeo,0u,0g,skopeo',
        '0,snapd,0u,0g,snapd',
        '0,systemctl,0u,0g,systemctl',
        '0,tailscaled,0u,0g,tailscaled',
        '0,tailscaled,500u,500g,tailscaled',
        '0,velociraptor,0u,0g,velociraptor_cl',
        '0,yay,0u,0g,yay',
        '105,http,0u,0g,https',
        '106,geoclue,0u,0g,geoclue',
        '114,geoclue,0u,0g,geoclue',
        '115,geoclue,0u,0g,geoclue',
        '120,fwupdmgr,0u,0g,fwupdmgr',
        '128,fwupdmgr,0u,0g,fwupdmgr',
        '129,fwupdmgr,0u,0g,fwupdmgr',
        '42,http,0u,0g,https',
        '500,sus,500u,500g,sus'
      ) -- Exceptions where we have to be more flexible for the process name
      -- Regular user binaries
      AND NOT exception_key LIKE '500,%,500u,500g,%'
      AND NOT exception_key LIKE '500,%,0u,0g,%'
      AND NOT exception_key LIKE '500,%,u,g,%'
      AND NOT exception_key LIKE '0,python3.%,0u,0g,dnf'
      AND NOT exception_key LIKE '0,python3.%,0u,0g,dnf-automatic'
      AND NOT exception_key LIKE '0,python3.%,0u,0g,yum'
      AND NOT exception_key LIKE '0,python3.%,500u,500g,dnf-automatic'
      AND NOT (
        exception_key = '0,curl,0u,0g,curl'
        AND p.cmdline LIKE 'curl --fail %'
      ) -- Exclude processes running inside of containers
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p.cgroup_path LIKE '/system.slice/system.slice:docker:%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%' -- Tests
      AND NOT p.path LIKE '/tmp/go-build%.test'
    GROUP BY
      p.cmdline
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Https Macos"
  description: Unexpected programs communicating over HTTPS (state-based)
  query: |
    SELECT
      pos.protocol,
      pos.local_port,
      pos.remote_port,
      pos.remote_address,
      pos.local_port,
      pos.local_address,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        REGEX_MATCH (p0.path, '.*/(.*?)$', 1),
        ',',
        p0.name,
        ',',
        s.authority,
        ',',
        s.identifier
      ) AS exception_key,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        REGEX_MATCH (p0.path, '.*/(.*?)$', 1),
        ',',
        p0.name,
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g'
      ) AS alt_exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pos
      LEFT JOIN processes p0 ON pos.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
    WHERE
      pos.protocol IN (6, 17)
      AND pos.remote_port = 443
      AND pos.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')
      AND pos.remote_address NOT LIKE 'fe80:%'
      AND pos.remote_address NOT LIKE '127.%'
      AND pos.remote_address NOT LIKE '192.168.%'
      AND pos.remote_address NOT LIKE '172.1%'
      AND pos.remote_address NOT LIKE '172.2%'
      AND pos.remote_address NOT LIKE '172.30.%'
      AND pos.remote_address NOT LIKE '172.31.%'
      AND pos.remote_address NOT LIKE '::ffff:172.%'
      AND pos.remote_address NOT LIKE '10.%'
      AND pos.remote_address NOT LIKE '::ffff:10.%'
      AND pos.remote_address NOT LIKE 'fdfd:%'
      AND pos.remote_address NOT LIKE 'fc00:%'
      AND pos.state != 'LISTEN' -- Ignore most common application paths
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p0.path NOT LIKE '/Library/Apple/System/Library/%'
      AND p0.path NOT LIKE '/Library/Application Support/%/Contents/%'
      AND p0.path NOT LIKE '/opt/%'
      AND p0.path NOT LIKE '/private/var/folders/%/go-build%/%' -- Apple programs running from weird places, like the UpdateBrainService
      AND p0.path NOT LIKE '/System/%'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.path NOT LIKE '/Users/%/bin/%'
      AND p0.path NOT LIKE '/Users/%/code/%'
      AND p0.path NOT LIKE '/Users/%/Library/%.app/Contents/MacOS/%'
      AND p0.path NOT LIKE '/Users/%/Library/Caches/JetBrains/%/tmp/GoLand/___%'
      AND p0.path NOT LIKE '/Users/%/src/%'
      AND p0.path NOT LIKE '/usr/libexec/%'
      AND p0.path NOT LIKE '/usr/local/kolide-k2/%'
      AND p0.path NOT LIKE '/usr/sbin/%'
      AND p0.path NOT LIKE '/nix/var/nix/profiles/default/bin/%'
      AND p0.path NOT LIKE '/nix/store/%/bin/%'
      AND NOT (
        s.identifier LIKE 'com.apple.%'
        AND s.authority = 'Software Signing'
      )
      AND NOT exception_key IN (
        '0,AGSService,AGSService,Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.ags',
        '0,at.obdev.littlesnitch.networkextension,at.obdev.littlesnitch.networkextension,Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R),at.obdev.littlesnitch.networkextension',
        '0,chainctl,chainctl,,a.out',
        '0,com.nordvpn.macos.helper,com.nordvpn.macos.helper,Developer ID Application: Nordvpn S.A. (W5W395V82Y),com.nordvpn.macos.helper',
        '0,licenseDaemon,licenseDaemon,Developer ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X),com.paceap.eden.licenseDaemon',
        '500,.Telegram-wrapped,.Telegram-wrapped,,Telegram',
        '500,agent,agent,Developer ID Application: Datadog, Inc. (JKFCB4CN7C),agent',
        '500,apko,apko,,a.out',
        '500,apkoaas,apkoaas,,a.out',
        '500,Arc Helper,Arc Helper,Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.browser.helper',
        '500,art,art,,a.out',
        '500,art,art,,a.out',
        '500,Authy,Authy,Apple iPhone OS Application Signing,com.authy',
        '500,bash,bash,,bash',
        '500,cloud_sql_proxy,cloud_sql_proxy,,a.out',
        '500,com.docker.backend,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R),com.docker.docker',
        '500,com.docker.build,com.docker.build,Developer ID Application: Docker Inc (9BNSXJN65R),com.docker',
        '500,copilot-language-server,copilot-language-server,Developer ID Application: GitHub (VEKTX9H2N7),copilot-language-server',
        '500,core,core,Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T),com.topaz.warsaw.core',
        '500,CrossyRoad,CrossyRoad,Apple iPhone OS Application Signing,com.hipsterwhale.crossy',
        '500,Fleet,~/Library/Caches/JetBrains/Fleet',
        '500,codebook-lsp,codebook-lsp,500u,20g',
        '500,gh,gh,,gh',
        '500,git-remote-http,git-remote-http,,git-remote-http-55554944748a32c47cdc35cfa7f071bb69a39ce4',
        '500,goland,goland,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland',
        '500,IterableRichNotifications,IterableRichNotifications,Apple iPhone OS Application Signing,com.plexapp.plex.IterableRichNotifications',
        '500,Java Updater,Java Updater,Developer ID Application: Oracle America, Inc. (VB5E2TV963),com.oracle.java.Java-Updater',
        '500,java,java,Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR),com.azul.zulu.java',
        '500,java,java,Developer ID Application: Oracle America, Inc. (VB5E2TV963),com.oracle.java.8u401.java',
        '500,jcef Helper,jcef Helper,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),org.jcef.jcef.helper',
        '500,Kindle,Kindle,TestFlight Beta Distribution,com.amazon.Lassen',
        '500,krisp Helper,krisp Helper,Developer ID Application: Krisp Technologies, Inc. (U5R26XM5Z2),ai.krisp.krispMac.helper',
        '500,krisp,krisp,Developer ID Application: Krisp Technologies, Inc. (U5R26XM5Z2),ai.krisp.krispMac',
        '500,kubectl,kubectl,Developer ID Application: Docker Inc (9BNSXJN65R),kubectl',
        '500,melange,melange,,a.out',
        '500,nami,nami,,a.out',
        '500,ngrok,ngrok,Developer ID Application: ngrok LLC (TEX8MHRDQ9),a.out',
        '500,node,node,Developer ID Application: Node.js Foundation (HX7739G8FX),node',
        '500,odo-darwin-amd64-b4853e1fa,odo-darwin-amd64-b4853e1fa,500u,20g',
        '500,Paintbrush,Paintbrush,Developer ID Application: Michael Schreiber (G966ML7VBG),com.soggywaffles.paintbrush',
        '500,Plex,Plex,Developer ID Application: Plex Inc. (K4QJ56KR4A),tv.plex.desktop',
        '500,PlexMobile,PlexMobile,Apple iPhone OS Application Signing,com.plexapp.plex',
        '500,podman,podman,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2),podman',
        '500,PowerPoint,PowerPoint,Apple Development: Zack Hoherchak (SS9PSPF8UF),PowerPoint',
        '500,process-agent,process-agent,Developer ID Application: Datadog, Inc. (JKFCB4CN7C),process-agent',
        '500,proctor,proctor,,a.out',
        '500,pycharm,pycharm,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.pycharm',
        '500,Realm,Realm,Apple iPhone OS Application Signing,camera.youpi.metareal',
        '500,sdaudioswitch,sdaudioswitch,,sdaudioswitch',
        '500,Signal Helper (Renderer),Signal Helper (Renderer),500u,20g',
        '500,Skitch,Skitch,Developer ID Application: Skitch Inc (J8RPQ294UB),com.skitch.skitch',
        '500,Sky Go,Sky Go,Developer ID Application: Sky UK Limited (GJ24C8864F),com.bskyb.skygoplayer',
        '500,snyk-ls_darwin_arm64,snyk-ls_darwin_arm64,,a.out',
        '500,syncthing,syncthing,,syncthing',
        '500,TextExpander,TextExpander,Developer ID Application: SmileOnMyMac, LLC (7PKJ6G4DXL),com.smileonmymac.textexpander',
        '500,trunk,trunk,Developer ID Application: Trunk Technologies, Inc. (LDR5F9BL92),trunk-cli',
        '500,WebexHelper,WebexHelper,Developer ID Application: Cisco (DE8Y96K9QP),Cisco-Systems.SparkHelper',
        '500,zed,zed,Developer ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed'
      )
      AND NOT alt_exception_key IN (
        '0,velociraptor,velociraptor,0u,0g',
        '500,sdaudioswitch,sdaudioswitch,500u,0g',
        '500,Python,Python,0u,80g',
        '0,nix,nix,0u,350g',
        '0,velociraptor,velociraptor,0u,80g'
      )
      AND NOT alt_exception_key LIKE '500,%,500u,20g'
      AND NOT alt_exception_key LIKE '500,%,0u,0g'
    
      AND NOT s.authority IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: AgileBits Inc. (2BUA8C4S2C)',
        'Developer ID Application: AMZN Mobile LLC (94KV3E626L)',
        'Developer ID Application: Bookry Ltd (4259LE8SU5)',
        'Developer ID Application: ANCHORE, INC. (9MJHKYX5AT)',
        'Developer ID Application: Autodesk (XXKJ396S2Y)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Determinate Systems, Inc. (X3JQ4VPJZ6)',
        'Developer ID Application: Denver Technologies, Inc (2BBY89MBSN)',
        'Developer ID Application: Determinate Systems, Inc. (X3JQ4VPJZ6)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Farhan Ahmed (4RZN52RN5P)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Schreiber (G966ML7VBG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Panic, Inc. (VE8FC488U5)',
        'Developer ID Application: PSI Services LLC (73AT498HPV)',
        'Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        'Developer ID Application: SLACK TECHNOLOGIES L.L.C. (BQR82RBBHL)',
        'Developer ID Application: Spotify (2FNC3A47ZF)',
        'Developer ID Application: SteelSeries (6WGL6CHFH2)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Developer ID Application: TechSmith Corporation (7TQL462TU8)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        'Developer ID Application: Zwift, Inc (C2GM8Y9VFM)'
      )
    GROUP BY
      p0.cmdline
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Talker Events"
  description: Unexpected socket events
  query: |
    SELECT
      s.status,
      s.family,
      s.path,
      s.fd,
      REPLACE(s.remote_address, "::ffff:", "") AS remote_address,
      s.remote_port,
      s.local_port,
      COALESCE(REGEX_MATCH (s.path, '.*/(.*)', 1), s.path) AS basename,
      REPLACE(f.directory, u.directory, '~') AS homedir,
      CONCAT (
        MIN(s.auid, 500),
        ",",
        MIN(f.uid, 500),
        ",",
        MIN(s.remote_port, 32768),
        ",",
        COALESCE(REGEX_MATCH (s.path, '.*/(.*)', 1), s.path)
      ) as exception_key,
      RTRIM(
        COALESCE(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?)/',
            1
          ),
          f.directory
        ),
        "/"
      ) AS top2_dir,
      -- Child
      s.path AS p0_path,
      s.pid AS p0_pid,
      s.auid AS p0_euid,
      TRIM(COALESCE(p.cmdline, pe.cmdline)) AS p0_cmd,
      TRIM(COALESCE(p.cwd, pe.cwd)) AS p0_cwd,
      hash.sha256 AS p0_sha256,
      -- Parent
      COALESCE(p.parent, pe.parent) AS p1_pid
    FROM
      socket_events AS s
      LEFT JOIN process_events pe ON s.pid = pe.pid
      AND pe.time > (strftime('%s', 'now') -7200)
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN file f ON s.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash ON s.path = hash.path
    WHERE
      s.time > (strftime('%s', 'now') -600)
      AND s.action = "connect"
      AND s.remote_port > 10
      AND s.remote_address NOT IN (
        '127.0.0.1',
        '::ffff:127.0.0.1',
        '::1',
        '::',
        '0.0.0.0'
      )
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '100.7%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '0000:%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE '::ffff:192.168.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND NOT s.path LIKE '/Applications/%' -- NOTE: Do not filter out /bin (bash) or /usr/bin (nc)
      AND NOT s.path LIKE '/private/var/folders/%/T/go-build%'
      AND NOT s.path = '/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Resources/Java Updater.app/Contents/MacOS/Java Updater'
      AND NOT top2_dir IN (
        '/Library/Apple',
        '/Library/Application Support',
        '/Library/Developer',
        '/Library/Kandji',
        '/opt/homebrew',
        '/snap/firefox',
        '/System/Applications',
        '/System/Library',
        '/System/Volumes',
        '/usr/bin',
        '/usr/libexec',
        '/usr/local',
        '/usr/sbin',
        '~/.provisio',
        '~/Applications',
        '~/Apps',
        '~/bin',
        '~/code',
        '~/github',
        '~/go',
        '~/homebrew',
        '~/src',
        '~/work'
      )
      AND NOT homedir IN (
        '/opt/spotify',
        '/usr/lib/google-cloud-sdk/platform/bundledpythonunix/bin',
        '~/Library/Application Support/Foxit Software/Addon/Foxit PDF Reader/FoxitPDFReaderUpdateService.app/Contents/MacOS'
      )
      AND NOT exception_key IN (
        '0,velociraptor,velociraptor,500u,80g',
        '500,0,110,syncthing',
        '500,0,123,sntp',
        '500,0,1234,spotify',
        '500,0,20480,com.adguard.mac.adguard.network-extension',
        '500,0,20480,io.tailscale.ipn.macsys.network-extension',
        '500,0,22,ssh',
        '500,0,27668,com.adguard.mac.adguard.network-extension',
        '500,0,31488,sntp',
        '500,0,32768,Authy',
        '500,0,32768,BDLDaemon',
        '500,0,32768,com.adguard.mac.adguard.network-extension',
        '500,0,32768,com.apple.MobileSoftwareUpdate.UpdateBrainService',
        '500,0,32768,com.apple.NRD.UpdateBrainService',
        '500,0,32768,elastic-endpoint',
        '500,0,32768,firefox',
        '500,0,32768,git-remote-http',
        '500,0,32768,io.tailscale.ipn.macsys.network-extension',
        '500,0,32768,ir_agent',
        '500,0,32768,ksfetch',
        '500,0,32768,networkQuality',
        '500,0,32768,syncthing',
        '500,0,3478,firefox',
        '500,0,4070,spotify',
        '500,0,43,whois',
        '500,0,443,Authy',
        '500,0,443,BDCoreIssues',
        '500,0,443,BDLDaemon',
        '500,0,443,bdredline',
        '500,0,443,BDUpdDaemon',
        '500,0,443,Brackets',
        '500,0,443,chrome_crashpad_handler',
        '500,0,443,chrome',
        '500,0,443,com.adguard.mac.adguard.network-extension',
        '500,0,443,com.apple.MobileSoftwareUpdate.UpdateBrainService',
        '500,0,443,com.apple.NRD.UpdateBrainService',
        '500,0,443,com.bitdefender.cst.net.dci.dci-network-extension',
        '500,0,443,com.docker.backend',
        '500,0,443,com.fortinet.forticlient.macos.vpn.nwextension',
        '500,0,443,com.google.one.NetworkExtension',
        '500,0,443,curl',
        '500,0,443,docker-buildx',
        '500,0,443,elastic-agent',
        '500,0,443,elastic-endpoint',
        '500,0,443,electron',
        '500,0,443,filebeat',
        '500,0,443,firefox',
        '500,0,443,fwupdmgr',
        '500,0,443,git-remote-http',
        '500,0,443,gnome-software',
        '500,0,443,go',
        '500,0,443,http',
        '500,0,443,incusd',
        '500,0,443,io.tailscale.ipn.macsys.network-extension',
        '500,0,443,ir_agent',
        '500,0,443,kioslave5',
        '500,0,443,ksfetch',
        '500,0,443,launcher',
        '500,0,443,metricbeat',
        '500,0,443,nessusd',
        '500,0,443,networkQuality',
        '500,0,443,node',
        '500,0,443,OneDriveStandaloneUpdater',
        '500,0,443,packetbeat',
        '500,0,443,pingsender',
        '500,0,443,Python',
        '500,0,443,rapid7_endpoint_broker',
        '500,0,443,slack',
        '500,0,443,snapd',
        '500,0,443,spotify',
        '500,0,443,ssh',
        '500,0,443,syncthing',
        '500,0,443,terraform',
        '500,0,443,velociraptor',
        '500,0,443,wget',
        '500,0,5228,chrome',
        '500,0,53,Brackets',
        '500,0,53,chrome',
        '500,0,53,electron',
        '500,0,53,firefox',
        '500,0,53,git',
        '500,0,53,launcher',
        '500,0,53,nessusd',
        '500,0,53,NetworkManager',
        '500,0,53,slack',
        '500,0,53,spotify',
        '500,0,53,wget',
        '500,0,5632,ssh',
        '500,0,80,BDUpdDaemon',
        '500,0,80,chrome',
        '500,0,80,com.adguard.mac.adguard.network-extension',
        '500,0,80,com.apple.NRD.UpdateBrainService',
        '500,0,80,com.bitdefender.cst.net.dci.dci-network-extension',
        '500,0,80,electron',
        '500,0,80,filebeat',
        '500,0,80,firefox',
        '500,0,80,http',
        '500,0,80,incusd',
        '500,0,80,io.tailscale.ipn.macsys.network-extension',
        '500,0,80,ir_agent',
        '500,0,80,ksfetch',
        '500,0,80,metricbeat',
        '500,0,80,slack',
        '500,0,8080,com.bitdefender.cst.net.dci.dci-network-extension',
        '500,0,9,launcher',
        '500,0,9,snapd',
        '500,500,13568,Code Helper',
        '500,500,20480,Code Helper',
        '500,500,20480,Google Chrome Helper',
        '500,500,20480,GoogleUpdater',
        '500,500,20480,ksfetch',
        '500,500,22,ssh',
        '500,500,2304,cloud_sql_proxy',
        '500,500,2304,terraform-provider-google_v4.37.0_x5',
        '500,500,3024,ZwiftAppSilicon',
        '500,500,32768,Chromium Helper',
        '500,500,32768,cloud-sql-proxy',
        '500,500,32768,Code Helper',
        '500,500,32768,DropboxMacUpdate',
        '500,500,32768,Electron',
        '500,500,32768,G2MUpdate',
        '500,500,32768,GoogleUpdater',
        '500,500,32768,java',
        '500,500,32768,ksfetch',
        '500,500,32768,melange',
        '500,500,32768,Microsoft.ServiceHub.Controller',
        '500,500,32768,Microsoft.VisualStudio.Code.Server',
        '500,500,32768,Microsoft.VisualStudio.Code.ServiceHost',
        '500,500,32768,node',
        '500,500,32768,old',
        '500,500,32768,rzls',
        '500,500,32768,terraform-ls',
        '500,500,3307,cloud_sql_proxy',
        '500,500,4318,Code Helper (Plugin)',
        '500,500,443,Acrobat Updater',
        '500,500,443,apk',
        '500,500,443,aws',
        '500,500,443,chainctl',
        '500,500,443,Chromium Helper',
        '500,500,443,Cisco WebEx Start',
        '500,500,443,CleanMyMac X Updater',
        '500,500,443,cloud_sql_proxy',
        '500,500,443,Code Helper (Plugin)',
        '500,500,443,Code Helper (Renderer)',
        '500,500,443,Code Helper',
        '500,500,443,copilot-agent-macos-arm64',
        '500,500,443,DropboxMacUpdate',
        '500,500,443,Electron',
        '500,500,443,figma_agent',
        '500,500,443,gh',
        '500,500,443,git-remote-http',
        '500,500,443,gitsign',
        '500,500,443,GitX',
        '500,500,443,go',
        '500,500,443,Google Chrome Helper',
        '500,500,443,GoogleUpdater',
        '500,500,443,grype',
        '500,500,443,istioctl',
        '500,500,443,ksfetch',
        '500,500,443,kubectl',
        '500,500,443,Meeting Center',
        '500,500,443,minikube',
        '500,500,443,node',
        '500,500,443,old',
        '500,500,443,Signal Helper (Renderer)',
        '500,500,443,Signal',
        '500,500,443,sublime_text',
        '500,500,443,syft',
        '500,500,443,webexmtaV2',
        '500,500,443,wolfibump',
        '500,500,443,wolfictl',
        '500,500,443,ZwiftAppSilicon',
        '500,500,53,Code Helper',
        '500,500,53,gitsign',
        '500,500,53,Google Chrome Helper',
        '500,500,53,Meeting Center',
        '500,500,80,cloud_sql_proxy',
        '500,500,80,Code Helper (Plugin)',
        '500,500,80,Code Helper',
        '500,500,80,copilot-agent-macos-arm64',
        '500,500,80,elastic-agent',
        '500,500,80,firefox-bin',
        '500,500,80,Google Chrome Helper',
        '500,500,80,GoogleUpdater',
        '500,500,80,ksfetch',
        '500,500,80,node',
        '500,500,9000,Meeting Center',
        '500,99,13568,Slack Helper',
        '500,99,32768,Slack Helper',
        '500,99,32768,Slack',
        '500,99,443,Slack Helper',
        '500,99,443,Slack',
        '500,99,53,Slack Helper'
      )
      AND NOT exception_key LIKE '500,0,%,chrome'
      AND NOT exception_key LIKE '500,0,%,syncthing'
      AND NOT exception_key LIKE '500,500,%,chrome'
      AND NOT exception_key LIKE '500,500,%,Google Chrome Helper'
      AND NOT exception_key LIKE '500,500,2304,terraform%'
      AND NOT exception_key LIKE '500,500,32768,terraform-provider-%'
      AND NOT exception_key LIKE '500,500,443,___%_%'
      AND NOT exception_key LIKE '500,500,443,kubectl.%'
      AND NOT exception_key LIKE '500,500,443,terraform%'
      AND NOT exception_key LIKE '500,500,53,terraform%'
      AND NOT exception_key LIKE '500,500,80,terraform%'
      AND NOT p0_path LIKE '/private/var/folders/%/T/AppTranslocation/%/%.app/Contents/MacOS/%'
      AND NOT p0_path LIKE '/System/%'
      AND NOT p0_path LIKE '/Users/%/code/%'
      AND NOT p0_path LIKE '/Users/%/dev/%'
      AND NOT p0_path LIKE '/Users/%/go/%'
      AND NOT p0_path LIKE '/Users/%/Library/Caches/JetBrains/GoLand%'
      AND NOT p0_path LIKE '/Users/%/src/%'
      AND NOT (
        basename = "Python"
        AND (
          p0_cmd LIKE '%/gcloud.py%'
          OR p0_cmd LIKE '%/bin/aws%'
          OR p0_cmd LIKE '%/google-cloud-sdk/%'
          OR p0_cmd LIKE '%googlecloudsdk/%'
          OR p0_cmd LIKE '%pip install%'
          OR p0_cmd LIKE "%/gsutil/%"
        )
      )
    GROUP BY
      s.pid,
      exception_key
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Talkers Linux"
  description: Unexpected programs communicating over non-HTTPS protocols (state-based)
  query: |
    SELECT
      s.remote_address,
      s.remote_port,
      s.local_port,
      s.local_address,
      p.name,
      p.path,
      p.cmdline AS child_cmd,
      p.cwd,
      p.euid,
      pp.path AS parent_path,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd,
      p.cgroup_path,
      s.state,
      hash.sha256,
      -- This intentionally avoids file.path, as it won't join across mount namespaces
      CONCAT (
        MIN(s.remote_port, 32768),
        ',',
        s.protocol,
        ',',
        MIN(p.euid, 500),
        ',',
        REGEX_MATCH (p.path, '.*/(.*?)$', 1),
        ',',
        MIN(f.uid, 500),
        'u,',
        MIN(f.gid, 500),
        'g,',
        p.name
      ) AS exception_key
    FROM
      process_open_sockets s
      LEFT JOIN processes p ON s.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      protocol > 0
      AND s.remote_port > 0 -- See unexpected-https-client
      AND NOT (
        s.remote_port = 443
        AND protocol IN (6, 17)
      ) -- See unexpected-dns-traffic
      AND NOT (
        s.remote_port = 53
        AND protocol IN (6, 17)
      )
      AND s.remote_address NOT IN (
        '127.0.0.1',
        '::ffff:127.0.0.1',
        '::1',
        '::',
        '0.0.0.0'
      )
      AND s.remote_address NOT LIKE 'fe80:%'
      AND s.remote_address NOT LIKE '127.%'
      AND s.remote_address NOT LIKE '192.168.%'
      AND s.remote_address NOT LIKE '100.7%'
      AND s.remote_address NOT LIKE '169.254.%'
      AND s.remote_address NOT LIKE '172.1%'
      AND s.remote_address NOT LIKE '172.2%'
      AND s.remote_address NOT LIKE '172.30.%'
      AND s.remote_address NOT LIKE '172.31.%'
      AND s.remote_address NOT LIKE '::ffff:172.%'
      AND s.remote_address NOT LIKE '10.%'
      AND s.remote_address NOT LIKE '::ffff:10.%'
      AND s.remote_address NOT LIKE '::ffff:192.168.%'
      AND s.remote_address NOT LIKE 'fc00:%'
      AND p.path != ''
      AND NOT (
        s.remote_address LIKE '100.%'
        AND s.local_address LIKE '100.%'
        AND exception_key = '32768,6,%,sshd,0u,0g,sshd'
      )
      AND NOT exception_key IN (
        '123,17,106,chronyd,0u,0g,chronyd',
        '123,17,125,chronyd,0u,0g,chronyd',
        '123,17,473,chronyd,0u,0g,chronyd',
        '123,17,500,chronyd,0u,0g,chronyd',
        '19305,6,500,msedge,0u,0g,msedge',
        '21,6,0,rpm-ostree,0u,0g,rpm-ostree',
        '22,6,500,azure,500u,500g,azure',
        '22,6,500,gce,500u,500g,gce',
        '22,6,500,gcp,500u,500g,gcp',
        '25565,6,500,java,500u,500g,java',
        '25567,6,500,java,500u,500g,java',
        '27018,6,500,pasta.avx2,0u,0g,pasta.avx2',
        '32520,6,0,rpm-ostree,0u,0g,rpm-ostree',
        '32768,6,0,registry,u,g,registry',
        '32768,6,0,tailscaled,0u,0g,tailscaled',
        '32768,6,22,sshd-auth,0u,0g,sshd-auth',
        '32768,6,500,mumble,0u,0g,mumble',
        '32768,6,500,slirp4netns,0u,0g,slirp4netns',
        '4070,6,500,spotify,0u,0g,spotify',
        '4070,6,500,spotify,u,g,spotify',
        '4433,6,500,openssl,0u,0g,openssl',
        '4460,6,106,chronyd,0u,0g,chronyd',
        '4460,6,125,chronyd,0u,0g,chronyd',
        '49152,6,500,ContinuityCaptureAgent,Software Signing',
        '5222,6,500,msedge,0u,0g,msedge',
        '587,6,500,perl,0u,0g,git-send-email',
        '67,17,0,NetworkManager,0u,0g,NetworkManager',
        '80,6,0,dnf5,0u,0g,dnf',
        '80,6,0,dnf5,0u,0g,dnf5',
        '80,6,0,grep,0u,0g,grep',
        '80,6,0,incusd,0u,0g,incusd',
        '80,6,0,kmod,0u,0g,depmod',
        '80,6,0,kubelet,u,g,kubelet',
        '80,6,0,ldconfig,0u,0g,ldconfig',
        '80,6,0,melange,500u,500g,melange',
        '80,6,0,NetworkManager,0u,0g,NetworkManager',
        '80,6,0,packagekit-dnf-refresh-repo,0u,0g,packagekit-dnf-',
        '80,6,0,packagekitd,0u,0g,packagekitd',
        '80,6,0,pacman,0u,0g,pacman',
        '80,6,0,pdftex,0u,0g,pdftex',
        '80,6,0,python2.7,500u,500g,yum',
        '80,6,0,python3.10,0u,0g,dnf',
        '80,6,0,python3.10,0u,0g,dnf-automatic',
        '80,6,0,python3.10,0u,0g,yum',
        '80,6,0,python3.11,0u,0g,dnf',
        '80,6,0,python3.11,0u,0g,dnf-automatic',
        '80,6,0,python3.11,0u,0g,yum',
        '80,6,0,python3.12,0u,0g,apport-gtk',
        '80,6,0,python3.12,0u,0g,dnf',
        '80,6,0,python3.12,0u,0g,dnf-automatic',
        '80,6,0,python3.12,0u,0g,yum',
        '80,6,0,python3.12,500u,500g,dnf-automatic',
        '80,6,0,python3.9,u,g,yum',
        '80,6,0,rpm-ostree,0u,0g,rpm-ostree',
        '80,6,0,sort,0u,0g,sort',
        '80,6,0,systemd-hwdb,0u,0g,systemd-hwdb',
        '80,6,0,tailscaled,0u,0g,tailscaled',
        '80,6,0,wget,0u,0g,wget',
        '80,6,0,zstd,0u,0g,zstd',
        '80,6,0,zypper,0u,0g,Zypp-main',
        '80,6,100,http,0u,0g,http',
        '80,6,105,http,0u,0g,http',
        '80,6,42,http,0u,0g,http',
        '80,6,500,aws-iam-authenticator,0u,0g,aws-iam-authent',
        '80,6,500,brave,0u,0g,brave',
        '80,6,500,chrome,0u,0g,chrome',
        '80,6,500,chrome,u,g,chrome',
        '80,6,500,chromium,0u,0g,chromium',
        '80,6,500,cloud_sql_proxy,0u,0g,cloud_sql_proxy',
        '80,6,500,code,0u,0g,code',
        '80,6,500,code-oss,u,g,code-oss',
        '80,6,500,copilot-agent-linux,500u,500g,copilot-agent-l',
        '80,6,500,curl,0u,0g,curl',
        '80,6,500,dotnet,u,g,dotnet',
        '80,6,500,dropbox,500u,500g,dropbox',
        '80,6,500,electron,0u,0g,electron',
        '80,6,500,firefox,0u,0g,.firefox-wrappe',
        '80,6,500,firefox,0u,0g,firefox',
        '80,6,500,firefox-bin,0u,0g,firefox-bin',
        '80,6,500,firefox-bin,500u,500g,firefox-bin',
        '80,6,500,firefox-bin,u,g,firefox-bin',
        '80,6,500,firefox-esr,0u,0g,firefox-esr',
        '80,6,500,flatpak,0u,0g,flatpak',
        '80,6,500,git-remote-http,0u,0g,git-remote-http',
        '80,6,500,gnome-software,0u,0g,gnome-software',
        '80,6,500,http,0u,0g,http',
        '80,6,500,http,u,g,http',
        '80,6,500,java,0u,0g,java',
        '80,6,500,java,u,g,java',
        '80,6,500,librewolf,0u,0g,librewolf',
        '80,6,500,main,500u,500g,main',
        '80,6,500,mateweather-applet,0u,0g,mateweather-app',
        '80,6,500,mconvert,500u,500g,mconvert',
        '80,6,500,mediawriter,u,g,mediawriter',
        '80,6,500,melange,500u,500g,melange',
        '80,6,500,minecraft-launcher,500u,500g,minecraft-launc',
        '80,6,500,msedge,0u,0g,msedge',
        '80,6,500,obs-browser-page,u,g,obs-browser-pag',
        '80,6,500,ocsp.test,u,g,ocsp.test',
        '80,6,500,pacman,0u,0g,pacman',
        '80,6,500,python3.10,0u,0g,aws',
        '80,6,500,python3.10,0u,0g,yum',
        '80,6,500,python3.11,0u,0g,abrt-action-ins',
        '80,6,500,python3.11,0u,0g,dnf',
        '80,6,500,python3.11,0u,0g,yum',
        '80,6,500,python3.12,0u,0g,pull-lp-source',
        '80,6,500,qemu-system-x86_64,0u,0g,qemu-system-x86',
        '80,6,500,qemu-system-x86_64,500u,500g,qemu-system-x86',
        '80,6,500,rpi-imager,0u,0g,rpi-imager',
        '80,6,500,signal-desktop,0u,0g,signal-desktop',
        '80,6,500,signal-desktop,u,g,signal-desktop',
        '80,6,500,slack,0u,0g,slack',
        '80,6,500,slirp4netns,500u,500g,slirp4netns',
        '80,6,500,spotify,0u,0g,spotify',
        '80,6,500,spotify,500u,500g,spotify',
        '80,6,500,spotify,u,g,spotify',
        '80,6,500,spotify-launcher,0u,0g,spotify-launche',
        '80,6,500,steam,500u,100g,steam',
        '80,6,500,steam,500u,500g,steam',
        '80,6,500,steamwebhelper,500u,500g,steamwebhelper',
        '80,6,500,telegram-desktop,u,g,telegram-deskto',
        '80,6,500,terraform,0u,0g,terraform',
        '80,6,500,terraform,500u,500g,terraform',
        '80,6,500,thunderbird,0u,0g,thunderbird',
        '80,6,500,thunderbird,u,g,thunderbird',
        '80,6,500,thunderbird-bin,0u,0g,thunderbird-bin',
        '80,6,500,thunderbird-bin,u,g,thunderbird-bin',
        '80,6,500,updater,500u,500g,updater',
        '80,6,500,vlc,0u,0g,vlc',
        '80,6,500,WebKitNetworkProcess,0u,0g,WebKitNetworkPr',
        '80,6,500,wget,0u,0g,wget',
        '80,6,500,wine64-preloader,0u,0g,control.exe',
        '80,6,500,zen,u,g,zen',
        '80,6,500,zoom,0u,0g,zoom',
        '80,6,500,zoom.real,u,g,zoom.real',
        '80,6,500,ZoomWebviewHost,0u,0g,ZoomWebviewHost',
        '8000,6,500,brave,0u,0g,brave',
        '8000,6,500,chrome,0u,0g,chrome',
        '8000,6,500,firefox,0u,0g,firefox',
        '8080,6,500,bambu-studio,u,g,bambustu_main',
        '8080,6,500,brave,0u,0g,brave',
        '8080,6,500,chrome,0u,0g,chrome',
        '8080,6,500,firefox,0u,0g,firefox',
        '8080,6,500,goland,500u,500g,goland',
        '8080,6,500,goland,u,g,goland',
        '8080,6,500,idea,0u,0g,idea',
        '8080,6,500,java,u,g,java',
        '8080,6,500,msedge,0u,0g,msedge',
        '8080,6,500,pycharm,500u,500g,pycharm',
        '8080,6,500,python3.11,0u,0g,speedtest-cli',
        '8080,6,500,python3.12,u,g,hass',
        '8080,6,500,speedtest,0u,0g,speedtest',
        '8080,6,500,speedtest,500u,500g,speedtest',
        '8443,6,500,chrome,0u,0g,chrome',
        '8443,6,500,firefox,0u,0g,firefox',
        '8443,6,500,WebKitNetworkProcess,0u,0g,WebKitNetworkPr',
        '88,6,500,syncthing,0u,0g,syncthing',
        '8801,17,500,zoom,0u,0g,zoom',
        '8801,17,500,zoom.real,u,g,zoom.real',
        '8883,6,500,bambu-studio,u,g,bambustu_main',
        '8883,6,500,WebKitWebProcess,u,g,WebKitWebProces',
        '89,6,500,chrome,0u,0g,chrome',
        '8987,6,500,whois,0u,0g,whois',
        '9,17,0,launcher,0u,0g,launcher',
        '9418,6,0,git,0u,0g,git',
        '9418,6,500,git,0u,0g,git',
        '993,6,500,evolution,0u,0g,evolution',
        '993,6,500,mbsync,0u,0g,mbsync',
        '993,6,500,thunderbird,0u,0g,thunderbird',
        '993,6,500,thunderbird,u,g,thunderbird',
        '993,6,500,thunderbird-bin,0u,0g,thunderbird-bin',
        '9999,6,500,firefox,0u,0g,firefox'
      )
      AND NOT exception_key LIKE '%,6,500,nuclei,500u,500g,nuclei'
      AND NOT exception_key LIKE '%,6,500,ssh,0u,0g,ssh'
      AND NOT exception_key LIKE '80,6,500,terraform_1.1.5,500u,500g,terraform'
      AND NOT exception_key LIKE '%,6,0,rpm-ostree,0u,0g,rpm-ostree'
      AND NOT exception_key LIKE '%,6,0,sshd-session,0u,0g,sshd-session'
      AND NOT exception_key LIKE '%,6,22,sshd-auth,0u,0g,sshd-auth'
    
      AND NOT (
        s.remote_port = 80
        AND s.protocol = 6
        AND p.euid > 500
        AND (
          p.path LIKE '%/bin/%'
          OR p.path LIKE '/app/%'
          OR p.path LIKE '/opt/%'
        )
      )
      AND NOT (
        p.name = 'java'
        AND p.cmdline LIKE '/home/%/.local/share/JetBrains/Toolbox/%'
        AND s.remote_port > 1024
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'ruby'
        AND p.cmdline LIKE '%fluentd%'
        AND s.remote_port > 1024
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name IN ('java', 'jcef_helper')
        AND p.cmdline LIKE '/home/%/PhpStorm%'
        AND s.remote_port > 79
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'syncthing'
        AND f.filename = 'syncthing'
        AND s.remote_port > 900
        AND s.protocol = 6
        AND p.euid > 500
      )
      AND NOT (
        p.name IN ('chrome', 'chromium')
        AND f.filename IN ('chrome', 'chromium')
        AND s.remote_port > 1024
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'steam'
        AND f.filename = 'steam'
        AND s.remote_port > 27000
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      )
      AND NOT (
        p.name = 'brave'
        AND f.filename = 'brave'
        AND s.remote_port > 3000
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      )
      AND NOT (
        p.name IN (
          'firefox',
          'firefox-bin',
          'firefox-esr',
          'librewolf'
        )
        AND f.filename IN (
          'firefox',
          'firefox-bin',
          'firefox-esr',
          'librewolf'
        )
        AND s.remote_port > 3000
        AND s.protocol IN (6, 17)
        AND p.euid > 500
      ) -- TODO: Move this to a custom override overlay, as it is extremely obscure (small ISP)
      AND NOT (
        exception_key = '32768,6,500,ssh,0u,0g,ssh'
        AND s.remote_port = 40022
      ) -- Qualys
      AND NOT (
        exception_key = '80,6,0,curl,0u,0g,curl'
        AND p.cgroup_path = '/system.slice/qualys-cloud-agent.service'
        AND child_cmd LIKE ' curl -sS -H Metadata:true http://169.254.169.254/metadata/instance%'
      )
      AND NOT (
        s.remote_port = 80
        AND (
          p.cgroup_path LIKE '/system.slice/docker-%'
          OR p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'
        )
      )
      AND NOT parent_cmd IN ('/opt/microsoft/msedge/msedge')
      AND NOT (
        exception_key LIKE '%,6,500,sshd-session,0u,0g,sshd-session'
        AND parent_cmd LIKE '%chainguard_dev%'
      )
      AND NOT p.path = '/opt/docker-desktop/bin/com.docker.backend'
    GROUP BY
      p.cmdline
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Talkers Macos"
  description: Unexpected programs communicating over non-HTTPS running from weird locations
  query: |
    SELECT
      pos.protocol,
      pos.local_port,
      pos.remote_port,
      remote_address,
      pos.local_port,
      pos.local_address,
      CONCAT (MIN(p0.euid, 500), ',', s.authority) AS signed_exception,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        pos.protocol,
        ',',
        MIN(pos.remote_port, 32768),
        ',',
        COALESCE(REGEX_MATCH (p0.path, '.*/(.*?)$', 1), p0.name),
        ',',
        p0.name
      ) AS unsigned_exception,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256
    FROM
      process_open_sockets pos
      LEFT JOIN processes p0 ON pos.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
    WHERE
      pos.pid IN (
        SELECT
          pid
        from
          process_open_sockets
        WHERE
          protocol > 0
          AND local_port > 0
          AND remote_port > 0
          AND NOT (
            remote_port IN (53, 443)
            AND protocol IN (6, 17)
          )
          AND remote_address NOT IN (
            '0.0.0.0',
            '::127.0.0.1',
            '127.0.0.1',
            '::ffff:127.0.0.1',
            '::1',
            '::'
          )
          AND remote_address NOT LIKE 'fe80:%'
          AND remote_address NOT LIKE '127.%'
          AND remote_address NOT LIKE '192.168.%'
          AND remote_address NOT LIKE '172.1%'
          AND remote_address NOT LIKE '172.2%'
          AND remote_address NOT LIKE '169.254.%'
          AND remote_address NOT LIKE '172.30.%'
          AND remote_address NOT LIKE '172.31.%'
          AND remote_address NOT LIKE '::ffff:172.%'
          AND remote_address NOT LIKE '10.%'
          AND remote_address NOT LIKE '::ffff:10.%'
          AND remote_address NOT LIKE 'fc00:%'
          AND remote_address NOT LIKE 'fdfd:%'
          AND state != 'LISTEN'
      ) -- Ignore most common application paths
      AND protocol > 0
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%/MacOS/%'
      AND p0.path NOT LIKE '/Applications/%.app/Contents/MacOS/%'
      AND p0.path NOT LIKE '/Applications/%.app/Contents/Resources/%'
      AND p0.path NOT LIKE '/Users/%/Applications/%.app/Contents/MacOS/%'
      AND p0.path NOT LIKE '/Library/Apple/%'
      AND p0.path NOT LIKE '/Library/Application Support/%/Contents/%'
      AND p0.path NOT LIKE '/opt/%/bin/%'
      AND p0.path NOT LIKE '/System/%'
      AND p0.path NOT LIKE '/Users/%/bin/%'
      AND p0.path NOT LIKE '/usr/bin/%'
      AND p0.path NOT LIKE '/usr/libexec/%'
      AND p0.path NOT LIKE '/usr/sbin/%'
      AND NOT signed_exception IN (
        '0,Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        '0,Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        '0,Developer ID Application: Y Soft Corporation, a.s. (3CPED8WGS9)',
        '500,Apple Mac OS Application Signing',
        '500,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '500,Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        '500,Developer ID Application: Autodesk (XXKJ396S2Y)',
        '500,Developer ID Application: AMZN Mobile LLC (94KV3E626L)',
        '500,Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR)',
        '500,Developer ID Application: Blackmagic Design Inc (9ZGFBWLSYP)',
        '500,Developer ID Application: Bookry Ltd (4259LE8SU5)',
        '500,Developer ID Application: Cisco (DE8Y96K9QP)',
        '500,Developer ID Application: David Kocher (G69SCX94XU)',
        '500,Developer ID Application: Google LLC (EQHXZ8M8AV)',
        '500,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        '500,Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        '500,Developer ID Application: ngrok LLC (TEX8MHRDQ9)',
        '500,Developer ID Application: Razer USA Ltd. (R2H967U7J8)',
        '500,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        '500,Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        '500,Developer ID Application: Sky UK Limited (GJ24C8864F)',
        '500,Developer ID Application: Spotify (2FNC3A47ZF)',
        '500,Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G)',
        '500,Developer ID Application: Valve Corporation (MXGJJ98X76)',
        '500,Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        '500,Developer ID Application: Zwift, Inc (C2GM8Y9VFM)',
        '500,Software Signing'
      )
      AND NOT (
        unsigned_exception = '500,6,80,main,main'
        AND p0.path LIKE '/var/folders/%/T/go-build%/b001/exe/main'
      )
      AND NOT (
        unsigned_exception = '500,6,443,.Telegram-wrapped,.Telegram-wrapped'
        AND p0.path LIKE '/nix/store/%-telegram-desktop-%/Applications/Telegram.app/Contents/MacOS/Telegram'
      )
      -- port 0 means the connection has come and gone since the original process_open_sockets entry
      AND NOT unsigned_exception IN (
        '500,0,0,,',
        '500,0,0,.Telegram-wrapped,.Telegram-wrapped',
        '500,0,0,chainlink,chainlink',
        '500,0,0,git,git',
        '500,6,22,ssh,ssh',
        '500,0,0,gvproxy,gvproxy',
        '500,0,0,jspawnhelper,jspawnhelper',
        '500,0,0,Python,Python',
        '500,17,0,com.adguard.mac.adguard.network-extension,com.adguard.mac.adguard.network-extension',
        '500,17,0,limactl,limactl',
        '500,17,123,gvproxy,gvproxy',
        '500,17,123,crc,crc',
        '500,17,443,,',
        '500,17,53,gvproxy,gvproxy',
        '500,6,0,fuscript,fuscript',
        '500,6,0,gvproxy,gvproxy',
        '500,6,32768,cloud_sql_proxy,cloud_sql_proxy',
        '500,6,32768,gvproxy,gvproxy',
        '500,6,443,,',
        '500,6,443,.Telegram-wrapped,.Telegram-wrapped',
        '500,6,443,chainlink,chainlink',
        '500,6,443,cloud_sql_proxy,cloud_sql_proxy',
        '500,6,443,gvproxy,gvproxy',
        '500,6,5223,apsd,apsd',
        '500,6,5228,,',
        '500,6,5228,Google Chrome for Testing Helper,Google Chrome for Testing Helper',
        '500,6,80,.Telegram-wrapped,.Telegram-wrapped',
        '500,6,80,chainlink,chainlink',
        '500,6,8080,Python,Python',
        '500,6,90,java,java',
        '500,6,9418,git,git',
        '500,6,32768,.limactl-wrapped,.limactl-wrapped'
      )
      AND NOT unsigned_exception LIKE '500,6,%,firefox,firefox'
    GROUP BY
      p0.cmdline
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Icmp Socket Events"
  description: Unexpected programs speaking over ICMP (event-based)
  query: |
    SELECT
      se.*,
      p.path,
      p.cwd,
      p.euid,
      p.cmdline
    FROM
      socket_events se
      LEFT JOIN processes p ON se.pid = p.pid
    WHERE
      se.time > (strftime('%s', 'now') -300)
      AND family = 2 -- PF_INET
      AND protocol = 1 -- ICMP
      AND p.name NOT IN ('ping')
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Icmp Socket"
  description: Unexpected programs speaking over ICMP (state-based)
  query: |
    SELECT
      pop.pid AS p0_pid,
      pop.socket,
      pop.local_address,
      pop.remote_address,
      -- Child
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pop
      LEFT JOIN processes p0 ON pop.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pop.family = 2 -- PF_INET
      AND pop.protocol = 1 -- ICMP
      AND p0.name NOT IN ('ping')
      AND p0.path NOT IN ('/opt/docker-desktop/bin/com.docker.backend')
    GROUP BY
      p0_pid
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Root Libcurl Proc Linux"
  description: Find programs processes which link against libcurl, common among cross-platform malware
  query: |
    SELECT
      CONCAT (
        p0.name,
        ',',
        REPLACE(
          p0.path,
          COALESCE(
            REGEX_MATCH (p0.path, "/nix/store/(.*?)/.*", 1),
            REGEX_MATCH (p0.path, "(\d[\.\d]+)/.*", 1),
            "3.11"
          ),
          "__VERSION__"
        ),
        ',',
        p0.euid,
        ',',
        CONCAT (
          SPLIT (p0.cgroup_path, "/", 0),
          ",",
          SPLIT (p0.cgroup_path, "/", 1)
        ),
        ',',
        f.mode
      ) AS exception_key,
      pmm.path AS library_path,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.start_time AS p1_start,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid = 0
      AND pmm.path LIKE '%libcurl%'
      AND NOT exception_key IN (
        '0,0,/var/run/ublue-update.lock,regular,0755',
        'accounts-daemon,/usr/libexec/accounts-daemon,0,system.slice,accounts-daemon.service,0755',
        'apache2,/usr/sbin/apache2,0,system.slice,apache2.service,0755',
        'boltd,/usr/libexec/boltd,0,system.slice,bolt.service,0755',
        'osqueryd,/usr/local/kolide-k2/bin/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'agentbeat,/opt/Elastic/Agent/data/elastic-agent-9.0.0-9786ac/components/agentbeat,0,system.slice,elastic-agent.service,0750',
        'elastic-endpoin,/opt/Elastic/Endpoint/elastic-endpoint,0,elasticendpoint,,0500',
        'bluetoothd,/usr/libexec/bluetooth/bluetoothd,0,system.slice,bluetooth.service,0755',
        'sudo,/usr/bin/sudo,0,system.slice,sshd.service,4755',
        'dnf,/usr/bin/python__VERSION__,0,system.slice,dnf-makecache.service,0755',
        'dnf,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'dnf-automatic,/usr/bin/python3.12,0,system.slice,dnf-automatic-install.service,0755',
        'dnf-automatic,/usr/bin/python__VERSION__,0,system.slice,dnf-automatic-install.service,0755',
        'firewalld,/usr/bin/python3.13,0,system.slice,firewalld.service,0755',
        'flatpak-system-,/usr/libexec/flatpak-system-helper,0,system.slice,flatpak-system-helper.service,0755',
        'fwupd,/usr/lib/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'fwupd,/usr/libexec/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'agentbeat,/opt/Elastic/Agent/data/elastic-agent-9.0.1-68f3ed/components/agentbeat,0,system.slice,elastic-agent.service,0750',
        'implicitclass,/usr/lib/cups/backend/implicitclass,0,system.slice,cups.service,0744',
        'sddm-helper,/usr/lib/x86_64-linux-gnu/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'libvirtd,/usr/bin/libvirtd,0,system.slice,libvirtd.service,0755',
        'libvirtd,/usr/sbin/libvirtd,0,system.slice,libvirtd.service,0755',
        'sshd-session,/usr/lib/ssh/sshd-session,0,system.slice,sshd.service,0755', -- nss_oslogin
        'ModemManager,/usr/sbin/ModemManager,0,system.slice,ModemManager.service,0755',
        'NetworkManager,/usr/bin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'NetworkManager,/usr/sbin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'nix-daemon,/nix/store/__VERSION__/bin/nix,0,system.slice,nix-daemon.service,0555',
        'ostree,/usr/bin/ostree,0,system.slice,ostree-finalize-staged-hold.service,0755',
        'packagekitd,/usr/libexec/packagekitd,0,system.slice,packagekit.service,0755',
        'pacman,/usr/bin/pacman,0,user.slice,user-1000.slice,0755',
        'realmd,/usr/libexec/realmd,0,system.slice,realmd.service,0755',
        'rpm-ostree,/usr/bin/rpm-ostree,0,system.slice,rpm-ostreed.service,0755',
        'rpm-ostree,/usr/bin/rpm-ostree,0,system.slice,ublue-update.service,0755',
        'sddm,/usr/bin/sddm,0,system.slice,sddm.service,0755',
        'sddm-helper,/usr/lib/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/libexec/sddm-helper,0,user.slice,user-1000.slice,0755',
        'udisksd,/usr/libexec/udisks2/udisksd,0,system.slice,udisks2.service,0755',
        'virtlockd,/usr/sbin/virtlockd,0,system.slice,virtlockd.service,0755',
        'virtlogd,/usr/bin/virtlogd,0,system.slice,virtlogd.service,0755',
        'virtlogd,/usr/sbin/virtlogd,0,system.slice,virtlogd.service,0755',
        'virt-manager,/usr/bin/python3.12,0,user.slice,user-1000.slice,0755',
        'virtqemud,/usr/sbin/virtqemud,0,system.slice,virtqemud.service,0755',
        'yum,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal,0,user.slice,user-1000.slice,0755',
        'dnf,/usr/bin/dnf5,0,user.slice,user-0.slice,0755',
        'zed,/nix/store/__VERSION__/bin/zed,0,system.slice,zfs-zed.service,0555',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,zfs-snapshot-frequent.service,0555'
      )
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p0.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/c2] Unexpected Root Libcurl Proc Macos"
  description: Find root processes which link against libcurl, common among cross-platform malware
  query: |
    SELECT
      s.authority,
      s.identifier,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid = 0
      AND pmm.path LIKE '%libcurl%'
      AND p0.name NOT IN (
        'cloud-provider-kind',
        'docker-mac-net-connect',
        'ir_agent',
        'nix',
        'nix-daemon',
        'osqueryd',
        'rapid7_endpoint_broker',
        'socket_vmnet',
        'velociraptor'
      )
    GROUP BY
      p0.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/collection] High Disk Bytes Written"
  description: Programs which are writing an unusually large amount of data
  query: |
    SELECT
      -- WARNING: Writes to tmpfs are not reflected against this counter
      p0.disk_bytes_written AS bytes_written,
      (strftime('%s', 'now') - p0.start_time) AS age,
      p0.disk_bytes_written / (strftime('%s', 'now') - p0.start_time) AS bytes_written_rate,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cgroup_path AS p0_cgroup,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- On my Linux machine, creating a gzip archive clocks in at 6780210
      bytes_written_rate > 4800000
      AND age > 200
      AND p0.pid > 2
      AND p0.parent != 2
      AND p0.path NOT IN (
        '/app/libexec/mediawriter/helper',
        '/bin-busybox',
        '/bin/bash',
        '/bin/sh',
        '/Library/Application Support/Adobe/Adobe Desktop Common/HDBox/Setup',
        '/opt/homebrew/bin/qemu-system-aarch64',
        '/opt/osquery/lib/osquery.app/Contents/MacOS/osqueryd',
        '/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/Current/AppleMobileDeviceHelper.app/Contents/Resources/AppleMobileBackup',
        '/usr/bin/apt',
        '/usr/bin/aptd',
        '/usr/bin/bash',
        '/usr/bin/bwrap',
        '/usr/bin/curl',
        '/usr/bin/darktable',
        '/usr/bin/dockerd',
        '/usr/bin/fish',
        '/usr/bin/git',
        '/usr/bin/gnome-disks',
        '/usr/bin/gnome-shell',
        '/usr/bin/gnome-software',
        '/usr/bin/gnome-text-editor',
        '/usr/bin/make',
        '/usr/bin/nautilus',
        '/usr/bin/melange',
        '/usr/bin/pacman',
        '/usr/bin/toolbox',
        '/usr/bin/qemu-system-x86_64',
        '/usr/bin/yay',
        '/usr/bin/zsh',
        '/usr/lib/baloo_file',
        '/usr/lib/baloo_file_extractor',
        '/usr/lib/flatpak-system-helper',
        '/usr/lib/snapd/snapd',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib64/thunderbird/thunderbird',
        '/usr/libexec/coreduetd',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/logd_helper',
        '/usr/libexec/mobileassetd',
        '/usr/libexec/packagekitd',
        '/usr/libexec/rosetta/oahd',
        '/usr/libexec/rtcreportingd',
        '/usr/libexec/secd',
        '/usr/libexec/sharingd',
        '/usr/sbin/screencapture',
        '/usr/share/spotify-client/spotify'
      )
      AND NOT (
        p0.name LIKE 'jbd%/dm-%'
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'bindfs'
        AND p0.cmdline LIKE 'bindfs -f -o fsname=%'
      )
      AND NOT (
        p0.name = 'btrfs-transaction'
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'kernel_task'
        AND p0.path = ''
        AND p0.parent IN (0, 1)
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'launchd'
        AND p0.path = '/sbin/launchd'
        AND p0.parent = 0
      )
      AND NOT (
        p0.name = 'logd'
        AND p0.cmdline = '/usr/libexec/logd'
        AND p0.parent = 1
      )
      AND NOT (
        p0.name = 'aptd'
        AND p0.cmdline = '/usr/bin/python3 /usr/sbin/aptd'
      )
      AND NOT p0.name IN (
        'apkoaas',
        'Autodesk Fusion 360',
        'baloo_file_extr',
        'bincapz',
        'bwrap',
        'cargo',
        'chrome',
        'clair',
        'code',
        'com.apple.MobileSoftwareUpdate.UpdateBrainService',
        'com.apple.NRD.UpdateBrainService',
        'containerd',
        'containerd-',
        'containerd-shim',
        'darkfiles',
        'dlv',
        'dnf',
        'dnf-automatic',
        'docker-index',
        'esbuild',
        'firefox',
        'wolfi-package-info-who-owns',
        'flatpak-session',
        'fsdaemon',
        'git',
        'gnome-terminal-',
        'go',
        'goland',
        'golangci-lint-v',
        'GoogleUpdater',
        'gopls',
        'grype',
        'idea',
        'Install',
        'java',
        'jetbrains-toolb',
        'kandji-daemon',
        'kpromo',
        'launcher',
        'limactl',
        'logioptionsplus_updater',
        'lxd',
        'mal',
        'mediawriter',
        'melange',
        'melange-run',
        'monorail',
        'nami',
        'nessusd',
        'ninja',
        'node',
        'osqueryd',
        'photorec',
        'qemu-system-aarch64',
        'qemu-system-x86',
        'qemu-system-x86_64',
        'postgres',
        'rpm-ostree',
        'rsync',
        'rust-analyzer',
        'rustup',
        'slack',
        'snyk',
        'snyk-macos',
        'spotify',
        'staticcheck',
        'steam',
        'steam_osx',
        'syft',
        'terraform',
        'terraform-provider-apko',
        'thunderbird-bin',
        'tmux:server',
        'topgrade',
        'tracker-miner-f',
        'trivy',
        'trivy-db',
        'unattended-upgr',
        'vi',
        'vim',
        'wimlib-imagex',
        'wineserver',
        'wolfictl',
        'yum',
        'zsh'
      )
      AND NOT p1.name IN ('bwrap')
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%'
      AND p0.path NOT LIKE '/home/%/.local/share/Steam'
      AND p0.path NOT LIKE '/Library/Application Support/%'
      AND p0.path NOT LIKE '/nix/store/%/bin/%sh'
      AND p0.path NOT LIKE '/nix/store/%/bin/nix'
      AND p0.path NOT LIKE '/nix/store/%kolide-launcher-%/bin/launcher'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND p0.path NOT LIKE '/var/folders/%/T/go-build%'
      AND p0.path NOT LIKE '/var/kolide-k2/%/osqueryd'
      AND p0.path NOT LIKE "%/terraform-provider-%"
      AND NOT p0.cmdline LIKE '%/gsutil %rsync%'
      AND NOT p0.cmdline LIKE '%python -m build%'
      AND NOT p0.cmdline LIKE '%python -m pip%'
      AND NOT p0.cmdline LIKE '%/lib/gcloud.py components update'
      AND NOT p0.cmdline LIKE '%brew.rb upgrade%'
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
      AND p0.cwd != '/home/build'
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/collection] Excess Google Drive Downloads Macos"
  description: Surface when a machine has downloaded an unusual number of files from Google Drive
  query: |
    SELECT
      COUNT(DISTINCT file.path) AS num_downloads,
      GROUP_CONCAT(DISTINCT file.path) AS paths,
      SUM(file.size) AS total_size,
      MIN(file.btime) AS first_btime,
      MAX(file.atime) AS last_atime
    FROM
      mdfind
      JOIN file ON mdfind.path = file.path
      JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = "where_from"
    WHERE
      query = "kMDItemFSCreationDate >= $time.now(-86400)"
      -- For some reason relying on kMDItemWhereFroms omitted download word docs, so
      -- this does it the slow way.
      AND ea.value LIKE "https://doc-%googleusercontent.com%"
      -- this seems excessive, but I was having issues with kMDItemFSCreationDate not filtering appropriately
      AND MAX(file.btime, file.ctime, file.mtime) > (strftime('%s', 'now') -86400)
      -- Common, low-risk for exfil
      AND file.filename NOT LIKE '%.csv'
      -- "GROUP BY" should be unnecessary, but Kolide seems to require it
    GROUP BY
      ea.key
    HAVING
      num_downloads > 8
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/collection] Excess Google Drive Folder Exports Macos"
  description: Surface when a machine has downloaded an unusual number of zip exports from Google Drive
  query: |
    SELECT
      COUNT(DISTINCT file.path) AS num_exports,
      GROUP_CONCAT(DISTINCT file.path) AS paths,
      SUM(file.size) AS total_size,
      MIN(file.btime) AS first_btime,
      MAX(file.atime) AS last_atime
    FROM
      mdfind
      JOIN file ON mdfind.path = file.path
      JOIN hash ON file.path = hash.path
      JOIN extended_attributes ea ON mdfind.path = ea.path
    WHERE
      mdfind.query = "kMDItemWhereFroms == 'https://*-drive-data-export.googleusercontent.com*' AND 'kMDItemFSCreationDate >= $time.now(-604800)'"
      -- this seems excessive, but I was having issues with kMDItemFSCreationDate not filtering appropriately
      AND MAX(file.btime, file.ctime, file.mtime) > (strftime('%s', 'now') -604800)
      -- "GROUP BY" should be unnecessary, but Kolide seems to require it
    GROUP BY
      ea.key
    HAVING
      total_size > (100 * 1024 * 1024)
      OR num_exports > 1
    ORDER BY
      file.path ASC
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/collection] Spotlight Database Export Macos"
  description: Find database exports. Will need tuning based on your table names.
  query: |
    SELECT
      f.path,
      f.size,
      datetime(f.btime, 'unixepoch') AS file_created,
      magic.data
    FROM
      file f
      JOIN mdfind ON mdfind.path = f.path
      LEFT JOIN magic ON f.path = magic.path
    WHERE
      (
        (
          mdfind.query = 'kMDItemFSName == ''*enforce*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*iam*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*tenant*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
      )
      AND f.path NOT LIKE '%.json'
      AND f.path NOT LIKE '%.log'
      AND f.path NOT LIKE '%/testdata/%'
      AND f.path NOT LIKE '%mysql-test/suite/%'
      AND f.size > 32768
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/credentials] Unexpected Dev Opener Linux"
  description: Detects unexpected programs opening files in /dev on Linux
  query: |
    SELECT
      pof.path AS device,
      CONCAT (
        IIF(
          REGEX_MATCH (
            TRIM(REPLACE(pof.path, ' (deleted)', '')),
            '(/dev/.*)[\d ]+$',
            1
          ) != '',
          REGEX_MATCH (
            TRIM(REPLACE(pof.path, ' (deleted)', '')),
            '(/dev/.*)[\d ]+$',
            1
          ),
          TRIM(REPLACE(pof.path, ' (deleted)', ''))
        ),
        ',',
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        )
      ) AS path_exception,
      CONCAT (
        TRIM(
          REPLACE(
            pof.path,
            CONCAT (
              '/',
              REPLACE(
                pof.path,
                RTRIM(pof.path, REPLACE(pof.path, '/', '')),
                ''
              )
            ),
            ''
          )
        ),
        ',',
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        )
      ) AS dir_exception,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_files pof
      LEFT JOIN processes p0 ON pof.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pof.path LIKE '/dev/%'
      AND pof.path NOT IN (
        '/dev/console',
        '/dev/dri/card0',
        '/dev/dri/card1',
        '/dev/dri/card2',
        '/dev/dri/renderD128',
        '/dev/dri/renderD129',
        '/dev/fuse',
        '/dev/io8log',
        '/dev/io8logmt',
        '/dev/io8logtemp',
        '/dev/null',
        '/dev/nvidia-modeset',
        '/dev/nvidia-uvm',
        '/dev/nvidia0',
        '/dev/nvidiactl',
        '/dev/ptmx',
        '/dev/pts/ptmx',
        '/dev/random',
        '/dev/rfkill',
        '/dev/shm/u1000-ValveIPCSharedObj-Steam',
        '/dev/snd/seq',
        '/dev/udmabuf',
        '/dev/urandom',
        '/dev/vga_arbiter',
        '/dev/video10' -- workaround for poor regex management (ffmpeg)
      )
      AND pof.path NOT LIKE '/dev/hidraw%'
      AND pof.path NOT LIKE '/dev/pts/%'
      AND pof.path NOT LIKE '/dev/shm/.com.google.Chrome.%'
      AND pof.path NOT LIKE '/dev/shm/.org.chromium.Chromium.%'
      AND pof.path NOT LIKE '/dev/snd/%'
      AND pof.path NOT LIKE '/dev/tty%'
      -- Zoom
      AND pof.path NOT LIKE '/dev/shm/aomshm.%'
      AND pof.path NOT LIKE '/dev/shm/authentik_%'
      AND NOT dir_exception IN (
        '/dev,qemu-nbd',
        '/dev/bus/usb,pcscd',
        '/dev/input,acpid',
        '/dev/input,gnome-shell',
        '/dev/input,Hyprland',
        '/dev/input,keyd',
        '/dev/input,kwin_wayland',
        '/dev/input,sway',
        '/dev/input,systemd',
        '/dev/input,systemd-logind',
        '/dev/input,thermald',
        '/dev/input,touchegg',
        '/dev/input,upowerd',
        '/dev/input,Xorg',
        '/dev/net,.tailscaled-wrapped',
        '/dev/net,tailscaled',
        '/dev/net/tun,qemu-system-x86_64',
        '/dev/shm,1password',
        '/dev/shm,Brackets',
        '/dev/shm,chrome',
        '/dev/shm,code',
        '/dev/shm,electron',
        '/dev/shm,firefox',
        '/dev/input/event,firefox',
        '/dev/shm,gameoverlayui',
        '/dev/shm,gopls',
        '/dev/shm,hl2_linux',
        '/dev/shm,Hyprland',
        '/dev/shm,java',
        '/dev/shm,jcef_helper',
        '/dev/shm,Melvor Idle',
        '/dev/shm,msedge',
        '/dev/shm,osqueryd',
        '/dev/shm,reaper',
        '/dev/shm,slack',
        '/dev/shm,spotify',
        '/dev/shm,steam',
        '/dev/shm,steamwebhelper',
        '/dev/shm,Tabletop Simulator.x86_64',
        '/dev/shm,wine64-preloader',
        '/dev/shm,winedevice.exe',
        '/dev/shm,xdg-desktop-portal-hyprland',
        '/dev/snd,.pulseaudio-wrapped',
        '/dev/snd,alsactl',
        '/dev/snd,pipewire',
        '/dev/snd,pulseaudio',
        '/dev/snd,wireplumber',
        '/dev/usb,apcupsd',
        '/dev/usb,upowerd'
      )
      AND NOT path_exception IN (
        '/dev/autofs,systemd',
        '/dev/console,agetty',
        '/dev/console,busybox',
        '/dev/cpu/0/msr,nvidia-powerd',
        '/dev/drm_dp_aux,fwupd',
        '/dev/fb,Xorg',
        '/dev/hidraw,chrome',
        '/dev/hvc,agetty',
        '/dev/hwrng,rngd',
        '/dev/input/event,thermald',
        '/dev/input/event,touchegg',
        '/dev/input/event,Xorg',
        '/dev/input/event,sway',
        '/dev/kmsg,bpfilter_umh',
        '/dev/kmsg,dmesg',
        '/dev/kmsg,k3s',
        '/dev/kmsg,_k3s-inner',
        '/dev/kmsg,kubelet',
        '/dev/kmsg,systemd',
        '/dev/kmsg,systemd-coredump',
        '/dev/kmsg,systemd-journald',
        '/dev/kvm,qemu-system-x86_64',
        '/dev/mapper/control,dockerd',
        '/dev/mapper/control,dmeventd',
        '/dev/mapper/control,gpartedbin',
        '/dev/mapper/control,multipathd',
        '/dev/mcelog,mcelog',
        '/dev/media0,pipewire',
        '/dev/media0,wireplumber',
        '/dev/media,pipewire',
        '/dev/media,wireplumber',
        '/dev/nbd,qemu-nbd',
        '/dev/net/tun,openvpn',
        '/dev/net/tun,pasta.avx2',
        '/dev/net/tun,qemu-system-x86_64',
        '/dev/net/tun,slirp4netns',
        '/dev/pts,incusd',
        '/dev/sda,ntfs-3g',
        '/dev/shm/envoy_shared_memory_1,envoy',
        '/dev/tpmrm,launcher',
        '/dev/tty,agetty',
        '/dev/tty,gdm-wayland-session',
        '/dev/tty,gdm-x-session',
        '/dev/tty,systemd-logind',
        '/dev/tty,Xorg',
        '/dev/udmabuf,gnome-shell-portal-helper',
        '/dev/udmabuf,nautilus',
        '/dev/udmabuf,xdg-desktop-portal-gnome',
        '/dev/uhid,bluetoothd',
        '/dev/uinput,bluetoothd',
        '/dev/uinput,keyd',
        '/dev/uinput,ydotoold',
        '/dev/usb/hiddev,apcupsd',
        '/dev/usb/hiddev,upowerd',
        '/dev/vhost-net,qemu-system-x86_64',
        '/dev/vhost-vsock,qemu-system-x86_64',
        '/dev/video0,chrome',
        '/dev/video,brave',
        '/dev/video,cheese',
        '/dev/video,chrome',
        '/dev/video,dash',
        '/dev/video,ffmpeg',
        '/dev/video,firefox',
        '/dev/video,firefox-bin',
        '/dev/video,guvcview',
        '/dev/video,msedge',
        '/dev/video,obs',
        '/dev/video,obs-ffmpeg-mux',
        '/dev/video,pipewire',
        '/dev/video,signal-desktop',
        '/dev/video,slack',
        '/dev/video,v4l2-relayd',
        '/dev/video,vlc',
        '/dev/video,wireplumber',
        '/dev/video,zoom',
        '/dev/video,zoom.real',
        '/dev/wwan0mbim,mbim-proxy',
        '/dev/zfs,',
        '/dev/zfs,zed',
        '/dev/zfs,zfs',
        '/dev/zfs,zpool'
      )
      AND path_exception NOT LIKE '/dev/dm-%,qemu-system-%'
      AND path_exception NOT LIKE '/dev/bus/usb/%,scdaemon'
      AND path_exception NOT LIKE '/dev/cpu_dma_latency,python%'
      AND path_exception NOT LIKE '/dev/shm/%'
      AND path_exception NOT LIKE '/dev/video%,chrome'
      AND path_exception NOT LIKE '/dev/video%,chromium'
      AND NOT (
        pof.path = "/dev/uinput"
        AND p0.name LIKE "solaar%"
        AND p0.path LIKE '/usr/bin/python%'
      )
      AND NOT (
        pof.path LIKE "/dev/input/event%"
        AND p0.name IN ("openrazer-daemo", "solaar")
      )
      AND NOT (
        pof.path LIKE '/dev/bus/usb/%'
        AND p0.name IN (
          'adb',
          'fprintd',
          'fwupd',
          'gphoto2',
          'gvfs-gphoto2-vo',
          'gvfs-gphoto2-volume-monitor',
          'gvfsd-gphoto2',
          'gvfsd-mtp',
          'pcscd',
          'streamdeck',
          'usbmuxd'
        )
      )
    GROUP BY
      pof.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/credentials] Unexpected Dev Opener Macos"
  description: Detects unexpected programs opening files in /dev on Linux
  query: |
    SELECT
      pof.pid,
      pof.path AS device,
      s.authority,
      s.identifier,
      CONCAT (
        IIF(
          REGEX_MATCH (pof.path, '(/dev/.*)\d+$', 1) != '',
          REGEX_MATCH (pof.path, '(/dev/.*)\d+', 1),
          pof.path
        ),
        ',',
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        ),
        ',',
        s.authority,
        ',',
        s.identifier
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_files pof
      LEFT JOIN processes p0 ON pof.pid = p0.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pof.path LIKE '/dev/%'
      AND pof.path NOT IN (
        '/dev/null',
        '/dev/ptmx',
        '/dev/random',
        '/dev/tty',
        '/dev/urandom',
        '/dev/zero'
      )
      AND pof.path NOT LIKE '/dev/ttys%'
      -- Assume SIP
      AND p0.path NOT LIKE '/System/%'
      AND p0.path NOT LIKE '/usr/libexec/%'
      AND p0.path NOT LIKE '/usr/sbin/%'
      AND exception_key NOT IN (
        '/dev/afsc_type,revisiond,Software Signing,com.apple.revisiond',
        '/dev/auditpipe,ir_agent,Developer ID Application: Rapid7 LLC (UL6CGN7MAL),ir_agent',
        '/dev/auditpipe,osqueryd,,',
        '/dev/auditpipe,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF),io.osquery.agent',
        '/dev/auditpipe,osqueryd,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF),osqueryd',
        '/dev/auditsessions,authd,Software Signing,com.apple.authd',
        '/dev/auditsessions,GSSCred,Software Signing,com.apple.GSSCred',
        '/dev/auditsessions,securityd,Software Signing,com.apple.securityd',
        '/dev/auditsessions,TouchBarServer,Software Signing,com.apple.touchbarserver',
        '/dev/autofs,automountd,Software Signing,com.apple.automountd',
        '/dev/bpf,agentbeat,Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z),agentbeat',
        '/dev/bpf,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/bpf,BDLDaemon,Developer ID Application: Bitdefender SRL (GUNFMW623Y),com.bitdefender.epsecurity.BDLDaemonApp',
        '/dev/bpf,com.bjango.istatmenus.daemon,Developer ID Application: Bjango Pty Ltd (Y93TK974AT),com.bjango.istatmenus',
        '/dev/bpf,core,Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T),com.topaz.warsaw.core',
        '/dev/bpf,MHLinkServer,Developer ID Application: Metric Halo Distribution, Inc. (X7EY8SFM86),com.mhlabs.mhlink.server',
        '/dev/bpf,packetbeat,Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z),packetbeat',
        '/dev/bus/usb/001/01,scdaemon',
        '/dev/console,Arc,Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.Browser',
        '/dev/console,dbeaver,Developer ID Application: DBeaver Corporation (42B6MDKMW8),org.jkiss.dbeaver.core.product',
        '/dev/console,kernelmanagerd,Software Signing,com.apple.kernelmanagerd',
        '/dev/console,launchd,Software Signing,com.apple.xpc.launchd',
        '/dev/console,launchd_sim,Software Signing,com.apple.xpc.launchd',
        '/dev/cu.BLTH,bluetoothd,Software Signing,com.apple.bluetoothd',
        '/dev/cu.debug-console,ZwiftAppSilicon,Developer ID Application: Zwift, Inc (C2GM8Y9VFM),ZwiftAppSilicon',
        '/dev/cu.usbmodem10,serial-monitor,,a.out',
        '/dev/io,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io8log,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8log,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io8log,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io8log,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io8log,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io8log,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/io8logmt,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8logtemp,airportd,Software Signing,com.apple.airport.airportd',
        '/dev/io8logtemp,ControlCenter,Software Signing,com.apple.controlcenter',
        '/dev/io8logtemp,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/io8logtemp,symptomsd,Software Signing,com.apple.symptomsd',
        '/dev/io8logtemp,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',
        '/dev/io8logtemp,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',
        '/dev/kbfuse,kbfs,Developer ID Application: Keybase, Inc. (99229SGT5K),kbfs',
        '/dev/kbfuse,keybase-redirector,Developer ID Application: Keybase, Inc. (99229SGT5K),keybase-redirector',
        '/dev/klog,syslogd,Software Signing,com.apple.syslogd',
        '/dev/macfuse,gcsfuse,,a.out',
        '/dev/macfuse,rclone,,a.out',
        '/dev/oslog,logd,Software Signing,com.apple.logd',
        '/dev/pf,CloudflareWARP,Developer ID Application: Cloudflare Inc. (68WVV388M8),CloudflareWARP',
        '/dev/pf,mullvad-daemon,Developer ID Application: Mullvad VPN AB (CKG9MXH72F),mullvad-daemon',
        '/dev/rdisk,etcher-util,Developer ID Application: Balena Ltd (66H43P8FRG),etcher-util',
        '/dev/shm,python3',
        '/dev/tty.usbmodem21430,Bazecor Helper (Renderer),,',
        '/dev/xcpm,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',
        '/dev/xcpm,systemstats,Software Signing,com.apple.systemstats',
        '/dev/xcpm,thermald,Software Signing,com.apple.thermald',
        '/dev/zero,bash,Software Signing,com.apple.bash'
      )
      -- Keyboard flashing
      AND NOT exception_key LIKE '/dev/cu.usbmodem%,Google Chrome,Developer ID Application: Google LLC (EQHXZ8M8AV),com.google.Chrome'
      AND NOT exception_key LIKE '/dev/tty.usbserial-%,java,,net.java.openjdk.java'
      AND NOT exception_key LIKE '/dev/cu.%,screen,Software Signing,com.apple.screen'
    GROUP BY
      pof.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/credentials] Macos Keyboard Sniffer"
  description: Find programs that are sniffing keyboard events on macOS
  query: |
    SELECT
      et.enabled,
      et.process_being_tapped,
      et.tapping_process,
      CONCAT (
        REPLACE(
          p0.path,
          RTRIM(p0.path, REPLACE(p0.path, '/', '')),
          ''
        ),
        ',',
        s.identifier,
        ',',
        s.authority
      ) AS exception_key,
      ---
      s.authority,
      s.identifier,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      event_taps et
      LEFT JOIN processes p0 ON et.tapping_process = p0.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      et.event_tapped IN ('EventKeyDown', 'EventKeyUp')
      AND et.enabled != 0
      AND s.authority != 'Software Signing' -- Popular programs that sniff keyboard events, but do not appear to be malware.
      AND NOT exception_key IN (
        'Alfred,com.runningwithcrayons.Alfred,Developer ID Application: Running with Crayons Ltd (XZZXE9SED4)',
        'BetterDisplay,pro.betterdisplay.BetterDisplay,Developer ID Application: Istvan Toth (299YSU96J7)',
        'MonitorControl,app.monitorcontrol.MonitorControl,Developer ID Application: Istvan Toth (299YSU96J7)',
        'BetterTouchTool,com.hegenberg.BetterTouchTool,Developer ID Application: folivora.AI GmbH (DAFVSXZ82P)',
        'CheatSheet,com.mediaatelier.CheatSheet,Developer ID Application: Stefan Fuerst (2295B9BX7F)',
        'Contexts,com.contextsformac.Contexts,Developer ID Application: Usman Khalid (RZ7E748ZSC)',
        'DDPM,Qisda.DDPM,Developer ID Application: Yufu Fan (S3YBM9ALKM)',
        'deskflow-client,deskflow-client,',
        'deskflow-server,deskflow-server,',
        'Display Pilot 2,com.benq.DisplayPilot2,Developer ID Application: BenQ Corporation (3YMZ8E4Y5W)',
        'Grammarly Desktop,com.grammarly.ProjectLlama,Developer ID Application: Grammarly, Inc (W8F64X92K3)',
        'HueSync,com.lighting.huesync,Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',
        'Hyperkey,com.knollsoft.Hyperkey,Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'iTerm2,com.googlecode.iterm2,Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'lghub_agent,com.logi.ghub.agent,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'LinearMouse,com.lujjjh.LinearMouse,Developer ID Application: Jiahao Lu (C5686NKYJ7)',
        'logioptionsplus_agent,com.logi.cp-dev-mgr,Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Lunar,fyi.lunar.Lunar,Developer ID Application: Alin Panaitiu (RDDXV84A73)',
        'Magnet,com.crowdcafe.windowmagnet,Apple Mac OS Application Signing',
        'MonitorControl,me.guillaumeb.MonitorControl,Developer ID Application: Joni Van Roost (CYC8C8R4K9)',
        'NotesCmdr,app.smallest.NotesCmdr,Developer ID Application: Anders Rex (UL38YXE4DL)',
        'osqueryd,io.osquery.agent,Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'polyrecorder,polyrecorder,Developer ID Application: Adam Pietrasiak (SXF593CX2N)',
        'Rocket,net.matthewpalmer.Rocket,Developer ID Application: Matthew Palmer (Z4JV2M65MH)',
        'skhd,skhd,',
        'Superkey,com.knollsoft.Superkey,Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'synergy-core,synergy-core,Developer ID Application: Symless Ltd (4HX897Y6GJ)',
        'TextExpander,com.smileonmymac.textexpander,Developer ID Application: SmileOnMyMac, LLC (7PKJ6G4DXL)',
        'Raycast,com.raycast.macos,Developer ID Application: Raycast Technologies Inc (SY64MV22J9)',
        'Wispr Flow,com.electron.wispr-flow.accessibility-mac-app,Developer ID Application: Wispr AI INC (C9VQZ78H85)'
      )
    GROUP BY
      p0.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/credentials] Unexpected Sensitive File Access Linux"
  description: Unexpected programs accessing sensitive data stores (state-based)
  query: |
    SELECT
      pof.pid,
      pof.fd,
      pof.path,
      f.uid AS file_uid,
      p.cwd AS cwd,
      p.euid,
      p.start_time,
      p.uid AS process_uid,
      p.name AS program_name,
      p.cmdline AS cmdline,
      pp.name AS parent_name,
      pp.cwd AS parent_cwd,
      pp.path AS parent_path,
      pf.filename AS program_base,
      hash.sha256,
      REPLACE(f.directory, u.directory, '~') AS dir,
      CONCAT (
        pf.filename,
        ',',
        p.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(f.directory, u.directory, '~')
        )
      ) AS exception_key
    FROM
      -- Starting with processes is just slightly faster than starting with pof
      processes p
      LEFT JOIN process_open_files pof ON p.pid = pof.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON pof.path = f.path
      LEFT JOIN file pf ON p.path = pf.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash hp ON pp.path = hp.path
    WHERE
      -- minor optimization: filtering out low parents saves us another 5% of runtime
      p.parent > 2
      -- Large files are probably not secrets
      AND pf.filename != ''
      AND f.size < 1000000
      AND (
        pof.path IN ('/var/run/docker.sock')
        OR pof.path LIKE '/home/%/.aws%'
        OR pof.path LIKE '/home/%/.bash_history'
        OR pof.path LIKE '/home/%/.cache/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/gcloud/%'
        OR pof.path LIKE '/home/%/.config/google-chrome/%'
        OR pof.path LIKE '/home/%/.config/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/Slack/%'
        OR pof.path LIKE '/home/%/.mozilla/firefox/%'
        OR pof.path LIKE '/home/%/.ssh/%'
        OR pof.path LIKE '/root/.bash_history'
        OR pof.path LIKE '/root/.ssh/%'
      )
      AND NOT p.cmdline LIKE 'less %id_rsa.pub'
      AND NOT (
        file_uid == process_uid
        AND exception_key IN (
          'aws,aws,~/.aws',
          'chrome_crashpad_handler,chrome_crashpad,',
          'chrome_crashpad_handler,chrome_crashpad,~/.config/google-chrome',
          'chrome,chrome,~/.config/google-chrome',
          'firefox-bin,file:// Content,~/.mozilla/firefox',
          'firefox-bin,firefox-bin,~/.cache/mozilla',
          'firefox-bin,firefox-bin,~/.mozilla/firefox',
          'firefox-bin,Isolated Servic,~/.mozilla/firefox',
          'firefox-bin,Isolated Web Co,~/.mozilla/firefox',
          'firefox-bin,Privileged Cont,~/.mozilla/firefox',
          'firefox-bin,WebExtensions,~/.mozilla/firefox',
          'firefox,.firefox-wrappe,~/.cache/mozilla',
          'firefox,.firefox-wrappe,~/.mozilla/firefox',
          'firefox,file:// Content,~/.cache/mozilla',
          'firefox,file:// Content,~/.mozilla/firefox',
          'firefox,file:// Content,~/snap/firefox',
          'firefox,firefox,~/.cache/mozilla',
          'firefox,firefox,~/.mozilla/firefox',
          'firefox,firefox,~/snap/firefox',
          'firefox,Isolated Servic,~/.cache/mozilla',
          'firefox,Isolated Servic,~/.mozilla/firefox',
          'firefox,Isolated Servic,~/snap/firefox',
          'firefox,Isolated Web Co,~/.cache/mozilla',
          'firefox,Isolated Web Co,~/.mozilla/firefox',
          'firefox,Isolated Web Co,~/snap/firefox',
          'firefox,Privileged Cont,~/.cache/mozilla',
          'firefox,Privileged Cont,~/.mozilla/firefox',
          'firefox,Privileged Cont,~/snap/firefox',
          'firefox,Privileged Mozi,~/.mozilla/firefox',
          'firefox,Sandbox Forked,~/snap/firefox',
          'firefox,Web Content,~/.cache/mozilla',
          'firefox,Web Content,~/.mozilla/firefox',
          'firefox,Web Content,~/snap/firefox',
          'firefox,WebExtensions,~/.cache/mozilla',
          'firefox,WebExtensions,~/.mozilla/firefox',
          'firefox,WebExtensions,~/snap/firefox',
          'plugin-container,MainThread,~/.mozilla/firefox',
          'plugin-container,MainThread,~/snap/firefox',
          'python3,python3,~/.config/gcloud',
          'python3.10,python3,~/.config/gcloud',
          'python3.11,python3,~/.config/gcloud',
          'python3.12,python3,~/.config/gcloud',
          'slack,slack,~/.config/Slack',
          'slack,slack,~/snap/slack',
          'soffice.bin,soffice.bin,~/.mozilla/firefox',
          'updater,updater,~/.cache/mozilla',
          'updater,updater,~/.mozilla/firefox',
          'vim,vim,~/.aws',
          'vim.basic,vi,~/.ssh'
        )
      )
    GROUP BY
      pof.pid,
      pof.path
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/credentials] Unexpected Sensitive File Access Macos"
  description: Unexpected programs accessing sensitive data stores (state-based)
  query: |
    SELECT
      pof.pid,
      pof.fd,
      pof.path,
      f.uid AS file_uid,
      p.cwd AS cwd,
      p.euid,
      p.uid AS process_uid,
      p.name AS program_name,
      p.cmdline AS cmdline,
      pp.name AS parent_name,
      pp.cwd AS parent_cwd,
      pp.path AS parent_path,
      pf.filename AS program_base,
      hash.sha256,
      REPLACE(f.directory, u.directory, '~') AS dir,
      CONCAT (
        pf.filename,
        ',',
        p.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(f.directory, u.directory, '~')
        )
      ) AS exception_key
    FROM
      -- Starting with processes is just slightly faster than starting with pof
      processes p
      LEFT JOIN process_open_files pof ON p.pid = pof.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN file f ON pof.path = f.path
      LEFT JOIN file pf ON p.path = pf.path
      LEFT JOIN users u ON p.uid = u.uid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash hp ON pp.path = hp.path
    WHERE
      -- minor optimization: filtering out low parents saves us another 5% of runtime
      p.parent > 2
      -- Large files are probably not secrets
      AND pf.filename != ''
      AND f.size < 1000000
      AND (
        pof.path IN ('/var/run/docker.sock')
        OR pof.path LIKE '/home/%/.aws%'
        OR pof.path LIKE '/home/%/.bash_history'
        OR pof.path LIKE '/home/%/.cache/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/gcloud/%'
        OR pof.path LIKE '/home/%/.config/google-chrome/%'
        OR pof.path LIKE '/home/%/.config/mozilla/firefox%'
        OR pof.path LIKE '/home/%/.config/Slack/%'
        OR pof.path LIKE '/home/%/.mozilla/firefox/%'
        OR pof.path LIKE '/home/%/.ssh/%'
        OR pof.path LIKE '/root/.bash_history'
        OR pof.path LIKE '/root/.ssh/%'
      )
      AND NOT (
        file_uid == process_uid
        AND exception_key IN (
          'aws,aws,~/.aws',
          'chrome_crashpad_handler,chrome_crashpad,',
          'chrome_crashpad_handler,chrome_crashpad,~/.config/google-chrome',
          'chrome,chrome,~/.config/google-chrome',
          'firefox,.firefox-wrappe,~/.cache/mozilla',
          'firefox,.firefox-wrappe,~/.mozilla/firefox',
          'firefox,file:// Content,~/.cache/mozilla',
          'firefox,file:// Content,~/.mozilla/firefox',
          'firefox,file:// Content,~/snap/firefox',
          'firefox,firefox,~/.cache/mozilla',
          'firefox,firefox,~/.mozilla/firefox',
          'firefox,firefox,~/snap/firefox',
          'firefox,Isolated Servic,~/.cache/mozilla',
          'firefox,Isolated Servic,~/.mozilla/firefox',
          'firefox,Isolated Servic,~/snap/firefox',
          'firefox,Isolated Web Co,~/.cache/mozilla',
          'firefox,Isolated Web Co,~/.mozilla/firefox',
          'firefox,Isolated Web Co,~/snap/firefox',
          'firefox,Privileged Cont,~/.cache/mozilla',
          'firefox,Privileged Cont,~/.mozilla/firefox',
          'firefox,Privileged Cont,~/snap/firefox',
          'firefox,Web Content,~/.cache/mozilla',
          'firefox,Web Content,~/.mozilla/firefox',
          'firefox,Web Content,~/snap/firefox',
          'firefox,WebExtensions,~/.cache/mozilla',
          'firefox,WebExtensions,~/.mozilla/firefox',
          'firefox,WebExtensions,~/snap/firefox',
          'plugin-container,MainThread,~/.mozilla/firefox',
          'plugin-container,MainThread,~/snap/firefox',
          'python3,python3,~/.config/gcloud',
          'python3.10,python3,~/.config/gcloud',
          'python3.11,python3,~/.config/gcloud',
          'python3.12,python3,~/.config/gcloud',
          'slack,slack,~/.config/Slack',
          'slack,slack,~/snap/slack',
          'soffice.bin,soffice.bin,~/.mozilla/firefox',
          'vim,vim,~/.aws'
        )
      )
    GROUP BY
      pof.pid,
      pof.path
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/credentials] Yara Mounted Stealer"
  description: Look for sketchy mounted disk images, inspired by Shlayer
  query: |
    SELECT
      RTRIM(file.path, '/') AS f,
      file.bsd_flags AS f_flags,
      file.gid AS f_gid,
      file.mode AS f_mode,
      file.size AS f_size,
      file.type AS f_type,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS f_ext,
      file.uid AS f_uid,
      hash.sha256 AS f_sha256,
      magic.data AS f_data,
      mdfind.path AS probable_source,
      mdhash.sha256 AS probable_source_sha256,
      ea.value AS probable_url,
      REGEX_MATCH (file.path, '/Volumes/(.*?)/', 1) AS vol_name,
      signature.authority AS s_auth,
      signature.identifier AS s_id,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN mdfind ON mdfind.query = "kMDItemFSName == '*" || REGEX_MATCH (file.path, '/Volumes/(\w+)', 1) || "*.dmg'"
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = 'where_from'
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN hash mdhash ON mdfind.path = mdhash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      file.path IN (
        SELECT
          file.path
        FROM
          block_devices
          JOIN mounts ON mounts.device = block_devices.name
          JOIN file ON file.directory = mounts.path
          OR file.directory LIKE mounts.path || "/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%.app/Contents/Resources/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Library/LaunchServices"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Resources/"
        WHERE
          model = 'Disk Image'
          AND parent != ""
          AND mounts.path LIKE "/Volumes/%"
          -- osquery will traverse symlinks, this prevents following symlinks to /Applications (poorly)
          AND file.path NOT LIKE "/Volumes/%/Applications/%"
          AND (
            file.mode LIKE "%7%"
            OR file.mode LIKE "%5%"
            OR file.mode LIKE "%1%"
          )
          AND file.type = "regular"
      )
      AND magic.data LIKE "%Executable%"
      AND yara.sigrule = '
        rule stealer {
        strings:
            $brave_software = "BraveSoftware" ascii
            $cookies_sqlite = "cookies.sqlite" ascii
            $data_stealers = "data_stealers" ascii
            $find_generic_password = "find-generic-password" ascii
            $library_keychains = "/Library/Keychains" ascii
            $moz_cookies = "moz_cookies" ascii
            $operagx = "OperaGX" ascii
            $osascript = "osascript" ascii
    
        condition:
            2 of them
    }'
      AND yara.count > 0
      AND NOT (
        vol_name = "Docker"
        AND s_auth = "Developer ID Application: Docker Inc (9BNSXJN65R)"
      )
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/discovery] Unexpected Netutil Calls Linux"
  description: Suspicious parenting of network utilities (event-based)
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      uptime.total_seconds > 30
      AND pe.path IN (
        '/bin/ifconfig',
        '/bin/ip',
        '/bin/iptables',
        '/bin/nft',
        '/bin/ufw',
        '/sbin/ifconfig',
        '/sbin/ip',
        '/sbin/iptables',
        '/sbin/nft',
        '/sbin/ufw',
        '/usr/bin/ifconfig',
        '/usr/bin/ip',
        '/usr/bin/iptables',
        '/usr/bin/nft',
        '/usr/bin/ufw'
      )
      AND pe.cmdline != ''
      AND pe.time > (strftime('%s', 'now') -300)
      AND NOT (
        pe.euid > 500
        AND p1_name IN ('bash', 'dash', 'fish', 'nu', 'sh', 'zsh')
        AND p2_name IN (
          'alacritty',
          'gnome-terminal-',
          'gnome-terminal-server',
          'kitty',
          'login',
          'newgrp',
          'roxterm',
          'screen',
          'tmux:server',
          'tmux',
          'wezterm-gui',
          'zsh'
        )
      )
      AND NOT p1_cmd IN (
        '/bin/sh /etc/network/if-up.d/avahi-autoipd',
        '/opt/incus/bin/incusd --group incus-admin --logfile /var/log/incus/incusd.log',
        '/usr/bin/libvirtd --timeout 120'
      )
      AND NOT p1_path IN (
        '/opt/incus/bin/incusd',
        '/usr/libexec/gvfsd',
        '/usr/libexec/incus/incusd'
      )
      AND NOT p0_cmd LIKE '%ip link set lo netns -1'
      AND NOT p0_cmd LIKE '%ip route add % dev % metric 1000 scope link'
    GROUP BY
      pe.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/discovery] Unexpected Netutil Calls Macos"
  description: Suspicious parenting of fetch tools (event-based)
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.path IN (
        '/sbin/ifconfig',
        '/sbin/pfctl',
        '/usr/bin/nscurl',
        '/usr/libexec/ApplicationFirewall/socketfilterfw',
        '/usr/sbin/netstat'
      )
      AND uptime.total_seconds > 30
      AND pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND pe.status == 0
      AND NOT (
        pe.euid > 500
        AND p1_name IN ('bash', 'dash', 'fish', 'sh', 'zsh')
        AND p2_name IN (
          'kitty',
          'login',
          'ShellLauncher',
          'sudo',
          'tmux:server',
          'tmux',
          'zsh'
        )
      )
      AND NOT exception_key IN (
        'ifconfig,0,cloud-provider-kind,sudo',
        'ifconfig,0,pia-daemon,launchd',
        'ifconfig,0,pia-openvpn,pia-daemon',
        'ifconfig,500,dotnet,dotnet',
        'ifconfig,500,dotnet,zsh',
        'ifconfig,500,Python,Code Helper (Plugin)',
        'ifconfig,500,zsh,stable',
        'netstat,0,io.tailscale.ipn.macsys.network-extension,launchd',
        'netstat,0,metricbeat,elastic-agent',
        'netstat,0,pia-daemon,launchd',
        'netstat,500,AccountSubscriber,launchd',
        'netstat,500,coresymbolicationd,launchd',
        'netstat,500,IPNExtension,launchd',
        'pfctl,0,bash,pia-daemon',
        'pfctl,0,pia-daemon,launchd',
        'socketfilterfw,0,launcher,launchd'
      )
      AND p1_cmd NOT IN ('/bin/sh /etc/periodic/daily/420.status-network')
      AND p1_authority != 'Software Signing'
    GROUP BY
      pe.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/discovery] Unexpected Bpf User"
  description: Find root-run processes which link against libpf
  query: |
    SELECT
      pmm.pid,
      pmm.path AS lib_path,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256
      -- Using processes is much faster than process_memory_map
    FROM
      processes p
      LEFT JOIN process_memory_map pmm ON p.pid = pmm.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.euid = 0
      AND (
        lib_path LIKE '%:bpf%'
        OR lib_path LIKE '%libbpf%'
      )
      AND p.path NOT IN (
        '/opt/Elastic/Endpoint/elastic-endpoint',
        '/usr/bin/qemu-system-x86_64',
        '/usr/lib/systemd/systemd-nsresourced',
        '/usr/lib/systemd/systemd',
        '/var/opt/Elastic/Endpoint/elastic-endpoint'
      )
      AND p.cmdline != '/usr/bin/python3 /usr/sbin/execsnoop-bpfcc'
      AND p.path NOT LIKE '/nix/store/%/lib/systemd/systemd'
      AND p.name != "xcover"
    GROUP BY
      pmm.pid
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/discovery] Unexpected Pcap User Linux"
  description: Find root-run processes which link against libpcap
  query: |
    SELECT
      pmm.pid,
      p.uid,
      p.gid,
      pmm.path AS lib_path,
      p.path AS child_path,
      p.name AS child_name,
      p.cmdline AS child_cmd,
      p.cwd AS child_cwd,
      h.sha256 AS child_sha256,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      ph.sha256 AS parent_sha256
      -- Using processes is much faster than process_memory_map
    FROM
      processes p
      LEFT JOIN process_memory_map pmm ON p.pid = pmm.pid
      LEFT JOIN hash h ON p.path = h.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash AS ph ON pp.path = ph.path
    WHERE
      p.euid = 0
      AND pmm.path LIKE '%libpcap%'
      AND child_path NOT LIKE '/nix/store/%-systemd-%/bin/udevadm'
      AND child_path NOT LIKE '/nix/store/%-systemd-%/lib/systemd/systemd%'
      AND child_path NOT LIKE '/nix/store/%/bin/nix'
      AND child_path NOT LIKE '/System/Library/%'
      AND child_path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND child_path NOT IN (
        '/run/current-system/systemd/lib/systemd/systemd',
        '/usr/bin/libvirtd',
        '/usr/sbin/libvirtd',
        '/usr/bin/tcpdump',
        '/usr/libexec/UserEventAgent',
        '/opt/datadog-agent/bin/agent/agent',
        '/opt/datadog-agent/embedded/bin/system-probe',
        '/usr/sbin/cupsd',
        '/usr/sbin/systemstats'
      )
      AND child_cmd NOT IN (
        '/nix/var/nix/profiles/default/bin/nix-daemon',
        '/run/current-system/systemd/lib/systemd/systemd'
      )
      AND child_cmd NOT LIKE '/usr/bin/python3 -s%/usr/sbin/firewalld%'
    GROUP BY
      p.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/discovery] Unexpected Pcap User Macos"
  description: Find root-run processes which link against libpcap
  query: |
    SELECT
      s.authority,
      s.identifier,
      pmm.path,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid = 0
          AND path NOT LIKE '/Library/Apple/%'
          AND path NOT LIKE '/nix/store/%/bin/nix'
          AND path NOT LIKE '/opt/homebrew/Cellar/btop/%/bin/btop'
          AND path NOT LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
          AND path NOT LIKE '/opt/homebrew/Cellar/vim/%/bin/vim'
          AND path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          AND path NOT LIKE '/sbin/%'
          AND path NOT LIKE '/System/%'
          AND path NOT LIKE '/usr/bin/%'
          AND path NOT LIKE '/usr/libexec/%'
          AND path NOT LIKE '/usr/local/Cellar/htop/%/bin/htop'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
          AND path NOT LIKE '/usr/sbin/%'
          AND path NOT IN (
            '/opt/socket_vmnet/bin/socket_vmnet',
            '/usr/local/sbin/velociraptor'
          )
      )
      AND pmm.path LIKE '%libpcap%'
      -- These are all protected directories
      AND NOT s.authority IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Software Signing'
      )
      AND NOT p0.path LIKE '/opt/homebrew/Cellar/kubernetes-cli/%/bin/kubectl'
    GROUP BY
      p0.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Touched Executable Linux"
  description: "Programs which were spawned by an executable containing a matching ctime & mtime, which"
  query: |
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cgroup_path,
      p.cwd,
      p.euid,
      p.parent,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      f.ctime = f.mtime
      AND (strftime('%s', 'now') - p.start_time) > 25000
      AND p.path != '/'
      AND f.path NOT IN (
        '/opt/Elastic/Endpoint/elastic-endpoint',
        '/opt/google/endpoint-verification/bin/apihelper',
        '/opt/resolve/bin/resolve',
        '/usr/bin/ld.bfd',
        '/usr/bin/ld',
        '/usr/bin/ghostty',
        '/usr/bin/melange',
        '/var/opt/velociraptor/bin/velociraptor'
      )
      AND f.path NOT LIKE '/home/%'
      AND f.path NOT LIKE '/opt/Elastic/Agent/data/elastic-agent%'
      AND f.path NOT LIKE '/opt/rapid7/ir_agent/%'
      AND f.path NOT LIKE '/snap/%'
      AND f.path NOT LIKE '/tmp/%/.terraform/providers/%'
      AND f.path NOT LIKE '/tmp/%go-build%/exe/%'
      AND f.path NOT LIKE '/tmp/cargo-install%/%'
      AND f.path NOT LIKE '/tmp/go-build%'
      AND f.path NOT LIKE '/usr/local/aws-cli/%/dist/aws'
      AND f.path NOT LIKE '/usr/local/bin/%'
      AND f.path NOT LIKE '/usr/local/kolide-k2/bin/%-updates/%'
      AND f.path NOT LIKe '/var/home/%'
      AND f.path NOT LIKE '/var/home/linuxbrew/.linuxbrew/%'
      AND f.path NOT LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%/bin/%'
      AND f.path NOT LIKE '/var/kolide-k2/k2device.kolide.com/updates/%'
      AND f.path NOT LIKE '/var/opt/Elastic/Endpoint/elastic-endpoint'
      AND f.path NOT LIKE '%/go/bin/%'
      AND f.path NOT LIKE '%/osqueryi'
      AND p.name NOT LIKE 'osqtool%'
    GROUP by
      p.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Empty Root Environ Linux"
  description: Find programs which spawn root children without propagating environment variables
  query: |
    SELECT
      COUNT(key) AS count,
      p.pid,
      p.path,
      p.name,
      p.on_disk,
      p.cgroup_path,
      hash.sha256,
      p.parent,
      p.cmdline,
      p.cwd,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd
      -- Processes is 20X faster to scan than process_envs
    FROM
      processes p
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN process_envs pe ON p.pid = pe.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE
      p.euid = 0
      -- This time should match the interval
      AND p.start_time > (strftime('%s', 'now') - 601)
      -- Filter out transient processes that may not have an envs entry by the time we poll for it
      AND p.start_time < (strftime('%s', 'now') - 1)
      AND p.parent NOT IN (0, 2)
      AND NOT p.path IS NULL
      AND p.name NOT IN (
        '(udev-worker)',
        '1Password-Keyri',
        'abrt-handle-eve',
        'applydeltarpm',
        'bwrap',
        'containerd',
        'crond',
        'cupsd',
        'dbus-daemon',
        'dhcpcd',
        'dnf',
        'elastic-agent',
        'fprintd',
        'gdm-session-wor',
        'gdm-x-session',
        'gpg-agent',
        'ir_agent',
        'launcher',
        'modprobe',
        'nix-daemon',
        'nginx',
        'osqueryd',
        'osqueryi',
        'packagekit-dnf-',
        'realmd',
        'sedispatch',
        'ssh',
        'sshd',
        'sshd-session',
        'sudo',
        'systemd-udevd',
        'systemd-userdbd',
        'systemd-userwor',
        'systemd',
        'Xorg',
        'zfs',
        'zypak-sandbox'
      )
      AND NOT pp.name IN (
        '(sd-exec-strv)',
        '(udev-worker)',
        'crond',
        'dovecot',
        'dpkg',
        'launcher',
        'systemd-nsresou',
        'systemd-udevd',
        'systemd-userdbd',
        'systemd'
      )
      AND NOT (
        p.name LIKE 'systemd-%'
        AND p.parent = 1
      )
      AND NOT p.cgroup_path IN ('/system.slice/cronie.service')
      AND NOT pp.cmdline LIKE 'bwrap %'
      AND NOT p.cmdline LIKE '%--type=zygote%'
      AND NOT p.cmdline LIKE '%--disable-seccomp-filter-sandbox%'
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT pp.path LIKE '/usr/bin/%'
      AND NOT (
        p.name = 'sh'
        AND p.cgroup_path = '/system.slice/znapzend.service'
      )
    GROUP BY
      p.pid
    HAVING
      count = 0;
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Empty Root Environ Macos"
  description: Find programs which spawn root children without propagating environment variables
  query: |
    SELECT
      COUNT(key) AS count,
      p.pid,
      p.path,
      p.name,
      p.euid,
      p.on_disk,
      p.parent,
      p.cmdline,
      p.cwd,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      signature.identifier,
      signature.authority,
      hash.sha256,
      CONCAT (
        MIN(p.euid, 500),
        ',',
        p.name,
        ',',
        signature.identifier,
        ',',
        signature.authority
      ) AS exception_key
    FROM
      processes p
      LEFT JOIN process_envs pe ON p.pid = pe.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      p.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid = 0
          AND start_time > (strftime('%s', 'now') - 601)
          AND start_time < (strftime('%s', 'now') - 1)
          AND path NOT LIKE '/opt/homebrew/Cellar/%'
          AND path NOT LIKE '/System/Library/%'
      )
      AND signature.authority NOT IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mozilla Corporation (43AQ936H96)',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Software Signing'
      )
    GROUP BY
      p.pid
    HAVING
      count == 0;
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Cwd"
  description: Programs running with a hidden current working directory (state-based)
  query: |
    SELECT
      REPLACE(p0.cwd, u.directory, '~') AS dir,
      REGEX_MATCH (
        REPLACE(p0.cwd, u.directory, '~'),
        '([/~].*?/.*?)/',
        1
      ) AS top_dir,
      CONCAT (
        p0.name,
        ',',
        IIF(
          REGEX_MATCH (
            REPLACE(p0.cwd, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ) != '',
          REGEX_MATCH (
            REPLACE(p0.cwd, u.directory, '~'),
            '([/~].*?/.*?/.*?)/',
            1
          ),
          REPLACE(p0.cwd, u.directory, '~')
        )
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.cgroup_path AS p0_cgroup,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.cgroup_path AS p1_cgroup,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON p0.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT DISTINCT
          pid
        FROM
          processes
        WHERE
          cwd LIKE '%/.%'
          AND NOT name IN (
            'apfsd',
            'bindfs',
            'Code Helper (Plugin)',
            'Code Helper',
            'code',
            'find',
            'git',
            'gitsign',
            'mc',
            'nvim',
            'terraform',
            'updatedb',
            'vi',
            'vim'
          )
          AND NOT cgroup_path LIKE '/system.slice/docker-%'
          AND NOT cgroup_path LIKE '/system.slice/system.slice:docker:%'
      )
      AND NOT (
        exception_key IN (
          'Arduino IDE Helper,/private/var/folders',
          'arduino-language-server,/private/var/folders',
          'as,~/.cache/yay',
          'bash,/var/home/linuxbrew',
          'bash,/var/lib/incus',
          'bash,/var/tmp/.vscode-server',
          'bash,~/.local/share',
          'bash,~/.Trash',
          'bash,~/go/src',
          'c++,~/.cache/yay',
          'cc1,/home/build/.cache',
          'cc1plus,~/.cache/yay',
          'cgo,~/.gimme/versions',
          'clangd,/private/var/folders',
          'conmon,/var~/.local/share',
          'curl,/var/home/linuxbrew',
          'dirhelper,/private/var/folders',
          'zsh,~/Documents/My Vault',
          'Electron,~/.vscode/extensions',
          'exe,/var~/.local/share',
          'fileproviderd,~/Library/Mobile Documents',
          'fish,~/.local/share',
          'fish,~/.Trash',
          'git,~/.local/share',
          'java,/home/build/.gradle',
          'java,/home/build/.kotlin',
          'java,/root/.gradle/daemon',
          'java,~/.gradle/daemon',
          'java,~/.local/share',
          'make,~/.cache/yay',
          'makepkg,~/.cache/yay',
          'mysqld,~/.local/share',
          'npm install,/home/build/.npm',
          'npm install,~/.npm/_cacache',
          'opera_autoupdate,/private/var/folders',
          'postinstall,/Library/InstallerSandboxes/.PKInstallSandboxManager',
          'rm,/private/var/folders',
          'rust-analyzer-p,~/.cargo/registry',
          'rustc,/home/build/.cargo',
          'telegram-deskto,~/snap/telegram-desktop',
          'vet,/home/build/.cache',
          'zsh,/private/tmp/workspace',
          'zsh,~/.Trash',
          'zsh,~/Library/Mobile Documents'
        )
        OR exception_key LIKE '%sh,~/.Trash/%'
        OR exception_key LIKE '%sh,~/dev/%'
        OR exception_key LIKE 'java,/.gradle/%'
        OR exception_key LIKE 'wineserver,/tmp/.wine-1000/server-%'
        OR dir IN (
          '/home/build',
          '/var/home/linuxbrew/.linuxbrew/Cellar',
          '/var/home/linuxbrew/.linuxbrew/Homebrew',
          '~/.cache/yay',
          '~/.config',
          '~/.emacs.d',
          '~/.gmailctl',
          '~/.hunter/_Base',
          '~/.local/bin',
          '~/.local/share/chezmoi',
          '~/.local/share/nvim',
          '~/.local/share/Steam',
          '~/.oh-my-zsh',
          '~/.provisio',
          '~/.terraform.d',
          '~/.vim',
          '~/.zsh',
          '~/dev/extra-packages/.chainguard'
        )
        OR top_dir IN (
          '~/dev',
          '/root/.gradle',
          '~/src',
          '~/Git',
          '~/Sync',
          '/var~/.config',
          '/var~/.local',
          '~/workspace'
        )
        OR dir LIKE '/.gradle/%'
        OR dir LIKE '/home/build/.%'
        OR dir LIKE '/home/build/%'
        OR dir LIKE '/Library/Apple/System/Library/InstallerSandboxes/.PKInstallSandboxManager-SystemSoftware/%'
        OR dir LIKE '/opt/homebrew/%/.cache/%'
        OR dir LIKE '/private/tmp/%/.git'
        OR dir LIKE '/run/.ro%'
        OR dir LIKE '/tmp/.mount_%'
        OR dir LIKE '/tmp/%/.git'
        OR dir LIKE '/tmp/%/.github/workflows'
        OR dir LIKE '%/.build'
        OR dir LIKE '%/.cache/melange%'
        OR dir LIKE '%/.cargo-arm64%'
        OR dir LIKE '%/.cargo/%'
        OR dir LIKE '%/.git'
        OR dir LIKE '%/.git/%'
        OR dir LIKE '%/.github'
        OR dir LIKE '%/.github/%'
        OR dir LIKE '%/.gradle'
        OR dir LIKE '%/.venv'
        OR dir LIKE '%/.venv/%'
        OR dir LIKE '%/node_modules/.bin'
        OR dir LIKE '~/.%'
        OR dir LIKE '/private/var/%/T/.com.google.Chrome.%'
        OR dir LIKE '~/.gradle/%'
        OR dir LIKE '~/%/.config/nvim'
        OR dir LIKE '~/%/.docker%'
        OR dir LIKE '~/%/.modcache/%'
        OR dir LIKE '~/%/.terraform%'
        OR dir LIKE '~/%/.terragrunt-cache/%'
        OR dir LIKE '~/%/.tests/%'
        OR dir LIKE '~/%/.vercel%'
        OR dir LIKE '~/%/github.com/%'
        OR dir LIKE '~/%/node_modules/.pnpm/%'
        OR dir LIKE '~/%/src/%'
        OR dir LIKE '~/%enterprise-packages/.chainguard'
        OR dir LIKE '~/%google-cloud-sdk/.install/.backup%'
        OR dir LIKE '~/code/%'
        OR dir LIKE '~/dev/%/dots/%/.config%'
        OR dir LIKE '~/src/%' -- For sudo calls to other things
        OR (
          dir LIKE '/home/.terraform.d/%'
          AND p0.euid = 0
        )
      )
    GROUP BY
      p0.pid
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Home Libappsupport"
  description: Find unexpected hidden files in a users Application Support directory
  query: |
    SELECT
      file.path,
      file.filename,
      file.type,
      file.mode,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      REPLACE(file.path, u.directory, '~') AS homepath,
      REPLACE(file.directory, u.directory, '~') AS homedir,
      file.gid,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      JOIN hash ON file.path = hash.path
      JOIN users u ON file.uid = u.uid
      JOIN magic ON file.path = magic.path
      JOIN signature ON file.path = signature.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            path LIKE '/Users/%/Library/Application Support/%/.%'
            OR path LIKE '/Users/%/Library/Application Support/.%'
          )
          AND NOT file.filename IN ('.', '..', '.updaterId', '.DS_Store')
          AND size > 0
      )
      AND NOT homedir IN (
        '~/Library/Application Support/1Password',
        '~/Library/Application Support/Adobe',
        '~/Library/Application Support/Beeper',
        '~/Library/Application Support/BetterTouchTool',
        '~/Library/Application Support/CleanMyMac X Menu',
        '~/Library/Application Support/CleanMyMac X',
        '~/Library/Application Support/Code',
        '~/Library/Application Support/com.apple.spotlight',
        '~/Library/Application Support/com.bohemiancoding.sketch3',
        '~/Library/Application Support/com.intelliscapesolutions.caffeine',
        '~/Library/Application Support/com.operasoftware.Opera',
        '~/Library/Application Support/com.psiexams.psi-bridge-secure-browser',
        '~/Library/Application Support/com.tinyapp.TablePlus',
        '~/Library/Application Support/discord',
        '~/Library/Application Support/Docker Desktop',
        '~/Library/Application Support/DropboxElectron',
        '~/Library/Application Support/GitHub Desktop',
        '~/Library/Application Support/Jabra Direct',
        '~/Library/Application Support/Keybase',
        '~/Library/Application Support/Lens',
        '~/Library/Application Support/lghub',
        '~/Library/Application Support/Loom',
        '~/Library/Application Support/abnerworks.Typora',
        '~/Library/Application Support/nuclei',
        '~/Library/Application Support/Evernote',
        '~/Library/Application Support/Presenting',
        '~/Library/Application Support/Slack',
        '~/Library/Application Support/ZaloApp',
        '~/Library/Application Support/ZaloData',
        '~/Library/Application Support/ZaloPC'
      )
      AND NOT homepath IN (
        '~/Library/Application Support/.com.contextsformac.Contexts.plist',
        '~/Library/Application Support/.settings',
        '~/Library/Application Support/.Shadowland5.5',
        '~/Library/Application Support/Evernote/.ldl',
        '~/Library/Application Support/BBEdit/.SupportFolderMigration.txt'
      )
      AND NOT homepath LIKE '~/Library/Application Support/.syssettings%'
      AND NOT magic.data = 'XML 1.0 document, ASCII text'
      -- Capture One
      AND NOT (
        file.mode = "0666"
        AND size > 1200
        AND size < 4000
        AND REGEX_MATCH (file.filename, "^(\.[0-9A-Z]{32})$", 0) != ""
      )
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Missing From Disk Linux"
  description: "Processes that do not exist on disk, running in osquery's namespace"
  query: |
    SELECT
      p.pid,
      p.euid,
      p.cmdline,
      p.path,
      p.cgroup_path,
      mnt_namespace,
      p.cwd,
      p.on_disk,
      p.state,
      file.inode,
      pp.on_disk AS parent_on_disk,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      ph.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN process_namespaces ON p.pid = process_namespaces.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ph ON pp.path = ph.path
    WHERE
      p.on_disk != 1
      AND p.path != ''
      AND p.start_time < (strftime('%s', 'now') - 3600)
      -- use osquery as the reference mount namespace
      AND mnt_namespace IN (
        SELECT DISTINCT
          (mnt_namespace)
        FROM
          process_namespaces
          JOIN processes ON processes.pid = process_namespaces.pid
        WHERE
          processes.name IN ('osqueryi', 'osqueryd')
      )
      -- This is truly a missing program, not just one that has been updated with a new binary.
      AND file.inode IS NULL
      AND p.path != '/bpfilter_umh'
      -- Snap packages?
      AND p.path NOT LIKE '/home/%/.cache/yay/1password-cli/pkg/1password-cli/usr/bin/op'
      AND p.path NOT LIKE '/tmp/.mount_%'
      -- Probably just an upgrade
      AND p.path NOT LIKE '/opt/%'
      AND p.path NOT LIKE '/usr/bin/%'
      AND p.path NOT LIKE '/usr/sbin/%'
      AND p.path NOT LIKE '/home/%/.local/share/firefoxpwa/runtime%/firefox-bin'
      AND p.path NOT IN (
        '/usr/lib/firefox/firefox-bin',
        '/usr/lib64/firefox/firefox'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Missing From Disk Macos"
  description: Processes that do not exist on disk
  query: |
    SELECT
      p.pid,
      p.path,
      p.name,
      p.parent,
      p.state,
      p.cwd,
      p.gid,
      p.uid,
      p.euid,
      p.cmdline AS cmd,
      p.cwd,
      p.on_disk,
      p.state,
      strftime('%s', 'now') - p.start_time AS age,
      pp.on_disk AS parent_on_disk,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
      LEFT JOIN file ON p.path = file.path
    WHERE
      -- Unlike on Linux, this also excludes processes where the binary has been replaced since start time
      p.on_disk != 1
      AND file.path = ''
      AND (strftime('%s', 'now') - p.start_time) > 25000
      AND p.pid > 0
      AND p.parent != 2 -- kthreadd
      AND p.state != 'Z' -- The kernel no longer has enough tracking information for this alert to be useful
      AND NOT (
        p.parent = 1
        AND p.path = ''
      )
      AND NOT (
        p.gid = 20
        AND (
          -- NOTE: p.path is typically empty when on_disk != 1, so don't depend on it.
          cmd LIKE '/Library/Apple/System/%'
          OR cmd LIKE '/Applications/%/Contents/%'
          OR cmd LIKE '/Library/Apple/System/%'
          OR cmd LIKE '/Library/Application Support/Logitech.localized/%'
          OR cmd LIKE '/Library/Developer/CommandLineTools/%'
          OR p.path IN (
            '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper',
            '/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Renderer).app/Contents/MacOS/Code Helper (Renderer)',
            '/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper'
          )
          OR cmd LIKE '/opt/homebrew/Cellar/%'
          OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/opt/homebrew/Cellar/%/libexec/%'
          OR p.path LIKE '/private/var/folders/zz/%/T/PKInstallSandboxTrash/%.sandboxTrash/%'
          OR p.path LIKE '/private/var/kolide-k2/k2device.kolide.com/updates/%'
          OR p.path LIKE '/Users/%/.local/share/nvim/mason/packages/%'
          OR p.path LIKE '/Users/%/.terraform/providers/%/terraform-provider-%'
          OR p.path LIKE '/Users/%/go/bin/%'
          OR p.path LIKE '/Users/%/homebrew/Cellar/%'
          OR p.path LIKE '/Users/%/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/Users/%/Library/Application Support/Steam/Steam.AppBundle/Steam/Contents/MacOS/ipcserver.old'
          OR p.path LIKE '/Users/%/node_modules/.pnpm/%'
          OR p.path LIKE '/usr/local/Cellar/%/bin/%'
          OR cmd LIKE ''
          OR cmd LIKE '/opt/homebrew/opt/%'
          OR cmd LIKE '/private/var/folders/%/Visual Studio Code.app/Contents/%'
          OR cmd LIKE '/Users/%/homebrew/opt/mysql/bin/%' -- Sometimes cmd is empty also :(
          OR cmd LIKE '%/.terraform/providers/%'
          OR cmd LIKE '%/go/src/github.com/%'
          OR parent_cmd LIKE '/Applications/Google Chrome.app/%'
        )
      )
      AND NOT (
        p.name = ''
        AND parent_cmd = '/Applications/Firefox Developer Edition.app/Contents/MacOS/firefox -foreground'
      )
      AND NOt cmd LIKE '/opt/homebrew/opt/%'
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Old Binaries Running"
  description: Alert on programs running that are unusually old
  query: |
    SELECT
      p.path,
      p.cmdline,
      p.cwd,
      p.pid,
      p.name,
      f.mtime,
      f.ctime,
      p.cgroup_path,
      ((strftime('%s', 'now') - f.ctime) / 86400) AS ctime_age_days,
      ((strftime('%s', 'now') - f.mtime) / 86400) AS mtime_age_days,
      ((strftime('%s', 'now') - f.btime) / 86400) AS btime_age_days,
      h.sha256,
      f.uid,
      m.data,
      f.gid
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN hash h ON p.path = h.path
      LEFT JOIN magic m ON p.path = m.path
    WHERE
      (
        ctime_age_days > 1460
        OR mtime_age_days > 1460
      )
      -- Jan 1st, 1980 (the source of many false positives)
      AND f.mtime > 315561600
      AND f.path NOT LIKE '/home/%/idea-IU-223.8214.52/%'
      AND f.directory NOT LIKE '/Applications/%.app/Contents/Frameworks/%/Resources'
      AND f.directory NOT LIKE '/Applications/%.app/Contents/MacOS'
      AND f.directory NOT LIKE '/opt/homebrew/Cellar/%/bin'
      AND f.path NOT IN (
        '/Applications/Gitter.app/Contents/Library/LoginItems/GitterHelperApp.app/Contents/MacOS/GitterHelperApp',
        '/Applications/Pandora.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Resources/crashpad_handler',
        '/Applications/Skitch.app/Contents/Library/LoginItems/J8RPQ294UB.com.skitch.SkitchHelper.app/Contents/MacOS/J8RPQ294UB.com.skitch.SkitchHelper',
        '/Applications/Vimari.app/Contents/PlugIns/Vimari Extension.appex/Contents/MacOS/Vimari Extension',
        '/Library/Apple/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/A/Resources/usbmuxd',
        '/Library/Application Support/EPSON/Scanner/ScannerMonitor/Epson Scanner Monitor.app/Contents/MacOS/Epson Scanner Monitor',
        '/Library/Application Support/LogiFacecam.bundle/Contents/MacOS/LogiFacecamService',
        '/Library/Application Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService',
        '/Library/Application Support/Razer/RzUpdater.app/Contents/MacOS/RzUpdater',
        '/Library/Java/JavaVirtualMachines/jdk-17.0.2.jdk/Contents/Home/bin/java',
        '/Volumes/CANON_IJ/Setup.app/Contents/MacOS/Setup',
        '/opt/IRCCloud/chrome-sandbox',
        '/opt/IRCCloud/irccloud',
        '/snap/brackets/138/opt/brackets/Brackets-node',
        '/snap/brackets/138/opt/brackets/Brackets',
        '/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/A/Resources/usbmuxd',
        '/usr/bin/dbus-broker-launch',
        '/usr/bin/espeak',
        '/usr/bin/i3blocks',
        '/usr/bin/i3lock',
        '/usr/bin/mono-sgen',
        '/usr/bin/pavucontrol',
        '/usr/bin/sshfs',
        '/usr/bin/unpigz',
        '/usr/bin/xbindkeys',
        '/usr/bin/xclip',
        '/usr/bin/xsel',
        '/usr/bin/xsettingsd',
        '/usr/bin/xss-lock',
        '/usr/libexec/dconf-service',
        '/usr/local/bin/dive'
      )
      AND f.path NOT LIKE '/Library/Printers/%'
      AND p.name NOT IN (
        'Android File Transfer Agent',
        'BluejeansHelper',
        'buildkitd',
        'dlv',
        'Flycut',
        'gitstatusd-darwin-arm64',
        'gitstatusd-linu',
        'J8RPQ294UB.com.skitch.SkitchHelper',
        'kail',
        'Pandora Helper',
        'Pandora',
        'SetupWizard',
        'Vimari Extension'
      )
      AND f.path NOT LIKE '/private/var/folders/%/T/AppTranslocation/%/d/Skitch.app/Contents/MacOS/Skitch'
      AND f.path NOT LIKE '/private/var/folders/%/T/AppTranslocation/%/d/Spectacle.app/Contents/MacOS/Spectacle'
      AND f.path NOT LIKE '/snap/surfshark/%/usr/bin/gjs-console'
      AND f.filename NOT LIKE 'protoc-%'
      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p.cgroup_path NOT LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'
      AND p.cgroup_path NOT LIKE '/user.slice/user-%.slice/user@%.service/user.slice/podman-%'
    GROUP BY
      p.pid,
      p.path
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Touched Executable Macos"
  description: Programs which appear to have been touched on macOS
  query: |
    SELECT
      p.path,
      p.name,
      p.cmdline,
      p.euid,
      DATETIME(p.start_time, 'unixepoch') AS started,
      DATETIME(f.ctime, 'unixepoch') AS changed,
      DATETIME(f.btime, 'unixepoch') AS birthed,
      DATETIME(f.mtime, 'unixepoch') AS modified,
      DATETIME(f.atime, 'unixepoch') AS accessed,
      (f.btime - f.ctime) / 86400 AS btime_ctime_days_diff,
      (p.start_time - f.atime) / 86400 AS start_atime_days_diff,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS sha256,
      signature.identifier,
      signature.authority
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      p.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          path NOT LIKE '/System/%'
          AND path NOT LIKE '/Applications/%/Contents/MacOS/%'
          AND path NOT LIKE '/Library/Apple/%'
          AND path NOT LIKE '/opt/%/bin/%'
          AND path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          AND path NOT LIKE '/sbin/%'
          AND path NOT LIKE '/usr/bin/%'
          AND path NOT LIKE '/usr/libexec/%'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
          AND path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
          AND path NOT LIKE '/usr/sbin/%'
          AND path NOT LIKE '/Volumes/%'
      )
      AND f.btime = f.mtime
      AND (
        -- change time is older than birth time
        btime_ctime_days_diff > 0 -- change time is older than birth time, but not 1970
        OR (
          (btime_ctime_days_diff < -365)
          AND (btime_ctime_days_diff < -1000)
        ) -- access time is older than start time
        OR start_atime_days_diff > 90
      ) -- Vendors that create software packages that look like a touched file.
      AND NOT signature.authority IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Bryan Jones (49EYHPJ4Q3)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Emmanouil Konstantinidis (3YP8SXP3BF)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        -- Karibiner
        'Developer ID Application: Galvanix (5BRAQAFB8B)',
        'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Jones (YD6LEYT6WZ)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Reflect App, LLC (789ULN5MZB)',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Developer ID Application: Zoom Video Communications, Inc.',
        'Software Signing'
      )
      AND NOT (
        p.euid > 500
        AND (
          p.path IN (
            '/Applications/Canon Utilities/IJ Scan Utility/Canon IJ Scan Utility Lite.app/Contents/Library/LoginItems/CIJSULAgent.app/Contents/MacOS/CIJSULAgent',
            '/Applications/Canon Utilities/Inkjet Extended Survey Program/Inkjet Extended Survey Program.app/Contents/MacOS/ESPController.app/Contents/Library/LoginItems/CanonIJExtendedSurveyLaunchAgent.app/Contents/MacOS/CanonIJExtendedSurveyLaunchAgent',
            '/Applications/Divvy.app/Contents/MacOS/Divvy',
            '/Applications/Sourcetree.app/Contents/MacOS/Sourcetree',
            '/Library/CoreMediaIO/Plug-Ins/DAL/LogiCapture.plugin/Contents/MacOS/Assistant',
            '/Library/Printers/Brother/Utilities/BrStatusMonitor.app/Contents/MacOS/BrStatusMonitor',
            '/opt/homebrew/share/google-cloud-sdk/bin/log-streaming',
            '/usr/local/bin/node'
          )
          OR p.path LIKE '/Applications/%.app/Contents/Frameworks/%/Versions/A/Resources/%'
          OR p.path LIKE '/Users/%/.cache/gitstatus/gitstatusd-darwin-arm64'
          OR p.path LIKE '/Applications/%.app/Contents/MacOS/%'
          OR p.path LIKE '/opt/homebrew/Caskroom/%/bin/%'
          OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'
          OR p.path LIKE '/private/var/folders/%/T/AppTranslocation/%/Contents/MacOS/%'
          OR p.path LIKE '/Users/%/google-cloud-sdk/bin/%'
          OR p.path LIKE '/Users/%/J8RPQ294UB.com.skitch.SkitchHelper'
          OR p.path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'
        )
      )
      AND NOT (
        p.euid > 300
        AND p.path LIKE '/nix/store/%'
      )
      AND NOT (
        p.euid > 300 -- Electron
        AND p.path LIKE '% Helper'
      )
      AND NOT (
        p.euid = 0
        AND (
          p.path LIKE '/nix/store/%/bin/nix'
          OR p.path LIKE '/nix/store/%/bin/nix-daemon'
        )
      )
    GROUP by
      p.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Alf Exceptions Macos"
  description: macOS application layer firewall (ALF) service exceptions.
  query: |
    SELECT
      ae.path,
      ae.state,
      file.mtime,
      file.ctime,
      file.uid,
      file.directory,
      file.size,
      file.type,
      hash.sha256,
      signature.identifier,
      signature.authority,
      CONCAT (
        signature.authority,
        ',',
        signature.identifier,
        ',',
        ae.path,
        ',',
        MIN(file.uid, 501)
      ) AS exception_key
    FROM
      alf_exceptions ae
      LEFT JOIN file ON ae.path = file.path
      LEFT JOIN hash ON ae.path = hash.path
      LEFT JOIN signature ON ae.path = signature.path
    WHERE -- Filter out stock exceptions to decrease overhead
      ae.path NOT IN (
        '/System/Library/CoreServices/UniversalControl.app/',
        '/System/Library/PrivateFrameworks/Admin.framework/Versions/A/Resources/readconfig',
        '/System/Library/PrivateFrameworks/EmbeddedOSInstall.framework/Versions/A/XPCServices/EmbeddedOSInstallService.xpc/',
        '/System/Volumes/Preboot/Cryptexes/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/',
        '/usr/bin/nmblookup',
        '/usr/libexec/bootpd',
        '/usr/libexec/configd',
        '/usr/libexec/discoveryd',
        '/usr/libexec/xartstorageremoted',
        '/usr/sbin/mDNSResponder',
        '/usr/sbin/racoon'
      ) -- Ignore files that ahve already been removed
      AND file.filename NOT NULL
      AND exception_key NOT IN (
        ',a.out,/private/tmp/learning-labs-static/server,501',
        ',a.out,/Users/amouat/proj/learning-labs-static/server,501',
        ',a.out,/Users/dlorenc/.wash/downloads/nats-server,501',
        ',com.docker.docker,/Applications/Docker.app/,501',
        ',deskflow-server,/Applications/Deskflow.app/Contents/MacOS/deskflow-server,501',
        'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',
        'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.localized/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF),com.adguard.mac.adguard.network-extension,/Library/SystemExtensions/AD3BCA34-237A-4135-B7A4-0F7477D9144C/com.adguard.mac.adguard.network-extension.systemextension/,0',
        'Developer ID Application: Ned Deily (DJ3H93M7VJ),org.python.python,/Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/,0',
        'Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python,/Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/,0',
        'Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python,/Library/Frameworks/Python.framework/Versions/3.12/Resources/Python.app/,0',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension,/Library/SystemExtensions/A30AF854-E980-4345-A658-17000BF66D00/io.tailscale.ipn.macsys.network-extension.systemextension/,0'
      )
      -- Signed
      AND NOT exception_key LIKE 'Developer ID Application:%,/Applications/%.app/,501'
      -- Unsigned
      AND NOT exception_key LIKE ',,/Applications/%.app/,'
      -- Locally compiled
      AND NOT exception_key LIKE ',a.out,/Users/%,501'
      -- Homebrew
      AND NOT exception_key LIKE ',%,/opt/homebrew/Cellar/%,501'
      -- Nix
      AND NOT exception_key LIKE ',%,/nix/store/%,0'
      AND NOT exception_key LIKE ',%,/nix/store/%,501'
      -- Apple (root)
      AND NOT exception_key LIKE 'Software Signing,com.apple.%,0'
      -- App Store
      AND NOT exception_key LIKE 'Apple Mac OS Application Signing,%,/Applications/%.app/,0'
      -- Other weirdo apps
      AND NOT exception_key LIKE 'Developer ID Application: Cypress.Io, Inc. (7D655LWGLY),com.electron.cypress,/Users/%/Library/Caches/Cypress/%/Cypress.app/,501'
      AND NOT exception_key LIKE 'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension,/Library/SystemExtensions/%'
      AND NOT exception_key LIKE 'Developer ID Application: The Foundry (82R497YNSK),org.python.python,/Applications/Nuke%/Contents/Frameworks/Python.framework/Versions/%/Resources/Python.app/,501'
      AND NOT signature.authority IN (
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)',
        'Developer ID Application: The Foundry (82R497YNSK)'
      )
      AND NOT (
        signature.identifier LIKE 'fake-%'
        AND ae.path LIKE '%/exe/fake'
      )
      AND NOT (
        signature.identifier = 'nix'
        AND ae.path LIKE '/nix/store/%-nix-%/bin/nix'
      )
      AND NOT (
        ae.path LIKE '/Users/%/Library/Application%20Support/Steam/Steam.AppBundle/Steam/'
      )
      AND NOT (
        signature.authority = ''
        AND signature.identifier = 'org.chromium.Chromium'
        AND ae.path LIKE '/Users/%/Library/pnpm/global/%/.pnpm/carlo@%/node_modules/carlo/lib/.local-data/mac-%/chrome-mac/Chromium.app/'
      )
      -- End user tools
      AND NOT (
        (
          signature.identifier = 'a.out'
          OR signature.identifier LIKE '%-%'
        )
        AND file.uid > 500
        AND (
          file.directory LIKE '/opt/homebrew/Cellar/%/bin'
          OR file.directory LIKE '/private/var/folders/%/T/go-build%/exe'
          OR file.directory LIKE '/Users/%/%-cli'
          OR file.directory LIKE '/Users/%/bin'
          OR file.directory LIKE '/Users/%/code/%'
          OR file.directory LIKE '/Users/%/debug/%'
          OR file.directory LIKE '/Users/%/gh/%'
          OR file.directory LIKE '/Users/%/git/%'
          OR file.directory LIKE '/Users/%/node_modules/.bin/%'
          OR file.directory LIKE '/Users/%/sigstore/%'
          OR file.directory LIKE '/Users/%/src/%'
          OR file.directory LIKE '/Users/%/target/%'
          OR file.directory LIKE '/Users/%/tmp/%'
        )
      )
    GROUP BY
      exception_key
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Etc Executables"
  description: Find unexpected executables in /etc
  query: |
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (file.path LIKE '/etc/%%')
      AND file.type = 'regular'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/etc/acpi',
        '/etc/acpi/actions',
        '/etc/alternatives',
        '/etc/ansible/facts.d',
        '/etc/apcupsd',
        '/etc/apk/commit_hooks.d',
        '/etc/apm/resume.d',
        '/etc/apm/scripts.d',
        '/etc/apm/suspend.d',
        '/etc/asciidoc/filters/code',
        '/etc/avahi',
        '/etc/bash_completion.d',
        '/etc/brltty/Contraction',
        '/etc/ca-certificates/update.d',
        '/etc/chromium/native-messaging-hosts',
        '/etc/cifs-utils',
        '/etc/cloud/clean.d/99-installer-use-networkmanager',
        '/etc/console-setup',
        '/etc/cron.daily',
        '/etc/cron.hourly',
        '/etc/cron.monthly',
        '/etc/cron.weekly',
        '/etc/dconf/db/distro.d',
        '/etc/dconf/db/distro.d/locks',
        '/etc/dhcp/dhclient-enter-hooks.d',
        '/etc/dhcp/dhclient-exit-hooks.d',
        '/etc/dhcp/dhclient.d',
        '/etc/distrobox',
        '/etc/dkms',
        '/etc/etckeeper/commit.d',
        '/etc/flatpak/remotes.d',
        '/etc/framework-ectool',
        '/etc/fstab.script',
        '/etc/gdm',
        '/etc/gdm/Init',
        '/etc/gdm/PostLogin',
        '/etc/gdm/PostSession',
        '/etc/gdm/PreSession',
        '/etc/gdm3',
        '/etc/gdm3/Init',
        '/etc/gdm3/PostLogin',
        '/etc/gdm3/PostSession',
        '/etc/gdm3/PreSession',
        '/etc/gdm3/Prime',
        '/etc/gdm3/PrimeOff',
        '/etc/grub.d',
        '/etc/httpd/modules',
        '/etc/ifplugd',
        '/etc/ifplugd/action.d',
        '/etc/init.d',
        '/etc/initramfs/post-update.d',
        '/etc/kde/shutdown',
        '/etc/kernel/header_postinst.d',
        '/etc/kernel/install.d',
        '/etc/kernel/postinst.d',
        '/etc/kernel/postrm.d',
        '/etc/kernel/preinst.d',
        '/etc/kernel/prerm.d',
        '/etc/lightdm',
        '/etc/localtime',
        '/etc/mc',
        '/etc/mcelog/triggers',
        '/etc/menu-methods',
        '/etc/needrestart/hook.d',
        '/etc/needrestart/notify.d',
        '/etc/needrestart/restart.d',
        '/etc/network',
        '/etc/network/if-down.d',
        '/etc/network/if-post-down.d',
        '/etc/network/if-pre-up.d',
        '/etc/network/if-up.d',
        '/etc/NetworkManager/dispatcher.d',
        '/etc/nix/result',
        '/etc/nix/result/sw/bin',
        '/etc/openvpn',
        '/etc/periodic/daily',
        '/etc/periodic/monthly',
        '/etc/periodic/weekly',
        '/etc/pinentry',
        '/etc/pki/tls/misc',
        '/etc/pm/sleep.d',
        '/etc/pop-os/update-motd.d',
        '/etc/ppp',
        '/etc/ppp/ip-down.d',
        '/etc/ppp/ip-up.d',
        '/etc/ppp/ipv6-up.d',
        '/etc/profile.d',
        '/etc/qemu-ga',
        '/etc/rc.d/init.d',
        '/etc/rc.d/rc0.d',
        '/etc/rc.d/rc1.d',
        '/etc/rc.d/rc2.d',
        '/etc/rc.d/rc3.d',
        '/etc/rc.d/rc4.d',
        '/etc/rc.d/rc5.d',
        '/etc/rc.d/rc6.d',
        '/etc/rc0.d',
        '/etc/rc1.d',
        '/etc/rc2.d',
        '/etc/rc3.d',
        '/etc/rc4.d',
        '/etc/rc5.d',
        '/etc/rc6.d',
        '/etc/rcS.d',
        '/etc/rdnssd',
        '/etc/redhat-lsb',
        '/etc/resolvconf/update-libc.d',
        '/etc/resolvconf/update.d',
        '/etc/runit',
        '/etc/schroot/setup.d',
        '/etc/security',
        '/etc/skel',
        '/etc/smartmontools',
        '/etc/smartmontools/run.d',
        '/etc/ssl/certs',
        '/etc/ssl/misc',
        '/etc/ssl/trust-source',
        '/etc/sv/dnsmasq',
        '/etc/sv/dnsmasq/log',
        '/etc/sv/incus',
        '/etc/sv/incus-user',
        '/etc/sv/incus-user/log',
        '/etc/sv/pcscd',
        '/etc/sv/pcscd/control',
        '/etc/sv/pcscd/log',
        '/etc/sv/svlogd',
        '/etc/sysconfig/network-scripts',
        '/etc/systemd/system',
        '/etc/systemd/system-shutdown',
        '/etc/systemd/system/graphical.target.wants',
        '/etc/timeshift/restore-hooks.d',
        '/etc/udev/rules.d',
        '/etc/update-motd.d',
        '/etc/vmware-tools',
        '/etc/vmware-tools/scripts/vmware',
        '/etc/vpnc',
        '/etc/wpa_supplicant',
        '/etc/X11',
        '/etc/X11/xinit',
        '/etc/X11/xinit/xinitrc.d',
        '/etc/xdg/Xwayland-session.d',
        '/etc/zfs-fuse',
        '/etc/zfs/zed.d',
        '/etc/zfs/zpool.d'
      )
      AND file.path NOT IN (
        '/etc/auto.net',
        '/etc/auto.smb',
        '/etc/cloud/clean.d/99-installer',
        '/etc/cloud/clean.d/99-installer-use-networkmanager',
        '/etc/cron.yearly/0anacron',
        '/etc/fstab.script',
        '/etc/grub2-efi.cfg',
        '/etc/grub2.cfg',
        '/etc/hibernate.sh',
        '/etc/libpaper.d/texlive-base',
        '/etc/macchanger/ifupdown.sh',
        '/etc/modulefiles/vpl',
        '/etc/nftables.conf',
        '/etc/opt/chrome/native-messaging-hosts/com.google.endpoint_verification.api_helper.json',
        '/etc/paths.d/100-rvictl',
        '/etc/pcp/pmcd/rc.local',
        '/etc/pcp/pmie/rc',
        '/etc/pcp/pmlogger/rc',
        '/etc/pcp/pmproxy/rc',
        '/etc/pki/tls/certs/make-dummy-cert',
        '/etc/pki/tls/certs/renew-dummy-cert',
        '/etc/postfix/post-install',
        '/etc/postfix/postfix-script',
        '/etc/profile',
        '/etc/pwrstatd.conf',
        '/etc/qemu-ifdown',
        '/etc/qemu-ifup',
        '/etc/rmt',
        '/etc/sddm/wayland-session',
        '/etc/sddm/Xsession',
        '/etc/sddm/Xsetup',
        '/etc/sddm/Xstop',
        '/etc/shutdown.sh',
        '/etc/sudoers.d/lima',
        '/etc/sv/ssh/finish',
        '/etc/sv/ssh/log/run',
        '/etc/sv/ssh/run',
        '/etc/udev/powersave.sh',
        '/etc/vpl/vars.sh',
        '/etc/xdg/xfce4/xinitrc'
      )
      AND file.directory NOT LIKE '/etc/asciidoc/%'
      -- Nix (on macOS) -- actually a symbolic link
      AND file.path NOT LIKE '/etc/etckeeper/%'
      AND file.path NOT LIKE '/etc/profiles/per-user/%/bin/%'
      AND file.path NOT LIKE '/etc/pwrstatd-%.sh'
      AND file.path NOT LIKE '/etc/pwrstatd-%.sh'
      AND file.path NOT LIKE '/etc/alternatives/%'
      AND (
        magic.data IS NULL
        OR magic.data NOT IN ('JSON text data', 'ASCII text')
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Ld So Files Linux"
  description: Find unexpected ld.so.conf files
  query: |
    SELECT
      file.path,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      CONCAT (file.path, ',', mode, ',', size, ',', sha256) AS exception_key
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path IN ('/etc/ld.so.conf', '/etc/ld.so.preload')
        OR file.path LIKE '/etc/ld.so.conf.d/%'
        OR file.path LIKE '/etc/ld.so.conf.d/.%'
      )
      AND file.filename NOT IN ('.', '..')
      AND exception_key NOT IN (
        '/etc/ld.so.conf,0644,117,dad04a370e488aa85fb0a813a5c83cf6fd981ce01883fc59685447b092de84b5',
        '/etc/ld.so.conf,0644,154,785c6c3614a27ae6115a27c1ca55bbf333654780997c4ba7e181172b021d1bf3',
        '/etc/ld.so.conf,0644,28,239c865e4c0746a01f82b03d38d620853bab2a2ba8e81d6f5606c503e0ea379f',
        '/etc/ld.so.conf,0644,33,27d7ebd402e1b9a20fd3a0663ccc10e1b1feff2d9dfb1ad7dd12bb76cfe0880a',
        '/etc/ld.so.conf,0644,34,d4b198c463418b493208485def26a6f4c57279467b9dfa491b70433cedb602e8',
        '/etc/ld.so.conf.d/000_cuda.conf,0644,41,a9327cff9435220eac872cffedc7f6144d915bdcb70d985304c72f4c3cb9a7d3',
        '/etc/ld.so.conf.d/989_cuda-11.conf,0644,44,915b1ed4caa95cf65a62a74d8255c5ef80ef864cc2767933c85e240a78957167',
        '/etc/ld.so.conf.d/bind-export-x86_64.conf,0644,26,efeec53def06657c947f064463d5ebdb68f7c6f9e40cc2e72fc11c263484942e',
        '/etc/ld.so.conf.d/cuda.conf,0644,66,a65f7d96e2447eb40b1be9586b90eb0bd776a8938c93d21f9606d2880b548b28',
        '/etc/ld.so.conf.d/dyninst-x86_64.conf,0644,19,a4c740c1f59176d816ba18d429ba823317d3db416accf6d79a9cb0ac845d9d50',
        '/etc/ld.so.conf.d/fakechroot-x86_64-linux-gnu.conf,0644,37,b31d4e51d547996eaad550223d078701016504cdf6571abd2b37ece9db3caac7',
        '/etc/ld.so.conf.d/fakeroot-x86_64-linux-gnu.conf,0644,38,af7edc777dd224bade078ba540538444db69856533c02e18a7f9fbbdd23bd181',
        '/etc/ld.so.conf.d/fakeroot.conf,0644,21,564c4c4d369d005702d825d34edc5e5568cb1ab6ee1b19fa03d0d672fb8b3aee',
        '/etc/ld.so.conf.d/gds-11-8.conf,0644,46,2b48cb0abd03ff1d8926eca02a71540f4ee00ebccad5515e4d28a542dae8438a',
        '/etc/ld.so.conf.d/homebrew.conf,0644,33,f4972e79fa4966d9976487a5b5d4152c4cd7020b236b173ad1f2a3d2fa86f74a',
        '/etc/ld.so.conf.d/i386-linux-gnu.conf,0644,168,023231b8d6d21a7f4b1a59b875576604395041c814c0fd640d4a1d3d29455e6a',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-dpcpp-cpp-runtime-libs.conf,0644,44,9f123b367c8afdcd116047d24f91339a95724d6f6cd189967696d2eb8eda63b4',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-dpcpp-cpp-runtime.conf,0644,48,c0c6efda46a86b0d0cbc620b910cec4ba455d09a2bc7a39adf45ce113093366d',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-dpcpp-cpp-runtime.conf,0644,92,c4f62f0bfed45e548755c60b5e012e79c9062bb2a993c041db661951eb994476',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-opencl-cpu.conf,0644,92,c4f62f0bfed45e548755c60b5e012e79c9062bb2a993c041db661951eb994476',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-runtime-libs.conf,0644,65,0e9c472578fe009314f02ab64613fc41114f4d07cfd3a805191a5b755d780a43',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-runtime.conf,0644,157,0b4a1c81fcab2d345f99e0187f29cf28f085ae67bf42c86d7b509c06b345186e',
        '/etc/ld.so.conf.d/intel-oneapi-compiler-shared-runtime.conf,0644,92,c4f62f0bfed45e548755c60b5e012e79c9062bb2a993c041db661951eb994476',
        '/etc/ld.so.conf.d/intel-oneapi-openmp.conf,0644,155,160358af96f4a1a92e624fa84a1776d45c1a2c4695c8b96070374f6d66bf6061',
        '/etc/ld.so.conf.d/intel-oneapi-openmp.conf,0644,155,76736fa4deb3f3f4a7a96a068eb01b610faf9492814d47d36b3acbc1b4fb9fd3',
        '/etc/ld.so.conf.d/intel-oneapi-tbb.conf,0644,48,ab4d154371df8bf81c4fd8f079137994c5c9a60f43bef4132e6ffcbfbb08e99d',
        '/etc/ld.so.conf.d/kernel-3.10.0-1160.83.1.el7.x86_64.conf,0444,63,37cb41e22b4cb69bb7b8652111c59d3d07b6522ac1f4a635e794ca7eaf411dd7',
        '/etc/ld.so.conf.d/kernel-3.10.0-1160.el7.x86_64.conf,0444,63,37cb41e22b4cb69bb7b8652111c59d3d07b6522ac1f4a635e794ca7eaf411dd7',
        '/etc/ld.so.conf.d/lib32-glibc.conf,0644,11,c27424154a6096ae32c0824b785e05de6acef33d9224fd6147d1936be9b4962b',
        '/etc/ld.so.conf.d/libc.conf,0644,44,90d4c7e43e7661cd116010eb9f50ad5817e43162df344bd1ad10898851b15d41',
        '/etc/ld.so.conf.d/libc.conf,0644,64,4fdfcdfbc49472b5cc928d4d7ead19646ae0e1733a04c7c905ac7309b178567c',
        '/etc/ld.so.conf.d/libiscsi-x86_64.conf,0644,17,fa3839c3cb893d3a589a020a0a9a010de1332b8385ee8139660e2da8bcc932a3',
        '/etc/ld.so.conf.d/llvm13-x86_64.conf,0644,22,4da62e9ec76b030c527e2ea87ccfab1baeff7d0f9092f980231e49961bb97de0',
        '/etc/ld.so.conf.d/llvm15-x86_64.conf,0644,22,30e995961d9e382d287469acce7e168d15811356bf20971fc17bb582a8d62afa',
        '/etc/ld.so.conf.d/llvm16-x86_64.conf,0644,22,3ddda874af4dd14e9e873da09d082031abfacd4b5094982c28f53e1fd50a5fe3',
        '/etc/ld.so.conf.d/llvm17-x86_64.conf,0644,22,3aceee0a4efb8cc2b0f981035cdbb6f28be48634f72f9b6fb98c1e282d32347c',
        '/etc/ld.so.conf.d/llvm18-x86_64.conf,0644,22,a22fdfb5b0443aa1e820a319c56867529ebc54b0f11634c51e5dd847cd8f1b97',
        '/etc/ld.so.conf.d/llvm19-x86_64.conf,0644,22,1913d56931d9831f62a3f22c88512861e790725dd881f0d12b7c39a50b65ec82',
        '/etc/ld.so.conf.d/mariadb-x86_64.conf,0644,17,598466b4954bc66c6f45f1f119211b0698d4a549f6c01b5d9a933a2511b82626',
        '/etc/ld.so.conf.d/mesa-freeworld-lib.conf,0644,26,d5448de51f81d11b937c058b79edb5971debf0907747620a5d24d944868ff619',
        '/etc/ld.so.conf.d/mesa-freeworld-lib64.conf,0644,28,a50ec22baae2e12761e5fcf0bdfec8563c59cd24586a065ad7cdb584ff773815',
        '/etc/ld.so.conf.d/mingw32-hostlib.conf,0644,27,3cc2feee654c7193027397a7f6ab41bd1c6db13fda295278205a050f870f3f3d',
        '/etc/ld.so.conf.d/mingw64-hostlib.conf,0644,29,df1b65371bead6dddc703346f56dde023e22d52d9f071a3b646beaaec75a53c9',
        '/etc/ld.so.conf.d/nessus.conf,0644,16,5a9dc65a4a0daa50ce9dd70ff3973fcceef9660cc3fdf5bb0beec8e0b6c57708',
        '/etc/ld.so.conf.d/opencollada.conf,0644,21,2fc9656a2b881ca4528416daa91fc525adaa97d73e96a18b41aa7856270eba1f',
        '/etc/ld.so.conf.d/perf.conf,0644,14,c67f871bdc72182dc75c160b16ca3b5371fdab76a27199a29f14b52a5aed1d3f',
        '/etc/ld.so.conf.d/pipewire-jack-x86_64-linux-gnu.conf,0644,45,b84c0e703c387e522837367d8db7b09d46aa3c39a476471643dda38faf5b226d',
        '/etc/ld.so.conf.d/pipewire-jack-x86_64.conf,0644,30,cf4cb69feaa8ec8b99558c4e1123518831b3c56488981cbc34a662fe218ef221',
        '/etc/ld.so.conf.d/R-x86_64.conf,0644,17,c9c072d721ce9e27ca1fdd30982777769d66e3c962cd86b2cfc2062d7c619585',
        '/etc/ld.so.conf.d/tix-x86_64.conf,0644,18,b2ef4843990ded5fd96e417fc08027a785fac59bd70eca6a26dd7b057542273a',
        '/etc/ld.so.conf.d/x86_64-linux-gnu.conf,0644,100,f03e4740e6922b4f4a1181cd696b52f62f9f10d003740a8940f7121795c59c98',
        '/etc/ld.so.conf.d/zz_i386-biarch-compat.conf,0644,56,4e3c617050427d51497a0e5969b0159421580cf5e7c9649e39f45b5e2fcb47b6',
        '/etc/ld.so.conf.d/zz_x32-biarch-compat.conf,0644,58,af55087d2769067a6a7c9069fd70f9ac2adb0e0ae29bfbd4e9df7504396c9bf2'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Process Extension Linux"
  description: Processes that have an unusual extension
  query: |
    SELECT
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      REGEX_MATCH (p0.path, '.*\/(.*?)$', 1) AS basename,
      REGEX_MATCH (p0.path, '.*\.(\w+)$', 1) AS extension,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      extension IS NOT NULL
      AND extension NOT IN (
        '0',
        '1',
        '2',
        '3',
        '4',
        '5',
        '7',
        '10',
        '11',
        '12',
        '13',
        '14',
        '15',
        '16',
        '17',
        '18',
        '19',
        '20',
        '21',
        '22',
        '23',
        '24',
        '25',
        '26',
        '27',
        '28',
        '29',
        '30',
        '31',
        '32',
        '33',
        '34',
        'AppImage',
        'backend',
        'basic',
        'bfd',
        'bin',
        'build',
        'emacs',
        'ext',
        'gtk3',
        'nox',
        'real',
        'smp',
        'test',
        'tiny'
      )
      AND NOT basename IN ('io.elementary.appcenter')
      AND NOT basename IN ('rpc.mountd')
      AND NOT basename LIKE 'kubectl-%'
      AND NOT basename LIKE 'ld-%.so'
      AND NOT basename LIKE 'python2.%'
      AND NOT basename LIKE 'python3.%'
      AND NOT basename LIKE 'emacs-%'
      AND NOT basename LIKE 'terraform-provider%'
      AND NOT basename LIKE 'unison-%'
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Tmp Executables Linux"
  description: Find unexpected executables in temp directories, often used by malware droppers
  query: |
    SELECT DISTINCT
      file.path,
      uid,
      gid,
      mode,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS extension,
      file.btime,
      file.ctime,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE -- Optimization: don't join things until we have a whittled down list of files
      file.path IN (
        SELECT DISTINCT
          path
        FROM
          file
        WHERE
          (
            file.directory = '/tmp'
            OR file.directory LIKE '/tmp/.%'
          ) -- Prevent weird recursion
          AND NOT file.directory LIKE '%/../%'
          AND NOT file.directory LIKE '%/./%' -- Exclude very temporary files
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
          AND file.type = 'regular'
          AND (
            file.mode LIKE '%7%'
            or file.mode LIKE '%5%'
            or file.mode LIKE '%1%'
          )
          AND NOT (
            uid > 500
            AND (
              file.path LIKE '%/go-build%'
              OR file.directory LIKE '/tmp/%/out'
              OR file.path IN ('/tmp/mission', '/tmp/mkinitramfs')
              OR file.path LIKE '/tmp/GoLand/___go_build_%_go'
              OR file.path LIKE '/tmp/ko%/out'
              OR file.path LIKE '/tmp/lima/%/out/%'
              OR file.path LIKE '/tmp/wolfi%'
              OR file.path LIKE '%-release%/%'
              OR file.path LIKE '%/bin/%'
              OR file.path LIKE '/tmp/%.sh'
              OR file.path LIKE '%/checkout/%'
              OR file.path LIKE '%/ci/%'
              OR file.path LIKE '%/configure'
              OR file.path LIKE '%/debug/%'
              OR file.path LIKE '%/dist/%'
              OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%'
              OR file.path LIKE '%/git/%'
              OR file.path LIKE '%/github/%'
              OR file.path LIKE '%/go.%.sum'
              OR file.path LIKE '%/guile-%/guile-%'
              OR file.path LIKE '%/ko/%'
              OR file.path LIKE '%/kots/%'
              OR file.path LIKE '%/melange-guest-%'
              OR file.path LIKE '%/pdf-tools/%'
              OR file.path LIKE '%/Rakefile'
              OR file.path LIKE '%/site-packages/markupsafe/_speedups.cpython-%'
              OR file.path LIKE '%/src/%'
              OR file.path LIKE '%/target/%'
              OR file.path LIKE '%/terraformer/%'
              OR file.path LIKE '%/tmp/epdf%'
              OR file.path LIKE '%integration_test%'
              OR file.path LIKE '%test_script'
              OR file.path LIKE "/tmp/lima/%"
              OR file.path LIKE "%/%/gradlew"
              OR file.path LIKE "%/bin/bash"
              OR file.path LIKE "%/bin/busybox"
              OR file.path LIKE "%/lib/%.so.%"
              OR file.path LIKE "%/lib/%.so"
              OR file.path LIKE "%/melange%"
            )
          )
          AND NOT (
            file.path LIKE "%/lib/%.so"
            OR file.path LIKE '/tmp/staged-updates%launcher'
            OR file.path LIKE "%/bin/bash"
            OR file.path LIKE "%/bin/busybox"
            OR file.path LIKE "%/lib/%.so.%"
            OR file.path LIKE "%/lib64/%.so.%"
            OR file.path LIKE "%/lib64/%.so"
            OR file.path LIKE "%/melange%"
            OR file.path LIKE "%/sbin/%"
          )
          -- Nix
          AND NOT (
            file.directory LIKE '/tmp/tmp%'
            AND gid = 0
            AND uid > 300
            AND uid < 350
          ) -- Babel
          AND NOT (
            file.directory LIKE '/tmp/babel-%/sh-script-%'
            AND gid > 900
            AND uid = 1000
            AND size < 1024
          ) -- Random Testdata
          AND NOT (
            gid > 900
            AND uid = 1000
            AND (
              file.directory LIKE '/tmp/%/test'
              OR file.directory LIKE '/tmp/%/testdata'
            )
          ) -- Don't alert if the file is only on disk for a moment
          AND NOT (
            uid > 500
            AND file.path LIKE '/tmp/terraform_%/terraform'
          )
          AND NOT (
            file.path LIKE '/tmp/%compressed'
            AND size < 4000
            AND uid > 500
          ) -- Executables too small to even hold '#!/bin/sh\nuid'
          AND NOT (
            file.type = 'regular'
            AND size < 10
          ) -- Weird cert
          AND NOT (
            file.path LIKE '/tmp/tmp.%/ssl/default-fake-certificate.pem'
            AND file.size < 4096
          ) -- Binaries we might actually see legitimately
          AND NOT (
            file.path LIKE '/tmp/%'
            AND file.uid > 500
            AND (
              file.filename LIKE "%ctl"
              OR file.filename LIKE "%adm"
              OR file.filename LIKE "%-cli"
              OR file.filename LIKE '.org.chromium.Chromium.%'
              OR file.filename = "a.out"
            )
          )
          AND NOT (
            file.directory LIKE "%/lib"
            OR file.directory LIKE "%/lib64"
            AND file.uid > 500
            AND (
              file.filename LIKE "%.so.%"
              OR file.filename LIKE "%.so"
            )
          )
      ) -- All checks with magic.data must first check for a lack of NULL value,
      -- otherwise you filter out platforms without magic.data.
      AND NOT (
        file.uid > 500
        AND magic.data IS NOT NULL
        AND (
          magic.data IN (
            "POSIX shell script, ASCII text executable",
            "Bourne-Again shell script, ASCII text executable",
            "libtool library file, ASCII text",
            "ASCII text",
            "JSON data",
            "JSON text data"
          )
          OR magic.data LIKE 'ELF 32-bit LSB pie executable, ARM, EABI5%'
          OR magic.data LIKE 'ELF 64-bit MSB pie executable, IBM S/390%'
          OR magic.data LIKE 'Linux kernel %'
          OR magic.data LIKE 'symbolic link to %'
          OR magic.data LIKE "ELF 64-bit LSB shared object,%"
          OR magic.data LIKE "gzip compressed data%" -- Exotic platforms
          OR magic.data LIKE "Unicode text%"
        )
      )
      AND NOT (
        file.uid = 0
        AND magic.data IS NOT NULL
        AND (
          magic.data LIKE 'symbolic link to %'
          OR magic.data IN (
            "ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1, stripped",
            "libtool library file, ASCII text"
          )
        )
      )
      AND NOT (
        file.size < 65000
        AND file.uid > 500
        AND file.filename LIKE "%.%"
        AND extension IN (
          'adoc',
          'api',
          'authn',
          'bat',
          'erb',
          'iam',
          'java',
          'js',
          'json',
          'log',
          'nib',
          'pem',
          'perl',
          'pl',
          'pub',
          'py',
          'rb',
          'registry',
          'script',
          'sh',
          'strings',
          'txt',
          'yaml',
          'yml'
        )
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Tmp Executables Macos"
  description: Find unexpected executables in temp directories, often used by malware droppers
  query: |
    SELECT DISTINCT
      file.path,
      uid,
      gid,
      mode,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1) AS extension,
      file.btime,
      file.ctime,
      file.mtime,
      file.type,
      file.size,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE -- Optimization: don't join things until we have a whittled down list of files
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.directory = '/tmp'
            OR file.directory LIKE '/tmp/.%'
            or file.directory LIKE '/tmp/.%/.%'
            OR file.directory LIKE '/tmp/.%/%'
            OR file.directory LIKE '/tmp/%'
            OR file.directory LIKE '/tmp/%/.%'
            OR file.directory LIKE '/tmp/%/%'
          ) -- Prevent weird recursion
          AND NOT file.directory LIKE '%/../%'
          AND NOT file.directory LIKE '%/./%' -- Exclude very temporary files
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
          AND file.type = 'regular'
          AND (
            file.mode LIKE '%7%'
            or file.mode LIKE '%1%'
            or file.mode LIKE '%5%'
          )
          AND NOT (
            uid > 500
            AND (
              file.path LIKE '%/go-build%'
              OR file.path LIKE '/tmp/%/AdobePIM.dylib'
              OR file.path LIKE '/tmp/%ctl'
              OR file.path LIKE '/tmp/com.apple.installer%'
              OR file.path LIKE '/tmp/flow/%.npmzS_cacachezStmpzSgit-clone%'
              OR file.path LIKE '/tmp/GoLand/___Test%.test'
              OR file.path LIKE '/tmp/KSInstallAction.%/m/.keystone_install'
              OR file.path LIKE '/tmp/lima/%'
              OR file.path LIKE '/tmp/melange%'
              OR file.path LIKE '%-release%/%'
              OR file.path LIKE '%.tfstate.sh'
              OR file.path LIKE '%/bin/%'
              OR file.path LIKE '%/CCLBS/%'
              OR file.path LIKE '%/checkout/%'
              OR file.path LIKE '%/ci/%'
              OR file.path LIKE '%/debug/%'
              OR file.path LIKE '%/dist/%'
              OR file.path LIKE '%/elastic-agent-%'
              OR file.path LIKE '%/etc/network/if-up.d/%'
              OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%'
              OR file.path LIKE '%/git/%'
              OR file.path LIKE '%/github/%'
              OR file.path LIKE '%/go.%.sum'
              OR file.path LIKE '%/guile-%/guile-%'
              OR file.path LIKE '%/ko/%'
              OR file.path LIKE '%/kots/%'
              OR file.path LIKE '%/nix/%'
              OR file.path LIKE '%/pdf-tools/%'
              OR file.path LIKE '%/Photoshop Installer.app/Contents/%'
              OR file.path LIKE '%/sbin/%'
              OR file.path LIKE '%/site-packages/markupsafe/_speedups.cpython-%'
              OR file.path LIKE '%/src/%'
              OR file.path LIKE '%/target/%'
              OR file.path LIKE '%/terraformer/%'
              OR file.path LIKE '%/tmp/epdf%'
              OR file.path LIKE "%/%/gradlew"
              OR file.path LIKE "%/lib/%.so.%"
              OR file.path LIKE "%/lib/%.so"
              OR file.filename IN (
                'chainctl',
                'configure',
                'cosign',
                'golangci-lint',
                'goreleaser',
                'grype',
                'mysqld_exporter'
              )
            )
          )
          -- Melange
          AND NOT file.directory LIKE '/tmp/melange-guest-%'
          -- Nix
          AND NOT (
            file.directory LIKE '/tmp/tmp%'
            AND gid = 0
            AND uid > 300
            AND uid < 350
          ) -- Babel
          AND NOT (
            file.directory LIKE '/tmp/babel-%/sh-script-%'
            AND gid > 900
            AND uid = 1000
            AND size < 1024
          ) -- Random Testdata
          AND NOT (
            gid > 900
            AND uid = 1000
            AND (
              file.directory LIKE '/tmp/%/test'
              OR file.directory LIKE '/tmp/%/testdata'
            )
          ) -- macOS updates
          AND NOT file.directory LIKE '/tmp/msu-target-%' -- I don't know man. I don't work here.
          AND NOT file.directory LIKE '/tmp/UpdateBrain-%/AssetData/com.apple.MobileSoftwareUpdate.UpdateBrainService.xpc/Contents/MacOS' -- terraform
          AND NOT file.directory LIKE '/tmp/staged-updates%'
          AND NOT (
            uid > 500
            AND file.path LIKE '/tmp/terraform_%/terraform'
          )
          AND NOT (
            file.path LIKE '/tmp/%compressed'
            AND size < 4000
            AND uid > 500
          ) -- Executables too small to even hold '#!/bin/sh\nuid'
          AND NOT (
            file.type = 'regular'
            AND size < 10
          ) -- TODO: Remove this hardcoded entry after Apr 2023
          AND NOT (
            file.path = '/tmp/policy-tester'
            AND file.uid = 501
            AND file.gid = 20
            AND file.size = 90921938
          )
      )
      AND NOT signature.authority IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)'
      )
      AND NOT (
        magic.data IN ('JSON data', 'ASCII text')
        OR magic.data LIKE 'ELF %-bit %SB executable%'
        OR magic.data LIKE 'symbolic link to %'
        OR magic.data LIKE 'ELF %-bit LSB shared object%'
        OR magic.data LIKE 'libtool library file,%'
        OR magic.data LIKE "POSIX shell script, ASCII text executable%"
        OR (
          file.size < 50000
          AND file.uid > 500
          AND extension IN (
            'adoc',
            'bat',
            'conf',
            'java',
            'js',
            'json',
            'log',
            'md',
            'nib',
            'pem',
            'perl',
            'pl',
            'py',
            'rb',
            'script',
            'sh',
            'status',
            'strings',
            'txt',
            'yaml',
            'yml'
          )
          AND (
            magic.data IS NULL
            OR magic.data NOT LIKE "%Mach-O%"
          )
        )
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Var Run Linux"
  description: Find unexpected regular files in /var/run
  query: |
    SELECT
      file.filename,
      uid,
      gid,
      mode,
      file.ctime,
      file.atime,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      file.directory = "/var/run"
      AND file.type = "regular"
      AND file.filename NOT IN (
        'acpid.pid',
        'adduser',
        'agetty.reload',
        'alsactl.pid',
        'apcupsd.pid',
        'apport.lock',
        'atd.pid',
        'atopacctd.pid',
        'auditd.pid',
        'bluetooth.blocked',
        'bootupd-lock',
        'casper-md5check.json',
        'com.rapid7.cnchub.pid',
        'com.rapid7.component_insight_agent.pid',
        'com.rapid7.ir_agent.pid',
        'cron.reboot',
        'crond.pid',
        'crond.reboot',
        'dmeventd.pid',
        'dnf-metadata.lock',
        'do-not-hibernate',
        'docker.pid',
        'firefox-restart-required',
        'gdm3.pid',
        'greetd.run',
        'gssproxy.pid',
        'haproxy.pid',
        'keyd.socket.lock',
        'libvirtd.pid',
        'lightdm.pid',
        'lima-boot-done',
        'lima-ssh-ready',
        'lxcfs.pid',
        'machine-id',
        'mcelog.pid',
        'metalauncher.pid',
        'motd',
        'motd.dynamic',
        'multipathd.pid',
        'nginx.pid',
        'nvidia-powerd.pid',
        'nvidia_runtimepm_enabled',
        'nvidia_runtimepm_supported',
        'ostree-booted',
        'pacct_source',
        'pulseaudio-enable-autospawn',
        'reboot-required',
        'reboot-required.pkgs',
        'rsyslogd.pid',
        'sm-notify.pid',
        'sshd.pid',
        'ublue-update.lock',
        'ufw.lock',
        'unattended-upgrades.lock',
        'unattended-upgrades.pid',
        'unattended-upgrades.progress',
        'usbmuxd.pid',
        'utmp',
        'uupd.lock',
        'virtlockd.pid',
        'virtlogd.pid',
        'xtables.lock',
        'zed.pid',
        'zed.state',
        'zfs_fs_name',
        'zfs_unlock_complete'
      )
      AND NOT file.filename LIKE 'u-d-c-%'
    GROUP BY
      file.path;
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unusual Executable Name Linux"
  description: Processes with executable names that feel weird
  query: |
    SELECT
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS pname,
      COALESCE(
        REGEX_MATCH (p0.path, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        pname LIKE "%kthread%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%-help"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%flush%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{16,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR REGEX_MATCH (pname, "^(\W)", 1) != ""
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com", "test")
      )
      AND NOT pname LIKE '.%-wrapped'
      AND NOT pname LIKE '__debug_bin%'
      AND NOT pname LIKE '__Test%.test'
      AND pname NOT IN (
        "acpid",
        "cpu_sup",
        "akonadi_followupreminder_agent",
        "gmenudbusmenuproxy",
        "irqbalance",
        "kactivitymanagerd",
        "nm-applet",
        "nm-dispatcher",
        "xdg-dbus-proxy",
        "xdg-desktop-portal-gnome",
        "xdg-desktop-portal-gtk",
        "xdg-desktop-portal-kde",
        "xdg-desktop-portal-regolith",
        "xdg-desktop-portal-xapp",
        'xdg-desktop-portal-wlr',
        "xdg-desktop-portal",
        "xdg-document-portal",
        "xdg-permission-store",
        "xwaylandvideobridge"
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unusual Executable Name Macos"
  description: Processes with executable names that feel weird
  query: |
    SELECT
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS pname,
      COALESCE(
        REGEX_MATCH (p0.path, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        pname LIKE "%kthread%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%-help"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%flush%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{16,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR REGEX_MATCH (pname, "^(\W)", 1) != ""
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT pname IN (
        'at.obdev.littlesnitch.networkextension',
        'at.obdev.littlesnitchmini.networkextension',
        'com.microsoft.teams2.notificationcenter',
        'cpu',
        'dynamiclinkmediaserver',
        'dynamiclinkmanager',
        'EcammLiveVideoOutAssistantXPCHelper',
        'launchd_startx',
        'OneSignalNotificationServiceExtension',
        'test',
        'ThingsWidgetExtensionMacAppStore',
        'TwitterNotificationServiceExtension',
        'usercontextservice'
      )
      AND NOT pname LIKE '___%Test_%.test'
      AND NOT pname LIKE '__%go_build_%'
      AND NOT pname LIKE '__%go_test_%'
      AND NOT pname LIKE '__Test%'
      AND NOT pname LIKE '%.test'
      AND NOT pname LIKE '.%-wrapped'
      AND NOT pname LIKE 'BetterTouch%Runner%'
      AND NOT pname LIKE 'cody-engine-%'
      -- example: 85C27NK92C.com.flexibits.fantastical2.mac.helper
      AND NOT pname LIKE "%.com.flexibits.fantastical2.mac.helper"
      AND NOT s.authority = "Software Signing"
      AND NOT (
        s.authority = 'Developer ID Application: Adobe Inc. (JQ525L2MZD)'
        AND pname = 'agcinvokerutility'
      )
      AND NOT p0.path LIKE '/nix/store/%'
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unusual Process Name Linux"
  description: Processes with executable names that feel weird
  query: |
    SELECT
      p0.name AS pname,
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS basename,
      COALESCE(
        REGEX_MATCH (p0.name, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.start_time < (strftime('%s', 'now') - 43200)
      AND (
        pname LIKE "%kthread%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%-help"
        OR pname LIKE "%/%"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%flush%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{18,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR (
          REGEX_MATCH (pname, "^(\W)", 1) != ""
          AND p0.path NOT LIKE "/nix/store/%/.%-wrapped"
        )
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT p1_pid = 2
      AND NOT p0_pid = 2
      AND NOT pname LIKE '.%-wrap%'
      AND NOT pname IN ('xdg-open', 'nm-openvpn-auth', 'MainThread')
      AND p0.path NOT LIKE "/nix/store/%"
      AND basename NOT IN (
        "acpid",
        "busybox",
        "nm-openvpn-auth",
        "com.docker.backend",
        "nm-openvpn-service",
        "com.docker.build",
        "com.docker.extensions",
        "cpulimit",
        "dynamiclinkmanager",
        'firefox',
        'firefox-bin',
        "gmenudbusmenuproxy",
        "irqbalance",
        "kactivitymanagerd",
        "nm-applet",
        "perl",
        'pk-debconf-helper',
        "pt_main_thread",
        "systemd",
        "systemd-executor",
        'udevadm',
        "xdg-dbpus-proxy",
        'xdg-dbus-proxy',
        "xdg-desktop-portal",
        "xdg-desktop-portal-gnome",
        "xdg-desktop-portal-gtk",
        "xdg-desktop-portal-kde",
        "xdg-desktop-portal-regolith",
        'xdg-desktop-portal-wlr',
        "xdg-desktop-portal-xapp",
        "xdg-document-portal",
        'xdg-open',
        "xdg-permission-store",
        "xwaylandvideobridge"
      )
      AND basename NOT LIKE '___Test%'
      AND basename NOT LIKE '___2Test%'
      AND NOT (
        basename IN ('nm-dispatcher')
        AND p1_pid = 1
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unusual Process Name Macos"
  description: Processes with executable names that feel weird
  query: |
    SELECT
      p0.name AS pname,
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS basename,
      COALESCE(
        REGEX_MATCH (p0.name, '.*/.*\.([a-z]{2,4})$', 1),
        ""
      ) AS pext,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.start_time < (strftime('%s', 'now') - 43200)
      AND (
        pname LIKE "%kthread%"
        OR pname LIKE '%xprotect%'
        OR pname LIKE "%-help"
        OR pname LIKE "%/%"
        OR pname LIKE "%acpi%"
        OR pname LIKE "%crypt%"
        OR pname LIKE "%flush%"
        OR pname LIKE "%initd%"
        OR pname LIKE "%irq%"
        OR pname LIKE "%kaudit%"
        OR pname LIKE "%kdev%"
        OR pname LIKE "%kdmp%"
        OR pname LIKE "%ksoft%"
        OR pname LIKE "%kswap%"
        OR pname LIKE "%kworker%"
        OR pname LIKE "%launchd%"
        OR pname LIKE "%nvme%"
        OR pname LIKE "%tasks%"
        OR pname LIKE "%thread%"
        OR pname LIKE "%user_dir%"
        OR pname LIKE "%xdg%"
        OR pname LIKE "%zswap%"
        OR pname LIKE "cpu%"
        OR pname LIKE "events%"
        OR pname LIKE "idle_%"
        OR pname LIKE "mm-%"
        OR pname LIKE "nm_%"
        OR pname LIKE "rcu%"
        OR REGEX_MATCH (pname, '([a-z]{16,})', 1) != ""
        OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})', 1) != ""
        OR REGEX_MATCH (pname, '(\w{40,})', 1) != ""
        OR REGEX_MATCH (
          pname,
          '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',
          1
        ) != ""
        OR REGEX_MATCH (pname, "([a-z].*[A-Z].*\d+.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d.*[a-z].*\d.*[a-z].*\d+)", 1) != ""
        OR REGEX_MATCH (pname, "(\d{5,})", 1) != ""
        OR REGEX_MATCH (pname, "^(\d\d)", 1) != ""
        OR (
          REGEX_MATCH (pname, "^(\W)", 1) != ""
          AND NOT (
            p0.path LIKE "/nix/store/%/.%-wrapped"
            OR p0.path LIKE "/etc/profiles-per-user/%"
          )
        )
        OR (
          REGEX_MATCH (pname, "(\W)$", 1) != ""
          AND pname NOT LIKE "%)"
        )
        AND pext NOT IN ("", "gui", "cli", "us", "node", "com")
      )
      AND NOT pname IN (
        'at.obdev.littlesnitch.endpointsecurity',
        'at.obdev.littlesnitch.networkextension',
        'at.obdev.littlesnitchmini.networkextension',
        'BetterTouchToolAppleScriptRunner',
        'OneSignalNotificationServiceExtension',
        'BetterTouchToolAppleScriptRunner3',
        'BetterTouchToolShellScriptRunner',
        'com.microsoft.teams2.notificationcenter',
        'cpu',
        'dynamiclinkmanager',
        'dynamiclinkmediaserver',
        'EcammLiveVideoOutAssistantXPCHelper',
        'EncryptMe',
        'launchd_startx',
        'ThingsWidgetExtensionMacAppStore',
        'TwitterNotificationServiceExtension',
        'usercontextservice',
        'xdg-open'
      )
      -- example: 85C27NK92C.com.flexibits.fantastical2.mac.helper
      AND NOT pname LIKE '___1Test%'
      AND NOT pname LIKE '___Test%'
      AND NOT pname LIKE '__%go_build%'
      AND NOT pname LIKE '__debug_bin%'
      AND NOT pname LIKE '%-macos-arm64'
      AND NOT pname LIKE 'BetterTouchToolAppleScriptRunner%'
      AND NOT pname LIKE 'cody-engine-%'
      AND NOT pname LIKE 'debug.test%'
      AND NOT pname LIKE "%.com.flexibits.fantastical2.mac.helper"
      AND NOT s.authority IN (
        "Software Signing",
        "Apple Mac OS Application Signing"
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Executables From The Future"
  description: Programs which claim to be from the future, based on (btime,ctime,mtime)
  query: |
    SELECT
      p.pid,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      f.ctime,
      f.btime,
      f.mtime,
      p.start_time,
      f.mtime > (strftime('%s', 'now') + 43200) AS mtime_newer,
      f.ctime > (strftime('%s', 'now') + 43200) AS ctime_newer,
      f.btime > (strftime('%s', 'now') + 43200) AS btime_newer,
      f.mtime - strftime('%s', 'now') AS mtime_diff,
      f.ctime - strftime('%s', 'now') AS ctime_diff,
      f.btime - strftime('%s', 'now') AS btime_diff,
      strftime('%s', 'now') AS now_ts,
      hash.sha256 AS child_hash256,
      pp.path AS parent_path,
      pp.cmdline AS parent_cmd,
      pp.cwd AS parent_cwd,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      (
        mtime_newer == 1
        OR ctime_newer == 1
        OR btime_newer == 1
      )
      AND NOT p.path LIKE '/Applications/Signal.app%'
      AND NOT p.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
      -- 2038
      AND NOT f.mtime > 2153484373
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Cwd Events Linux"
  description: Programs running with a hidden current working directory (event-based)
  query: |
    SELECT
      COALESCE(
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*?)\/", 1),
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*)", 1)
      ) AS hidden_base,
      REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*)", 1) AS hidden_part,
      COALESCE(
        REGEX_MATCH (TRIM(pe.cwd, '"'), '.*/(.*)', 1),
        pe.cwd
      ) AS basename,
      CONCAT (
        COALESCE(
          REGEX_MATCH (TRIM(pe.path, '"'), '.*/(.*)', 1),
          pe.path
        ),
        ',',
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*?)\/", 1),
        REGEX_MATCH (TRIM(pe.cwd, '"'), "/(\..*)", 1)
      ) AS exception_key,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      TRIM(pe.cwd, '"') AS p0_cwd,
      pe.status AS p0_status,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      p1.cwd AS p1_cwd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name
    FROM
      process_events pe
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.time > (strftime('%s', 'now') -60660)
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
    WHERE
      pe.time > (strftime('%s', 'now') -60600)
      AND pe.cwd LIKE '%/.%'
      AND NOT (
        hidden_base IN (
          '.cache',
          '.cargo',
          '.config',
          '.docker',
          '.emacs.d',
          '.gimme',
          '.git',
          '.github',
          '.gmailctl',
          '.gradle',
          '.kotlin',
          '.linuxbrew',
          '.local',
          '.npm',
          '.oh-my-zsh',
          '.provisio',
          '.terraform.d',
          '.vim',
          '.vscode-oss',
          '.vscode',
          '.zsh'
        )
        OR exception_key LIKE '%sh,~/.Trash'
        OR exception_key IN ('git,.test')
      )
      AND NOT pe.cwd LIKE '%/build/%'
      AND NOT pe.cwd LIKE '%/out/%'
    GROUP BY
      p.cmdline,
      p.cwd;
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Executable"
  description: Programs running with a hidden file path or process name
  query: |
    SELECT
      f.directory,
      f.btime,
      p0.start_time,
      RTRIM(
        COALESCE(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '([/~].*?/.*?)/',
            1
          ),
          f.directory
        ),
        "/"
      ) AS top2_dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(f.directory, u.directory, '~'),
          '([/~].*?/.*?/.*?)/',
          1
        ),
        REPLACE(f.directory, u.directory, '~')
      ) AS top3_dir,
      REPLACE(f.directory, u.directory, '~') AS homedir,
      REPLACE(f.path, u.directory, '~') AS homepath,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      (
        p0.name LIKE '.%'
        OR f.filename LIKE '.%'
        OR f.directory LIKE '%/.%'
      )
      AND NOT homedir LIKE '%/node_modules/.%'
      -- exclude top-level hidden home directories (there are many)
      AND NOT (
        homedir LIKE '~/.%'
        AND NOT homedir LIKE '~/.config/%'
        AND NOT homedir LIKE '~/.cache/%'
      )
      AND NOT homedir LIKE '~/%/node_modules/.bin%'
      AND NOT homepath LIKE '~/%arm64%'
      AND NOT homepath LIKE '~/%x86_64%'
      AND NOT top2_dir IN (
        '/nix/store/.links',
        '/var~/.local',
        '~/.goenv',
        '~/.vs-kubernetes',
        '~/chainguard-images',
        '~/code',
        '~/Code',
        '~/Projects',
        '~/projects',
        '~/git',
        '~/repos',
        '~/src'
      )
      AND NOT top3_dir IN (
        '/home/linuxbrew/.linuxbrew',
        '/var~/.local/share',
        '~/.cache/gitstatus',
        '~/.cache/cloud-code',
        '~/.cache/go-build',
        '~/.cache/JetBrains',
        '~/.cache/rod',
        '~/.cache/selenium',
        '~/.config/bluejeans-v2',
        '~/.config/Code',
        '~/.config/nvm',
        '~/Documents/GitHub',
        '~/node_modules/.bin',
        '~/thinkorswim/.install4j'
      )
      AND NOT f.directory = '/nix/store/.links'
      AND NOT f.directory LIKE '%/.terraform/%'
      AND NOT f.directory LIKE '%/.zig-cache/%'
      AND NOT f.directory LIKE '%/anchore/grype/.tool%'
      AND NOT f.directory LIKE '%/Applications/PSI Bridge Secure Browser.app/Contents/Resources/.apps/darwin/%'
      AND NOT f.directory LIKE '%/com.jetbrains.GoLand/cache/JetBrains/GoLand%'
      AND NOT f.directory LIKE '/Applications/Corsair iCUE5 Software/.cuepkg-%'
      AND NOT f.directory LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%'
      AND NOT f.directory LIKE '/var/home/linuxbrew/.linuxbrew/Homebrew/%'
      AND NOT f.directory LIKE '/Volumes/com.getdropbox.dropbox-%'
      AND NOT f.path LIKE '/nix/store/%/%-wrapped'
      AND NOT homepath LIKE '~/.ape-1%'
      AND NOT (
        f.path LIKE '/nix/store/%'
        AND p0.name LIKE '%-wrappe%'
      )
      AND NOT homedir LIKE '%/.Trash/1Password %.app/Contents/Library/LoginItems/1Password Extension Helper.app/Contents/MacOS'
      AND NOT homedir LIKE '%/.Trash/Logi Options.app/Contents/Support/LogiMgrDaemon.app/Contents/MacOS'
      AND NOT homedir LIKE '/Users/%/.Trash/lghub.app/Contents/MacOS/lghub_agent.app/Contents/MacOS'
      AND NOT homedir LIKE '~/%/.venv/bin'
      AND NOT homedir LIKE '~/.local/share/AppImage/ZenBrowser.AppImage'
      AND NOT homedir LIKE '~/.Trash/1Password %.app/Contents/Library/LoginItems/1Password Extension Helper.app/Contents/MacOS'
      AND NOT homedir LIKE '~/Library/Application Support/Code/User/globalStorage/ms-dotnettools.vscode-dotnet-runtime/.dotnet/%'
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
    GROUP BY
      f.path
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Home Config Dir"
  description: Find unexpected hidden files in a users config directory
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE "/home/%/.config/.%"
        OR file.path LIKE '/home/%/.config/.%/%'
        OR file.path LIKE '/home/%/.config/%%/.%/.%'
        OR file.path LIKE '/home/%/.config/%%/.%/%'
        OR file.path LIKE '/root/.%/.%/%'
        OR file.path LIKE '/root/.config/.%/%'
        OR file.path LIKE '/root/.config/%%/.%/.%'
        OR file.path LIKE '/root/.config/%%/.%/%'
      )
      AND file.path NOT LIKE '/home/%/.config/.gsd-keyboard.settings-ported'
      AND file.path NOT LIKE '/home/%/.config/.org.chromium.Chromium.%'
      AND file.path NOT LIKE '/home/%/.config/%/.git%'
      AND file.path NOT LIKE '/root/.cache/.flatpak/%'
      AND file.path NOT LIKE '/root/.debug/.build-id/%'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Home Library Dir"
  description: Find unexpected hidden files in a users Library directory
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      REPLACE(file.directory, u.directory, '~') AS homedir,
      file.gid,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN users u ON file.uid = u.uid
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      (
        file.path LIKE '/Users/%/Library/%%/.%/%%'
        OR file.path LIKE '/Users/%/Library/.%/%%'
        OR file.path LIKE '/Users/%/Library/%%/.%/.%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND NOT homedir IN (
        '~/Library/Accessibility/.com.apple.RTTTranscripts_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Application Support/.keymapp',
        '~/Library/Caches/.adobe/c2pa_cache',
        '~/Library/Caches/.sigstore/gitsign',
        '~/Library/com.apple.groupkitd/.syncedGroupStore_SUPPORT/_EXTERNAL_DATA',
        '~/Library/com.apple.groupkitd/.syncedGroupStore_SUPPORT/_EXTERNAL_DATA/',
        '~/Library/Finance/.finance_cloud_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Finance/.finance_dropbox_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Finance/.finance_local_SUPPORT/_EXTERNAL_DATA',
        '~/Library/Group Containers/.SiriTodayViewExtension',
        '~/Library/Group Containers/.SiriTodayViewExtension/Library',
        '~/Library/GroupContainersAlias/.SiriTodayViewExtension',
        '~/Library/GroupContainersAlias/.SiriTodayViewExtension/Library',
        '~/Library/HomeKit/.core-cloudkit-shared_SUPPORT/_EXTERNAL_DATA',
        '~/Library/HomeKit/.core-cloudkit_SUPPORT/_EXTERNAL_DATA',
        '~/Library/pnpm/.tools/pnpm',
        '~/Library/Preferences/.wrangler',
        '~/Library/Preferences/.wrangler/config',
        '~/Library/Saved Searches/.DockTags',
        '~/Library/Stickers/.stickers_SUPPORT/_EXTERNAL_DATA'
      )
      AND NOT homedir LIKE '~/Library/.icedove/%'
      AND NOT homedir LIKE '~/Library/%/.%_SUPPORT/_EXTERNAL_DATA'
      AND NOT homedir LIKe '~/Library/Caches/.git%'
      AND NOT homedir LIKE '~/Library/Mobile Documents/.Trash%'
      -- ugh
      AND NOT file.path LIKE '/Library/Application Scripts/.%-%-%-%-%/.%'
      AND NOT homedir LIKE '~/Library/Application Scripts/.%-%-%-%-%'
      AND NOT homedir LIKE '~/Library/Application Scripts/.%-%-%-%-%/.%'
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Name Path Mismatch"
  description: Processes that have an unrelated name in the process tree than the program on disk.
  query: |
    SELECT
      SUBSTR(
        COALESCE(
          -- TODO: Fix to not require filename!
          REGEX_MATCH (f.filename, '(.*?)\W', 1),
          f.filename
        ),
        0,
        6
      ) AS short_filename,
      COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS basename,
      COALESCE(
        REGEX_MATCH (p0.path, '.*/([a-zA-Z]+)', 1),
        p0.path
      ) AS base_letters,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path),
        ',',
        p0.name
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.path != ''
      AND NOT p0.name == basename
      AND NOT (
        LENGTH(basename) > 1
        AND basename == short_filename
      )
      AND NOT (
        LENGTH(p0.name) > 2
        AND INSTR(LOWER(basename), LOWER(p0.name)) > 0
      )
      AND NOT (
        LENGTH(short_filename) > 2
        AND INSTR(LOWER(p0.name), LOWER(short_filename)) > 0
      ) -- Extremely common and unpredictable process name setters
      AND NOT base_letters IN (
        'bash',
        'busybox',
        'dash',
        'electron',
        'firefox',
        'gjs',
        'librewolf',
        'node',
        'perl',
        'python',
        'ruby',
        'systemd',
        'thunderbird',
        'vim'
      )
      AND NOT exception_key IN (
        '0,newgrp,sg',
        '0,systemd-executor,(sd-pam)',
        '0,udevadm,(udev-worker)',
        '0,udevadm,systemd-udevd',
        '112,systemd-executor,(sd-pam)',
        '120,systemd-executor,(sd-pam)',
        '128,systemd-executor,(sd-pam)',
        '42,systemd-executor,(sd-pam)',
        '500,busybox,sh',
        '500,chainctl,docker-credenti',
        '500,coreutils,tail',
        '500,docker,code',
        '500,gjs-console,daemon.js',
        '500,gjs-console,gnome-character',
        '500,libgvc6-config-update,dot',
        '500,mate-session,x-session-manag',
        '500,nc.openbsd,nc',
        '500,netcat,nc',
        '500,plugin-container,MainThread',
        '500,pyrogenesis,main',
        '500,rootlesskit,exe',
        '500,rootlessport,exe',
        '500,systemd-executor,(sd-pam)',
        '500,udevadm,(udev-worker)',
        '500,udevadm,systemd-udevd',
        '500,vim.basic,vi',
        '500,vim.nox,vi',
        '500,vim.tiny,vi',
        '500,x86_64-linux-gnu-as,as'
      )
      AND NOT exception_key LIKE '%,systemd,(sd-pam)'
      AND NOT (
        p0.path LIKE '/usr/lib/%/panel/wrapper-2.0'
        AND exception_key LIKE '500,wrapper-2.0,panel-%'
      )
      AND NOT p0.path IN ('/usr/lib/systemd/systemd')
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
    GROUP by
      exception_key
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Parent Missing From Disk Linux"
  description: A program where the parent PID is not on disk
  query: |
    SELECT -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      p1.path AS p1_path,
      REGEX_MATCH (p1.path, '(.*)/', 1) AS p1_dirname,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p1.on_disk != 1
      AND p0.on_disk = 1
      AND NOT p0.pid IN (1, 2)
      AND NOT p1.pid IN (1, 2) -- launchd, kthreadd
      -- Probably a software upgrade
      AND NOT p1_dirname IN (
        '/opt/google/chrome',
        '/opt/microsoft/msedge',
        '/usr/bin',
        '/usr/lib',
        '/usr/lib/electron22',
        '/usr/lib/go/bin',
        '/usr/lib/systemd',
        '/usr/libexec',
        '/usr/sbin',
        '/usr/sbin/gdm3',
        '/usr/share/code',
        '/usr/share/codium'
      ) -- long-running launchers
      AND NOT p1.name IN (
        'bash',
        'chrome',
        'dnf',
        'Docker Desktop',
        'electron',
        'fish',
        'gnome-shell',
        'gnome-terminal',
        'kube-proxy',
        'kubelet',
        'lightdm',
        'make',
        'ninja',
        'nvim',
        'sh',
        'slack',
        'zed-editor'
      )
      AND NOT (
        p1.path LIKE '/app/%'
        AND p1.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/%'
      )
      AND NOT (
        p1.path LIKE '/home/build/%'
        AND p1.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/%'
      )
      AND NOT p2.name = 'bwrap'
      AND p1.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p1.cgroup_path NOT IN (
        '/system.slice/containerd.service',
        '/system.slice/docker.service',
        '/system.slice/gdm.service'
      )
      AND p1.cgroup_path NOT LIKE '/lxc.monitor.n%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-steam@%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/docker-%'
      AND p1.path NOT LIKE '/opt/homebrew/Cellar/%'
      AND p1.path NOT LIKE '/tmp/.mount_%/%'
      AND p1.path NOT LIKE '%google-cloud-sdk/.install/.backup%'
      AND NOT (
        p1.name LIKE 'kworker/%+events_unbound'
        AND p0.name IN ('modprobe')
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Parent Missing From Disk Macos"
  description: A program where the parent PID is not on disk
  query: |
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          p.pid
        FROM
          processes p
          -- NOTE: This is an expensive join on macOS
          JOIN processes pp ON p.parent = pp.pid
        WHERE
          p.parent NOT IN (0, 1, 2)
          AND p.path != ""
          -- macOS Optimization
          AND p.path NOT LIKE '/sbin/%'
          AND p.path NOT LIKE '/System/%'
          AND p.path NOT LIKE '/usr/bin/%'
          AND p.path NOT LIKE '/usr/libexec/%'
          -- Exceptions
          AND pp.path NOT LIKE '/opt/homebrew/Cellar/%'
          AND pp.path NOT LIKE '/private/var/folders/%/T/PKInstallSandboxTrash/%.sandboxTrash/%'
          AND pp.path NOT LIKE '%google-cloud-sdk/.install/.backup%'
          AND pp.path NOT IN (
            '/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper',
            "",
            "/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin)",
            "/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper",
            "/sbin/launchd",
            "/var/lib/incus/containers"
          )
          AND pp.on_disk != 1
      );
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Ssh Notty"
  description: "Find ssh sessions that are hiding from 'w'/'who'"
  query: |
    SELECT
      *
    FROM
      (
        SELECT
          p.pid,
          p.name,
          p.cmdline AS cmd,
          p.start_time,
          p.cwd,
          cp.name AS child_name,
          cp.cmdline AS child_cmd,
          gcp.name AS grandchild_name,
          gcp.cmdline AS grandchild_cmd,
          GROUP_CONCAT(DISTINCT pof.path) AS open_files
        FROM
          processes p
          LEFT JOIN process_open_files pof ON p.pid = pof.pid
          LEFT JOIN processes cp ON p.pid = cp.parent
          LEFT JOIN processes gcp ON cp.pid = gcp.parent
        WHERE
          p.name = 'sshd'
        GROUP BY
          p.pid
      )
    WHERE
      (
        INSTR(cmd, '@notty') > 0
        OR (
          open_files != '/dev/null'
          AND INSTR(open_files, '/dev/ptmx') = 0
        )
      )
      -- You must specifically check for NULL here, or risk inadvertently filtering everything out.
      AND (
        grandchild_name IS NULL
        OR grandchild_name != 'zfs'
      )
      AND child_name IS NOT NULL
      AND child_name NOT IN ('', 'zfs')
      AND child_cmd NOT LIKE '%osquery-defense-kit%make verify'
      AND grandchild_cmd NOT LIKE '%osquery-defense-kit%make verify'
      AND grandchild_name NOT IN ('unison')
      AND cmd != 'sshd: docker@notty'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Dev Entries"
  description: Find unexpected files in /dev
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/dev/shm/%%'
        OR file.path LIKE '/dev/.%'
        OR file.path LIKE '/dev/.%/%'
        OR file.path LIKE '/dev/%/.%'
        OR file.path LIKE '/dev/%%/.%/%'
        OR file.path LIKE '/dev/mqueue/%%'
      )
      AND NOT (
        file.uid > 499
        AND (
          file.path LIKE '/dev/shm/.com.google.%'
          OR file.path LIKE '/dev/shm/.com.microsoft.Edge.%'
          OR file.path LIKE '/dev/shm/.org.chromium.%'
          OR file.path LIKE '/dev/shm/aomshm.%'
          OR file.path LIKE '/dev/shm/byobu-%'
          OR file.path LIKE '/dev/shm/jack_db%'
          OR file.path LIKE '/dev/shm/lsp-catalog-%.lock'
          OR file.path LIKE '/dev/shm/pulse-shm-%'
          OR file.path LIKE '/dev/shm/sem.%autosave'
          OR file.path LIKE '/dev/shm/shm-%-%-%'
          OR file.path LIKE '/dev/shm/u1000-Shm%'
          OR file.path LIKE '/dev/shm/u1000-Valve%'
          OR file.path LIKE '/dev/shm/wayland.mozilla.%'
          OR file.path LIKE '/dev/shm/CefRaster%'
          OR file.path LIKE '/dev/shm/xapp-tmp-%'
          OR file.path LIKE '/dev/mqueue/us.zoom.aom.globalmgr.%.rpc'
        )
      )
      AND NOT (
        file.size <= 32
        AND file.path LIKE '/dev/shm/%'
      )
      AND file.path NOT LIKE '/dev/shm/flatpak-%'
      AND file.path NOT LIKE '/dev/shm/libpod_rootless_lock_%'
      AND file.path NOT LIKE '/dev/shm/lttng-ust-wait-%'
      AND file.path NOT LIKE '/dev/shm/sem.mp-%'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.path NOT IN (
        '/dev/.mdadm/',
        '/dev/shm/libpod_lock',
        '/dev/shm/sem.camlock'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Hidden System Paths"
  description: Find unexpected hidden directories in operating-system folders
  query: |
    SELECT
      file.path,
      file.inode,
      file.directory,
      uid,
      gid,
      mode,
      atime,
      btime,
      mtime,
      ctime,
      type,
      size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/lib/.%'
        OR file.path LIKE '/.%'
        OR file.path LIKE '/bin/%/.%'
        OR file.path LIKE '/dev/.%'
        OR file.path LIKE '/etc/.%'
        OR file.path LIKE '/etc/%/.%'
        OR file.path LIKE '/lib/%/.%'
        OR file.path LIKE '/libexec/.%'
        OR file.path LIKE '/Library/.%'
        OR file.path LIKE '/sbin/.%'
        OR file.path LIKE '/sbin/%/.%'
        OR file.path LIKE '/tmp/.%'
        OR file.path LIKE '/tmp/.%/%'
        OR file.path LIKE '/usr/bin/.%'
        OR file.path LIKE '/usr/lib/.%'
        OR file.path LIKE '/usr/lib/%/.%'
        OR file.path LIKE '/usr/libexec/.%'
        OR file.path LIKE '/usr/local/bin/.%'
        OR file.path LIKE '/usr/local/lib/.%'
        OR file.path LIKE '/usr/local/lib/.%'
        OR file.path LIKE '/usr/local/libexec/.%'
        OR file.path LIKE '/usr/local/sbin/.%'
        OR file.path LIKE '/usr/sbin/.%'
        OR file.path LIKE '/var/.%'
        OR file.path LIKE '/var/%/.%'
        OR file.path LIKE '/var/lib/.%'
        OR file.path LIKE '/var/tmp/.%'
        OR file.path LIKE '/var/tmp/.%/%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%' -- Avoid mentioning extremely temporary files
      AND file.path NOT LIKE '/usr/lib/x86_64-linux-gnu/.lib%.hmac'
      AND file.path NOT LIKE '/lib/x86_64-linux-gnu/.lib%.hmac'
      AND strftime('%s', 'now') - file.ctime > 20
      AND file.path NOT IN (
        '/.autorelabel',
        '/.cache/',
        '/.equarantine/',
        '/.file',
        '/.kconfig',
        '/.lesshst',
        '/.mozilla/',
        '/.netrwhist',
        '/.nofollow/',
        '/.profile',
        '/.ostree.cfs',
        '/.resolve/',
        '/.vim/',
        '/.viminfo',
        '/.vol/',
        '/.VolumeIcon.icns',
        '/dev/.blkid.tab',
        '/dev/.mdadm/',
        '/etc/.#sudoers',
        '/etc/.bootcount',
        '/etc/.clean',
        '/etc/.etckeeper',
        '/etc/.git/',
        '/etc/.gitattributes',
        '/etc/.java/',
        '/etc/.resolv.conf.systemd-resolved.bak',
        '/etc/selinux/.config_backup',
        '/etc/skel/.local/',
        '/etc/skel/.mozilla/',
        '/etc/skel/.var/',
        '/lib/jvm/.java-1.17.0-openjdk-amd64.jinfo',
        '/tmp/._contentbarrier_installed',
        '/tmp/.accounts-agent/',
        '/tmp/.aqua/',
        '/tmp/.audio-agent/',
        '/tmp/.bazelci/',
        '/tmp/.BBE72B41371180178E084EEAF106AED4F350939DB95D3516864A1CC62E7AE82F', -- Xcode
        '/tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
        '/tmp/.content-agent/',
        '/tmp/.dl.log',
        '/tmp/.docker-tmp/',
        '/tmp/.docker/',
        '/tmp/.dotnet/',
        '/tmp/.dotnet/lockfiles/',
        '/tmp/.dotnet/shm/',
        '/tmp/.dracula-tmux-data',
        '/tmp/.dracula-tmux-weather.lock',
        '/tmp/.DS_Store',
        '/tmp/.eos-update-notifier.log',
        '/tmp/.featureflags-agent/',
        '/tmp/.font-unix/',
        '/tmp/.git/',
        '/tmp/.github/',
        '/tmp/.go-version',
        '/tmp/.helmrepo',
        '/tmp/.ICE-unix/',
        '/tmp/.last_survey_prompt.yaml',
        '/tmp/.last_update_check.json',
        '/tmp/.melange.yaml',
        '/tmp/.metrics-agent/',
        '/tmp/.PKGINFO',
        '/tmp/.s.PGSQL.5432',
        '/tmp/.s.PGSQL.5432.lock',
        '/tmp/.searcher.tmp/',
        '/tmp/.ses',
        '/tmp/.settings-agent/',
        '/tmp/.terraform.lock.hcl',
        '/tmp/.terraform/',
        '/tmp/.Test-unix/',
        '/tmp/.touchpaddefaults',
        '/tmp/.ui-agent/',
        '/tmp/.updater-agent/',
        '/tmp/.venv/',
        '/tmp/.vscode.dmypy_status/',
        '/tmp/.wsdl/',
        '/tmp/.X0-lock',
        '/tmp/.X1-lock',
        '/tmp/.X11-unix/',
        '/tmp/.X2-lock',
        '/tmp/.XIM-unix/',
        '/tmp/.ydotool_socket',
        '/usr/bin/.kcapi-hasher.hmac',
        '/usr/lib/jvm/.java-1.17.0-openjdk-amd64.jinfo',
        '/usr/lib/nvidia-visual-profiler/.eclipseproduct',
        '/usr/local/bin/.swtpm',
        '/usr/local/libexec/.ksysguard/',
        '/var/.ntw_cache',
        '/var/.Parallels_swap/',
        '/var/.pwd_cache',
        '/var/.slm/',
        '/var/.slmauth/',
        '/var/.slmbackup/',
        '/var/db/.AppleInstallType.plist',
        '/var/db/.AppleUpgrade',
        '/var/db/.com.apple.iokit.graphics',
        '/var/db/.com.intego.netupdate.serviceId',
        '/var/db/.EntReg',
        '/var/db/.GKRearmTimer',
        '/var/db/.InstallerTMExcludes.plist',
        '/var/db/.intl8859cache.db',
        '/var/db/.LastGKApp',
        '/var/db/.LastGKReject',
        '/var/db/.lvm_setupdone',
        '/var/db/.MASManifest',
        '/var/db/.RunLanguageChooserToo',
        '/usr/lib/x86_64-linux-gnu/.libkcapi.so.1.5.0.hmac',
        '/lib/x86_64-linux-gnu/.libkcapi.so.1.5.0.hmac',
        '/bin/X11/.kcapi-hasher.hmac',
        '/var/db/.SoftwareUpdateOptions',
        '/var/db/.StagedAppleUpgrade',
        '/var/db/.SystemPolicy-default',
        '/var/discourse/.git/',
        '/var/discourse/.github/',
        '/var/home/.duperemove.hash',
        '/var/home/.snapshots',
        '/var/home/.snapshots/',
        '/var/mail/.cache/',
        '/var/root/.bash_history',
        '/var/root/.bash_profile',
        '/var/root/.cache/',
        '/var/root/.CFUserTextEncoding',
        '/var/root/.config/',
        '/var/root/.docker/',
        '/var/root/.forward',
        '/var/root/.lesshst',
        '/var/root/.nix-channels',
        '/var/root/.nix-defexpr/',
        '/var/root/.nix-profile/',
        '/var/root/.nx/',
        '/var/root/.osquery/',
        '/var/root/.PenTablet/',
        '/var/root/.provisio',
        '/var/root/.ssh/',
        '/var/root/.Trash/',
        '/var/root/.viminfo',
        '/var/tmp/.DS_Store',
        '/var/root/.zsh_history',
        '/var/roothome/.bash_history',
        '/var/roothome/.bash_logout',
        '/var/roothome/.bash_profile',
        '/var/roothome/.bashrc',
        '/var/roothome/.cache/',
        '/var/roothome/.cargo/',
        '/var/roothome/.config/',
        '/var/roothome/.dbus/',
        '/var/roothome/.justfile',
        '/var/roothome/.lesshst',
        '/var/roothome/.local/',
        '/var/roothome/.mozilla/',
        '/var/roothome/.osquery/',
        '/var/roothome/.ssh/',
        '/var/roothome/.var/',
        '/var/roothome/.viminfo',
        '/var/run/.heim_org.h5l.kcm-socket',
        '/var/run/.sim_diagnosticd_socket',
        '/var/run/.vfs_rsrc_streams_0x2b725bbfb94ba4ef0/',
        '/var/setup/.AppleSetupUser',
        '/var/setup/.fseventsd/',
        '/var/setup/.TemporaryItems',
        '/var/setup/.TemporaryItems/',
        '/var/tmp/.ses',
        '/var/tmp/.ses.bak'
      )
      AND file.directory NOT IN (
        '/etc/etckeeper/commit.d',
        '/etc/skel',
        '/etc/skel/.config',
        '/var/root/.provisio'
      )
      -- haven't seen any malware use sockets yet
      AND NOT file.type = 'socket'
      AND file.filename NOT LIKE '.%.swo'
      AND file.filename NOT LIKE '.%.swp'
      AND file.path NOT LIKE '%/.build-id/'
      AND file.path NOT LIKE '%/.dwz/'
      AND file.path NOT LIKE '%/.updated'
      AND file.path NOT LIKE '%/google-cloud-sdk/.install/'
      AND file.path NOT LIKE '%/lib/.lib%.hmac'
      AND file.path NOT LIKE '/%bin/bootstrapping/.default_components'
      AND file.path NOT LIKE '/lib/jvm/.java-%.jinfo'
      AND file.path NOT LIKE '/tmp/.#%'
      AND file.path NOT LIKE '/tmp/.%.gcode'
      AND file.path NOT LIKE '/tmp/.cdx.json%'
      AND file.path NOT LIKE '/tmp/.com.google.Chrome.%'
      AND file.path NOT LIKE '/tmp/.com.microsoft.Edge.%'
      AND file.path NOT LIKE '/tmp/.com.valvesoftware.Steam.%/'
      AND file.path NOT LIKE '/tmp/.dropbox-dist-%'
      AND file.path NOT LIKE '/tmp/.io.nwjs.%'
      AND file.path NOT LIKE '/tmp/.lark_cache_%'
      AND file.path NOT LIKE '/tmp/.org.chromium.Chromium%'
      AND file.path NOT LIKE '/tmp/.testcontainers-tmp-%'
      AND file.path NOT LIKE '/tmp/.tmp%/'
      AND file.path NOT LIKE '/tmp/.tmp%/stdin'
      AND file.path NOT LIKE '/tmp/.vbox-%-ipc/'
      AND file.path NOT LIKE '/tmp/.vbox-%-ipc/lock'
      AND file.path NOT LIKE '/tmp/.wine-%'
      AND file.path NOT LIKE '/tmp/.SIGN.RSA%.rsa.pub'
      AND file.path NOT LIKE '/tmp/.X1%-lock'
      AND file.path NOT LIKE '/tmp/.gradle%'
      AND file.path NOT LIKE '/tmp/.git_signing_key%'
      AND file.path NOT LIKE '/tmp/.xfsm-ICE-%'
      AND file.path NOT LIKE '/usr/lib/jvm/.java-%-openjdk-%.jinfo'
      AND file.path NOT LIKE '/usr/local/%/.keepme'
      AND file.path NOT LIKE '/var/roothome/.xauth%'
      AND file.path NOT LIKE '/var/run/.vfs_rsrc_streams_%/'
      AND NOT (
        type = 'regular'
        AND (
          filename LIKE '%.swp'
          OR filename LIKE '%.swo'
          OR filename LIKE '%.swn'
          OR size < 2
        )
      )
      AND NOT (
        type = 'regular'
        AND filename IN ('.placeholder', '.abignore', '.gitignore')
      ) -- A curious addition seen on NixOS and Fedora machines
      AND NOT (
        file.path = '/.cache/'
        AND file.uid = 0
        AND file.gid = 0
        AND file.mode IN ('0755', '0700')
        AND file.size < 4
      ) -- Ecamm Live
      AND NOT (
        file.path LIKE "/tmp/.elive%"
        AND file.size < 7
      )
      AND NOT (
        file.path = '/.config/'
        AND file.uid = 0
        AND file.gid = 0
        AND file.mode IN ('0755', '0700')
        AND file.size = 4
      )
      AND NOT (
        file.path = '/var/tmp/.DS_Store'
        AND file.uid = 501
        AND file.mode = '0644'
        AND file.size < 10000
      )
      AND NOT (
        file.path LIKE '/tmp/.java_pid%'
        AND file.type = 'socket'
        AND file.size = 0
      )
      AND NOT (
        file.path = '/var/root/.oracle_jre_usage/'
        AND file.size = 96
      )
      AND NOT (
        file.path LIKE '/tmp/.ssh-%'
        AND file.type = "socket"
        AND file.mode = '0600'
      )
      -- still not sure what the hell this is
      AND NOT (
        file.path LIKE '/tmp/.%3D'
        AND file.size < 35000
        AND file.size > 20000
        AND file.mode = '0644'
        AND uid = 501
        AND gid = 0
      )
      -- RX100
      AND NOT (
        file.path LIKE '/var/db/.%'
        AND file.gid = 0
        AND file.uid = 0
        AND file.size = 28
        AND file.mode = '0666'
      )
      AND NOT (
        file.path LIKE '/tmp/.comments/%.jpg.xml'
        AND file.uid > 0
        AND file.size < 15000
      )
      AND NOT (
        file.path LIKE '/tmp/.tmp%'
        AND file.uid > 500
        AND size < 4096
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Kernel Extensions Macos"
  description: Find unexpected 3rd-party kernel extensions
  query: |
    SELECT
      k.linked_against,
      k.name,
      k.path,
      k.size,
      k.version,
      hash.sha256,
      k.path || ',' || k.name || ',' || k.version || ',' || k.linked_against AS exception_key
    FROM
      kernel_extensions AS k
      LEFT JOIN hash ON k.path = hash.path
    WHERE
      k.path NOT LIKE '/System/Library/Extensions/%'
      AND NOT (
        idx = 0
        AND name = '__kernel__'
      )
      AND exception_key NOT IN (
        '/Library/StagedExtensions/Library/Extensions/CalDigitUSBHubSupport.kext,com.CalDigit.USBHubSupport,1,<3>',
        '/Library/StagedExtensions/Library/Filesystems/kbfuse.fs/Contents/Extensions/13/kbfuse.kext,com.github.kbfuse.filesystems.kbfuse,2113.21,<1 3 4 5 7>',
        '/Library/StagedExtensions/Library/Filesystems/macfuse.fs/Contents/Extensions/14/macfuse.kext,io.macfuse.filesystems.macfuse,2128.20,<1 3 4 5 7>'
      )
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/UAD2System.kext,com.uaudio.driver.UAD2System,%'
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/ufsd_ExtFS.kext,com.paragon-software.filesystems.extfs,%'
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/ufsd_NTFS.kext,com.paragon-software.filesystems.ntfs,%'
      AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Filesystems/macfuse.fs/Contents/Extensions/%/macfuse.kext,io.macfuse.filesystems.macfuse,%'
      AND exception_key NOT LIKE '/usr/appleinternal/standalone/platform,com.apple.sptm,24.%'
      AND exception_key NOT LIKE '/usr/appleinternal/standalone/platform,com.apple.txm,24.%'
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Kernel Modules Linux"
  description: Find kernel modules that are not part of the expected list
  query: |
    SELECT
      *
    FROM
      kernel_modules
    WHERE
      -- Filter out kernel modules that are required by another kernel module to reduce false-positives
      used_by != NULL
      AND name NOT IN (
        '8021q',
        'ac97_bus',
        'acpi_cpufreq',
        'acpi_pad',
        'acpi_tad',
        'acpi_thermal_rel',
        'aesni_intel',
        'af_alg',
        'af_packet',
        'agpgart',
        'ahci',
        'algif_aead',
        'algif_hash',
        'algif_skcipher',
        'amd_pmc',
        'amdgpu',
        'apple_mfi_fastcharge',
        'asn1_encoder',
        'asus_ec_sensors',
        'asus_wmi',
        'ath',
        'ath10k_core',
        'ath10k_pci',
        'atkbd',
        'authenc',
        'autofs4',
        'backlight',
        'battery',
        'binfmt_misc',
        'bluetooth',
        'bnep',
        'bpf_preload',
        'br_netfilter',
        'bridge',
        'btbcm',
        'btintel',
        'btmtk',
        'btrtl',
        'btusb',
        'button',
        'cbc',
        'ccm',
        'ccp',
        'cdc_ether',
        'cdrom',
        'cec',
        'cfg80211',
        'cmac',
        'configfs',
        'coretemp',
        'cpuid',
        'cqhci',
        'crc_t10dif',
        'crc16',
        'crc32_pclmul',
        'crc32c_generic',
        'crc32c_intel',
        'crct10dif_common',
        'crct10dif_generic',
        'crct10dif_pclmul',
        'cros_ec_chardev',
        'cros_ec_debugfs',
        'cros_ec_dev',
        'cros_ec_ishtp',
        'cros_ec_lpcs',
        'cros_ec_sysfs',
        'cros_ec',
        'cros_usbpd_charger',
        'cros_usbpd_logger',
        'cros_usbpd_notify',
        'cryptd',
        'crypto_simd',
        'crypto_user',
        'ctr',
        'dca',
        'dcdbas',
        'deflate',
        'dell_laptop',
        'dell_smbios',
        'dell_smm_hwmon',
        'dell_wmi_descriptor',
        'dell_wmi',
        'des_generic',
        'dm_bio_prison',
        'dm_bufio',
        'dm_crypt',
        'dm_mod',
        'dm_multipath',
        'dm_persistent_data',
        'dm_thin_pool',
        'drm_buddy',
        'drm_display_helper',
        'drm_dp_helper',
        'drm_kms_helper',
        'drm_ttm_helper',
        'drm',
        'ecb',
        'ecc',
        'ecdh_generic',
        'edac_core',
        'edac_mce_amd',
        'ee1004',
        'eeepc_wmi',
        'efi_pstore',
        'efivarfs',
        'encrypted_keys',
        'essiv',
        'evdev',
        'exfat',
        'ext4',
        'fat',
        'fb_sys_fops',
        'firmware_attributes_class',
        'fuse',
        'garmin_gps',
        'gf128mul',
        'ghash_clmulni_intel',
        'gigabyte_wmi',
        'gpio_amdpt',
        'gpio_generic',
        'gpu_sched',
        'hid_apple',
        'hid_generic',
        'hid_jabra',
        'hid_logitech_dj',
        'hid_logitech_hidpp',
        'hid_multitouch',
        'hid_sensor_als',
        'hid_sensor_custom',
        'hid_sensor_hub',
        'hid_sensor_iio_common',
        'hid_sensor_trigger',
        'hid',
        'hwmon_vid',
        'i2c_algo_bit',
        'i2c_core',
        'i2c_designware_core',
        'i2c_designware_platform',
        'i2c_hid_acpi',
        'i2c_hid',
        'i2c_i801',
        'i2c_piix4',
        'i2c_scmi',
        'i2c_smbus',
        'i8042',
        'i915',
        'icp',
        'idma64',
        'igb',
        'igc',
        'igen6_edac',
        'industrialio_triggered_buffer',
        'industrialio',
        'input_leds',
        'int3400_thermal',
        'int3403_thermal',
        'int340x_thermal_zone',
        'intel_cstate',
        'intel_gtt',
        'intel_hid',
        'intel_ish_ipc',
        'intel_ishtp_hid',
        'intel_ishtp_loader',
        'intel_ishtp',
        'intel_lpss_pci',
        'intel_lpss',
        'intel_pch_thermal',
        'intel_pmc_bxt',
        'intel_pmt',
        'intel_powerclamp',
        'intel_rapl_common',
        'intel_rapl_msr',
        'intel_soc_dts_iosf',
        'intel_spi_pci',
        'intel_spi',
        'intel_tcc_cooling',
        'intel_uncore',
        'intel_vsec',
        'intel_wmi_thunderbolt',
        'intel_xhci_usb_role_switch',
        'iommu_v2',
        'ip_set',
        'ip_tables',
        'ip_vs_rr',
        'ip_vs_sh',
        'ip_vs_wrr',
        'ip_vs',
        'ip6_tables',
        'ip6t_REJECT',
        'ip6t_rpfilter',
        'ip6t_rt',
        'ip6table_filter',
        'ip6table_mangle',
        'ip6table_nat',
        'ip6table_raw',
        'ip6table_security',
        'ipheth',
        'ipmi_devintf',
        'ipmi_msghandler',
        'ipt_REJECT',
        'ipt_rpfilter',
        'iptable_filter',
        'iptable_mangle',
        'iptable_nat',
        'iptable_raw',
        'iptable_security',
        'irqbypass',
        'isofs',
        'iTCO_vendor_support',
        'iTCO_wdt',
        'iwlmei',
        'iwlmvm',
        'iwlwifi',
        'jbd2',
        'jc42',
        'joydev',
        'k10temp',
        'kfifo_buf',
        'kvm_amd',
        'kvm_intel',
        'kvm',
        'led_class',
        'ledtrig_audio',
        'libaes',
        'libahci',
        'libarc4',
        'libata',
        'libcrc32c',
        'libdes',
        'libphy',
        'libps2',
        'llc',
        'loop',
        'lp',
        'mac_hid',
        'mac80211',
        'macvlan',
        'mbcache',
        'mc',
        'md_mod',
        'md4',
        'mdio_devres',
        'mei_hdcp',
        'mei_me',
        'mei_pxp',
        'mei_wdt',
        'mei',
        'mii',
        'mmc_block',
        'mmc_core',
        'mousedev',
        'msr',
        'mtd',
        'mxm_wmi',
        'nct6775_core',
        'nct6775',
        'netlink_diag',
        'nf_conntrack_broadcast',
        'nf_conntrack_netbios_ns',
        'nf_conntrack_netlink',
        'nf_conntrack',
        'nf_defrag_ipv4',
        'nf_defrag_ipv6',
        'nf_log_syslog',
        'nf_nat',
        'nf_reject_ipv4',
        'nf_reject_ipv6',
        'nf_tables',
        'nfnetlink_log',
        'nfnetlink_queue',
        'nfnetlink',
        'nft_chain_nat',
        'nft_compat',
        'nft_counter',
        'nft_ct',
        'nft_fib_inet',
        'nft_fib_ipv4',
        'nft_fib_ipv6',
        'nft_fib',
        'nft_limit',
        'nft_objref',
        'nft_reject_inet',
        'nft_reject',
        'nls_cp437',
        'nls_iso8859_1',
        'nvidia_drm',
        'nvidia_modeset',
        'nvidia_uvm',
        'nvidia',
        'nvme_common',
        'nvme_core',
        'nvme',
        'nvram',
        'overlay',
        'parport_pc',
        'parport',
        'pcspkr',
        'pinctrl_amd',
        'pinctrl_sunrisepoint',
        'pinctrl_tigerlake',
        'pkcs8_key_parser',
        'platform_profile',
        'pmt_class',
        'pmt_telemetry',
        'polyval_clmulni',
        'polyval_generic',
        'ppdev',
        'pps_core',
        'processor_thermal_device_pci_legacy',
        'processor_thermal_device_pci',
        'processor_thermal_device',
        'processor_thermal_mbox',
        'processor_thermal_rapl',
        'processor_thermal_rfim',
        'psmouse',
        'pstore_blk',
        'pstore_zone',
        'pstore',
        'ptp',
        'qrtr',
        'r8152',
        'r8153_ecm',
        'r8169',
        'raid0',
        'ramoops',
        'rapl',
        'raydium_i2c_ts',
        'rc_core',
        'realtek',
        'reed_solomon',
        'rfcomm',
        'rfkill',
        'rndis_host',
        'rndis_wlan',
        'rng_core',
        'roles',
        'rtc_cmos',
        'rtsx_pci_sdmmc',
        'rtsx_pci',
        'rtw89_8852a',
        'rtw89_8852ae',
        'rtw89_core',
        'rtw89_pci',
        'sch_fq_codel',
        'scsi_common',
        'scsi_mod',
        'sdhci_pci',
        'sdhci',
        'serio_raw',
        'serio',
        'sg',
        'snd_acp_config',
        'snd_acp3x_pdm_dma',
        'snd_acp3x_rn',
        'snd_compress',
        'snd_ctl_led',
        'snd_hda_codec_generic',
        'snd_hda_codec_hdmi',
        'snd_hda_codec_idt',
        'snd_hda_codec_realtek',
        'snd_hda_codec',
        'snd_hda_core',
        'snd_hda_ext_core',
        'snd_hda_intel',
        'snd_hrtimer',
        'snd_hwdep',
        'snd_intel_dspcfg',
        'snd_intel_sdw_acpi',
        'snd_pci_acp3x',
        'snd_pci_acp5x',
        'snd_pci_acp6x',
        'snd_pcm_dmaengine',
        'snd_pcm',
        'snd_rawmidi',
        'snd_rn_pci_acp3x',
        'snd_seq_device',
        'snd_seq_dummy',
        'snd_seq_midi_event',
        'snd_seq_midi',
        'snd_seq',
        'snd_soc_acpi_intel_match',
        'snd_soc_acpi',
        'snd_soc_avs',
        'snd_soc_core',
        'snd_soc_dmic',
        'snd_soc_hda_codec',
        'snd_soc_hdac_hda',
        'snd_soc_hdac_hdmi',
        'snd_soc_intel_hda_dsp_common',
        'snd_soc_skl_hda_dsp',
        'snd_soc_skl',
        'snd_soc_sst_dsp',
        'snd_soc_sst_ipc',
        'snd_sof_amd_acp',
        'snd_sof_amd_renoir',
        'snd_sof_intel_hda_common',
        'snd_sof_intel_hda',
        'snd_sof_pci_intel_tgl',
        'snd_sof_pci',
        'snd_sof_utils',
        'snd_sof_xtensa_dsp',
        'snd_sof',
        'snd_timer',
        'snd_usb_audio',
        'snd_usbmidi_lib',
        'snd',
        'soundcore',
        'soundwire_bus',
        'soundwire_cadence',
        'soundwire_generic_allocation',
        'soundwire_intel',
        'sp5100_tco',
        'sparse_keymap',
        'spi_intel_pci',
        'spi_intel',
        'spi_nor',
        'spl',
        'squashfs',
        'stp',
        'sunrpc',
        'syscopyarea',
        'sysfillrect',
        'sysimgblt',
        't10_pi',
        'tap',
        'tee',
        'thermal',
        'think_lmi',
        'thinkpad_acpi',
        'thunderbolt',
        'tiny_power_button',
        'tls',
        'tpm_crb',
        'tpm_tis_core',
        'tpm_tis',
        'tpm',
        'trusted',
        'ttm',
        'tun',
        'typec_ucsi',
        'typec',
        'uas',
        'ucsi_acpi',
        'uhid',
        'uinput',
        'usb_common',
        'usb_storage',
        'usbcore',
        'usbhid',
        'usbnet',
        'uvcvideo',
        'v4l2loopback',
        'veth',
        'vfat',
        'video',
        'videobuf2_common',
        'videobuf2_memops',
        'videobuf2_v4l2',
        'videobuf2_vmalloc',
        'videodev',
        'vivaldi_fmap',
        'watchdog',
        'wmi_bmof',
        'wmi',
        'x_tables',
        'x86_pkg_temp_thermal',
        'xfrm_algo',
        'xfrm_user',
        'xfs',
        'xhci_hcd',
        'xhci_pci_renesas',
        'xhci_pci',
        'xt_addrtype',
        'xt_comment',
        'xt_conntrack',
        'xt_hl',
        'xt_limit',
        'xt_LOG',
        'xt_mark',
        'xt_MASQUERADE',
        'xt_nat',
        'xt_pkttype',
        'xt_statistic',
        'xt_tcpudp',
        'zavl',
        'zcommon',
        'zfs',
        'zlua',
        'znvpair',
        'zram',
        'zunicode',
        'zzstd'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Library Entries Macos"
  description: Find unexpected files in /Library
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/Library/%'
        OR file.path LIKE '/Library/.%'
        OR file.path LIKE '/Library/%/.%'
        OR file.path LIKE '/Library/WebServer/%'
        OR file.path LIKE '/Library/WebServer/CGI-Executables/%%'
        OR file.path LIKE '/Library/WebServer/Documents/%%'
      )
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.size > 1
      AND file.path NOT IN (
        '/Library/.localized',
        '/Library/Apple/',
        '/Library/Application Support/',
        '/Library/Audio/',
        '/Library/AutoBugCapture/',
        '/Library/Automator/',
        '/Library/Bluetooth/',
        '/Library/Caches/',
        '/Library/Catacomb/',
        '/Library/ColorPickers/',
        '/Library/ColorSync/',
        '/Library/Components/',
        '/Library/Compositions/.localized',
        '/Library/Compositions/',
        '/Library/Contextual Menu Items/',
        '/Library/CoreAnalytics/',
        '/Library/CoreMediaIO/',
        '/Library/Desktop Pictures/.localizations/',
        '/Library/Desktop Pictures/.thumbnails/',
        '/Library/Desktop Pictures/',
        '/Library/Developer/',
        '/Library/DirectoryServices/',
        '/Library/Documentation/',
        '/Library/DriverExtensions/',
        '/Library/DropboxHelperTools/',
        '/Library/Extensions/',
        '/Library/Filesystems/',
        '/Library/Fonts/.uuid',
        '/Library/Fonts/',
        '/Library/Frameworks/',
        '/Library/Google/',
        '/Library/GPUBundles/',
        '/Library/Graphics/',
        '/Library/Image Capture/',
        '/Library/Input Methods/',
        '/Library/InstallerSandboxes/.metadata_never_index',
        '/Library/InstallerSandboxes/.PKInstallSandboxManager/',
        '/Library/InstallerSandboxes/',
        '/Library/Internet Plug-Ins/',
        '/Library/Java/',
        '/Library/KernelCollections/.file',
        '/Library/KernelCollections/',
        '/Library/Keyboard Layouts/',
        '/Library/Keychains/',
        '/Library/LaunchAgents/',
        '/Library/LaunchDaemons/',
        '/Library/Logs/',
        '/Library/Mail/',
        '/Library/Managed Preferences/',
        '/Library/Microsoft/',
        '/Library/Modem Scripts/',
        '/Library/Nessus/',
        '/Library/Objective-See/',
        '/Library/OpenDirectory/',
        '/Library/OSAnalytics/.DS_Store',
        '/Library/OSAnalytics/',
        '/Library/Parallels/',
        '/Library/PDF Services/',
        '/Library/Perl/',
        '/Library/Plug-Ins/',
        '/Library/PreferencePanes/',
        '/Library/Preferences/.GlobalPreferences.plist',
        '/Library/Preferences/',
        '/Library/Printers/',
        '/Library/PrivilegedHelperTools/',
        '/Library/Python/',
        '/Library/QuickLook/',
        '/Library/Receipts/',
        '/Library/Ruby/',
        '/Library/Sandbox/',
        '/Library/Screen Savers/',
        '/Library/ScriptingAdditions/',
        '/Library/Scripts/',
        '/Library/Security/',
        '/Library/Services/',
        '/Library/Speech/',
        '/Library/Spotlight/',
        '/Library/StagedDriverExtensions/',
        '/Library/StagedExtensions/',
        '/Library/StartupItems/',
        '/Library/SystemExtensions/.staging/',
        '/Library/SystemExtensions/',
        '/Library/SystemMigration/',
        '/Library/SystemProfiler/',
        '/Library/Tailscale/',
        '/Library/TeX/',
        '/Library/ThunderboltAccessoryFirmwareUpdates/',
        '/Library/Updates/',
        '/Library/User Pictures/',
        '/Library/User Template/',
        '/Library/Video/',
        '/Library/WebServer/',
        '/Library/WebServer/CGI-Executables/',
        '/Library/WebServer/Documents/',
        '/Library/WebServer/Documents/index.html.en',
        '/Library/WebServer/share/'
      )
      -- Probably Adobe copy protection, my guess is the host serial number or MAC addr.
      AND NOT REGEX_MATCH (
        file.path,
        '^/Library/Caches/\.([0-9ABCDEF]{12})$',
        1
      ) != ""
      AND NOT (
        file.path = '/Library/Caches/.DS_Store'
        AND magic.data = 'Apple Desktop Services Store'
        AND file.size < 9000
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Public Files Macos"
  description: Find unexpected files in ~/Public
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.btime,
      file.mode,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data,
      RTRIM(
        COALESCE(
          REGEX_MATCH (file.directory, '(/.*?/.*?/.*?/)', 1),
          file.directory
        ),
        "/"
      ) AS top3_dir
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.directory LIKE '/Users/%/Public'
        OR file.directory LIKE '/Users/%/Public/%%'
        OR file.directory LIKE '/Users/%/Public/.%'
      )
      AND NOT (
        file.type = 'directory'
        OR file.path LIKE '%/../%'
        OR file.path LIKE '%/./%'
        OR file.path LIKE '/Users/%/Public/Drop Box/.localized'
        OR file.path LIKE '/Users/%/Public/Drop Box/.DS_Store'
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected User Executables Macos"
  description: Find unexpected in unexpected places under /Users
  query: |
    SELECT
      f.path,
      f.directory,
      f.uid,
      f.gid,
      f.mode,
      f.mtime,
      f.atime,
      f.btime,
      f.ctime,
      f.size,
      hash.sha256,
      REPLACE(f.directory, u.directory, '~') AS homedir,
      REPLACE(f.path, u.directory, '~') AS homepath,
      RTRIM(
        COALESCE(
          REGEX_MATCH (
            REPLACE(f.directory, u.directory, '~'),
            '(.*?/.*?/.*?/)',
            1
          ),
          REPLACE(f.directory, u.directory, '~')
        ),
        "/"
      ) AS top2_homedir,
      magic.data,
      signature.authority,
      signature.identifier
    FROM
      file f
      LEFT JOIN hash on f.path = hash.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN magic ON f.path = magic.path
      LEFT JOIN signature ON f.path = signature.path
    WHERE
      -- Optimization: don't join things until we have a whittled down list of files
      f.path IN (
        SELECT DISTINCT
          path
        FROM
          file
        WHERE
          (
            directory = '/Users/Shared/'
            OR directory = '/var/root/'
            OR directory LIKE '/Users/%/.%'
            OR directory LIKE '/Users/%/.%/%'
            OR directory LIKE '/Users/%/Library'
            OR directory LIKE '/Users/%/Library/.%'
            OR directory LIKE '/Users/%/Library/%'
            OR directory LIKE '/Users/%/Library/%/.%'
            OR directory LIKE '/Users/%/Photos'
            OR directory LIKE '/Users/%/Photos/.%'
            OR directory LIKE '/Users/%/Photos/%'
            OR directory LIKE '/Users/%/Public'
            OR directory LIKE '/Users/%/Public/.%'
            OR directory LIKE '/Users/%/Public/%'
            OR directory LIKE '/Users/Shared/.%'
            OR directory LIKE '/Users/Shared/%'
            OR directory LIKE '/var/root/.%'
            OR directory LIKE '/var/root/%'
          )
          AND (
            type = 'regular'
            AND size > 32
            AND (
              mode LIKE '%7%'
              OR mode LIKE '%5%'
              OR mode LIKE '%1%'
            )
          )
          -- Prevent weird recursion
          AND NOT path LIKE '%/../%'
          AND NOT path LIKE '%/./%' -- Exclude very temporary files
          AND NOT directory LIKE '/Users/%/.bin/'
          AND NOT directory LIKE '/Users/%/.cargo/bin/'
          AND NOT directory LIKE '/Users/%/.crc/bin/'
          AND NOT directory LIKE '/Users/%/.go/bin/'
          AND NOT directory LIKE '/Users/%/.venv/bin/'
          AND NOT directory LIKE '/Users/%/.local/bin/'
          AND NOT directory LIKE '/Users/%/.minikube/bin/'
          AND NOT directory LIKE '/Users/%/.Trash/%'
          AND NOT directory LIKE '/Users/%/.vim/backup/'
          AND NOT directory LIKE '/Users/%/Library/Application Support/AutoFirma/certutil/'
          AND NOT directory LIKE '/Users/%/Library/Caches/chainctl/'
          AND NOT directory LIKE '/Users/%/Library/Containers/%'
          AND NOT directory LIKE '/Users/%/Library/Daemon Containers/%'
          AND NOT directory LIKE '/Users/%/Library/Mobile Documents/com~apple~CloudDocs/'
          AND NOT directory LIKE '/Users/%/Library/Mobile Documents/com~apple~shoebox/%'
          AND NOT directory LIKE '/Users/Shared/LGHUB/%'
          AND NOT directory LIKE '/Users/Shared/LogiOptionsPlus/%'
          AND NOT directory IN (
            '/Users/Shared/LogiOptionsPlus/cache/',
            '/Users/Shared/logitune/',
            '/Users/Shared/Red Giant/Uninstall/'
          )
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
      )
      AND (
        magic.data IS NULL
        OR magic.data LIKE "%executable%"
        OR magic.data LIKE "%shared library%"
      ) -- Filter out downloaded Linux binaries
      AND NOT (
        magic.data IS NOT NULL
        AND magic.data LIKE "ELF %LSB %"
      )
      AND NOT (
        magic.data IS NOT NULL
        AND magic.data LIKE "0420 Alliant virtual executable%"
      )
      AND NOT (
        magic.data IS NOT NULL
        AND magic.data LIKE "%shell script%"
      )
      AND NOT (
        magic.data IS NULL
        AND f.size < 50000
      )
      AND NOT homedir LIKE '/Users/%/.provisio'
      AND NOT homedir LIKE '~/%/bin'
      AND NOT homedir LIKE '~/%/plugins'
      AND NOT homedir LIKE '~/%/shims'
      AND NOT homedir IN (
        '/Users/Shared/LGHUB',
        '/Users/Shared/LogiOptionsPlus',
        '/Users/Shared/logitune',
        '/var/root/.PenTablet',
        '~/.amplify/bin',
        '~/.asdf/shims',
        '~/.bazel/bin',
        '~/.bin',
        '~/.cache/gitstatus',
        '~/.config/kn',
        '~/.config/nvim.bak',
        '~/.docker/cli-plugins',
        '~/.docker/scout',
        '~/.dotnet/tools',
        '~/.emacs.d.bak/bin',
        '~/.oh-my-zsh/themes',
        '~/.emacs.d/backups',
        '~/.fig/bin',
        '~/.fzf',
        '~/.fzf/bin',
        '~/.gvm/bin',
        '~/.kn/plugins',
        '~/.kuberlr/darwin-amd64',
        '~/.npm/sentry-cli',
        '~/.oh-my-zsh/tools',
        '~/.PenTablet',
        '~/.provisio',
        '~/.pulumi-dev/bin',
        '~/.pyenv/shims',
        '~/.rbenv/shims',
        '~/.venv/bin',
        '~/.vs-tekton',
        '~/.wash/downloads',
        '~/.wrangler/bin',
        '~/.zed/gopls',
        '~/.zsh_snap/zsh-autocomplete',
        '~/.zsh_snap/zsh-snap',
        '~/Library/ApplicationSupport/iTerm2',
        '~/Library/Dropbox/DropboxMacUpdate.app/Contents/MacOS',
        '~/Library/Group Containers/group.com.apple.wifi.logs/previous',
        '~/Library/Logs/Adobe',
        '~/Library/Logs/com.logmein.GoToOpener',
        '~/Library/Mobile Documents/com~apple~CloudDocs'
      )
      AND NOT top2_homedir IN (
        '/Users/Shared/LGHUB/cache',
        '/Users/Shared/LogiOptionsPlus/cache',
        '/Users/Shared/Red Giant/Uninstall',
        '~/.antigen',
        '~/.cache/fsh',
        '~/.docker.old/cli-plugins',
        '~/.fzf/test',
        '~/.iterm2',
        '~/.kuberlr/darwin-arm64',
        '~/.claude-code-tools',
        '~/.magefile',
        '~/.nvm',
        '~/.revox/updates',
        '~/.sdkman/libexec',
        '~/.terraform.d',
        '~/.wakatime',
        '~/.terraform.versions',
        '~/Library/Application Support',
        '~/Library/Caches',
        '~/Library/CloudStorage',
        '~/Library/helm',
        '~/Library/pnpm',
        '~/Library/Printers',
        '~/Library/Python',
        '~/Library/QuickLook',
        '~/Library/Screen Savers',
        '~/Library/Services',
        '~/Library/Thunderbird'
      )
      AND NOT homepath IN (
        '~/.config/i3',
        '~/.config/nvm/nvm.sh',
        '~/.config/polybar',
        '~/.config/i3/power-manager.sh',
        '~/.config/polybar/launch.sh',
        '~/.toolbase/toolbase-runner',
        '~/Library/Group Containers/group.com.docker/unleash-repo-schema-v1-Docker Desktop.json',
        '~/Library/Preferences/Macromedia/Flash Player/www.macromedia.com/bin/airappinstaller/airappinstaller_rsrc',
        '~/Library/Keychains/login.keychain-db',
        '~/Library/Logs/zoom.us/upload_history.txt',
        '~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2'
      )
      AND NOT top2_homedir LIKE '~/.mvnGoLang/go%.darwin-amd64'
      AND NOT homepath LIKE '~/Library/%/%.db-wal'
      AND NOT homepath LIKE '~/Library/%/%.db'
      AND NOT homepath LIKE '~/Library/%/%.sqlite%'
      AND NOT homepath LIKE '~/Library/%.aapbz'
      AND NOT f.directory LIKE '/Users/%/.docker/cli-plugins'
      AND NOT f.directory LIKE '/Users/%/.nix-profile/%'
      AND NOT f.directory LIKE '/Users/%/.pkg-cache/%'
      AND NOT f.directory LIKE '/Users/%/.npm-global/bin'
    
      AND NOT f.directory LIKE '/var/root/Library/Caches/%/org.sparkle-project.Sparkle/%/Contents/MacOS'
      AND NOT f.directory LIKE '/var/root/Library/Caches/%/org.sparkle-project.Sparkle/%/Sparkle.framework%'
      AND NOT f.path LIKE '/Users/%/Library/Fonts/%.otf'
      AND NOT f.path LIKE '/Users/%/Library/Fonts/%.ttf'
      AND NOT f.path LIKE '/Users/%/result/activate'
    GROUP BY
      f.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected User Shared Entries"
  description: Find unexpected files in /Users/Shared
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.btime,
      file.mode,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data,
      RTRIM(
        COALESCE(
          REGEX_MATCH (file.directory, '(/.*?/.*?/.*?/)', 1),
          file.directory
        ),
        "/"
      ) AS top3_dir
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE '/Users/Shared/%%'
        OR file.path LIKE '/Users/Shared/.%'
        OR file.path LIKE '/Users/Shared/.%/%%'
        OR file.path LIKE '/Users/Shared/%/.%'
      )
      AND NOT (
        file.type = 'directory'
        OR file.size = 0
        OR file.path LIKE '%/../%'
        OR file.path LIKE '%/./%'
        OR file.path IN (
          '/Users/Shared/.4oaLkgIGnA',
          '/Users/Shared/.BetaEnrollmentData.plist',
          '/Users/Shared/.betamigrated',
          '/Users/Shared/.com.intego.reporting.plist',
          '/Users/Shared/.DS_Store',
          '/Users/Shared/.ks.intego_metrics_2.plist',
          '/Users/Shared/.localized',
          '/Users/Shared/.NSVolumeHeap',
          '/Users/Shared/.SeedEnrollment.plist',
          '/Users/Shared/.userfonts.cachedb',
          '/Users/Shared/CleanMyMac X/.licence',
          '/Users/Shared/LogiTuneInstallerStarted.txt',
          '/Users/Shared/Plugin Loading.log'
        )
        OR top3_dir IN (
          '/Users/Shared/.logishrd',
          '/Users/Shared/Adobe',
          '/Users/Shared/AdobeGCData',
          '/Users/Shared/AdobeGCInfo',
          '/Users/Shared/AdobeInstalledCodecsTier2',
          '/Users/Shared/Audiority',
          '/Users/Shared/Canon_Inc_IC',
          '/Users/Shared/CleanMyMac X Menu',
          '/Users/Shared/CleanMyMac X',
          '/Users/Shared/CleanMyMac_5',
          '/Users/Shared/Electronic Arts',
          '/Users/Shared/LGHUB',
          '/Users/Shared/logi',
          '/Users/Shared/LogioptionsPlus',
          '/Users/Shared/LogiOptionsPlus',
          '/Users/Shared/logitune',
          '/Users/Shared/macenhance',
          '/Users/Shared/Maxon',
          '/Users/Shared/Media Cache Files',
          '/Users/Shared/Media Cache Files/',
          '/Users/Shared/Parallels',
          '/Users/Shared/Pixologic',
          '/Users/Shared/PPN',
          '/Users/Shared/Previously Relocated Items',
          '/Users/Shared/Red Giant',
          '/Users/Shared/Relocated Items',
          '/Users/Shared/TechSmith',
          '/Users/Shared/UnrealEngine',
          '/Users/Shared/ZBrushData2024'
        )
        OR file.path LIKE '/Users/Shared/Epic Games/%'
        OR file.path LIKE "/Users/Shared/Previously Relocated Items %/%"
        OR (
          file.path LIKE "%.plist"
          AND magic.data = 'XML 1.0 document, ASCII text'
        )
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Var Executables Linux"
  description: Find unexpected executables in /var
  query: |
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/var/%%'
        OR file.path LIKE '/var/spool/.%/%%'
        OR file.path LIKE '/var/spool/%/.%/%%'
        OR file.path LIKE '/var/spool/%/%/.%'
        OR file.path LIKE '/var/spool/%/%%'
        OR file.path LIKE '/var/spool/%%'
        OR file.path LIKE '/var/tmp/.%/%%'
        OR file.path LIKE '/var/tmp/%/.%/%%'
        OR file.path LIKE '/var/tmp/%/%/.%'
        OR file.path LIKE '/var/tmp/%/%%'
        OR file.path LIKE '/var/tmp/%%'
      )
      AND file.type = 'regular'
      AND file.path NOT LIKE '/var/tmp/buildah-cache-1000/var/cache/rpm-ostree/%'
      AND file.path NOT LIKE '/var/tmp/images/%'
      AND file.path NOT LIKE '/var/tmp/packages/%'
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND file.directory NOT LIKE '/var/tmp/buildah%/run'
      AND (
        file.mode LIKE '%7%'
        OR file.mode LIKE '%5%'
        OR file.mode LIKE '%1%'
      )
      AND file.directory NOT IN (
        '/var/lib/colord',
        '/var/ossec/agentless',
        '/var/ossec/bin',
        '/var/ossec/wodles',
        '/var/run/booted-system',
        '/var/run/current-system',
        '/var/usrlocal/bin',
        '/var/usrlocal/lib64',
        '/var/vanta'
      )
      AND file.directory NOT LIKE '/var/tmp/ostree-unlock-ovl.%/upper/bin'
      AND file.path NOT IN (
        '/var/run/lima-boot-done',
        '/var/run/lima-ssh-ready',
        '/var/opt/bin/elastic-agent'
      )
      AND NOT (
        file.directory = '/var/spool/postfix/incoming'
        AND size < 1024
        AND mode = '07000'
        AND gid = 0
      )
      AND (
        magic.data IS NULL
        OR magic.data != 'JSON data'
      )
      AND file.size > 10
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Var Run Macos"
  description: Find unexpected regular files in /var/run
  query: |
    SELECT
      file.filename,
      uid,
      gid,
      mode,
      file.ctime,
      file.atime,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      file.directory = "/var/run"
      AND file.type = "regular"
      AND file.filename NOT IN (
        '.autoBackup',
        '.DidRunFLO',
        '.fctcompsupdate',
        'appfwd.pid',
        'auditd.pid',
        'automount.initialized',
        'bootpd.pid',
        'com.apple.DumpPanic.finishedPMUFaultHandling',
        'com.apple.DumpPanic.finishedThisBoot',
        'com.apple.logind.didRunThisBoot',
        'com.apple.loginwindow.didRunThisBoot',
        'com.apple.mdmclient.daemon.didRunThisBoot',
        'com.apple.mobileassetd-MobileAssetBrain',
        'com.apple.parentalcontrols.webfilterctl.mutex',
        'com.apple.softwareupdate.availableupdatesupdated',
        'com.apple.WindowServer.didRunThisBoot',
        'diskarbitrationd.pid',
        'fctc.s',
        'FirstBootAfterUpdate',
        'FirstBootCleanupHandled',
        'hdiejectd.pid',
        'installd.commit.pid',
        'kdc.pid',
        'MobileAssetCritialDomainsUpdated.plist',
        'MobileAssetStartupActivation.doneThisBoot',
        'prl_desktop_services_foreground.lock',
        'prl_desktop_services.lock',
        'prl_disp_service.pid',
        'prl_disp_service.urgent',
        'prl_naptd.pid',
        'prl_watchdog-ebdba5702a20.pid',
        'resolv.conf',
        'rtadvd.pid',
        'signpost_reporter_running',
        'socketfilterfw.launchd',
        'syslog.pid',
        'systemkeychaincheck.done',
        'utmpx',
        'VMware Fusion Services.lock',
        'wifi'
      )
      AND NOT file.filename LIKE '%.pid'
    GROUP BY
      file.path;
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unusually Tainted Kernel Linux"
  description: Unusually tainted kernel - via a loaded kernel module
  query: |
    SELECT
      taint,
      taint & 65536 AS is_aux,
      taint & 8192 is_unsigned,
      taint & 4096 AS out_of_tree,
      taint & 512 AS kernel_warning,
      taint & 614 AS requested_by_userspace,
      taint & 8 AS force_unloaded,
      taint & 4 AS out_of_spec,
      taint & 2 AS force_loaded,
      taint & 1 AS proprietary,
      modules
    FROM
      (
        SELECT
          sc.current_value AS taint,
          GROUP_CONCAT(km.name) AS modules
        FROM
          system_controls sc,
          kernel_modules km
        WHERE
          sc.name = "kernel.tainted"
        ORDER BY
          km.name ASC
      )
      -- 4096 is a signed, out of tree, open source driver
      -- 4097 is a signed, out of tree, proprietary driver
      -- 512 is a kernel warning
    WHERE
      taint NOT IN (0, 512, 4096, 4097)
      -- Some day, folks will sign rootkits. That day isn't today.
      AND is_unsigned = 1
      AND NOT (
        (
          -- 12289 is an unsigned, out of tree, proprietary
          -- 12801 is an unsigned, out of tree, proprietary with kernel warning. not great.
          taint IN (12289, 12801)
          AND (
            modules LIKE "%,nvidia,%"
            OR modules LIKE "%,v42loopback,%"
            OR modules LIKE "%,wl,%"
          )
        )
        OR (
          -- 12352 is unsigned, out of tree, requested by user space
          -- 12289 is an unsigned, out of tree, proprietary
          taint IN (12352, 12289)
          AND modules LIKE "%,v4l2loopback,%"
        )
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Hidden Launchd Files Macos"
  description: Reveal launchd services which are located in a hidden directory.
  query: |
    SELECT
      file.path,
      file.type,
      file.filename,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN signature ON file.path = signature.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE '/Library/LaunchAgents/.%'
        OR file.path LIKE '/Users/%/Library/LaunchAgents/.%'
        OR file.path LIKE '/Users/%/Library/LaunchDaemons/.%'
      )
      AND file.filename NOT IN ('.', '..', '.DS_Store')
      AND NOT (
        file.filename = '.DS_Store'
        AND hash.sha256 = 'd65165279105ca6773180500688df4bdc69a2c7b771752f0a46ef120b7fd8ec3'
      )
      -- Kandji temp file
      AND NOT (
        file.path LIKE '/Library/LaunchAgents/.dat.nosync%'
        AND size = 242
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Overwritten Memory Map Ddexec Linux"
  description: Processes with a memory map that suggests they might be code smuggling.
  query: |
    SELECT
      pmm.path AS mmap_path,
      pmm.start as mmap_start,
      pmm.end AS mmap_end,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.path != ""
      AND pmm.offset = 0
      AND pmm.device = '00:00'
      AND pmm.permissions = 'r--p'
      AND pmm.pseudo = 0
      and pmm.start LIKE '0x0%'
    GROUP BY
      p0.pid;
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Parent Pid Missing From Procfs"
  description: Find a process which has a parent that is not listed in the process table
  query: |
    SELECT
      p.*,
      hash.sha256,
      GROUP_CONCAT(DISTINCT pof.path) AS open_files
    FROM
      processes p
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN process_open_files pof ON p.pid = pof.pid
    WHERE -- Prevent false positives by avoiding short-lived commands
      p.start_time < (strftime('%s', 'now') -300)
      AND p.parent NOT IN (
        SELECT
          pid
        FROM
          processes
      )
      AND p.parent != 0
      AND p.parent IS NOT NULL
    GROUP BY
      p.pid
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Pid Hidden By Rootkit"
  description: Finds processes that are apparently hidden by a rootkit
  query: |
    WITH RECURSIVE
      cnt (x) AS (
        SELECT
          1
        UNION ALL
        SELECT
          x + 1
        FROM
          cnt
        LIMIT
          32768
      )
    SELECT
      p.*
    FROM
      cnt
      JOIN processes p ON x = p.pid
    WHERE
      x NOT IN (
        SELECT
          pid
        FROM
          processes
      )
      AND p.start_time < (strftime('%s', 'now') - 1) -- Improve how we filter tasks out.
      -- This is not very precise. What we really want to do is verify that
      -- this pid is not listed as a task of any other pid
      AND (
        p.pgroup = p.pid
        OR (
          p.pid = p.parent
          AND p.threads = 1
        )
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Dev Executables Linux"
  description: Find unexpected executables in /dev
  query: |
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        -- This list is the result of multiple queries combined and can likely be minimized
        file.path LIKE '/dev/%%'
        OR file.path LIKE '/dev/%%/%%'
        OR file.path LIKE '/dev/mqueue/.%/%%'
        OR file.path LIKE '/dev/mqueue/%/.%/%%'
        OR file.path LIKE '/dev/mqueue/%/%/.%'
        OR file.path LIKE '/dev/mqueue/%/%%'
        OR file.path LIKE '/dev/mqueue/%%'
        OR file.path LIKE '/dev/shm/.%/%%'
        OR file.path LIKE '/dev/shm/%/.%/%%'
        OR file.path LIKE '/dev/shm/%/%/.%'
        OR file.path LIKE '/dev/shm/%/%%'
        OR file.path LIKE '/dev/shm/%%'
      )
      AND file.type = 'regular'
      AND file.size > 64
      AND file.path NOT LIKE '%/../%'
      AND file.path NOT LIKE '%/./%'
      AND (
        file.mode LIKE '%7%'
        or file.mode LIKE '%5%'
        or file.mode LIKE '%1%'
      ) -- Seen on Ubuntu
      AND NOT (
        file.uid = 1000
        AND file.gid = 1000
        AND file.mode = '0700'
        AND (
          magic.data IS NULL
          OR magic.data = 'data'
        )
        AND file.path LIKE '/dev/shm/pulse-shm-%'
        AND file.size > 60000000
      ) -- Seen with Steam
      AND NOT (
        file.uid = 1000
        AND file.gid IN (100, 1000)
        AND file.mode IN ('0755', '0775')
        AND file.path LIKE '/dev/shm/u1000-Shm_%'
        AND (
          magic.data IS NULL
          OR magic.data NOT LIKE "%executable%"
          OR magic.data IN (
            'Applesoft BASIC program data, first line number 86',
            'data',
            'DOS executable (COM)',
            'mc68k executable (shared)'
          )
        )
      )
      AND NOT (
        file.uid = 1000
        AND file.gid IN (100, 1000)
        AND file.mode IN ('0755', '0775')
        AND magic.data IS NULL
        AND file.path LIKE '/dev/shm/u1000-Shm_%'
      )
      AND NOT (
        file.uid = 1000
        AND file.gid IN (100, 1000)
        AND file.mode IN ('0755', '0775')
        AND file.path = '/dev/shm/u1000-ValveIPCSharedObj-Steam'
        AND file.size > 2000000
      )
      AND NOT (
        file.uid = 1000
        AND file.mode = '0755'
        AND file.path LIKE '/dev/shm/flatpak-com.valvesoftware.Steam-%/u1000-Shm_%'
        AND file.size > 1000000
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/evasion] Unexpected Var Executables Macos"
  description: Find unexpected executables in /var
  query: |
    SELECT
      file.path,
      file.directory,
      uid,
      gid,
      mode,
      file.mtime,
      file.size,
      hash.sha256,
      magic.data,
      signature.authority,
      signature.identifier
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE -- Optimization: don't join things until we have a whittled down list of files
      file.path IN (
        SELECT DISTINCT
          path
        FROM
          file
        WHERE
          (
            file.directory = '/var/tmp'
            OR file.directory = '/var/spool'
            OR file.directory LIKE '/var/spool/.%'
            OR file.directory LIKE '/var/spool/.%/.%'
            OR file.directory LIKE '/var/spool/.%/%'
            OR file.directory LIKE '/var/spool/%'
            OR file.directory LIKE '/var/spool/%/.%'
            OR file.directory LIKE '/var/spool/%/%'
            OR file.directory LIKE '/var/tmp/.%'
            OR file.directory LIKE '/var/tmp/.%/.%'
            OR file.directory LIKE '/var/tmp/.%/%'
            OR file.directory LIKE '/var/tmp/%'
            OR file.directory LIKE '/var/tmp/%/.%'
            OR file.directory LIKE '/var/tmp/%/%'
          ) -- Prevent weird recursion
          AND NOT file.directory LIKE '%/../%'
          AND NOT file.directory LIKE '%/./%' -- Exclude very temporary files
          AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable files
          AND file.type = 'regular'
          AND (
            file.mode LIKE '%7%'
            or file.mode LIKE '%5%'
            or file.mode LIKE '%1%'
          ) -- Rosetta cache, SIP protected
          AND file.path NOT LIKE '/var/db/oah/%'
          AND file.path NOT LIKE '/var/folders/%/C/com.apple.FontRegistry/annex_aux'
          AND file.path NOT LIKE '/var/folders/%/T/freefn-%_emacs_%.eln'
          AND file.path NOT LIKE '/var/folders/%/T/go.%.%.sum'
          AND file.path NOT LIKE '/var/folders/%/T/iTerm2-script%'
          AND file.path NOT LIKE '/var/folders/%/T/jansi-%-libjansi.jnilib'
          AND file.path NOT LIKE '/var/folders/%/T/pulumi-go.%'
          AND file.path NOT LIKE '/var/folders/%/T/sp_relauncher'
          AND file.path NOT LIKE '/var/run/current-system/etc/profiles/per-user/%'
          AND file.path NOT LIKE '/var/tmp/epdfinfo%'
          AND file.path NOT LIKE '/var/tmp/IN_PROGRESS_sysdiagnose_%.tmp/mddiagnose.mdsdiagnostic/%.log'
          AND file.path NOT LIKE '/var/tmp/sysdiagnose_%/mddiagnose.mdsdiagnostic/%.log'
          AND file.directory NOT IN (
            '/var/db/xcode_select_link/Makefiles/VersioningSystems/',
            '/var/db/xcode_select_link/usr/bin',
            '/var/db/xcode_select_link/usr/lib',
            '/var/db/xcode_select_link/usr/libexec',
            '/var/ossec/agentless',
            '/var/ossec/bin',
            '/var/ossec/wodles',
            '/var/run/booted-system',
            '/var/run/current-system',
            '/var/run/current-system/sw/bin',
            '/var/select',
            '/var/select/X11/bin',
            '/var/select/X11/lib',
            '/var/select/X11/lib/dri',
            '/var/select/X11/lib/flat_namespace',
            '/var/select/X11/libexec',
            '/var/spool/postfix/incoming'
          )
          AND file.path NOT IN (
            '/var/log/acroUpdaterTools.log',
            '/var/vm/sleepimage',
            '/var/spool/postfix/incoming/D3A82F0F057'
          )
          AND file.size > 10
          AND NOT (
            file.path LIKE '/var/folders/%/T/sp_update/%'
            AND file.gid = 20
            AND file.uid = 501
          ) -- JetBrains (Delve)
          AND NOT (
            file.path LIKE '/var/folders/%/T/dlvLauncher%.sh'
            AND file.size < 1024
            AND file.mode = '0744'
          )
          AND NOT (
            file.path LIKE '/var/folders/%/T/libjansi-%.jnilib'
            AND file.size < 40000
            AND file.uid = 501
          )
          AND NOT (
            file.path LIKE '/var/tmp/_bazel_%/%/install/%'
            AND file.uid = 501
          )
      ) -- It's pretty rare, but some vendors install updates into /var. Spotify, I'm looking at you!
      AND NOT signature.authority IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mozilla Corporation (43AQ936H96)',
        'Developer ID Application: Spotify (2FNC3A47ZF)',
        'Software Signing'
      )
      AND NOT (
        file.path LIKE '/var/db/timezone/zoneinfo/%'
        AND magic.data LIKE 'timezone%'
        AND file.size < 3000
        AND file.mode = '0755'
      ) -- Epson
      AND NOT (
        file.path LIKE '/var/tmp/InstallLog/%.plist'
        AND magic.data = 'Apple binary property list'
        AND file.size < 3000
        AND file.mode = '0777'
      )
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Exotic Command Events Linux"
  description: Pick out exotic processes based on their command-line (events-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      pe.uptime AS p0_uptime,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      AND p1.start_time <= pe.time
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.time <= pe.time
      AND pe1.cmdline != ""
      AND pe1.cwd != ""
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      AND p1_p2.start_time <= p1.start_time
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      AND pe1_p2.start_time <= pe1.time
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != ""
      AND pe1_pe2.cwd != ""
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ""
      AND pe.cwd != ""
      AND (
        p0_name IN (
          'bitspin',
          'bpftool',
          'cpuminer-multi',
          'cpuminer',
          'dnscat2',
          'esxcli',
          'heyoka',
          'httpdns',
          'incbit',
          'insmod',
          'iodine',
          'kmod',
          'lushput',
          'minerd',
          'mkfifo',
          'msfvenom',
          'nc',
          'nstx',
          'rsh',
          'rshell',
          'socat',
          'tuns',
          'vim-cmd',
          'xmrig'
        ) -- Chrome Stealer
        OR p0_name LIKE '%attack%' -- Unusual behaviors
        OR p0_name LIKE '%pwn%'
        OR p0_cmd LIKE '%cat /dev/null >%'
        OR p0_cmd LIKE '%chattr -i%'
        OR p0_cmd LIKE '%chrome%-load-extension%' -- Known attack scripts
        OR p0_cmd LIKE '%dd if=/dev/%'
        OR p0_cmd LIKE '%iptables -F%'
        OR p0_cmd LIKE '%iptables -P % ACCEPT%'
        OR p0_cmd LIKE '%iptables stop'
        OR p0_cmd LIKE '%setenforce 0'
        OR p0_cmd LIKE '%truncate -s0 %'
        OR p0_cmd LIKE '%ufw disable%'
        OR (
          INSTR(p0_cmd, 'history') > 0
          AND p0_cmd LIKE '%history'
          AND p0_cmd NOT LIKE 'man %'
        )
        OR p0_cmd LIKE '%.aws/%'
        OR p0_cmd LIKE '%.config/%chrome%'
        OR p0_cmd LIKE '%.config%gcloud%'
        OR p0_cmd LIKE '%ld.so.preload%'
        OR p0_cmd LIKE '%nohup%tmp%'
        OR p0_cmd LIKE '%pkill -f%'
        OR p0_cmd LIKE '%systemctl disable firewalld%'
        OR p0_cmd LIKE '%systemctl stop firewalld%'
        OR p0_cmd LIKE '%tar % .%'
        OR p0_cmd LIKE '%tar %/.%'
        OR p0_cmd LIKE '%touch -r%'
        OR p0_cmd LIKE '%touch%acmr%'
        OR p0_cmd LIKE '%urllib.urlopen%'
        OR (
          p0_cmd LIKE '%xargs kill -9%'
          AND pe.euid = 0
        )
        OR p0_cmd LIKE '%@reboot%crontab%'
        OR p0_cmd LIKE '%/dev/%cp/%'
        OR p0_cmd LIKE '%echo%|%base64%-d% %|%'
        OR p0_cmd LIKE '%fsockopen%'
        OR p0_cmd LIKE '%monero%'
        OR p0_cmd LIKE '%nanopool%'
        OR p0_cmd LIKE '%nicehash%'
        OR p0_cmd LIKE '%nohup /bin/bash%'
        OR p0_cmd LIKE '%openssl%quiet%'
        OR p0_cmd LIKE '%pty.spawn%'
        OR p0_cmd LIKE '%stratum%'
        OR p0_cmd LIKE '%UserKnownHostsFile=/dev/null%' -- Crypto miners
        OR (
          p0_cmd LIKE '%sh -i'
          AND NOT p1_name IN ('sh', 'java')
        )
        OR p0_cmd LIKE '%SOCK_STREAM%'
        OR INSTR(p0_cmd, 'Socket.') > 0
        OR (
          p0_cmd LIKE '%tail -f /dev/null%'
          AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
        )
      ) -- Things that could reasonably happen at boot.
      AND NOT (
        pe.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND p1_path = '/usr/lib/systemd/systemd'
        AND p1_cmd = '/sbin/init'
      )
      AND NOT (
        pe.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND p1_name IN (
          'dockerd',
          'firewalld',
          'kube-proxy',
          'mkinitramfs',
          'systemd'
        )
      )
      AND NOT (
        p0_cmd LIKE '/usr/bin/modprobe %'
        AND p1_cgroup = '/system.slice/firewalld.service'
      )
      AND NOT (
        pe.path IN ('/usr/bin/kmod', '/bin/kmod')
        AND pe.uptime < 15
      )
      AND NOT (
        pe.path = '/usr/bin/mkfifo'
        AND (
          p0_cmd LIKE '%/org.gpgtools.log.%/fifo'
          OR p0_cmd LIKE 'mkfifo -- %/gitstatus.POWERLEVEL9K%.fifo'
          OR p0_cmd LIKE '%/p10k.%'
        )
      )
      AND NOT p0_cmd IN (
        'lsmod',
        'dd if=/dev/stdin conv=unblock cbs=79',
        '/usr/bin/socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket',
        'socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket'
      )
      AND NOT p0_cmd LIKE '%/usr/bin/cmake%Socket%'
      AND NOT p0_cmd LIKE '%modprobe -va%'
      AND NOT p0_cmd LIKE '%modprobe aufs'
      AND NOT p0_cmd LIKE '%modprobe nf_nat_netbios_ns'
      AND NOT p0_cmd LIKE '%modprobe overlay'
      AND NOT p0_cmd LIKE '%touch -r /tmp/cc%.o %'
      AND NOT p0_cmd LIKE 'find . -executable -type f -name %grep -l GNU Libtool%touch -r%'
      AND NOT p0_cmd LIKE 'modinfo -k%'
      AND NOT p0_cmd LIKE 'modprobe --all%'
      AND NOT p0_cmd LIKE 'modprobe -ab%'
      AND NOT p0_cmd LIKE 'pkill -f cut -c3%'
      AND NOT p0_name IN ('ar', 'cc1', 'cc1plus', 'cmake', 'compile')
      AND NOT exception_key IN (
        'bash,0,bash,containerd-shim-runc-v2',
        'bash,500,ninja,bash',
        'bwrap,500,melange,dash',
        'chrome_crashpad_handler,500,systemd,systemd',
        'grep,500,fish,konsole',
        'kmod,0,incusd,systemd',
        'ls,500,zsh,alacritty',
        'nc,500,fish,konsole',
        'tar,0,incusd,systemd'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Exotic Command Events Macos"
  description: Pick out exotic processes based on their command-line (events-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -180)
      AND pe.status = 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND (
        p0_name IN (
          'bitspin',
          'bpftool',
          'csrutil',
          'dnscat2',
          'heyoka',
          'incbit',
          'iodine',
          'kmod',
          'lushput',
          'mkfifo',
          'msfvenom',
          'nc',
          'nstx',
          'rsh',
          'rshell',
          'socat',
          'tuns'
        ) -- Chrome Stealer
        OR p0_name LIKE '%pwn%'
        OR p0_cmd LIKE '%set visible of front window to false%'
        OR p0_cmd LIKE '%chrome%-load-extension%' -- Known attack scripts
        OR p0_name LIKE '%attack%' -- Unusual behaviors
        OR p0_cmd LIKE '%chattr -i%'
        OR p0_cmd LIKE '%dd if=/dev/%'
        OR p0_cmd LIKE '%cat /dev/null >%'
        OR p0_cmd LIKE '%truncate -s0 %'
        OR p0_cmd LIKE '%touch%acmr%'
        OR p0_cmd LIKE '%touch -r%'
        OR p0_cmd LIKE '%ld.so.preload%'
        OR p0_cmd LIKE 'killall%NotificationCenter'
        OR p0_cmd LIKE '%urllib.urlopen%'
        OR p0_cmd LIKE '%nohup%tmp%'
        OR p0_cmd LIKE '%killall Terminal%'
        OR (
          pe.euid = 0
          AND (
            p0_cmd LIKE '%pkill -f%'
            OR p0_cmd LIKE '%xargs kill -9%'
          )
        )
        OR p0_cmd LIKE '%rm -f /var/tmp%'
        OR p0_cmd LIKE '%rm -f /tmp%'
        OR p0_cmd LIKE '%nohup /bin/bash%'
        OR (
          INSTR(p0_cmd, 'history') > 0
          AND p0_cmd LIKE '%history'
          AND p0_cmd NOT LIKE '% history'
        )
        OR p0_cmd LIKE '%echo%|%base64 --decode %|%'
        OR p0_cmd LIKE '%echo%|%base64 -d %|%'
        OR p0_cmd LIKE '%launchctl bootout%'
        OR p0_cmd LIKE '%chflags uchg%'
        OR (
          p0_cmd LIKE '%UserKnownHostsFile=/dev/null%'
          AND NOT p1_name = 'limactl'
          AND NOT p1_cmd LIKE '%gcloud.py%'
        ) -- Random keywords
        OR p0_cmd LIKE '%ransom%' -- Reverse shells
        OR p0_cmd LIKE '%fsockopen%'
        OR p0_cmd LIKE '%openssl%quiet%'
        OR p0_cmd LIKE '%pty.spawn%'
        OR (
          p0_cmd LIKE '%sh -i'
          AND NOT p1_name IN ('sh', 'java')
          AND NOT p1_cmd LIKE "%pipenv shell"
        )
        OR p0_cmd LIKE 'socat %'
        OR p0_cmd LIKE '%SOCK_STREAM%'
        OR INSTR(p0_cmd, 'Socket.') > 0
      ) -- Things that could reasonably happen at boot.
      AND NOT (
        pe.path = '/usr/bin/mkfifo'
        AND (
          p0_cmd LIKE '%/org.gpgtools.log.%/fifo'
          OR p0_cmd LIKE '%/var/%/gitstatus.POWERLEVEL9K.%'
          OR p0_cmd LIKE '%/var/%/p10k.worker.%'
          OR p0_cmd LIKE '%/tmp/blesh/%'
        )
      )
      AND NOT (
        p0_cmd LIKE '%csrutil status'
        AND p1_name IN ('Dropbox')
      )
      AND NOT (
        p0_cmd IN (
          '/bin/launchctl bootout gui/501 /Library/LaunchAgents/com.logi.optionsplus.plist',
          '/bin/launchctl bootout system/com.docker.socket',
          '/bin/rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
          '/Library/Apple/System/Library/StagedFrameworks/Safari/SafariShared.framework/XPCServices/com.apple.Safari.History.xpc/Contents/MacOS/com.apple.Safari.History',
          '/usr/bin/csrutil report',
          '/usr/bin/csrutil status',
          '/usr/bin/pkill -F /private/var/run/lima/shared_socket_vmnet.pid',
          '/usr/bin/sudo /bin/rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',
          '/usr/bin/xattr -d com.apple.writer_bundle_identifier /Applications/Safari.app',
          'dd if=/dev/stdin conv=unblock cbs=79',
          'dd if=/dev/urandom bs=15 count=1 status=none',
          'git history',
          'helm history',
          'launchctl bootout gui/501/com.grammarly.ProjectLlama.UninstallAgent',
          'nc -h',
          'nc -uv 8.8.8.8 53',
          'nc localhost 8080 -vz',
          'nc',
          'nix profile history',
          'rm -f /tmp/mysql.sock',
          'sh -c launchctl bootout system "/Library/LaunchDaemons/com.ecamm.EcammAudioXPCHelper.plist"',
          'xpcproxy com.apple.Safari.History'
        ) -- The source of these commands is still a mystery to me.
        OR pe.parent = -1
      )
      AND NOT p0_cmd LIKE '-history%'
      AND NOT p0_cmd LIKE '/bin/cp %history%sessions/%'
      AND NOT p0_cmd LIKE '/bin/rm -f /tmp/com.adobe.%.updater/%'
      AND NOT p0_cmd LIKE '/bin/rm -f /tmp/nix-shell.%'
      AND NOT p0_cmd LIKE '/bin/rm -f /tmp/periodic.%'
      AND NOT p0_cmd LIKE '%find /Applications/LogiTuneInstaller.app -type d -exec chmod 777 {}%'
      AND NOT p0_cmd LIKE '%GNU Libtool%touch -r%'
      AND NOT p0_cmd LIKE '%nc -vz localhost%'
      AND NOT p0_cmd LIKE '%nc localhost%'
      AND NOT p0_cmd LIKE '%ssh %/lima/%'
      AND NOT p0_cmd LIKE 'dirname %history'
      AND NOT p0_cmd LIKE 'launchctl bootout gui/501 /Users/%/Library/LaunchAgents/com.elgato.StreamDeck.plist'
      AND NOT p0_cmd LIKE 'rm -f /tmp/blesh/%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/insttmp_%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/locate%/_updatedb%'
      AND NOT p0_cmd LIKE 'rm -f /tmp/locate%/mklocate%/_mklocatedb%'
      AND NOT p0_cmd LIKE 'touch -r . /private/tmp/nix-build%'
      AND NOT p0_cmd LIKE 'touch -r /tmp/KSInstallAction.%'
      AND NOT p0_name IN ('cc1', 'compile', 'yara')
      AND NOT exception_key IN (
        'bash,500,idea,launchd',
        'bat,500,zsh,login',
        'cat,500,zsh,login',
        'dd,500,zsh,login',
        'git,500,zsh,goland',
        'git,500,zsh,login',
        'go,500,fish,login',
        'jq,500,zsh,login',
        'sh,0,Ecamm Live,launchd',
        'ssh,500,limactl.ventura,launchd',
        'yara,500,bash,fish'
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Exotic Commands Linux"
  description: Pick out exotic processes based on their command-line (state-based)
  query: |
    SELECT
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- Known attack scripts
      (
        p0.name IN (
          'bitspin',
          'bpftool',
          'cpuminer-multi',
          'cpuminer',
          'dnscat2',
          'esxcli',
          'heyoka',
          'httpdns',
          'incbit',
          'insmod',
          'iodine',
          'kmod',
          'lushput',
          'minerd',
          'mkfifo',
          'msfvenom',
          'nc',
          'nstx',
          'rsh',
          'rshell',
          'socat',
          'tuns',
          'vim-cmd',
          'xmrig'
        )
        OR p0.name LIKE '%pwn%'
        OR p0.name LIKE '%xig%'
        OR p0.name LIKE '%xmr%'
        OR p0.cmdline LIKE '%--pool%'
        OR p0.cmdline LIKE '%--algo%'
        OR p0.cmdline LIKE '%--wss%'
        OR p0.cmdline LIKE '%wormhole%'
        OR p0.cmdline LIKE '%bitspin%'
        OR p0.cmdline LIKE '%lushput%'
        OR p0.cmdline LIKE '%incbit%'
        OR p0.cmdline LIKE '%traitor%'
        OR p0.cmdline LIKE '%ethereum%'
        OR p0.cmdline LIKE '%msfvenom%'
        -- Unusual behaviors
        OR p0.cmdline LIKE '%ufw disable%'
        OR p0.cmdline LIKE '%dd if=/dev/%'
        OR p0.cmdline LIKE '%iptables -P % ACCEPT%'
        OR p0.cmdline LIKE '%iptables -F%'
        OR p0.cmdline LIKE '%chattr -ia%'
        OR p0.cmdline LIKE '%chflags uchg%'
        OR p0.cmdline LIKE '%bpftool%'
        OR p0.cmdline LIKE '%tar % .%'
        OR p0.cmdline LIKE '%tar %/.%'
        OR p0.cmdline LIKE '%.config%gcloud%'
        OR p0.cmdline LIKE '%.config/%chrome%'
        OR p0.cmdline LIKE '%touch%acmr%'
        OR p0.cmdline LIKE '%ld.so.preload%'
        OR p0.cmdline LIKE '%urllib.urlopen%'
        OR p0.cmdline LIKE '%nohup%tmp%'
        OR p0.cmdline LIKE '%chrome%--load-extension%'
        OR (
          p0.cmdline LIKE '%UserKnownHostsFile=/dev/null%'
          AND NOT p1.name = 'limactl'
          AND NOT p0.cmdline LIKE '%@localhost%'
          AND NOT p0.cmdline LIKE '%@localhost -A%'
        ) -- Crypto miners
        OR p0.cmdline LIKE '%hashrate%'
        OR p0.cmdline LIKE '%hashvault%'
        OR p0.cmdline LIKE '%minerd%'
        OR p0.cmdline LIKE '%nanopool%'
        OR p0.cmdline LIKE '%nicehash%'
        OR p0.cmdline LIKE '%stratum%' -- Random keywords
        OR p0.cmdline LIKE '%plant%' -- Reverse shells
        OR p0.cmdline LIKE '%/dev/%cp/%'
        OR p0.cmdline LIKE '%fsockopen%'
        OR p0.cmdline LIKE '%openssl%quiet%'
        OR p0.cmdline LIKE '%pty.spawn%'
        OR (
          p0.cmdline LIKE '%sh -i'
          AND NOT p0.path = '/usr/bin/docker'
          AND NOT p1.name IN (
            'code',
            'containerd-shim',
            'emacs',
            'goland',
            'java',
            'pycharm',
            'zsh',
            'bash',
            'jetbrains',
            'sh',
            'vim',
            'vim.nox'
          )
          AND NOT p1.cmdline LIKE '%pipenv shell'
          AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
          AND NOT p0.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
        )
        OR p0.cmdline LIKE '%SOCK_STREAM%'
        OR INSTR(p0.cmdline, '%Socket.%') > 0 -- Keep the shell running, as in https://blog.aquasec.com/threat-alert-kinsing-malware-container-vulnerability
        OR (
          p0.cmdline LIKE '%tail -f /dev/null%'
          AND NOT p0.cmdline LIKE 'docker run%'
          AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
          AND NOT p1.pid = 0
        )
      )
      AND NOT p0.cmdline like '%socat UNIX-LISTEN:%com.discordapp%discord-ipc%'
      AND NOT p0.cmdline IN ('nc 127.0.0.1 5900')
      AND NOT p0.name IN (
        'bwrap',
        'cc1',
        'cc1plus',
        'chrome_crashpad',
        'cmake',
        'compile',
        'emacs',
        'espeak',
        'git'
      )
      AND NOT p1.name IN ('bwrap')
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Exotic Commands Macos"
  description: Pick out exotic processes based on their command-line (state-based)
  query: |
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          p.pid
        FROM
          processes p
        WHERE
          p.name IN (
            'bitspin',
            'bpftool',
            'cpuminer-multi',
            'cpuminer',
            'dnscat2',
            'esxcli',
            'heyoka',
            'httpdns',
            'incbit',
            'iodine',
            'lushput',
            'minerd',
            'mkfifo',
            'msfvenom',
            'nc',
            'nstx',
            'rsh',
            'rshell',
            'socat',
            'tuns',
            'vim-cmd',
            'xmrig'
          ) -- coin miner names
          OR REGEX_MATCH (p.name, "(pwn|xig|xmr)", 1) != "" -- malicious processes
          OR REGEX_MATCH (
            p.cmdline,
            "(bitspin|lushput|incbit|traitor|msfvenom|urllib.urlopen|nohup.*tmp|chrome.*--load-extension|tail -f /dev/null|wormhole)",
            1
          ) != "" -- suspicious things
          OR REGEX_MATCH (
            p.cmdline,
            "(UserKnownHostsFile=/dev/null|ransom|fsockopen|openssl.*quiet|pty.spawn|SOCK_STREAM)",
            1
          ) != "" -- Crypto miners
          OR REGEX_MATCH (
            p.cmdline,
            "(c3pool|cryptonight|f2pool|hashrate|hashvault|minerd|monero|nanopool|nicehash|stratum|wss://| --pool| --algo)",
            1
          ) != "" -- Needs to be case sensitive
          OR (
            INSTR(p.cmdline, '%Socket.%') > 0
            AND NOT p.name IN ('cc1', 'compile', 'cmake', 'cc1plus')
          )
          OR p.cmdline LIKE '%dd if=/dev/%'
      )
      AND NOT (
        p0_cmd LIKE '%UserKnownHostsFile=/dev/null%'
        AND (
          p0_cmd LIKE "%lima/%"
          OR p0_cmd LIKE "%minikube/%"
          OR p0_cmd LIKE '%@localhost'
          OR p0_cmd LIKE '%ServerAliveInterval=0%'
          OR p1_cmd LIKE '%gcloud.py%'
        )
      )
      AND NOT (
        p0_cmd LIKE '%sh -i'
        AND p1_cmd LIKE '%pipenv shell'
      )
      AND NOT p0_cmd IN ('pkill -f Jabra Direct')
      AND NOT p0_cmd LIKE "%dd if=/dev/stdin conv=unblock cbs=79"
      AND NOT p0_cmd LIKE '%docker% run % tail -f /dev/null'
      AND NOT p1_path LIKE '/Applications/Emacs.app/Contents/MacOS/Emacs-arm64-%'
      AND NOT p0_path = '/Applications/Google Drive.app/Contents/MacOS/crashpad_handler'
    GROUP BY
      p0.cmdline
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Recently Created Executables Long Lived Linux"
  description: Long-running programs who were recently added to disk, based on btime/ctime
  query: |
    SELECT
      f.ctime AS p0_ctime,
      f.mtime AS p0_mtime,
      p0.start_time - MAX(f.ctime, f.btime) AS p0_start_delay,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.start_time AS p0_start,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.start_time AS p1_start,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.start_time AS p2_start,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.start_time > 0
      AND f.ctime > 0
      AND p0.start_time < (strftime('%s', 'now') - 86400)
      AND (p0.start_time - MAX(f.ctime, f.btime)) < 300
      AND p0.start_time >= MAX(f.ctime, f.ctime)
      AND NOT f.directory IN ('/usr/lib/firefox', '/usr/local/kolide-k2/bin') -- Typically daemons or long-running desktop apps
      -- These are binaries that are known to get updated and subsequently executed
      --
      -- What I would give for osquery to support binary signature verification on Linux
      AND NOT p0.path IN (
        '',
        '/bin/bash',
        '/bin/containerd',
        '/bin/containerd-shim-runc-v2',
        '/bin/sh',
        '/opt/google/chrome/chrome',
        '/opt/google/chrome/chrome_crashpad_handler',
        '/opt/google/chrome/nacl_helper',
        '/opt/kolide-k2/bin/launcher',
        '/opt/kolide-k2/bin/osqueryd',
        '/opt/Lens/chrome_crashpad_handler',
        '/opt/Lens/lens',
        '/opt/sublime_text/sublime_text',
        '/usr/lib/at-spi-bus-launcher',
        '/usr/lib/at-spi2-registryd',
        '/usr/lib/cups/notifier/dbus',
        '/usr/lib/docker/cli-plugins/docker-compose',
        '/usr/lib/electron25/electron',
        '/usr/lib/flatpak-session-helper',
        '/usr/lib/fwupd/fwupd',
        '/usr/lib/gdm',
        '/usr/lib/gdm-session-worker',
        '/usr/lib/gdm-x-session',
        '/usr/lib/gnome-shell-calendar-server',
        '/usr/lib/google-cloud-sdk/platform/bundledpythonunix/bin/python3',
        '/usr/lib/ibus/ibus-dconf',
        '/usr/lib/ibus/ibus-engine-simple',
        '/usr/lib/ibus/ibus-portal',
        '/usr/lib/libreoffice/program/oosplash',
        '/usr/lib/libreoffice/program/soffice.bin',
        '/usr/lib/opt/google/chrome/chrome',
        '/usr/lib/opt/kolide-k2/bin/launcher',
        '/usr/lib/opt/kolide-k2/bin/osqueryd',
        '/usr/lib/polkit-1/polkitd',
        '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1',
        '/usr/lib/slack/chrome_crashpad_handler',
        '/usr/lib/slack/slack',
        '/usr/lib/snapd/snapd',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-executor',
        '/usr/lib/systemd/systemd-homed',
        '/usr/lib/systemd/systemd-hostnamed',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib/systemd/systemd-logind',
        '/usr/lib/systemd/systemd-machined',
        '/usr/lib/systemd/systemd-oomd',
        '/usr/lib/systemd/systemd-resolved',
        '/usr/lib/systemd/systemd-timesyncd',
        '/usr/lib/systemd/systemd-userdbd',
        '/usr/lib/systemd/systemd-userwork',
        '/usr/lib/tracker-extract-3',
        '/usr/lib/upowerd',
        '/usr/lib/x86_64-linux-gnu/obs-plugins/obs-browser-page',
        '/usr/lib/xdg-desktop-portal-gtk',
        '/usr/lib/xf86-video-intel-backlight-helper',
        '/usr/lib/xorg/Xorg',
        '/usr/lib64/discord/Discord',
        '/usr/lib64/electron/electron',
        '/usr/lib64/firefox/firefox',
        '/usr/lib64/google-cloud-sdk/platform/bundledpythonunix/bin/python3',
        '/usr/lib64/thunderbird/thunderbird',
        '/usr/libexec/accounts-daemon',
        '/usr/libexec/bluetooth/bluetoothd',
        '/usr/libexec/docker/docker-proxy',
        '/usr/libexec/flatpak-portal',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/fwupd/fwupd',
        '/usr/libexec/gdm-session-worker',
        '/usr/libexec/gdm-wayland-session',
        '/usr/libexec/gnome-shell-calendar-server',
        '/usr/libexec/gstreamer-1.0/gst-plugin-scanner',
        '/usr/libexec/gvfsd-dnssd',
        '/usr/libexec/gvfsd-metadata',
        '/usr/libexec/gvfsd-network',
        '/usr/libexec/gvfsd-recent',
        '/usr/libexec/gvfsd-wsdd',
        '/usr/libexec/ibus-dconf',
        '/usr/libexec/ibus-engine-simple',
        '/usr/libexec/ibus-extension-gtk3',
        '/usr/libexec/ibus-portal',
        '/usr/libexec/ibus-x11',
        '/usr/libexec/power-profiles-daemon',
        '/usr/libexec/snapd/snapd',
        '/usr/libexec/sssd/sssd_kcm',
        '/usr/libexec/tracker-extract-3',
        '/usr/libexec/tracker-miner-fs-3',
        '/usr/libexec/xdg-desktop-portal',
        '/usr/libexec/xdg-document-portal',
        '/usr/libexec/xdg-permission-store',
        '/usr/local/bin/kind',
        '/usr/sbin/dnsmasq',
        '/usr/share/code/chrome_crashpad_handler',
        '/usr/share/code/code',
        '/usr/share/codium/chrome-sandbox',
        '/usr/share/codium/codium',
        '/usr/share/librewolf/librewolf',
        '/usr/share/spotify-client/spotify',
        '/usr/share/teams/team'
      )
      AND NOT p0.path LIKE '/home/%/.cache/JetBrains/%/GoLand/___%'
      AND NOT p0.path LIKE '/home/%/.local/share/JetBrains/Toolbox/apps/%'
      AND NOT p0.path LIKE '/home/%/.local/share/nvim/mason/packages/%'
      AND NOT p0.path LIKE '/home/%/.local/share/Steam/ubuntu%'
      AND NOT p0.path LIKE '/home/%/.rustup/toolchains/%/libexec/%'
      AND NOT p0.path LIKE '/home/%/%.test'
      AND NOT p0.path LIKE '/home/%/bin/%'
      AND NOT p0.path LIKE '/home/%/.cache/JetBrains/%'
      AND NOT p0.path LIKE '/home/%/.local/share/JetBrains/%'
      AND NOT p0.path LIKE '/home/%/git/%'
      AND NOT p0.path LIKE '/home/%/jbr/bin/java'
      AND NOT p0.path LIKE '/home/%/jbr/lib/jcef_helper'
      AND NOT p0.path LIKE '/home/%/node_modules/.bin/%'
      AND NOT p0.path LIKE '/home/%/Projects/%'
      AND NOT p0.path LIKE '/home/%/terraform-provider-%'
      AND NOT p0.path LIKE '/home/%/upstream/%'
      AND NOT p0.path LIKE '/nix/store/%/bin/%'
      AND NOT p0.path LIKE '/nix/store/%/libexec/%'
      AND NOT p0.path LIKE '/opt/%'
      AND NOT p0.path LIKE '/tmp/go-build%'
      AND NOT p0.path LIKE '/tmp/terraform_%/terraform'
      AND NOT p0.path LIKE '/tmp/tmp0.%/%/bin/%'
      AND NOT p0.path LIKE '/usr/local/bin/%'
      AND NOT p0.path LIKE '/usr/local/Cellar/%'
      AND NOT p0.path LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/launcher'
      AND NOT p0.path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
      AND NOT p0.path LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%'
      AND NOT p0.path LIKE '/var/kolide-k2/%/launcher'
      AND NOT p0.path LIKE '/var/kolide-k2/%/osqueryd'
      AND NOT p0.path LIKE '/var/opt/Elastic/Agent/data/elastic-agent-%/components/%'
      AND NOT p0.path LIKE '%/.local/share/spotify-launcher/install/usr/%'
      AND NOT p0.path LIKE '%/.vscode/extensions/%'
      AND NOT p0.path LIKE '%/gitstatus/gitstatusd-linux-x86_64'
      AND NOT (
        p0.name IN ('osqtool-x86_64', 'osqtool-arm64')
        AND p0.cmdline LIKE './%'
      )
      AND NOT p1.path IN ('/usr/bin/gnome-shell') -- Filter out developers working on their own code
      AND NOT p1.name IN ('makepkg', 'make', 'dovecot')
      AND NOT p2.path = '/usr/bin/yay'
      AND NOT p2.cmdline LIKE '/usr/bin/yay %'
      AND NOT (
        f.directory IN ('/usr/bin', '/usr/sbin')
        AND f.filename NOT LIKE '.%'
      )
      AND NOT (
        p0.path LIKE '/home/%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
        AND p0.cmdline LIKE './%'
        AND p0.path NOT LIKE '%/.%'
        AND p0.path NOT LIKE '%cache%'
      )
      AND NOT (
        p0.path LIKE '/tmp/%/osqtool-%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
        AND p0.cmdline LIKE './%'
      )
      AND NOT (
        p0.path LIKE '/home/%/.magefile/%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
      )
    GROUP BY
      p0.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Recently Created Executables Long Lived Macos"
  description: Long-running programs who were started around when they were written to disk
  query: |
    SELECT
      f.ctime,
      f.btime,
      f.mtime,
      p0.start_time,
      s.authority AS s_auth,
      s.identifier AS s_id,
      REPLACE(f.directory, u.directory, '~') AS dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(f.directory, u.directory, '~'),
          '(~/.*?/.*?/.*?/)',
          1
        ),
        REPLACE(f.directory, u.directory, '~')
      ) AS top3_dir,
      REPLACE(f.path, u.directory, '~') AS homepath,
      p0.start_time - f.btime AS start_birth_delta,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.start_time AS p1_start,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > 0
          AND start_time > (strftime('%s', 'now') - 86400)
          AND pid > 0
          AND path != ""
          AND NOT path LIKE '/Applications/%'
          AND NOT path LIKE '/bin/%'
          AND NOT path LIKE '/Library/Apple/%'
          AND NOT path LIKE '/Library/Elastic/Agent/data/%/components/%'
          AND NOT path LIKE '/nix/store/%'
          AND NOT path LIKE '/opt/%'
          AND NOT path LIKE '/System/%'
          AND NOT path LIKE '/usr/bin/%'
          AND NOT path LIKE '/usr/libexec/%'
          AND NOT path LIKE '/usr/local/kolide-k2/bin/%'
          AND NOT path LIKE '/usr/sbin/%'
          AND NOT path LIKE '%/bin/cargo'
      )
      -- Processes that started around when they were last modified on disk
      AND start_birth_delta BETWEEN -900 AND 900
      -- Exceptions for no-privileged execution
      AND NOT (
        p0.euid > 499
        AND (
          top3_dir IN (
            '/Library/Application Support/EcammLive',
            '/Library/Developer/Xcode/',
            '/usr/local/kolide-k2/Kolide.app/Contents/MacOS',
            '~/.local/share/bob/',
            '~/.local/share/nvim/',
            '~/.cache/selenium/chromedriver/',
            '~/.terraform.d/plugin-cache/registry.terraform.io/',
            '~/.vscode/extensions/ms-vscode.cpptools-1.15.4-darwin-arm64/',
            '~/homebrew/Library/Homebrew/',
            '~/Library/Application Support/BraveSoftware/',
            '~/Library/Application Support/com.elgato.StreamDeck/',
            '~/Library/Application Support/duckly/',
            '~/Library/Application Support/Figma/',
            '~/Library/Application Support/Foxit Software/',
            '~/Library/Application Support/JetBrains/',
            '~/Library/Application Support/OpenLens',
            '~/Library/Application Support/sourcegraph-sp/',
            '~/Library/Application Support/Steam/',
            '~/Library/Application Support/WebEx Folder/',
            '~/Library/Application Support/Zed/',
            '~/Library/Application Support/Zwift',
            '~/Library/Application Support/Zwift/',
            '~/Library/Caches/com.mimestream.Mimestream/',
            '~/Library/Caches/com.sempliva.Tiles/',
            '~/Library/Caches/company.thebrowser.Browser/',
            '~/Library/Caches/JetBrains/',
            '~/Library/Caches/org.gpgtools.updater/',
            '~/Library/Caches/snyk/',
            '~/projects/go/src/'
          )
          OR dir IN (
            '/usr/local/aws-cli',
            '/usr/local/kolide-k2/Kolide.app/Contents/MacOS',
            '~/.local/bin',
            '~/.local/share/gh/extensions/gh-sbom',
            '~/.magefile',
            '~/bin',
            '~/code/bin',
            '~/go/bin',
            '~/gohome/bin',
            '~/Library/Application Support/cloud-code/installer/google-cloud-sdk/bin',
            '~/Library/Application Support/dev.warp.Warp-Stable',
            '~/Library/Application Support/snyk-ls',
            '~/Library/Application Support/zoom.us/Plugins/aomhost.app/Contents/MacOS',
            '~/melange',
            '~/projects/go/bin',
            '~/repos/bincapz/out'
          )
          OR dir LIKE '~/%.vscode/extensions/%'
          OR dir LIKE '~/%/go/bin'
          OR dir LIKE '~/%/node_modules/%bin'
          OR dir LIKE '~/.rustup/toolchains/%'
          OR dir LIKE '~/.vscode-insiders/extensions/%'
          OR dir LIKE '~/Applications/%.app/%'
          OR dir LIKE '~/dev/%'
          OR dir LIKE '~/Documents/GH/%'
          OR dir LIKE '~/Downloads/%.app/Contents/MacOS'
          OR dir LIKE '~/git/%'
          OR f.path LIKE '%go-build%'
          OR homepath LIKE '~/%/cloud_sql_proxy'
          OR homepath LIKE '~/%/gopls'
          OR homepath LIKE '~/%/pkg/%.test'
          OR homepath LIKE '~/%/src/%.test'
          OR homepath LIKE '~/%/terraform-provider-%'
          OR homepath LIKE '~/chainguard-dev/%'
          OR homepath LIKE '~/repos/%'
          OR homepath LIKE '~/github/%'
          OR homepath LIKE '~/go/%/bin'
          OR homepath LIKE '~/go/src/%'
          OR homepath LIKE '~/Parallels/%/WinAppHelper'
          OR homepath LIKE '~/src/%'
          OR f.path LIKE '/private/tmp/%/Creative Cloud Installer.app/Contents/MacOS/Install'
          OR f.path LIKE '/private/tmp/go-%'
          OR f.path LIKE '/private/tmp/nix-build-%'
          OR f.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          OR f.path LIKE '/private/var/folders/%/bin/%'
          OR f.path LIKE '/private/var/folders/%/d/Wrapper/%.app/%'
          OR f.path LIKE '/private/var/folders/%/GoLand/%'
          OR f.path LIKE '/private/var/folders/%/T/download/ARMDCHammer'
          OR f.path LIKE '/private/var/folders/%/T/pulumi-go.%'
        )
      )
      AND NOT s.authority IN (
        'Apple iPhone OS Application Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: AMZN Mobile LLC (94KV3E626L)',
        'Developer ID Application: Autodesk (XXKJ396S2Y)',
        'Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Bryan Jones (49EYHPJ4Q3)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Denver Technologies, Inc (2BBY89MBSN)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Emmanouil Konstantinidis (3YP8SXP3BF)',
        'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Galvanix (5BRAQAFB8B)',
        'Developer ID Application: Garmin International (72ES32VZUA)',
        'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: GitHub (VEKTX9H2N7)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: GPGTools GmbH (PKV8ZPD836)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Michael Jones (YD6LEYT6WZ)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mojang AB (HR992ZEAE6)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: SteelSeries (6WGL6CHFH2)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: SUSE LLC (2Q6FHJR3H3)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Developer ID Application: The Browser Company of New York Inc. (S6N382Y83G)',
        'Developer ID Application: VMware, Inc. (EG7KH642X6)',
        'Developer ID Application: Wesley FURLONG (P4A6FU9KZ3)',
        'Developer ID Application: Wizards of OBS LLC (2MMRE5MTB8)',
        'Developer ID Application: Yubico Limited (LQA3CS5MM7)',
        'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        'Developer ID Application: Zwift, Inc (C2GM8Y9VFM)',
        'Software Signing'
      )
      AND NOT (
        s.identifier = "com.apple.print.PrinterProxy"
        AND p0.path LIKE "/Users/%/Library/Printers/%/Contents/MacOS/PrinterProxy"
        AND p0.uid > 499
      )
      -- Local developer testing
      AND NOT (
        homepath LIKE '~/%'
        AND p0.uid > 499
        AND f.ctime = f.mtime
        AND f.uid = p0.uid
        AND p0.cmdline LIKE './%'
        AND p0.path NOT LIKE '%Library%'
        AND p0.path NOT LIKE '%/.%'
        AND p0.path NOT LIKE '%Cache%'
      )
      AND NOT p1.name IN ('makepkg', 'make')
      -- Arc
      AND NOT (
        p0.path LIKE '/Users/%/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%'
        AND s.identifier = 'org.sparkle-project.Sparkle.Updater'
        AND s.authority != ''
        AND p0.uid > 499
      )
      AND NOT (
        p0.path = '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent'
        AND s_auth = 'Developer ID Application: MacPaw Inc. (S8EX82NJP6)'
      )
    GROUP BY
      p0.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Sketchy Fetcher Events"
  description: Suspicious URL requests by built-in fetching tools (event-based)
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Extra fields
      REGEX_MATCH (pe.cmdline, '(\w+:\/\/.*)\b', 1) AS url,
      REGEX_MATCH (pe.cmdline, '[ /](\d+\.\d+\.\d+\.\d+)[:/]', 1) AS ip,
      REGEX_MATCH (pe.cmdline, ':(\d+)', 1) AS port,
      REGEX_MATCH (pe.cmdline, '//([\w\-\.]+)[:/]', 1) AS addr,
      REGEX_MATCH (pe.cmdline, '//[\w\-\.]+\.(\w+)[:/]', 1) AS tld
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      -- Extra fields
    WHERE
      pe.time > (strftime('%s', 'now') -120)
      AND pe.cmdline != ''
      -- NOTE: Sync remaining portion with sketchy-fetchers
      AND (
        INSTR(pe.cmdline, 'wget ') > 0
        OR INSTR(pe.cmdline, 'curl ') > 0
      )
      -- Sketchy fetcher events always seem to contain a switch
      AND pe.cmdline LIKE '%-%'
      AND pe.cmdline LIKE '%/%'
      AND (
        -- If it's an IP or port, it's suspicious
        ip NOT IN ('', '127.0.0.1', '0.0.0.0', '::1')
        OR port != ''
        OR tld NOT IN (
          '',
          'app',
          'ca',
          'cloud',
          'com',
          'de',
          'dev',
          'edu',
          'fun',
          'gov',
          'io',
          'md',
          'mil',
          'net',
          'org',
          'se',
          'sh',
          'so',
          'uk',
          'us'
        )
        -- Or if it matches weird keywords we've seen
        OR p.cmdline LIKE '%chmod%'
        OR pe.cmdline LIKE '%.onion%'
        OR pe.cmdline LIKE '%aliyun%'
        OR pe.cmdline LIKE '%curl -k%'
        OR pe.cmdline LIKE '%curl -sL %'
        OR pe.cmdline LIKE '%curl %--user-agent%'
        OR pe.cmdline LIKE '%curl.*write-out%'
        OR pe.cmdline LIKE '%curl%--connect-timeout%'
        OR pe.cmdline LIKE '%curl%--insecure%'
        OR pe.cmdline LIKE '%curl%--O /dev/null%'
        OR pe.cmdline LIKE '%curl%--output /dev/null%'
        OR pe.cmdline LIKE '%curl%-o-%'
        OR pe.cmdline LIKE '%pastebin%'
        OR pe.cmdline LIKE '%tor2web%'
        OR pe.cmdline LIKE '%wget -nc%'
        OR pe.cmdline LIKE '%wget -q%'
        OR pe.cmdline LIKE '%wget -t%'
        OR pe.cmdline LIKE '%wget %--no-check-certificate%'
        OR pe.cmdline LIKE '%wget %--user-agent%'
        -- Or anything launched by a system user
        OR (
          pe.cmdline LIKE '%wget -%'
          AND pe.euid < 500
          AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
        )
        OR (
          pe.cmdline LIKE '%curl %'
          AND pe.euid < 500
          AND pe.cmdline NOT LIKE "%./configure %--with-curl%"
          AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
        )
      )
      -- Exceptions for all calls
      AND NOT (
        pe.euid > 500
        AND (
          p1_cmd LIKE '%brew.rb%'
          OR p1_cmd LIKE '%brew.sh%'
          OR pe.cmdline LIKE '% localhost:%'
          OR pe.cmdline LIKE '%--dump-header%'
          OR pe.cmdline LIKE '%--progress-bar%'
          OR pe.cmdline LIKE '%.well-known/openid-configuration%'
          OR pe.cmdline LIKE '%/192.168.%:%'
          OR pe.cmdline LIKE '%/chainctl_%'
          OR pe.cmdline LIKE '%/openid/v1/jwks%'
          OR pe.cmdline LIKE '%127.0.0.1:%'
          OR pe.cmdline LIKE '%application/json%'
          OR pe.cmdline LIKE '%Authorization: Bearer%'
          OR pe.cmdline LIKE '%ctlog%'
          OR pe.cmdline LIKE '%curl -X %'
          OR pe.cmdline LIKE '%go mod %'
          OR pe.cmdline LIKE '%grpcurl%'
          OR pe.cmdline LIKE '%Homebrew%'
          OR pe.cmdline LIKE '%https://api.github.com/%'
          OR pe.cmdline LIKE '%If-None-Match%'
          OR pe.cmdline LIKE '%LICENSES/vendor/%'
          OR pe.cmdline LIKE '%localhost:%'
          OR pe.cmdline LIKE 'curl -sL wttr.in%'
          OR pe.cmdline LIKE 'git %'
          OR pe.cmdline LIKE 'wget --no-check-certificate https://github.com/%'
          OR pe.cmdline LIKE "%libcurl%"
        )
      )
      AND NOT (
        pe.euid > 500
        AND pe.cmdline LIKE '%/api'
        AND pe.cmdline NOT LIKE '%-o%'
        AND pe.cmdline NOT LIKE '%-O%'
      )
      AND NOT (
        pe.euid > 500
        -- /usr/bin/curl https://34.117.0.114:443 -k
        AND REGEX_MATCH (pe.cmdline, '(curl https://[\w\.\:\/]+ -k)$', 1) != ""
      )
      AND NOT (
        pe.euid > 500
        -- /usr/bin/curl -k https://34.117.0.114:443
        AND REGEX_MATCH (pe.cmdline, '(curl -k https://[\w\.\:\/]+)$', 1) != ""
      )
      -- These are typically curl -k calls
      -- We need the addr "IS NOT NULL" to avoid filtering out
      -- NULL entries
      AND NOT (
        addr IS NOT NULL
        AND (
          addr IN (
            'cdn.zoom.us',
            'dl.enforce.dev',
            'github.com',
            'releases.hashicorp.com',
            'repo1.maven.org'
          )
          -- Ignore local addresses (Docker development)
          OR addr NOT LIKE '%.%'
          OR ip LIKE '172.2%'
          OR ip LIKE '192.168.%'
          OR ip LIKE '127.%'
          OR ip LIKE '10.%'
        )
      )
      AND NOT p1_cmd LIKE '/usr/bin/bash /usr/bin/makepkg %'
      AND NOT url in ('https://aur.archlinux.org')
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Sketchy Fetcher"
  description: Suspicious URL requests by built-in fetching tools (state-based)
  query: |
    SELECT
      REGEX_MATCH (p0.cmdline, '(\w+:\/\/.*)\b', 1) AS url,
      REGEX_MATCH (p0.cmdline, '//(\d+\.\d+\.\d+\.\d+)[:/]', 1) AS ip,
      REGEX_MATCH (p0.cmdline, ':(\d+)', 1) AS port,
      REGEX_MATCH (p0.cmdline, '//([\w\-\.]+)[:/]', 1) AS addr,
      REGEX_MATCH (p0.cmdline, '//[\w\-\.]+\.(\w+)[:/]', 1) AS tld,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- NOTE: Sync remaining portion with sketchy-fetcher-events
      (
        INSTR(p0.cmdline, 'wget ') > 0
        OR INSTR(p0.cmdline, 'curl ') > 0
      )
      -- Sketchy fetcher events always seem to contain a switch
      AND p0.cmdline LIKE '%-%'
      AND p0.cmdline LIKE '%/%'
      AND (
        ip NOT IN ('', '127.0.0.1', '::1')
        AND ip NOT LIKE '172.17.%'
        OR port != ''
        OR tld NOT IN (
          '',
          'app',
          'ca',
          'cloud',
          'com',
          'de',
          'dev',
          'edu',
          'fun',
          'gov',
          'io',
          'md',
          'mil',
          'net',
          'org',
          'se',
          'sh',
          'so',
          'uk'
        )
        OR p0.cmdline LIKE '%.onion%'
        OR p0.cmdline LIKE '%aliyun%'
        OR p0.cmdline LIKE '%chmod%'
        OR p0.cmdline LIKE '%curl -k%'
        OR p0.cmdline LIKE '%curl -sL %'
        OR p0.cmdline LIKE '%curl %--user-agent%'
        OR p0.cmdline LIKE '%curl%--connect-timeout%'
        OR p0.cmdline LIKE '%curl%--insecure%'
        OR p0.cmdline LIKE '%curl%-o-%'
        OR p0.cmdline LIKE '%pastebin%'
        OR p0.cmdline LIKE '%tor2web%'
        OR p0.cmdline LIKE '%wget -nc%'
        OR p0.cmdline LIKE '%wget -q%'
        OR p0.cmdline LIKE '%wget -t%'
        OR p0.cmdline LIKE '%wget %--no-check-certificate%'
        OR p0.cmdline LIKE '%wget %--user-agent%'
        OR (
          p0.cmdline LIKE '%wget %'
          AND p0.euid < 500
          -- TODO: Update this query to understand containers
          AND p1.path NOT IN (
            "/usr/bin/bwrap",
            "/bin/busybox",
            "/usr/bin/melange"
          )
        )
        OR (
          p0.cmdline LIKE '%curl %'
          AND p0.euid < 500
          AND p0.cmdline NOT LIKE "%./configure %--with-curl%"
        )
      )
      -- Exceptions for all calls
      AND p1.name NOT IN ('makepkg') -- Exceptions for non-privileged calls
      AND NOT (
        p0.euid > 500
        AND (
          p0.cmdline LIKE '%--dump-header%'
          OR p0.cmdline LIKE '%--progress-bar%'
          OR p0.cmdline LIKE '%.well-known/openid-configuration%'
          OR p0.cmdline LIKE '%/api/v%'
          OR p0.cmdline LIKE '%/openid/v1/jwks%'
          OR p0.cmdline LIKE '%127.0.0.1:%'
          OR p0.cmdline LIKE '%169.254.169.254%'
          OR p0.cmdline LIKE '%application/json%'
          OR p0.cmdline LIKE '%aws-ec2-metadata%'
          OR p0.cmdline LIKE '%ctlog%'
          OR p0.cmdline LIKE '%curl -X %'
          OR p0.cmdline LIKE '%go mod %'
          OR p0.cmdline LIKE '%grpcurl%'
          OR p0.cmdline LIKE '%Homebrew%'
          OR p0.cmdline LIKE '%If-None-Match%'
          OR p0.cmdline LIKE '%LICENSES/vendor/%'
          OR p0.cmdline LIKE '%localhost:%'
          OR p0.cmdline LIKE '%Nixpkgs/%'
          OR p0.cmdline LIKE 'curl -sL wttr.in%'
          OR p0.cmdline LIKE 'git %'
          OR p1.cmdline LIKE '/nix/store/%-builder.sh'
          OR p1.cmdline LIKE '%brew.rb%'
          OR p1.cmdline LIKE '%brew.sh%'
          OR p0.name IN ('apko')
        )
      )
      -- These are typically curl -k calls
      -- We need the addr "IS NOT NULL" to avoid filtering out
      -- NULL entries
      AND NOT (
        addr IS NOT NULL
        AND (
          addr IN (
            'releases.hashicorp.com',
            'github.com',
            'dl.enforce.dev'
          )
          -- Ignore local addresses (Docker development)
          OR addr NOT LIKE '%.%'
          OR ip LIKE '172.21.%'
          OR ip LIKE '192.168.%'
        )
      )
      -- Qualys Cloud Agent
      AND NOT (
        addr = "169.254.169.254"
        AND p2.path = "/usr/local/qualys/cloud-agent/bin/qualys-scan-util"
      )
      -- Elastic Agent
      AND NOT p0.path LIKE '/Library/Elastic/Agent/%'
      AND NOt p0.cmdline LIKE '%/osqueryd %'
      -- Dumb things run under Docker
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Tiny Executable Events"
  description: Unusually small programs (events-based)
  query: |
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      file.size,
      p.time,
      file.type,
      p.mode,
      p.cwd,
      p.euid,
      p.parent,
      p.syscall,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256,
      magic.data AS magic
    FROM
      process_events p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash phash ON pp.path = phash.path
      LEFT JOIN magic ON p.path = magic.path
    WHERE
      p.time > (strftime('%s', 'now') -300)
      AND file.size > 0
      AND file.size < 10000
      AND file.type = 'regular'
      AND p.cwd != ""
      AND p.cwd IS NOT NULL
      AND p.path NOT LIKE '%.sh'
      AND p.path NOT LIKE '%.py'
      AND p.path NOT LIKE '%.rb'
      AND p.path NOT IN (
        '/opt/incus/bin/skopeo',
        '/sbin/ldconfig',
        '/usr/bin/c_rehash',
        '/usr/bin/dpkg-realpath',
        '/usr/bin/yq',
        '/usr/sbin/bpftool',
        '/usr/sbin/ldconfig',
        '/usr/sbin/update-ca-certificates'
      )
      AND NOT p.path LIKE '%/firefox'
      AND NOT (
        p.path LIKE '/Users/%'
        AND magic.data LIKE 'POSIX shell script%'
      )
      AND p.path NOT LIKE '/home/%/.local/share/Steam/%'
      AND p.path NOT LIKE '/private/var/folders/%/T/iTerm2-scrip%sh'
      AND p.path NOT LIKE '%/openoffice%/program/pagein'
      AND p.path NOT LIKE '/home/%/.ape-%'
    
      -- Removes a false-positive we've seen on Linux, generated through 'runc init'
      AND NOT (
        p.path = "/"
        AND file.size < 8192
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Env Values Linux"
  description: Applications setting environment variables to bypass security protections
  query: |
    SELECT
      pe.key,
      pe.value,
      LENGTH(pe.value) AS value_len,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      -- Querying processes first and filtering by time gives a massive 20X speed improvement
      -- over querying process_envs first and JOIN'ing against processes
      processes p0
      JOIN process_envs pe ON p0.pid = pe.pid
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE -- This time should match the interval
      p0.start_time > (strftime('%s', 'now') - 300)
      AND (
        pe.key = 'HISTFILE'
        AND NOT pe.value LIKE '/home/%'
        AND NOT pe.value LIKE '/Users/%'
        AND NOT pe.value LIKE '~/%'
        AND NOT pe.value LIKE '%/.histfile'
        AND NOT pe.value LIKE '/root/.%_history'
      )
      OR (
        pe.key = 'LD_PRELOAD'
        AND NOT pe.value = ''
        AND NOT p0.path LIKE '%/firefox'
        AND NOT pe.value IN (
          '/opt/splunkforwarder/lib/libdlwrapper.so',
          '/run/host/usr/lib/extest/libextest.so',
          '/snap/lxd/current/lib/x86_64-linux-gnu/libSegFault.so',
          '/tmp/preload.so',
          '/usr/lib/extest/libextest.so',
          '/usr/lib/libjemalloc.so',
          '/usr/lib/libsnmallocshim-checks-memcpy-only.so',
          '/usr/lib/libsnmallocshim.so',
          '/usr/local/lib/libmimalloc.so',
          'libapprun_hooks.so',
          'libeatmydata.so',
          'libfakeroot.so'
        )
        AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
        AND NOT pe.value LIKE ':/home/%/.local/share/Steam'
        AND NOT pe.value LIKE ':/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so:/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so'
        AND NOT pe.value LIKE ':/home/%/.var/app/com.valvesoftware.Steam/%'
        AND NOT pe.value LIKE ':/snap/%'
        AND NOT pe.value LIKE '/app/bin/%'
        AND NOT pe.value LIKE 'libmozsandbox.so%'
      )
      -- setuid
      OR (
        LENGTH(pe.value) > 1024
        AND pe.key != 'LS_COLORS'
        AND pe.key != 'HTTP_AUTH'
        AND f.mode IS NOT NULL
        AND f.mode NOT LIKE '0%'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Execdir Linux"
  description: Programs running out of unexpected directories, such as /tmp (state-based)
  query: |
    SELECT
      -- Child
      p0.pid AS p0_pid,
      p0.cgroup_path AS p0_cgroup,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT DISTINCT
          pid
        FROM
          processes
        WHERE
          pid > 1
          AND path != ""
          AND INSTR(path, "/app/") != 1
          AND INSTR(path, "/bin") != 1
          AND INSTR(path, "/home/") != 1
          AND INSTR(path, "/ko-app") != 1
          AND INSTR(path, "/nix/") != 1
          AND INSTR(path, "/opt/") != 1
          AND INSTR(path, "/sbin/") != 1
          AND INSTR(path, "/snap/") != 1
          AND INSTR(path, "/tmp/go-build") != 1
          AND INSTR(path, "/usr/bin/") != 1
          AND INSTR(path, "/usr/lib/") != 1
          AND INSTR(path, "/lib/chromium/") != 1
          AND INSTR(path, "/usr/lib64/") != 1
          AND INSTR(path, "/usr/libexec") != 1
          AND INSTR(path, "/usr/local/") != 1
          AND INSTR(path, "/usr/local/kolide-k2/bin/") != 1
          AND INSTR(path, "/usr/sbin/") != 1
          AND INSTR(path, "/usr/share/") != 1
          AND INSTR(path, "/usr/x86_64-pc-linux-gnu/bin") != 1
          AND INSTR(path, "/var/home/") != 1
          AND INSTR(path, "/var/kolide-k2/") != 1
          AND INSTR(path, "/var/lib/rancher/k3s/") != 1
          AND INSTR(path, "/var/lib/awx/") != 1
          AND INSTR(path, "/var/lib/flatpak") != 1
          AND INSTR(path, "/var/lib/snapd/") != 1
          AND INSTR(path, "/var/opt/") != 1
          AND INSTR(path, "/var/usrlocal/bin/") != 1
          AND INSTR(path, "/var/cache/melange") != 1
          AND INSTR(path, "/var/vanta/") != 1
          AND path NOT LIKE "%/.terraform%"
          AND path != '/bpfilter_umh'
          AND NOT path LIKE '/tmp/%/osqtool'
          AND NOT path LIKE '/tmp/GoLand/___go_build_%_go'
          AND NOT cgroup_path LIKE '/system.slice/docker-%' -- Interactive terminal
          AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'
          AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
          AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/snap.%'
          AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/docker-%'
          AND NOT cgroup_path LIKE '/kubepods.slice/%'
          AND NOT (
            cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-gnome-Alacritty-%.scope'
            AND path LIKE '/tmp/%'
          )
          AND NOT (
            (
              cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-%.scope'
              OR cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/docker-%.scope'
            )
            AND path LIKE '/usr/share/nvm/versions/node/v%/bin/node'
          )
          AND NOT (
            euid > 500
            AND (
              path LIKE '/tmp/terraform_%/terraform'
              OR path LIKE '/tmp/%/output/%'
              OR path LIKE '/tmp/%/_output/%'
              OR path LIKE '/tmp/%/bin/%'
              OR path LIKE '%/.terraform/providers/%'
              OR path LIKE '/tmp/.mount_%'
            )
          )
        GROUP BY
          path
      )
    GROUP BY
      p0.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Execdir Macos"
  description: Find programs running from strange directories on macOS
  query: |
    SELECT DISTINCT
      COALESCE(REGEX_MATCH (p0.path, '(.*)/', 1), p0.path) AS dir,
      REPLACE(f.directory, u.directory, '~') AS homedir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(f.directory, u.directory, '~'),
          '(~/.*?/.*?/.*?/)',
          1
        ),
        REPLACE(f.directory, u.directory, '~')
      ) AS top3_homedir,
      REGEX_MATCH (
        REPLACE(f.directory, u.directory, '~'),
        '(~/.*?/)',
        1
      ) AS top_homedir,
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.start_time AS p1_start,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON p0.uid = u.uid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          pid > 0
          AND REGEX_MATCH (
            path,
            "^(/System|/usr/libexec/|/usr/sbin/|/usr/bin/|/usr/lib/|/bin/|/Applications|/Library/Apple/|/sbin/|/usr/local/kolide-k2)",
            1
          ) IS NULL
        GROUP BY
          path
      )
      AND NOT dir IN (
        '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS',
        '/Library/Application Support/Logitech.localized/Logitech Options.localized/LogiMgrUpdater.app/Contents/Resources',
        '/Library/DropboxHelperTools/Dropbox_u501',
        '/Library/Filesystems/kbfuse.fs/Contents/Resources',
        '/Library/Frameworks/Python.framework/Versions/3.10/bin',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers.app/Contents/MacOS',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS/',
        '/Library/Printers/DYMO/Utilities',
        '/Library/PrivilegedHelperTools',
        '/Library/TeX/texbin',
        '/nix/store',
        '/nix/var/nix/profiles/default/bin',
        '/opt/homebrew/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin/gke-gcloud-auth-plugin',
        '/opt/usr/bin',
        '/opt/X11/bin',
        '/opt/X11/libexec',
        '/run/current-system/sw/bin',
        '/usr/local/aws-cli'
      )
      AND NOT homedir IN (
        '~/.cache/gitstatus',
        '~/.docker/cli-plugins',
        '~/.gvm/binscripts',
        '~/.local/share/gh/extensions/gh-sbom',
        '~/.magefile',
        '~/bin'
      )
      AND NOT homedir LIKE '~/%/bin'
      AND NOT homedir LIKE '~/Downloads/%.app/Contents/MacOS'
      AND NOT top_homedir IN (
        '~/.cargo/',
        '~/.config/',
        '~/.kuberlr/',
        '~/.provisio/',
        '~/.clickshare_button/',
        '~/.clickshare/',
        '~/.pulumi/',
        '~/.pyenv/',
        '~/.rbenv/',
        '~/.rustup/',
        '~/.steampipe/',
        '~/.supermaven/',
        '~/.tflint.d/',
        '~/.terraform.d/',
        '~/.Trash/',
        '~/chainguard-dev/',
        '~/.vs-kubernetes/',
        '~/.vscode/',
        '~/Applications (Parallels)/',
        '~/Applications/',
        '~/bin/',
        '~/code/',
        '~/Code/',
        '~/dev/',
        '~/Development/',
        '~/git/',
        '~/go/',
        '~/google-cloud-sdk/',
        '~/homebrew/',
        '~/Parallels/',
        '~/proj/',
        '~/projects/',
        '~/Projects/',
        '~/sigstore/',
        '~/src/',
        '~/thinkorswim/',
        '~/work/',
        '~/workspace/'
      )
      AND NOT top_homedir LIKE '~/%repos/'
      AND NOT top3_homedir IN (
        '/Library/Application Support/EcammLive',
        '/Library/Developer/Xcode/',
        '/opt/rapid7/ir_agent',
        '~/.cache/rod/browser/',
        '~/.cache/selenium/chromedriver/',
        '~/.local/share/bob/',
        '~/.local/share/nvim/',
        '~/.terraform.d/plugin-cache/registry.terraform.io/',
        '~/anaconda3/Anaconda-Navigator.app/Contents/',
        '~/Library/Arduino15/packages/',
        '~/Library/Caches/com.grammarly.ProjectLlama/',
        '~/Library/Caches/com.mimestream.Mimestream/',
        '~/Library/Caches/com.sempliva.Tiles/',
        '~/Library/Caches/Cypress/',
        '~/Library/Caches/go-build/',
        '~/Library/Caches/JetBrains/',
        '~/Library/Caches/org.gpgtools.updater/',
        '~/Library/Caches/snyk/',
        '~/Library/pnpm',
        '~/Library/Razer/RazerAppEngine/',
        '~/Library/Services/UE4EditorServices.app/',
        '~/opentelemetry-operator/cmd/otel-allocator',
        '~/zed/target/release/'
      )
      AND dir NOT LIKE '/Applications/%'
      AND dir NOT LIKE '/private/tmp/%.app/Contents/MacOS'
      AND dir NOT LIKE '/private/tmp/go-build%/exe'
      AND dir NOT LIKE '/private/tmp/KSInstallAction.%/Install Google Software Update.app/Contents/Helpers'
      AND dir NOT LIKE '/private/tmp/nix-build-%'
      AND dir NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%'
      AND dir NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'
      AND dir NOT LIKE '/private/var/folders/%/bin'
      AND dir NOT LIKE '/private/var/folders/%/Contents/%'
      AND dir NOT LIKE '/private/var/folders/%/d/Wrapper/%.app'
      AND dir NOT LIKE '/private/var/folders/%/go-build%'
      AND dir NOT LIKE '/private/var/folders/%/GoLand'
      AND dir NOT LIKE '/Volumes/com.getdropbox.dropbox-%'
      AND dir NOT LIKE '%/.terraform/providers/%'
      AND dir NOT LIKE '~/%_arm64'
      AND homedir NOT LIKE '~/.local/%/packages/%'
      AND homedir NOT LIKE '~/%/google-cloud-sdk/bin/%'
      AND homedir NOT LIKE '~/%/node_modules/%'
      AND homedir NOT LIKE '~/Library/Application Support/%'
      AND homedir NOT LIKE '~/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%/Updater.app/Contents/MacOS'
      AND homedir NOT LIKE '~/Library/Caches/ms-playwright/%'
      AND homedir NOT LIKE '~/Library/Printers/%/Contents/MacOS'
      AND homedir NOT LIKE '~/Documents/%/mono/%'
      AND homedir NOT LIKE '~/Documents/GH/%'
      AND s.authority NOT IN (
        'Apple iPhone OS Application Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',
        'Developer ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y)',
        'Developer ID Application: Figma, Inc. (T8RA8NE3B7)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Hercules Labs Inc. (B8PC799ZGU)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Developer ID Application: Razer USA Ltd. (R2H967U7J8)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: TablePlus Inc (3X57WP8E8V)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Software Signing'
      ) -- Locally built executables
      AND NOT (
        s.identifier = "a.out"
        AND homedir LIKE '~/%'
        AND (
          p1.name LIKE '%sh'
          OR p1.name = 'make'
        )
        AND (
          p2.name = 'login'
          OR p2.name LIKE '%sh'
        )
        AND p0.path NOT LIKE '%/Cache%'
        AND p0.path NOT LIKE '%/Library/%'
        AND p0.path NOT LIKE '%/.%'
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Executable Permissions"
  description: Find processes running that are tied to binaries with unsual permissions. Namely, 0777.
  query: |
    SELECT
      f.mode,
      f.uid,
      f.gid,
      f.ctime,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      f.mode NOT IN (
        '0500',
        '0551',
        '0544',
        '0555',
        '0711',
        '0750',
        '0755',
        '0775',
        '0744',
        '6755',
        '0700',
        '2755',
        '4511',
        '4555',
        '4755'
      )
      -- Vendors who are very relaxed about permissions
      AND NOT (
        f.path IN (
          '/Applications/Camera Settings.app/Contents/MacOS/LogitechCamera',
          '/Applications/motionVFX/Plugins/mUtility.app/Contents/PlugIns/mUtility XPC Service.pluginkit/Contents/MacOS/mUtility XPC Service',
          '/Library/Application Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService'
        )
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path IN (
          '/Applications/EA app.app/Contents/Applications/EABackgroundService.app/Contents/MacOS/EABackgroundService',
          '/Applications/EA app.app/Contents/Applications/EABackgroundAgent.app/Contents/MacOS/EABackgroundAgent',
          '/Applications/Finch/lima/bin/limactl',
          '/Applications/Finch/lima/bin/qemu-system-aarch64'
        )
        AND f.mode = '0777'
        AND f.uid = 0
      )
      AND NOT (
        f.path LIKE '/Users/%/.local/bin/%'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/Code/User/globalStorage/grafana.vscode-jsonnet/bin/jsonnet-language-server'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/.vscode/extensions/sumneko.lua-%-darwin-arm64/server/bin/lua-language-server'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/Zwift/ZwiftApp%'
        AND f.mode = '0777'
        AND f.uid > 500
      )
      AND NOT (
        f.path = '/usr/bin/sudo'
        AND f.mode = '4111'
        AND f.uid = 0
      )
      AND NOT (
        f.path LIKE '/home/%/.local/share/JetBrains/Toolbox/bin/jetbrains-toolbox'
        AND f.mode = '0744'
      )
      AND NOT (
        f.path LIKE '/home/%/.cache/JetBrains/%/semantic-search/server/%/embeddings-server'
        AND f.mode = '0764'
      )
      AND NOT (
        f.path LIKE '/Users/%/Applications (Parallels)/%.app/Contents/MacOS/WinAppHelper'
        AND f.mode = '0777'
      )
      AND NOT (
        f.path LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
        AND f.mode = '1555'
      )
      AND NOT (
        f.path LIKE '/opt/homebrew/Cellar/dnsmasq/%/sbin/dnsmasq'
        AND f.mode = '1555'
      )
      AND NOT (
        f.path LIKE '/Users/%/Library/Application Support/com.raycast.macos/NodeJS/runtime/%/bin/node'
        AND f.mode = '0754'
      )
      AND NOT (
        f.path LIKE '%/Elastic/Agent/data/elastic-agent%/elastic-agent'
        AND f.mode = '0770'
      )
      AND NOT (
        f.path = '/Library/Bitdefender/AVP/product/bin/EndpointSecurityforMac.app/Contents/MacOS/EndpointSecurityforMac'
        AND f.mode = '0655'
      )
      AND NOT (
        p0.name = 'ShortcutDroplet'
        AND f.mode = '0751'
      )
      AND NOT (
        f.path = '/home/%/.local/share/AppImage/ZenBrowser.AppImage'
        AND f.mode = '0600'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Fetcher Parent Events"
  description: Suspicious parenting of fetch tools (event-based)
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      -- NOTE: The remainder of this query is synced with unexpected-fetcher-parents
      pe.cmdline != ''
      AND pe.time > (strftime('%s', 'now') -450)
      AND p0_name IN ('curl', 'wget', 'ftp', 'tftp')
      AND NOT exception_key IN (
        'curl,0,nm-dispatcher,',
        'curl,0,nm-dispatcher,nm-dispatcher',
        'curl,500,bash,bash',
        'curl,500,bash,nix-daemon',
        'curl,500,bash,ShellLauncher',
        'curl,500,bash,yay',
        'curl,500,bash,zsh',
        'curl,500,env,env',
        'curl,500,fish,gnome-terminal-',
        'curl,500,ruby,zsh',
        'curl,500,ShellLauncher,',
        'curl,500,ShellLauncher,login',
        'curl,500,zsh,login',
        'curl,500,zsh,sh',
        'wget,500,env,env'
      )
      AND NOT (
        pe.euid > 500
        AND p1_name IN ('bash', 'dash', 'fish', 'sh', 'zsh')
        AND p2_name IN (
          'alacritty',
          'gnome-terminal-',
          'kitty',
          'login',
          'roxterm',
          'stable',
          'tmux:server',
          'tmux',
          'wezterm-gui',
          'zsh'
        )
      )
      AND NOT p1_name IN ('yay', 'nvim')
      AND NOT (
        pe.euid > 500
        AND p0_cmd IN ('curl --fail https://ipinfo.io/timezone')
      )
      AND NOT (
        pe.euid > 500
        AND p1_name = 'env'
        AND p1_cmd LIKE '/usr/bin/env -i % HOMEBREW_BREW_FILE=%'
      )
      AND NOT (
        pe.euid > 500
        AND p1_name = 'ruby'
        AND p1_cmd LIKE '%/Homebrew/brew.rb%'
      )
      AND NOT (
        pe.euid > 500
        AND p1_name = 'env'
        AND p1_cmd LIKE '/usr/bin/env bash ./hack/%.sh'
      )
      AND NOT p0_cmd LIKE 'wget --no-check-certificate https://github.com/istio/istio/%'
      AND NOT p0_cmd LIKE '%curl -L https://artifacts.elastic.co/%'
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Fetcher Parents"
  description: Suspicious parenting of fetch tools (state-based)
  query: |
    SELECT
      p.pid,
      p.path,
      p.name AS child_name,
      p.cmdline AS cmd,
      p.cwd,
      p.euid,
      p.parent,
      p.cgroup_path,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmd,
      pp.euid AS parent_euid,
      gp.name AS gparent_name,
      gp.cmdline AS gparent_cmd,
      pp.pid AS gparent_pid,
      hash.sha256 AS parent_sha256,
      CONCAT (
        p.name,
        ',',
        MIN(p.euid, 500),
        ',',
        pp.name,
        ',',
        gp.name
      ) AS exception_key
    FROM
      processes p
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN processes gp ON pp.parent = gp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE -- NOTE: The remainder of this query is synced with unexpected-fetcher-parent-events
      child_name IN ('curl', 'ftp', 'tftp', 'wget') -- And not a regular local user
      AND NOT exception_key IN (
        'curl,0,09-timezone,nm-dispatcher',
        'curl,0,bash,kandji-library-manager',
        'curl,0,build.sh,buildkit-runc',
        'curl,0,eos-rankmirrors,eos-rankmirrors',
        'curl,0,nm-dispatcher,',
        'curl,0,nm-dispatcher,nm-dispatcher',
        'curl,0,sh,qualys-cloud-ag',
        'curl,0,sh,qualys-scan-uti',
        'curl,300,bash,nix',
        'curl,301,bash,nix',
        'curl,302,bash,nix',
        'curl,303,bash,nix',
        'curl,305,bash,nix',
        'curl,307,bash,nix',
        'curl,500,bash,bash',
        'curl,500,bash,fakeroot',
        'curl,500,bash,fish',
        'curl,500,bash,nix-daemon',
        'curl,500,bash,ShellLauncher',
        'curl,500,bash,zsh',
        'curl,500,colima,zsh',
        'curl,500,emacs,systemd',
        'curl,500,endpoint-instal,bash',
        'curl,500,env,env',
        'curl,500,Stats,launchd',
        'curl,500,update-tools.sh,fish',
        'curl,500,eos-connection-,eos-update-noti',
        'curl,500,fish,gnome-terminal-',
        'curl,500,invoke,sh',
        'curl,500,bash,make',
        'curl,500,launchd,kernel_task',
        'curl,500,make,bash',
        'curl,500,make,fish',
        'curl,500,makepkg,yay',
        'curl,500,node-cve-count.,bash',
        'curl,500,nvim,nvim',
        'wget,0,bash,runc',
        'curl,500,nwg-panel,systemd',
        'curl,500,ruby,zsh',
        'curl,500,sh,make',
        'curl,500,ShellLauncher,',
        'curl,500,ShellLauncher,login',
        'curl,500,Slack,launchd',
        'curl,500,Stats,bash',
        'curl,500,zsh,Code Helper',
        'curl,500,zsh,Cursor Helper',
        'curl,500,zsh,Emacs-arm64-11',
        'curl,500,zsh,Hyper',
        'curl,500,download-packag,zsh',
        'curl,500,zsh,login',
        'curl,500,zsh,mc',
        'curl,500,zsh,sh',
        'curl,500,zsh,zellij',
        'wget,500,bootstrap,sh',
        'wget,500,env,env',
        'wget,500,invoke,sh',
        'wget,500,sh,bwrap',
        'wget,500,zsh,bash'
      )
      AND NOT (
        p.euid > 500
        AND parent_name IN ('bash', 'dash', 'fish', 'sh', 'zsh')
        AND gparent_name IN (
          'alacritty',
          'bash',
          'Code Helper',
          'Cursor Helper',
          'emacs',
          'gnome-terminal-',
          'goland',
          'kitty',
          'login',
          'node',
          'old',
          'pycharm',
          'roxterm',
          'stable',
          'tmux',
          'tmux:server',
          'vim',
          'wezterm-gui',
          'zsh'
        )
      )
      AND NOT p.cmdline IN (
        'curl -s -6 https://api.serhiy.io/v1/stats/ip',
        'curl -s -4 https://api.serhiy.io/v1/stats/ip',
        'curl https://wttr.in/?format=1 -s'
      )
      AND NOT parent_name IN ('yay', 'dget')
      AND NOT p.cmdline LIKE 'curl -s https://support-sp.apple.com/sp/product%'
      AND NOT (
        p.euid > 500
        AND parent_name = 'env'
        AND parent_cmd LIKE '/usr/bin/env -i % HOMEBREW_BREW_FILE=%'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'ruby'
        AND parent_cmd LIKE '%/Library/Homebrew/brew.rb%'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'env'
        AND parent_cmd LIKE '/usr/bin/env bash ./hack/%.sh'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'bash'
        AND parent_cmd LIKE 'bash ./hack/%.sh'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'bash'
        AND parent_cmd LIKE 'bash %/bin/go-build %'
      )
      AND NOT (
        p.euid > 500
        AND parent_name = 'ruby'
        AND p.cmdline LIKE '/usr/bin/curl --disable --cookie /dev/null --globoff --show-error --user-agent Homebrew/%'
      )
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p.pid
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Gatekeeper Approvals Macos"
  description: Gatekeeper exceptions are exceptions for downloaded binaries
  query: |
    SELECT
      gap.ctime,
      gap.mtime,
      gap.path,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      gatekeeper_approved_apps AS gap
      LEFT JOIN file ON gap.path = file.path
      LEFT JOIN hash ON gap.path = hash.path
      LEFT JOIN signature ON gap.path = signature.path
    WHERE
      gap.path NOT LIKE '/Users/%/bin/%'
      AND gap.path NOT LIKE '/Users/%/%_darwin_a%64%'
      AND gap.path NOT LIKE '/Users/%/%-darwin-a%64'
      AND gap.path NOT LIKE '/Users/%/bom'
      AND gap.path NOT LIKE '/Users/%/configure'
      AND gap.path NOT LIKE '/Users/%/cosign-%'
      AND gap.path NOT LIKE '/Users/%/crane'
      AND gap.path NOT LIKE '/Users/%/Downloads/%_arm64%/%'
      AND gap.path NOT LIKE '/Users/%/Downloads/cosign'
      AND gap.path NOT LIKE '/Users/%/Downloads/grpcurl_%'
      AND gap.path NOT LIKE '/Users/%/Downloads/missp'
      AND gap.path NOT LIKE '/Users/%/Downloads/openresty%/bundle/install'
      AND gap.path NOT LIKE '/Users/%/Downloads/twistcli'
      AND gap.path NOT LIKE '/Users/%/Downloads/U_STIGViewer%/STIGViewer'
      AND gap.path NOT LIKE '/Users/%/rekor-cli'
      AND gap.path NOT LIKE '/Users/%/trivy'
      AND gap.path NOT LIKE '/usr/local/bin/%'
      AND signature.authority != 'Developer ID Application: Jamie Zawinski (4627ATJELP)'
    GROUP BY
      gap.requirement
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Osascript Calls"
  description: Detect unusual calls to osascript
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.path IN ('/usr/bin/osascript', '/usr/bin/osacompile')
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.cmdline != ''
      -- Only include successful executions: On macOS, process_events includes unsuccessful path lookups!
      AND pe.status = 0
      AND NOT (
        pe.euid > 500
        AND (
          p0_cmd IN (
            'osascript -e get POSIX path of (path to application id "com.garmin.antagent")',
            'osascript -e get POSIX path of (path to application id "com.garmin.expressfit")',
            'osascript -e get POSIX path of (path to application id "com.garmin.LifetimeMapUpdate")',
            'osascript -e tell application "Finder" to reveal application file id "com.garmin.renu.client"',
            'osascript -e user locale of (get system info)',
            'osascript ./ExpressLoginItem.scpt'
          )
          OR p0_cmd LIKE '/usr/bin/osascript /Applications/Amazon Photos.app/Contents/Resources/quit_and_restart_app.scpt /Applications/Amazon Photos.app com.amazon.clouddrive.mac%'
          OR p0_cmd LIKE '/usr/bin/osascript /Users/%/Library/Caches/com.runningwithcrayons.Alfred/Workflow Scripts/%'
          OR p0_cmd LIKE '/usr/bin/osascript /Users/%/osx-trash/trashfile.AppleScript %'
          OR p0_cmd LIKE '/usr/bin/osascript %com.docker.docker%'
          OR p0_cmd LIKE '%"CFBundleName" of property list file (app_path & ":Contents:Info.plist")'
          OR p0_cmd LIKE '%osacompile -o /Users/%/Applications/Home Manager Trampolines/%'
          OR p0_cmd LIKE 'osascript -e set zoomStatus to "closed"%'
          OR p0_cmd LIKE 'osascript -e tell application "zoom.us"%'
          OR p0_cmd LIKE 'osascript -e%tell application "System Preferences"%reveal anchor "shortcutsTab"%"com.apple.preference.keyboard"'
          OR p0_cmd LIKE 'osascript -l JavaScript /tmp/PKInstallSandbox.%/Scripts/org.gpgtools.gpgmailloader.pkg.%/mailbundle-enabled.jxa -- GPGMailLoader.mailbundle'
          OR p0_cmd LIKE 'osascript -l JavaScript%com.elgato.StreamDeck%'
          OR p0_cmd LIKE 'osascript openChrome.applescript http://127.0.0.1:%'
          OR p0_cmd LIKE 'osascript openChrome.applescript http%://localhost%'
          OR p1_cmd LIKE '/bin/sh %/opt/homebrew/bin/git-gui%'
          OR p1_cmd LIKE '% /opt/homebrew/bin/jupyter%notebook'
          OR p1_cmd LIKE '%auth login'
          OR p1_cmd LIKE '%aws %sso%'
          OR p1_cmd LIKE '%gcloud% auth %login%'
          OR p1_cmd LIKE '%gcloud% init'
          OR p1_cmd LIKE '%jupyter_mac.command'
          OR p1_cmd LIKE '%tell application "Finder" to empty trash%'
          OR p1_cmd LIKE '%tell application "System Events" to sleep%'
          OR p1_authority = 'Developer ID Application: Docker Inc (9BNSXJN65R)'
          OR p1_name IN ('yubikey-agent')
          OR (
            p1_authority = 'Developer ID Application: VNG ONLINE CO.,LTD (CVB6BX97VM)'
            AND p0_cmd = 'osascript -ss'
          )
          OR (
            p1_authority = 'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)'
            AND p0_cmd = 'osascript'
          )
        )
      )
      -- The following apply to all uids
      AND NOT p0_cmd IN (
        '/usr/bin/osascript -e do shell script "/bin/rm -Rf /opt/vagrant /usr/local/bin/vagrant" with administrator privileges',
        'osascript -e do shell script "/bin/rm -Rf /opt/vagrant /usr/local/bin/vagrant" with administrator privileges',
        'osascript -e user locale of (get system info)'
      )
    GROUP BY
      pe.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Setuid Binaries"
  description: Find unexpected setuid binaries on disk
  query: |
    SELECT
      GROUP_CONCAT(path) AS paths,
      gid,
      uid,
      mode,
      type,
      size,
      data,
      sha256
    FROM
      (
        SELECT
          file.path,
          file.gid,
          file.uid,
          file.inode,
          file.mode,
          file.type,
          file.size,
          magic.data,
          hash.sha256
        FROM
          file
          LEFT JOIN hash ON file.path = hash.path
          LEFT JOIN magic ON file.path = magic.path
        WHERE
          file.directory IN (
            '/bin',
            '/etc',
            '/opt/google-cloud-sdk/bin',
            '/opt/homebrew/bin',
            '/opt/homebrew/sbin',
            '/sbin',
            '/tmp',
            '/usr/bin',
            '/usr/lib',
            '/usr/lib/jvm/default/bin',
            '/usr/lib64',
            '/usr/libexec',
            '/usr/local/bin',
            '/usr/local/lib',
            '/usr/local/lib64',
            '/usr/local/libexec',
            '/usr/local/sbin',
            '/usr/sbin',
            '/var/lib',
            '/var/tmp'
          )
          AND type = 'regular'
          AND mode NOT LIKE '0%'
          AND mode NOT LIKE '1%'
          AND mode NOT LIKE '2%'
          AND NOT (
            mode LIKE '4%11'
            AND uid = 0
            AND gid = 0
            AND file.path IN (
              '/bin/bwrap',
              '/bin/cdda2wav',
              '/bin/cdrecord',
              '/bin/chfn',
              '/bin/chsh',
              '/bin/grub2-set-bootflag',
              '/bin/icedax',
              '/bin/mount.nfs',
              '/bin/mount.nfs4',
              '/bin/readcd',
              '/bin/readom',
              '/bin/rscsi',
              '/bin/staprun',
              '/bin/sudo',
              '/bin/sudoedit',
              '/bin/umount.nfs',
              '/bin/umount.nfs4',
              '/bin/wodim',
              '/usr/local/libexec/ssh-keysign',
              '/sbin/cdda2wav',
              '/sbin/cdrecord',
              '/sbin/chfn',
              '/sbin/chsh',
              '/sbin/icedax',
              '/sbin/mount.nfs',
              '/sbin/mount.nfs4',
              '/sbin/readcd',
              '/sbin/readom',
              '/sbin/rscsi',
              '/bin/userhelper',
              '/usr/bin/userhelper',
              '/sbin/sudo',
              '/sbin/sudoedit',
              '/sbin/umount.nfs',
              '/sbin/umount.nfs4',
              '/sbin/userhelper',
              '/sbin/wodim',
              '/usr/bin/bwrap',
              '/usr/bin/cdda2wav',
              '/usr/bin/cdrecord',
              '/usr/bin/chfn',
              '/usr/bin/chsh',
              '/usr/bin/grub2-set-bootflag',
              '/usr/bin/icedax',
              '/usr/bin/mount.nfs',
              '/usr/bin/mount.nfs4',
              '/usr/bin/readcd',
              '/usr/bin/readom',
              '/usr/bin/rscsi',
              '/usr/bin/staprun',
              '/usr/bin/sudo',
              '/usr/bin/sudoedit',
              '/usr/bin/umount.nfs',
              '/usr/bin/umount.nfs4',
              '/usr/bin/wodim',
              '/usr/libexec/security_authtrampoline',
              '/usr/libexec/xf86-video-intel-backlight-helper',
              '/usr/sbin/cdda2wav',
              '/usr/sbin/cdrecord',
              '/usr/sbin/chfn',
              '/usr/sbin/chsh',
              '/usr/sbin/icedax',
              '/usr/sbin/mount.nfs',
              '/usr/sbin/mount.nfs4',
              '/usr/sbin/readcd',
              '/usr/sbin/readom',
              '/usr/sbin/rscsi',
              '/usr/sbin/sudo',
              '/usr/sbin/sudoedit',
              '/usr/sbin/umount.nfs',
              '/usr/sbin/umount.nfs4',
              '/usr/sbin/userhelper',
              '/usr/sbin/wodim'
            )
          )
          AND NOT (
            mode LIKE '4%55'
            AND uid = 0
            AND gid = 0
            AND file.path IN (
              '/bin/at',
              '/bin/atq',
              '/bin/screen',
              '/bin/screen-5.0.0',
              '/sbin/screen',
              '/sbin/screen-5.0.0',
              '/usr/bin/screen',
              '/usr/bin/screen-5.0.0',
              '/usr/sbin/screen',
              '/usr/sbin/screen-5.0.0',
              '/bin/atrm',
              '/bin/bwrap',
              '/bin/chage',
              '/bin/chfn',
              '/bin/chsh',
              '/bin/crontab',
              '/bin/doas',
              '/bin/expiry',
              '/bin/firejail',
              '/bin/fusermount',
              '/bin/fusermount-glusterfs',
              '/bin/fusermount3',
              '/bin/gpasswd',
              '/sbin/fusermount-glusterfs',
              '/usr/sbin/fusermount-glusterfs',
              '/bin/grub2-set-bootflag',
              '/bin/keybase-redirector',
              '/bin/ksu',
              '/bin/mount',
              '/bin/mount.nfs',
              '/bin/mount.nfs4',
              '/bin/mullvad-exclude',
              '/bin/ndisc6',
              '/bin/newgidmap',
              '/bin/newgrp',
              '/bin/newuidmap',
              '/bin/ntfs-3g',
              '/bin/nvidia-modprobe',
              '/bin/pam_timestamp_check',
              '/bin/passwd',
              '/bin/pkexec',
              '/bin/ps',
              '/sbin/atq',
              '/sbin/atrm',
              '/sbin/at',
              '/usr/sbin/atq',
              '/usr/sbin/atrm',
              '/usr/sbin/at',
              '/bin/rdisc6',
              '/bin/rltraceroute6',
              '/bin/schroot',
              '/bin/sg',
              '/bin/su',
              '/bin/sudo',
              '/sbin/vmware-user',
              '/sbin/vmware-user-suid-wrapper',
              '/usr/sbin/vmware-user',
              '/usr/sbin/vmware-user-suid-wrapper',
              '/bin/sudoedit',
              '/bin/suexec',
              '/bin/ubuntu-core-launcher',
              '/bin/umount',
              '/bin/umount.nfs',
              '/bin/umount.nfs4',
              '/bin/unix_chkpwd',
              '/bin/vmware-user',
              '/bin/vmware-user-suid-wrapper',
              '/sbin/chage',
              '/sbin/chfn',
              '/sbin/chsh',
              '/sbin/crontab',
              '/sbin/doas',
              '/sbin/expiry',
              '/sbin/firejail',
              '/sbin/fusermount',
              '/sbin/fusermount3',
              '/sbin/gpasswd',
              '/sbin/grub2-set-bootflag',
              '/sbin/ksu',
              '/sbin/mount',
              '/sbin/mount.cifs',
              '/sbin/mount.nfs',
              '/sbin/mount.nfs4',
              '/sbin/mount.ntfs',
              '/sbin/mount.ntfs-3g',
              '/sbin/mount.smb3',
              '/sbin/mullvad-exclude',
              '/sbin/ndisc6',
              '/sbin/newgrp',
              '/sbin/nvidia-modprobe',
              '/sbin/pam_timestamp_check',
              '/sbin/passwd',
              '/sbin/pkexec',
              '/sbin/rdisc6',
              '/sbin/rltraceroute6',
              '/sbin/sg',
              '/sbin/su',
              '/sbin/sudo',
              '/sbin/sudoedit',
              '/sbin/suexec',
              '/sbin/umount',
              '/sbin/umount.nfs',
              '/sbin/umount.nfs4',
              '/sbin/unix_chkpwd',
              '/sbin/usernetctl',
              '/usr/bin/at',
              '/usr/bin/atq',
              '/usr/bin/atrm',
              '/usr/bin/batch',
              '/usr/bin/bwrap',
              '/usr/bin/chage',
              '/usr/bin/chfn',
              '/usr/bin/chsh',
              '/usr/bin/crontab',
              '/usr/bin/doas',
              '/usr/bin/expiry',
              '/usr/bin/firejail',
              '/usr/bin/fusermount',
              '/usr/bin/fusermount-glusterfs',
              '/usr/bin/fusermount3',
              '/usr/bin/gpasswd',
              '/usr/bin/grub2-set-bootflag',
              '/usr/bin/keybase-redirector',
              '/usr/bin/ksu',
              '/usr/bin/login',
              '/usr/bin/mount',
              '/usr/bin/mount.nfs',
              '/usr/bin/mount.nfs4',
              '/usr/bin/mullvad-exclude',
              '/usr/bin/ndisc6',
              '/usr/bin/newgidmap',
              '/usr/bin/newgrp',
              '/usr/bin/newuidmap',
              '/usr/bin/ntfs-3g',
              '/usr/bin/nvidia-modprobe',
              '/usr/bin/pam_timestamp_check',
              '/usr/bin/passwd',
              '/usr/bin/pkexec',
              '/usr/bin/quota',
              '/usr/bin/rdisc6',
              '/usr/bin/rltraceroute6',
              '/usr/bin/schroot',
              '/usr/bin/sg',
              '/usr/bin/su',
              '/usr/bin/sudo',
              '/usr/bin/sudoedit',
              '/usr/bin/suexec',
              '/usr/bin/top',
              '/usr/bin/ubuntu-core-launcher',
              '/usr/bin/umount',
              '/usr/bin/umount.nfs',
              '/usr/bin/umount.nfs4',
              '/usr/bin/unix_chkpwd',
              '/usr/bin/vmware-user',
              '/usr/bin/vmware-user-suid-wrapper',
              '/usr/lib/mail-dotlock',
              '/usr/lib/xf86-video-intel-backlight-helper',
              '/usr/lib/Xorg.wrap',
              '/usr/lib64/mail-dotlock',
              '/usr/lib64/xf86-video-intel-backlight-helper',
              '/usr/lib64/Xorg.wrap',
              '/usr/libexec/authopen',
              '/usr/libexec/libgtop_server2',
              '/usr/libexec/polkit-agent-helper-1',
              '/usr/libexec/qemu-bridge-helper',
              '/usr/libexec/spice-client-glib-usb-acl-helper',
              '/usr/libexec/Xorg.wrap',
              '/usr/local/bin/doas',
              '/usr/sbin/chage',
              '/usr/sbin/chfn',
              '/usr/sbin/chsh',
              '/usr/sbin/crontab',
              '/usr/sbin/doas',
              '/usr/sbin/expiry',
              '/usr/sbin/firejail',
              '/usr/sbin/fusermount',
              '/usr/sbin/fusermount3',
              '/usr/sbin/gpasswd',
              '/usr/sbin/grub2-set-bootflag',
              '/usr/sbin/ksu',
              '/usr/sbin/mount',
              '/usr/sbin/mount.cifs',
              '/usr/sbin/mount.nfs',
              '/usr/sbin/mount.nfs4',
              '/usr/sbin/mount.ntfs',
              '/usr/sbin/mount.ntfs-3g',
              '/usr/sbin/mount.smb3',
              '/usr/sbin/mullvad-exclude',
              '/usr/sbin/ndisc6',
              '/usr/sbin/newgrp',
              '/usr/sbin/nvidia-modprobe',
              '/usr/sbin/pam_timestamp_check',
              '/usr/sbin/passwd',
              '/usr/sbin/pkexec',
              '/usr/sbin/rdisc6',
              '/usr/sbin/rltraceroute6',
              '/usr/sbin/sg',
              '/usr/sbin/su',
              '/usr/sbin/sudo',
              '/usr/sbin/sudoedit',
              '/usr/sbin/suexec',
              '/usr/sbin/traceroute',
              '/usr/sbin/traceroute6',
              '/usr/sbin/umount',
              '/usr/sbin/umount.nfs',
              '/usr/sbin/umount.nfs4',
              '/usr/sbin/unix_chkpwd',
              '/usr/sbin/usernetctl'
            )
          )
          AND NOT (
            mode = '4754'
            AND uid = 0
            AND gid = 30
            AND file.path IN ('/usr/sbin/pppd', '/sbin/pppd')
          )
          AND NOT (
            mode = '6755'
            AND uid = 0
            AND gid IN (0,8)
            AND file.path IN (
              '/bin/light',
              '/bin/man',
              '/bin/mandb',
              '/bin/mount.cifs',
              '/bin/mount.smb3',
              '/bin/procmail',
              '/bin/unix_chkpwd',
              '/sbin/mandb',
              '/sbin/mount.cifs',
              '/sbin/mount.smb3',
              '/sbin/unix_chkpwd',
              '/usr/bin/light',
              '/usr/bin/mandb',
              '/usr/bin/mount.cifs',
              '/usr/bin/mount.smb3',
              '/usr/bin/procmail',
              '/usr/bin/unix_chkpwd',
              '/usr/lib/xtest',
              '/usr/lib64/xtest',
              '/usr/sbin/mandb',
              '/usr/sbin/mount.cifs',
              '/usr/sbin/mount.smb3',
              '/usr/sbin/unix_chkpwd',
              '/bin/procmail',
              '/usr/bin/procmail'
            )
          )
          AND NOT (
            mode = '4110'
            AND uid = 0
            AND gid = 156
            AND file.path IN ('/bin/staprun', '/usr/bin/staprun', '/sbin/staprun', '/usr/sbin/staprun')
          )
      )
    GROUP BY
      inode
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Sysutils Linux"
  description: Unexpected calls to system utilities (event-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      AND pe.cmdline != ''
      AND (
        pe.path IN (
          '/sbin/chattr',
          '/sbin/setenforce',
          '/sbin/sysctl',
          '/usr/bin/chattr',
          '/usr/bin/setenforce',
          '/usr/bin/sqlite3',
          '/usr/bin/sysctl',
          '/usr/sbin/chattr',
          '/usr/sbin/setenforce',
          '/usr/sbin/sysctl'
        ) -- Used by LaZagne, through the Platform library
        OR (
          pe.path IN ('/ur/bin/uname', '/bin/uname')
          AND pe.cmdline LIKE '%uname -p'
        )
      )
      AND p.parent > 0
    GROUP BY
      pe.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Sysutils Macos"
  description: Unexpected calls to macOS system utilities (event-based)
  query: |
    SELECT
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key,
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -900)
      AND pe.status = 0
      AND pe.parent > 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND pe.status == 0
      AND pe.path IN (
        '/usr/bin/csrutil',
        '/usr/bin/ditto',
        '/usr/bin/dscl',
        '/usr/bin/funzip',
        '/usr/bin/openssl',
        '/usr/bin/security',
        '/usr/bin/sqlite3',
        '/usr/bin/sw_vers',
        '/usr/bin/unzip',
        '/usr/bin/uuidgen',
        '/usr/bin/whoami',
        '/usr/libexec/security_authtrampoline',
        '/usr/sbin/ioreg',
        '/usr/sbin/spctl',
        '/usr/sbin/sysctl',
        '/usr/sbin/system_profiler'
      )
      AND p.parent > 0
      AND NOT p0_cmd IN (
        '/usr/bin/security authorizationdb read system.login.screensaver',
        '/usr/sbin/sysctl -n hw.cputype',
        '/usr/sbin/sysctl kern.hv_support',
        '/usr/sbin/sysctl sysctl.proc_translated',
        '/usr/sbin/system_profiler SPUSBDataType',
        'security authorizationdb read system.login.screensaver',
        'sw_vers -productName',
        'sysctl -i sysctl.proc_translated',
        'sysctl -n hw.optional.arm64',
        'sysctl -n sysctl.proc_translated',
        'system_profiler SPUSBDataType',
        'unzip -h'
      )
      AND NOT exception_key IN (
        'ditto,500,ruby,zsh',
        'ioreg,500,bash,Alfred Preferences',
        'ioreg,500,com.docker.backend,com.docker.backend',
        'ioreg,500,com.docker.backend,launchd',
        'security_authtrampoline,500,Raycast,launchd',
        'system_profiler,0,launcher,launchd',
        'system_profiler,500,bash,DDPM',
        'system_profiler,500,bash,launchd',
        'system_profiler,500,bash,logioptionsplus_agent',
        'system_profiler,500,Google Drive,launchd',
        'system_profiler,500,steam_osx,launchd',
        'system_profiler,500,Ultimate,launchd',
        'unzip,500,tmux,launchd'
      )
      AND NOT exception_key LIKE 'unzip,500,login,iTermServer-%'
      AND NOT p0_cmd LIKE '/usr/libexec/security_authtrampoline /Library/Application Support/Adobe/Adobe Desktop Common/ElevationManager/Adobe Installer auth%'
      AND NOT p0_cmd LIKE '%sqlite3%vulnerability.db%'
      AND NOT p1_path IN (
        '/Applications/Alfred 5.app/Contents/Preferences/Alfred Preferences.app/Contents/MacOS/Alfred Preferences',
        '/Applications/LogiTune.app/Contents/MacOS/LogiTune'
      )
    GROUP BY
      pe.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Xattr Calls Macos"
  description: Detect unusual calls to xattr, used to remove filesystem attributes
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND pe.status = 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND pe.status == 0
      AND pe.path = '/usr/bin/xattr'
      AND p0_cmd NOT LIKE '%xattr -d -r com.apple.quarantine /Applications/%.app'
      AND p0_cmd NOT LIKE '%xattr -r -d com.apple.quarantine /Applications/%.app'
      AND p0_cmd NOT LIKE '%xattr -d com.apple.quarantine /Applications/%.app'
      AND p0_cmd NOT LIKE '%xattr -d com.apple.quarantine /Applications/%.app/%.xpc'
      AND p0_cmd NOT LIKE '%xattr -d com.apple.FinderInfo /Applications/Parallels Desktop.app'
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -l %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -p com.apple.quarantine %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '%xattr -p com.apple.metadata:kMDItemAlternateNames %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE '/usr/bin/xattr -w com.apple.metadata:kMDItemAlternateNames %'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd LIKE 'xattr -r -d com.apple.quarantine /Users/%/.provisio/bin/%.app'
      )
      AND NOT (
        pe.euid > 500
        AND p0_cmd = '/usr/bin/xattr -h'
        AND p1_cmd LIKE '%brew%'
      )
      AND p0_cmd NOT LIKE '%xattr -p com.apple.rootless %'
      AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0002;%'
      AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0181;%'
      AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0381;%'
    GROUP BY
      pe.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Exec Failed Launch Constraint Violation"
  description: Catch programs that failed to run due to a launch constraint violation, such as a signing issue.
  query: |
    SELECT
        s.identifier AS s_id,
        s.authority AS s_auth,
        -- Child
        pe.path AS p0_path,
        COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
        TRIM(pe.cmdline) AS p0_cmd,
        pe.time AS p0_time,
        -- pe.cwd is NULL on macOS
        p.cwd AS p0_cwd,
        pe.pid AS p0_pid,
        pe.euid AS p0_euid,
        -- Parent
        pe.parent AS p1_pid,
        TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
        p1.cwd AS p1_cwd,
        COALESCE(p1.path, pe1.path) AS p1_path,
        COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
        REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
        -- Grandparent
        COALESCE(p1.parent, pe1.parent) AS p2_pid,
        TRIM(
            COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
        ) AS p2_cmd,
        p1_p2.cwd AS p2_cwd,
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
        COALESCE(
            p1_p2_hash.path,
            pe1_p2_hash.path,
            pe1_pe2_hash.path
        ) AS p2_hash,
        REGEX_MATCH (
            COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
            '.*/(.*)',
            1
        ) AS p2_name
    FROM
        process_events pe
        LEFT JOIN file f ON pe.path = f.path
        LEFT JOIN signature S ON pe.path = s.path
        LEFT JOIN users u ON pe.uid = u.uid
        LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
        LEFT JOIN processes p1 ON pe.parent = p1.pid
        LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
        LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
        AND pe1.cmdline != ''
        LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
        LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
        LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
        LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
        AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
        LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
        LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
        LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
        pe.time > (strftime ('%s', 'now') -900)
        AND pe.status = 1
        AND pe.cmdline != ''
        AND pe.cmdline IS NOT NULL
        AND p0_cmd NOT IN (
            '/opt/homebrew/opt/tailscale/bin/tailscaled',
            '/Library/PrivilegedHelperTools/com.docker.vmnetd',
            '/Applications/ElasticEndpoint.app/Contents/MacOS/ElasticEndpoint --install'
        )
    GROUP BY
        pe.euid,
        pe.path,
        pe.cmdline
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Tiny Executable"
  description: Unusually small programs (state-based)
  query: |
    SELECT
      p.pid,
      p.path,
      p.cmdline,
      file.size,
      p.start_time,
      file.mode,
      file.type,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.euid AS parent_euid,
      hash.sha256 AS parent_sha256
    FROM
      processes p
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON pp.path = hash.path
    WHERE
      file.size > 0
      AND file.size < 10000
      AND NOT file.path LIKE '/home/%/.local/share/Steam/steamapps/%'
      AND NOT file.path LIKE '/home/%/.local/share/Steam/ubuntu%'
      AND NOT file.path LIKE '/home/%/.zsh/completion'
      AND NOT file.path LIKE '/Users/%/.zsh/completion'
      AND NOT file.path IN (
        '/',
        '/usr/bin/ruby',
        '/Applications/OpenOffice.app/Contents/MacOS/soffice'
      )
      AND NOT (
        file.path = '/sbin/ldconfig'
        AND pp.euid = 1000
      )
      AND NOT (
        file.path LIKE '/home/%/.ape-%'
        AND pp.euid = 1000
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Chmod Exec Event Linux"
  description: Things that call chmod to set executable permissions
  query: |
    SELECT
      IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) AS f_path,
      f.mode AS f_mode,
      f.type AS f_type,
      hash.sha256 AS f_hash,
      magic.data AS f_magic,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Wow, you can do that?
      LEFT JOIN file f ON IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) = f.path
      LEFT JOIN hash ON f.path = hash.path
      LEFT JOIN magic ON f.path = magic.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT DISTINCT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -300)
          AND syscall = "execve"
          AND (
            cmdline LIKE '%chmod% 7%'
            OR cmdline LIKE '%chmod 5%'
            OR cmdline LIKE '%chmod 1%'
            OR cmdline LIKE '%chmod +%x'
            OR cmdline LIKE '%chmod% +rwx%'
            OR cmdline LIKE '%chmod% +x%'
            OR cmdline LIKE '%chmod% u+x%'
            OR cmdline LIKE '%chmod% a+x%'
          )
          AND cmdline NOT LIKE 'chmod 777 /app/%'
          AND cmdline NOT LIKE 'chmod 700 /tmp/apt-key-gpghome.%'
          AND cmdline NOT LIKE 'chmod 700 /home/%/snap/%/%/.config'
          AND cmdline NOT LIKE 'chmod +x /home/%/bin/%'
          AND cmdline NOT LIKE '%chmod 755 /home/%/.local/share/cinnamon/applets/download-and-upload-speed@cardsurf/translation.sh'
      )
      AND NOT (
        f_path = '/usr/local/bin/kubectl'
        AND f_mode IN ('0755', '0775')
      )
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.syscall = "execve"
      AND f.type != 'directory'
      AND p1_cgroup NOT LIKE '/system.slice/docker-%'
      AND p1_cgroup NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND p2_cgroup NOT LIKE '/system.slice/docker-%'
      AND p2_cgroup NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND NOT exception_key IN (
        'chmod,500,bash,gnome-terminal-server',
        'chmod,500,fish,alacritty',
        'bash,500,vim.nox,bash',
        'chmod,500,fish,alacritty',
        'dash,500,code,code'
      )
      AND NOT (
        exception_key LIKE '%sh,500,node,%sh'
        AND f.path LIKE '%claude%'
      )
    GROUP BY
      p0_pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Chmod Exec Event Macos"
  description: Things that call chmod to set executable permissions
  query: |
    SELECT
      IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) AS f_path,
      f.mode AS f_mode,
      f.type AS f_type,
      hash.sha256 AS f_hash,
      magic.data AS f_magic,
      -- Child
      pe.path AS p0_path,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Wow, you can do that?
      LEFT JOIN file f ON IFNULL(
        REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),
        CONCAT (
          pe.cwd,
          '/',
          REGEX_MATCH (TRIM(pe.cmdline), '.* (.*)', 1)
        )
      ) = f.path
      LEFT JOIN hash ON f.path = hash.path
      LEFT JOIN magic ON f.path = magic.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT DISTINCT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -300)
          AND status = 0
          AND parent > 0
          AND (
            cmdline LIKE '%chmod% 7%'
            OR cmdline LIKE '%chmod% +rwx%'
            OR cmdline LIKE '%chmod% +x%'
            OR cmdline LIKE '%chmod% u+x%'
            OR cmdline LIKE '%chmod% a+x%'
          )
          AND cmdline != 'chmod 0777 /Users/Shared/logitune'
      )
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.syscall = "execve"
      AND f.type != 'directory'
    GROUP BY
      p0_pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Env Values Macos"
  description: Applications setting environment variables to bypass security protections
  query: |
    SELECT
      key,
      value,
      p.pid,
      p.path,
      p.cwd,
      p.cmdline,
      p.parent AS parent_pid,
      pp.cmdline AS parent_cmd
      -- Querying processes first and filtering by time gives a massive 20X speed improvement
      -- over querying process_envs first and JOIN'ing against processes
    FROM
      processes p
      LEFT JOIN process_envs pe ON p.pid = pe.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
    WHERE -- This time should match the interval
      p.start_time > (strftime('%s', 'now') - 60)
      AND (
        key = 'HISTFILE'
        AND NOT value LIKE '/Users/%/.%_history'
        AND NOT value = '~/.tramp_history'
      )
      OR (
        key = 'LD_PRELOAD'
        AND NOT p.path LIKE '%/firefox'
        AND NOT pe.value = 'libfakeroot.so'
        AND NOT pe.value LIKE 'libmozsandbox.so%'
        AND NOT pe.value LIKE ':/snap/%' -- Yes, on macOS (emote)
      )
      OR (
        key = 'DYLD_INSERT_LIBRARIES' -- actively exploited on programs which disable library security
        AND NOT pe.value = '/System/Library/PrivateFrameworks/PreviewsInjection.framework/PreviewsInjection'
        AND NOT pe.value LIKE '/opt/homebrew/Cellar/r/4.%/lib/R/lib/libR.dylib'
        AND NOT pe.value LIKE '%/libsamply_mac_preload.dylib'
        AND NOT pe.value LIKE '%/Steam/Steam.AppBundle/Steam/Contents/MacOS/steamloader.dylib:%/Steam/Steam.AppBundle/Steam/Contents/MacOS/gameoverlayrenderer.dylib'
        AND NOT pe.value LIKE '%/libtrace.dylib'
        AND NOT pe.value LIKE '%/libR.dylib'
      )
      OR (
        key = 'DYLD_FRAMEWORK_PATH' -- sort of obsolete, but may affect SIP abusers
        AND NOT pe.value LIKE '%/IDLE.app/%'
        AND NOT pe.value LIKE '/Users/%/Library/Caches/ms-playwright/webkit-%'
        AND NOT pe.value = '/System/Library/Frameworks'
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Execdir Events Linux"
  description: Catch applications running from unusual directories, such as /tmp (event-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = pe.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -300)
          AND (
            INSTR(path, "/.terraform/") > 0
            AND INSTR(path, "/app/") != 1
            AND INSTR(path, "/bin") != 1
            AND INSTR(path, "/home/") != 1
            AND INSTR(path, "/ko-app") != 1
            AND INSTR(path, "/nix/") != 1
            AND INSTR(path, "/opt/") != 1
            AND INSTR(path, "/sbin/") != 1
            AND INSTR(path, "/snap/") != 1
            AND INSTR(path, "/tmp/go-build") != 1
            AND INSTR(path, "/usr/bin/") != 1
            AND INSTR(path, "/usr/lib/") != 1
            AND INSTR(path, "/usr/lib64/") != 1
            AND INSTR(path, "/usr/libexec") != 1
            AND INSTR(path, "/usr/local/") != 1
            AND INSTR(path, "/usr/sbin/") != 1
            AND INSTR(path, "/usr/share/code/") != 1
            AND INSTR(path, "/usr/share/spotify") != 1
            AND INSTR(path, "/usr/share/teams/") != 1
            AND INSTR(path, "/var/kolide-k2/") != 1
            AND INSTR(path, "/var/lib/snapd/") != 1
          )
          AND syscall = "execve" -- REGEX_MATCH performed terribly. INSTR and LIKE are very very close.
        GROUP BY
          path
      )
      AND pe.time > (strftime('%s', 'now') -300)
      AND pe.syscall = "execve"
      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
      AND p1.cgroup_path NOT LIKE '/system.slice/docker-%'
      AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'
    GROUP BY
      pe.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Execdir Events Macos"
  description: Catch applications running from unusual directories, such as /tmp
  query: |
    SELECT
      COALESCE(
        REGEX_MATCH (REPLACE(pe.path, u.directory, '~'), '(.*)/', 1),
        pe.path
      ) AS dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(pe.path, u.directory, '~'),
          '(~*/.*?)/',
          1
        ),
        REPLACE(pe.path, u.directory, '~'),
        '(.*)/',
        1
      ) AS top1_dir,
      COALESCE(
        REGEX_MATCH (
          REPLACE(pe.path, u.directory, '~'),
          '(~*/.*?/.*?/.*?)/',
          1
        ),
        REPLACE(pe.path, u.directory, '~'),
        '(.*)/',
        1
      ) AS top3_dir,
      s.identifier AS s_id,
      s.authority AS s_auth,
      -- Child
      pe.path AS p0_path,
      COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.time AS p0_time,
      -- pe.cwd is NULL on macOS
      p.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      p1.cwd AS p1_cwd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      p1_p2.cwd AS p2_cwd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file f ON pe.path = f.path
      LEFT JOIN signature S ON pe.path = s.path
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -240)
      AND pe.status = 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND top1_dir NOT IN (
        '/Applications',
        '/nix',
        '/System',
        '~/.cargo',
        '~/.config',
        '~/.gimme',
        '~/.gradle',
        '~/.kuberlr',
        '~/.local',
        '~/.provisio',
        '~/.pulumi',
        '~/.pyenv',
        '~/.rustup',
        '~/.steampipe',
        '~/.tflint.d',
        '~/.vs-kubernetes',
        '~/.vscode-insiders',
        '~/.vscode',
        '~/anaconda3',
        '~/Applications (Parallels)',
        '~/Applications',
        '~/bin',
        '~/chainctl',
        '~/chainguard',
        '~/code',
        '~/Code',
        '~/dev',
        '~/git',
        '~/github',
        '~/go',
        '~/google-cloud-sdk',
        '~/homebrew',
        --  '~/Library',
        '~/melange',
        '~/Parallels',
        '~/proj',
        '~/projects',
        '~/Projects',
        '~/src',
        '~/workspace'
      )
      AND top3_dir NOT IN (
        '/Library/Apple/System',
        '/Library/Application Support/AdGuard Software',
        '/Library/Application Support/Adobe',
        '/Library/Application Support/Blackmagic Design',
        '/Library/Application Support/Canon_Inc_IC',
        '/Library/Application Support/com.canonical.multipass',
        '/Library/Application Support/EcammLive',
        '/Library/Application Support/Fortinet',
        '/Library/Application Support/GPGTools',
        '/Library/Application Support/org.pqrs',
        '/Library/Developer/CommandLineTools',
        '/Library/Elastic/Agent',
        '/Library/Frameworks/Python.framework',
        '/Library/Google/GoogleSoftwareUpdate',
        '/Library/Java/JavaVirtualMachines',
        '/Library/Plug-Ins/FxPlug',
        '/Library/Printers/Brother',
        '/Library/Printers/Canon',
        '/Library/Screen Savers/XScreenSaverUpdater.app',
        '/opt/Elastic/Endpoint',
        '/opt/homebrew/Caskroom',
        '/opt/homebrew/Cellar',
        '/opt/homebrew/Library',
        '/opt/rapid7/ir_agent',
        '/private/tmp/golangci-lint',
        '/private/var/kolide-k2',
        '/usr/libexec/AssetCache',
        '/usr/libexec/rosetta',
        '/usr/local/Cellar',
        '/usr/local/crc',
        '/usr/local/kolide-k2',
        '/Volumes/Google Chrome/Google Chrome.app',
        '/Volumes/Slack/Slack.app',
        '~/.docker/cli-plugins',
        '~/.docker/cli-plugins/docker-sbom',
        '~/.wdm/drivers/chromedriver',
        '~/Library/Application Support/Box',
        '~/Library/Application Support/BraveSoftware',
        '~/Library/Application Support/CleanMyMac X',
        '~/Library/Application Support/Code',
        '~/Library/Application Support/com.elgato.StreamDeck',
        '~/Library/Application Support/com.grammarly.ProjectLlama',
        '~/Library/Application Support/Foxit Software',
        '~/Library/Application Support/InstantView',
        '~/Library/Application Support/JetBrains',
        '~/Library/Application Support/LogMeInInc',
        '~/Library/Application Support/minecraft',
        '~/Library/Application Support/OpenLens',
        '~/Library/Application Support/Steam',
        '~/Library/Application Support/zoom.us',
        '~/Library/Caches/com.knollsoft.Rectangle',
        '~/Library/Caches/com.mimestream.Mimestream',
        '~/Library/Caches/Cypress',
        '~/Library/Caches/dagger',
        '~/Library/Caches/JetBrains',
        '~/Library/Caches/snyk',
        '~/Library/Developer/Xcode',
        '~/Library/Google/GoogleSoftwareUpdate',
        '~/Library/Services/UE4EditorServices.app',
        '~/syft/.tool/binny'
      )
      AND dir NOT IN (
        '/bin',
        '/Library/Application Support/Fortinet/FortiClient/bin',
        '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS',
        '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS',
        '/Library/Application Support/Logitech.localized/Logitech Options.localized/LogiMgrUpdater.app/Contents/Resources',
        '/Library/Application Support/X-Rite/Frameworks/XRiteDevice.framework/Versions/B/Resources/XRD Software Update.app/Contents/MacOS',
        '/Library/Audio/Plug-Ins/HAL/ACE.driver/Contents/Resources',
        '/Library/Audio/Plug-Ins/HAL/ACE.driver/Contents/Resources/aceagent.app/Contents/MacOS',
        '/Library/Audio/Plug-Ins/HAL/SolsticeDesktopSpeakers.driver/Contents/XPCServices/RelayXpc.xpc/Contents/MacOS',
        '/Library/DropboxHelperTools/Dropbox_u501',
        '/Library/Filesystems/kbfuse.fs/Contents/Resources',
        '/Library/Filesystems/macfuse.fs/Contents/Resources',
        '/Library/Frameworks/Python.framework/Versions/3.10/bin',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers.app/Contents/MacOS',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',
        '/Library/Image Capture/Devices/EPSON Scanner.app/Contents/MacOS',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS/',
        '/Library/Printers/Brother/Filter/rastertobrother2130.bundle/Contents/MacOS',
        '/Library/Printers/Brother/Filter/rastertobrother2300.bundle/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/LOGINserver.app/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/NETserver.app/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/USBAppControl.app/Contents/MacOS',
        '/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/Contents/MacOS',
        '/Library/Printers/DYMO/Utilities',
        '/Library/Printers/EPSON/InkjetPrinter2/Filter/commandtoescp.app/Contents/MacOS',
        '/Library/PrivilegedHelperTools',
        '/Library/TeX/texbin',
        '/node_modules/.bin',
        '/opt/custom-cli-tools',
        '/opt/homebrew/bin',
        '/opt/osquery/lib/osquery.app/Contents/MacOS',
        '/opt/usr/bin',
        '/opt/X11/bin',
        '/opt/X11/libexec',
        '/run/current-system/sw/bin',
        '/sbin',
        '/tmp/bin',
        '/usr/bin',
        '/usr/lib',
        '/usr/lib/bluetooth',
        '/usr/lib/cups/notifier',
        '/usr/lib/fwupd',
        '/usr/lib/ibus',
        '/usr/lib/system',
        '/usr/libexec',
        '/usr/libexec/ApplicationFirewall',
        '/usr/libexec/AssetCache',
        '/usr/libexec/cups/backend',
        '/usr/libexec/firmwarecheckers',
        '/usr/libexec/firmwarecheckers/eficheck',
        '/usr/libexec/rosetta',
        '/usr/local/aws-cli',
        '/usr/local/bin',
        '/usr/local/MacGPG2/bin',
        '/usr/sbin',
        '/Volumes/Grammarly/Grammarly Installer.app/Contents/MacOS',
        '~/.cache/gitstatus',
        '~/.docker/cli-plugins',
        '~/.local/bin',
        '~/.magefile',
        '~/bin',
        '~/code/bin',
        '~/Downloads/google-cloud-sdk/bin',
        '~/Downloads/protoc/bin',
        '~/go/bin',
        '~/Library/Application Support/Alfred/Assistant',
        '~/Library/Application Support/cloud-code/installer/google-cloud-sdk/bin',
        '~/Library/Application Support/dev.warp.Warp-Stable',
        '~/Library/Application Support/minecraft/launcher/launcher.bundle/Contents/Frameworks/launcher-Helper (GPU).app/Contents/MacOS',
        '~/Library/Application Support/snyk-ls',
        '~/melange',
        '~/projects/go/bin'
      ) -- Locally built executables
      AND NOT (
        s.identifier = 'a.out'
        AND (
          dir LIKE '~/%'
          OR dir LIKE '/Users/%'
        )
        AND p1_name IN ('fish', 'sh', 'bash', 'zsh', 'terraform', 'code')
      )
      AND NOT (
        s.authority = ''
        AND dir LIKE '~/%'
        AND p1_name IN ('fish', 'sh', 'bash', 'zsh')
        AND p.cmdline LIKE './%'
      ) -- Spotify
      AND pe.path NOT LIKE '/private/tmp%/cloud_sql_proxy'
      AND pe.path NOT LIKE '/private/var/folders/%/T/sp_relauncher' -- Sparkle updater
      AND pe.path NOT LIKE '/Users/%/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%/Updater.app/Contents/MacOS/Updater'
      AND dir NOT LIKE '/Applications/%'
      AND dir NOT LIKE '/Library/SystemExtensions/%-%/%.systemextension/Contents/MacOS'
      AND dir NOT LIKE '/opt/%/bin'
      AND dir NOT LIKE '/private/tmp/%.app/Contents/MacOS'
      AND dir NOT LIKE '/private/tmp/go-build%/exe'
      AND dir NOT LIKE '/private/tmp/KSInstallAction.%/Install Google Software Update.app/Contents/Helpers'
      AND dir NOT LIKE '/private/tmp/nix-build-%'
      AND dir NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%'
      AND dir NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'
      AND dir NOT LIKE '/private/var/folders/%/bin'
      AND dir NOT LIKE '/private/var/folders/%/Contents/%'
      AND dir NOT LIKE '/private/var/folders/%/d/Wrapper/%.app%'
      AND dir NOT LIKE '/private/var/folders/%/go-build%'
      AND dir NOT LIKE '/private/var/folders/%/GoLand'
      AND dir NOT LIKE '/private/var/folders/%/T/cargo-install%'
      AND dir NOT LIKE '/private/var/kolide-k2/k2device.kolide.com/updates/osqueryd/%'
      AND dir NOT LIKE '/Volumes/com.getdropbox.dropbox-%' -- These signers can run from wherever the hell they want.
      AND dir NOT LIKE '%/.terraform/providers/%'
      AND dir NOT LIKE '%/go/bin'
      AND dir NOT LIKE '~/.local/%/packages/%'
      AND dir NOT LIKE '~/%/bin'
      AND dir NOT LIKE '~/%/google-cloud-sdk/bin/%'
      AND dir NOT LIKE '~/%/node_modules/%'
      AND dir NOT LIKE '~/%repo%' -- When running code as root
      AND dir NOT LIKE '~/%sigstore%'
      AND dir NOT LIKE '~/Documents/%/build/%'
      AND dir NOT LIKE '~/Documents/%/target/%'
      AND dir NOT LIKE '~/Downloads/%.app/Contents/MacOS'
      AND dir NOT LIKE '~/Library/Arduino%/packages/%'
      AND dir NOT LIKE '~/Library/Caches/ms-playwright/%'
      AND dir NOT LIKE '~/Library/Printers/%/Contents/MacOS'
      AND s.identifier != 'org.sparkle-project.Sparkle.Autoupdate'
      AND s.authority NOT IN (
        'Apple iPhone OS Application Signing',
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y)',
        'Developer ID Application: Figma, Inc. (T8RA8NE3B7)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: LG Electronics (5SKT5H4CPQ)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mojang AB (HR992ZEAE6)',
        'Developer ID Application: Ned Deily (DJ3H93M7VJ)',
        'Developer ID Application: Node.js Foundation (HX7739G8FX)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: reMarkable AS (4FFUD2H2F6)',
        'Developer ID Application: Rogue Amoeba Software, LLC (7266XEXAPM)',
        'Developer ID Application: Silicon Laboratories Inc (52444FG85C)',
        'Developer ID Application: SILICON MOTION, INC. (JAGYSS7E9A)',
        'Developer ID Application: Snyk Limited (97QYW7LHSF)',
        'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',
        'Developer ID Application: TablePlus Inc (3X57WP8E8V)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Software Signing'
      ) -- Don't spam alerts with repeated invocations of the same command-line
    GROUP BY
      p.cmdline,
      p.cwd,
      p.euid;
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Long Running Security Framework Macos"
  description: Find programs that use the Security Framework on macOS - popular among malware authors
  query: |
    SELECT
      s.authority,
      s.identifier,
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        p0.name,
        ',',
        s.identifier,
        ',',
        s.authority
      ) AS exception_key,
      pmm.path AS lib_path,
      -- Child
      p0.pid AS p0_pid,
      p0.start_time AS p0_start,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.start_time AS p1_start,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.start_time AS p2_start,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE -- Focus on longer-running programs
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time < (strftime('%s', 'now') - 25200)
          AND parent != 0 -- Assume STP
          AND NOT path LIKE '/Applications/%.app/%' -- Other oddball binary paths
          AND NOT path LIKE '/nix/store/%'
          AND NOT path LIKE '/opt/%'
          AND NOT path LIKE '/private/var/folders%/T/go-build%/exe/%'
          AND NOT path LIKE '/System/%'
          AND NOT path LIKE '/Users/%/.terraform/providers/%'
          AND NOT path LIKE '/Users/%/bin/%'
          AND NOT path LIKE '/Users/%/dev/%'
          AND NOT path LIKE '/Users/%/go/%'
          AND NOT path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'
          AND NOT path LIKE '/Users/%/Library/Application Support/Zed/extensions/%'
          AND NOT path LIKE '/Users/%/Library/Application Support/Zed/supermaven/%'
          AND NOT path LIKE '/Users/%/src/%'
          AND NOT path LIKE '/usr/libexec/%'
          AND NOT path LIKE '/usr/sbin/%' -- Regular apps
          AND NOT REGEX_MATCH (path, '(.*)/', 1) LIKE '%/bin'
          AND NOT (
            path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/com.elgato.cpu.sdPlugin/cpu'
            AND name = 'cpu'
          ) -- Takes arguments
          AND NOT (
            euid >= 500
            AND cmdline LIKE "% --%"
          )
      )
      AND pmm.path LIKE '%Security.framework%'
      AND NOT s.authority IN (
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Google, Inc. (EQHXZ8M8AV)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)'
      )
      AND exception_key NOT IN (
        '0,velociraptor,a.out,',
        '500,docker,docker,',
        '500,pnpm,pnpm,',
        '500,python3,python.exe,',
        '500,sdaudioswitch,,',
        '500,sdaudioswitch,sdaudioswitch,',
        '500,sdmicmute,sdmicmute,',
        '500,sdzoomplugin,,'
      )
      AND NOT exception_key LIKE '500,%,a.out,'
      AND NOT exception_key LIKE '500,lifx-streamdeck,lifx-streamdeck-%'
      AND NOT exception_key LIKE '500,marksman-macos,marksman-%,'
      AND NOT exception_key LIKE '500,nvim,bob-%,'
      AND NOT exception_key LIKE '500,package-version-server-v%,package_version_server-%,'
      AND NOT exception_key LIKE '500,rust-analyzer,rust_analyzer-%,'
      AND NOT exception_key LIKE '500,rust-analyzer-proc-macro-srv,rust_analyzer_proc_macro_srv-%,'
      AND NOT exception_key LIKE '500,sm-agent,sm_agent-%'
    GROUP BY
      p0.pid
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Packet Sniffer"
  description: "Find unexpected use of raw sockets in executables, sometimes used for C&C communications"
  query: |
    SELECT
      pop.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pop
      LEFT JOIN processes p0 ON pop.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pop.family = 17 -- PF_PACKET
      AND p0.name NOT IN (
        'agentbeat',
        'dhclient',
        'dhcpcd',
        'dockerd',
        'NetworkManager',
        'packetbeat',
        'systemd-network',
        'tailscaled',
        'tcpdump',
        'wpa_supplicant'
      )
      AND NOT (
        p0.cgroup_path LIKE '/system.slice/docker-%'
        AND p0.path = '/speaker'
        AND p0.name = 'speaker'
        AND protocol = 2054
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Root Signer Events Macos"
  description: Programs running as root from unusual signers on macOS
  query: |
    SELECT
      f.directory AS dir,
      REGEX_MATCH (p.path, '(/.*?/.*?)/', 1) AS top_dir,
      -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      pe.euid AS p0_euid,
      s.authority AS p0_sauth,
      s.identifier AS p0_sid,
      hash.sha256 AS p0_hash,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      -- pe.cwd is NULL on macOS
      p.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.start_time, pe1.time) AS p1_start,
      COALESCE(p1.path, pe1.path) AS p1_path,
      p1.cwd AS p1_cwd,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      p1_p2.cwd AS p2_cwd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file f ON pe.path = f.path
      LEFT JOIN users u ON pe.uid = u.uid
      LEFT JOIN signature s ON pe.path = s.path
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN hash ON pe.path = hash.path
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      p0_euid = 0
      AND pe.time > (strftime('%s', 'now') -900)
      -- query optimization: Exclude SIP protected directories
      AND top_dir NOT IN (
        '/Library/Apple',
        '/System/Library',
        '/usr/bin',
        '/usr/libexec',
        '/usr/sbin'
      )
      AND s.authority NOT IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Rogue Amoeba Software, Inc. (7266XEXAPM)',
        'Developer ID Application: Rogue Amoeba Software, LLC (7266XEXAPM)',
        'Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'Developer ID Application: Sanford, L.P. (N3S6676K3E)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Software Signing'
      )
      AND NOT (
        s.authority = ""
        AND pe.path LIKE "/nix/store/%-nix-%/bin/nix"
        AND p1.path = "/sbin/launchd"
      )
      AND NOT (
        s.authority = ""
        AND (
          pe.path LIKE "/nix/store/%-nix-%/bin/nix-%"
          OR pe.path LIKE "/private/var/folders/%/T/tmp.%/nix-installer"
        )
        AND p1_path = "/usr/bin/sudo"
      )
      AND NOT (
        s.authority = ""
        AND pe.path LIKE "/opt/%/bin/%"
        AND p1_path IN ("/usr/bin/sudo", "/sbin/launchd")
      )
      -- Surfshark
      AND NOT pe.path LIKE '/Library/SystemExtensions/%/com.surfshark.vpnclient.macos.direct.PacketTunnel-WireGuard.systemextension/Contents/MacOS'
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Relative Exec Low Uid Events"
  description: Programs running as root with a relative path (event-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.time AS p0_time,
      pe.time AS p0_time,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -180)
      AND pe.cmdline != ''
      AND pe.euid < 500
      AND pe.cmdline LIKE './%'
      AND p0_cmd NOT IN (
        './configure',
        './conftest',
        './ksinstall --install=Keystone.tbz',
        './podinfo --port=9898 --port-metrics=9797 --grpc-port=9999 --grpc-service-name=podinfo --level=info --random-delay=false --random-error=false'
      )
      AND p0_cmd NOT LIKE './out/osqtool-% %'
      AND p0_cmd NOT LIKE './tools/bpf/resolve_btfids/resolve_btfids -b vmlinux /var/lib/dkms/%'
      AND p0_cmd NOT LIKE './tools/objtool/objtool%--hacks%'
      AND p0_cmd NOT LIKE './updater -insecure https://10.%:9174/check-update/macos'
      AND p0_path NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%/OneDrivePkgTelemetry'
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Relative Exec Low Uid"
  description: Programs running as root with a relative path
  query: |
    SELECT -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.start_time AS p0_start,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.start_time AS p1_start,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid < 500
          AND cmdline LIKE './%'
          AND NOT cmdline LIKE './out/osqtool-% %'
          AND NOT cmdline LIKE './osqueryi%'
          AND NOT cmdline LIKE './OneDrivePkgTelemetry%'
          AND NOT cmdline LIKE './xcover %'
          AND NOT cmdline LIKE './updater -insecure %'
          AND NOT cmdline = './utrace -p utrace --debug'
          AND NOT cgroup_path LIKE '/system.slice/docker-%'
      )
    GROUP BY
      p0.pid
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Reverse Shell Socket"
  description: Uncover reverse-shell processes
  query: |
    SELECT DISTINCT
      (p.pid),
      p.parent,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      p.root,
      p.uid,
      p.gid,
      p.start_time,
      pos.remote_address,
      pos.remote_port,
      pos.local_address,
      pos.local_port,
      pp.cmdline,
      pp.path
    FROM
      process_open_files pof
      JOIN process_open_sockets pos USING (pid)
      LEFT JOIN processes p ON pof.pid = p.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT OUTER JOIN process_open_files ON p.pid = process_open_files.pid
    WHERE
      p.name IN ('sh', 'bash', 'perl', 'python')
      AND pof.pid IS NULL
      AND pos.remote_port > 0
      AND NOT (
        p.path = '/usr/bin/bash'
        AND pp.cmdline LIKE 'pacman -S%'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Unexpected Mounts"
  description: Detect weird mounts, like mounting the EFI partition
  query: |
    SELECT
      *
    FROM
      mounts
    WHERE
      device = '/dev/disk0s1'
      AND type = 'msdos';
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Xprotect Reports"
  description: Returns a list of malware matches from macOS XProtect
  query: |
    SELECT
      *
    FROM
      xprotect_reports;
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Yara Unexpected Miner Process"
  description: Currently running CryptoCoin miner
  query: |
    SELECT
      yara.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '    
        rule miner {
        strings:
            $tcp = "stratum+tcp://" ascii
            $tls = "stratum+tls://" ascii
            $ssl = "stratum+ssl://" ascii
            $stratum = "stratum://" ascii
            $normalhash = "\"normalHashing\": true,"
        condition:
            filesize < 10MB and 1 of them
    }'
      AND yara.count > 0
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/execution] Yara Unexpected Upx Process"
  description: Currently running UPX executable
  query: |
    SELECT
      yara.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule upx {
        strings:
            $upx_sig = "UPX!"
    
        condition:
            $upx_sig in (0..1024)
        }'
      AND yara.count > 0
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/exfil] Salesforce Large Download Generic"
  description: Returns a list of files likely exported from Salesforce
  query: |
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      datetime(file.atime, 'unixepoch') AS file_accessed,
      hash.sha256
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE '/Users/%/Downloads/%-202%-%-%-%-%-%.xlsx'
        OR file.path LIKE '/home/%/Downloads/%-202%-%-%-%-%-%.xlsx'
        OR file.path LIKE '/Users/%/Downloads/WE_%.ZIP'
        OR file.path LIKE '/home/%/Downloads/WE_%.ZIP'
        OR file.path LIKE '/Users/%/Downloads/report17%.%'
        OR file.path LIKE '/home/%/Downloads/report17%.%'
        OR file.path LIKE '/Users/%/Downloads/%/Cont%act.csv'
        OR file.path LIKE '/home/%/Downloads/%/Cont%act.csv'
      )
      AND file.btime > (strftime('%s', 'now') -86400)
      AND file.size > 500000
    GROUP BY
      file.path
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/exfil] Salesforce Large Download Spotlight"
  description: Surface Salesforce exports (possible data exfiltration)
  query: |
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      datetime(file.atime, 'unixepoch') AS file_accessed,
      hash.sha256,
      ea.value
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
    WHERE
      mdfind.query = 'kMDItemWhereFroms == ''*https://*.my.salesforce.com/*'''
      AND ea.key = 'where_from'
      -- Software downloads
      AND ea.value NOT LIKE "%/sfc/dist/version/download/%"
      AND file.btime > (strftime('%s', 'now') -86400)
      AND file.size > 500000
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/exfil] High Disk Bytes Read"
  description: Programs which are reading an unusually large amount of data
  query: |
    SELECT
      -- WARNING: Writes to tmpfs are not reflected against this counter
      p0.disk_bytes_read AS bytes_read,
      (strftime('%s', 'now') - p0.start_time) AS age,
      p0.disk_bytes_read / (strftime('%s', 'now') - p0.start_time) AS bytes_read_rate,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cgroup_path AS p0_cgroup,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      -- On my Linux machine, tarring up a home directory clocks in at 2,800,000 - 4,986,722
      bytes_read_rate > 3000000
      AND age > 180
      AND p0.path NOT LIKE '/app/%'
      AND p0.path NOT LIKE '/Applications/%.app/Contents/%'
      -- Don't exclude /usr so that we find things like tar & rsync
      AND p0.path NOT LIKE '/home/%/.local/share/Steam/steamapps/%'
      AND p0.path NOT LIKE '/Library/Apple/System/Library/%'
      AND p0.path NOT LIKE '/opt/%'
      AND p0.path NOT LIKE '/System/Applications/%'
      AND p0.path NOT LIKE '/System/Library/%'
      AND p0.name NOT IN (
        'apko',
        'Autodesk Fusion 360',
        'Autodesk Identity Manager',
        'baloo_file',
        'baloo_file_extr',
        'bash',
        'BDLDaemon',
        'bincapz',
        'bwrap',
        'cargo',
        'chrome',
        'clamscan',
        'code',
        'codium',
        'com.apple.MobileSoftwareUpdate.UpdateBrainService',
        'com.apple.NRD.UpdateBrainService',
        'com.apple.WebKit.Networking',
        'cpptools',
        'Disk Inventory X',
        'dnf',
        'docker',
        'elastic-endpoin',
        'elastic-endpoint',
        'electron',
        'emacs',
        'factorio',
        'Fedora Media Writer',
        'firefox',
        'firefox-bin',
        'fish',
        'fleet_backend',
        'fsdaemon',
        'fsnotifier',
        'git',
        'gnome-software',
        'go',
        'containerd-shim',
        'goland',
        'golangci-lint',
        'Google Chrome',
        'GoogleSoftwareUpdateAgent',
        'gopls',
        'grype',
        'hugo',
        'java',
        'kandji-library-manager',
        'kandji-parameter-agent',
        'kube-apiserver',
        'kube-controller',
        'kube-scheduler',
        'kue',
        'launcher',
        'LogiFacecamService',
        'mal',
        'mediawriter',
        'Meeting Center',
        'melange',
        'minecraft-launc',
        'meta',
        'Microsoft Update Assistant',
        'nautilus',
        'nessusd',
        'nix',
        'nix-daemon',
        'nvim',
        'ollama',
        'ollama-runer',
        'ollama_llama_server',
        'osqueryd',
        'osqueryi',
        'plasmashell',
        'pycharm',
        'qemu-system-aarch64',
        'qemu-system-x86',
        'qemu-system-x86-64',
        'rpi-imager',
        'rpm-ostree',
        'rsync',
        'Safari',
        'sh',
        'simdiskimaged',
        'slack',
        'snapd',
        'spotify',
        'steam',
        'steam_osx',
        'systemd',
        'terraform',
        'terraform-ls',
        'terraform-provider-apko',
        'thunderbird',
        'tilt',
        'unattended-upgr',
        'update_dyld_sim_shared_cache',
        'UpdateBrainService',
        'updatedb',
        'vim',
        'wineserver',
        'bundle',
        'rake',
        'wolfictl',
        'yay',
        'ykman-gui',
        'yum',
        'zsh',
        'ZwiftAppMetal',
        'ZwiftAppSilicon'
      )
      AND NOT p0.path IN (
        '/app/libexec/mediawriter/helper',
        '/usr/libexec/syspolicyd',
        '/usr/libexec/logd',
        '/usr/libexec/logd_helper',
        '/usr/libexec/lsd',
        '/usr/libexec/packagekitd',
        '/usr/libexec/diskimagesiod',
        '/Library/Application Support/Adobe/Adobe Desktop Common/HDBox/Setup',
        '/Library/Elastic/Endpoint/elastic-endpoint',
        '/System/Volumes/Preboot/Cryptexes/App/System/Applications/Safari.app/Contents/XPCServices/com.apple.Safari.BrowserDataImportingService.xpc/Contents/MacOS/com.apple.Safari.BrowserDataImportingService',
        '/System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.WebContent.xpc/Contents/MacOS/com.apple.WebKit.WebContent'
      )
      AND NOT p0.path LIKE '/Library/SystemExtensions/%/io.kandji.KandjiAgent.ESF-Extension.systemextension/Contents/MacOS/io.kandji.KandjiAgent.ESF-Extension'
      AND NOT p0.path LIKE '/private/var/folders/%/T/go-build%'
      AND NOT p0.path LIKE '/Users/%/Library/Application Support/Google/GoogleUpdater/%/GoogleUpdater.app/Contents/MacOS/GoogleUpdater'
      AND NOT (
        p0.name = 'bindfs'
        AND p0.cmdline LIKE 'bindfs%-o fsname=%'
      )
      AND NOT (
        p0.name = 'jetbrains-toolb'
        AND p0.path LIKE '/tmp/.mount_jet%/jetbrains-toolbox'
      )
      AND NOT (
        p0.name LIKE 'gopls_%'
        AND p0.path LIKE '%gopls/gopls%'
      )
      AND NOT p0.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%com.apple.MobileSoftwareUpdate.UpdateBrainService.%.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.UpdateBrainService'
      AND NOT (
        p0.name = 'FindMy'
        AND p0.path = '/System/Applications/FindMy.app/Contents/MacOS/FindMy'
      )
      AND NOT (
        p0.name = 'go'
        AND p0.cmdline LIKE 'go run %'
      )
      AND NOT (
        p0.name = 'kernel_task'
        AND p0.path = ''
        AND p0.parent IN (0, 1)
        AND p0.on_disk = -1
      )
      AND NOT (
        p0.name = 'node'
        AND p0.cwd LIKE '%/console-ui/app'
      )
      AND NOT (
        p0.name = 'ruby'
        AND p0.cmdline LIKE '%brew.rb upgrade'
      )
      AND NOT (
        p0.name = 'terraform-ls'
        AND p0.cmdline LIKE 'terraform-ls serve%'
      )
      AND NOT (
        p0.name = ""
        AND p1.name = "nvim"
      )
      AND NOT p0.path LIKE "%/terraform-provider-%"
      AND NOT p0_cmd LIKE '%/gcloud.py components update'
      AND NOT (
        p0.path LIKE '/home/%/Apps/PhpStorm%/jbr/bin/java'
      )
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      p0.pid
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/exfil] Yara Exec Connect Process Linux"
  description: Currently running program with Linux red flags
  query: |
    SELECT
      yara.strings,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule syscalls {
        strings:
            $inet_ntoa = "inet_ntoa"
            $listen = "listen"
            $connect = "connect"
            $execve = "execve"
        condition:
            filesize < 10MB and $execve in (0..8192) and 2 of them
    }'
      AND yara.count > 0
      AND yara.path NOT IN (
        '/usr/bin/dbus-broker-launch',
        '/usr/bin/sudo',
        '/usr/lib/git-core/git-remote-https',
        '/usr/sbin/auditd',
        '/usr/sbin/greetd',
        '/usr/sbin/mcelog'
      )
      AND p0_name != 'git-remote-htp'
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/exfil] Yara Unexpected Rust Http Exec Process"
  description: Rust Program that uses both HTTP and Exec
  query: |
    SELECT
      yara.*,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
          AND NOT path LIKE '/%/.local/zed.app/libexec/zed-editor'
          AND NOT path LIKE '/Applications/%.app/Contents/macOS/%'
          AND NOT path LIKE '/opt/%'
          AND NOT path LIKE '/private/var/folders%/T/go-build%/exe/%'
          AND NOT path LIKE '/System/%'
          AND NOT path LIKE '/Users/%/.terraform/providers/%'
          AND NOT path LIKE '/Users/%/bin/%'
          AND NOT path LIKE '/Users/%/dev/%'
          AND NOT path LIKE '/Users/%/go/%'
          AND NOT path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'
          AND NOT path LIKE '/Users/%/src/%'
          AND NOT path LIKE '/usr/libexec/%'
          AND NOT path LIKE '/usr/sbin/%' -- Regular apps
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule http_exec {
        strings:
            $http_proxy = "HTTP_PROXY" ascii
            $process_unix = "process_unix.rs" ascii
        condition:
            all of them
    }'
      AND yara.count > 0
      AND p0.name NOT IN (
        'atuin',
        'cargo',
        'Cody',
        'deno',
        'DevPod',
        'fig-darwin-universal',
        'figma_agent',
        'i3status-rs',
        'i3status-rust',
        'nvim',
        'old',
        'OrbStack Helper',
        'package-version',
        'rpm-ostree',
        'rustc',
        'sg-nvim-agent',
        'sm-agent',
        'stable',
        'toolbase-runner',
        'uv',
        'warp',
        'warp-terminal',
        'wezterm-gui',
        'zed'
      )
      AND p0.name NOT LIKE 'cody-engine-%'
      AND p0.path NOT LIKE '/Users/%/.cargo/bin/%'
      AND p0.path NOT IN (
        '/Applications/safeqclient.app/Contents/MacOS/safeqclient',
        '/Applications/Zed.app/Contents/MacOS/Zed',
        '/usr/local/bin/determinate-nixd',
        '/usr/bin/pop-launcher',
        '/Library/safeqclientcore/bin/safeqclientcore'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/impact] Evenly Timestomped"
  description: "Files where the timestamp falls along 12-hour boundaries - probably caused by 'touch <date>0000'"
  query: |
    SELECT
      file.path,
      DATETIME(file.mtime, 'unixepoch', 'localtime') AS mod_time,
      DATETIME(file.atime, 'unixepoch', 'localtime') AS access_time,
      file.inode,
      file.type,
      file.mode,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.path LIKE "/bin/%%"
        OR file.path LIKE "/etc/%%"
        OR file.path LIKE "/sbin/%%"
        OR file.path LIKE "/lib/%%"
      )
      -- This timestamp is in UTC
      AND file.mtime > (strftime('%s', 'now') - (86400 * 720))
      AND file.mtime % 3600 = 0
      AND file.type = 'regular'
      -- Narrow down to specific offsets in the users local timezone (there should be a better way!)
      AND (
        mod_time LIKE "% 12:00:00"
        OR mod_time LIKE "% 00:00:00"
      )
      -- false positives
      AND filename NOT IN (
        '_libinput',
        'COPYING',
        'debian_version',
        'installer-info.json',
        'master.passwd',
        'METADATA',
        'NEWS',
        'printcap',
        'strace-log-merge'
      )
      AND filename NOT LIKE '%.txt'
      AND file.path NOT LIKE '/etc/cups/%'
      AND file.path NOT LIKE '%/lynis%'
      AND file.path NOT LIKE '%/yelp-xsl%'
      AND file.path != '/bin/VGAuthService'
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/impact] Unexpected Etc Hosts"
  description: Unexpected /etc/hosts entries
  query: |
    SELECT
      *
    FROM
      etc_hosts
    WHERE
      hostnames NOT IN (
        'ip6-allnodes',
        'ip6-allrouters',
        'kubernetes',
        'localhost ip6-localhost ip6-loopback',
        'localhost localhost.localdomain localhost4 localhost4.localdomain4',
        'localhost'
      )
      AND address NOT IN (
        '::1',
        'ff02::1',
        'ff02::2',
        '255.255.255.255',
        'fe00::0',
        'ff00::0'
      )
      AND address NOT LIKE '127.%'
      AND address NOT LIKE '172.%'
      AND address NOT LIKE '192.168.%'
      AND address NOT LIKE '10.%'
      AND hostnames NOT LIKE '%.%-%.%.dev'
      AND hostnames NOT LIKE '%.internal'
      AND hostnames NOT LIKE '%.local'
      AND hostnames NOT LIKE '%.svc'
      AND hostnames NOT LIKE '%.test'
      AND hostnames NOT LIKE '%.wtf'
      AND hostnames NOT LIKE '%k8s%'
      AND hostnames NOT LIKE '%local%'
      AND hostnames NOT LIKE 'ip6-%'
      AND hostnames NOT LIKE 'localhost.%'
      AND hostnames NOT LIKE "%.cloud"
      AND hostnames NOT LIKE "%.example.com"
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Unexpected Diskimage Source Macos"
  description: Surface ISO/DMG disk images that were downloaded from unexpected places
  query: |
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      signature.identifier,
      signature.authority,
      ea.value AS url,
      REGEX_MATCH (ea.value, '/([\w_-]+\.[\w\._-]+)[:/]', 1) AS host,
      COALESCE(
        REGEX_MATCH (
          ea.value,
          '/\/[\w_-]+\.([\w_-]+\.[\w\._-]+)[:/]',
          1
        ),
        -- Fallback to hostname if no subdomain is found
        REGEX_MATCH (ea.value, '/([\w_-]+\.[\w\._-]+)[:/]', 1)
      ) AS subdomain
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN hash ON mdfind.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      LEFT JOIN magic ON mdfind.path = magic.path
      LEFT JOIN signature ON mdfind.path = signature.path
    WHERE
      (
        mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.iso'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.dmg'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.pkg'"
      )
      AND ea.key = 'where_from'
      AND file.btime > (strftime('%s', 'now') -86400)
      AND subdomain NOT IN (
        'adguard.com',
        'adobe.com',
        'akmedia.digidesign.com',
        'alfredapp.com',
        'amazon.com',
        'android.com',
        'ankerwork.com',
        'ankiweb.net',
        'apple.com',
        'arc.net',
        'asana.com',
        'astutegraphics.com',
        'backblazeb2.com',
        'balena.io',
        'balsamiq.com',
        'bblmw.com',
        'bluestacks.com',
        'box.com',
        'boxcdn.net',
        'brave.com',
        'byfly.by',
        'claude.ai',
        'c-wss.com',
        'canon.co.uk',
        'cdn.mozilla.net',
        'charlesproxy.com',
        'chatgpt.com',
        'chime.aws',
        'cloudfront.net',
        'cron.com',
        'csclub.uwaterloo.ca',
        'curseforge.com',
        'descript.com',
        'desktop.evernote.com',
        'digidesign.com',
        'discord.com',
        'discordapp.net',
        'dl.meitu.com',
        'dl.sourceforge.net',
        'docker.com',
        'dogado.de',
        'download.prss.microsoft.com',
        'duckduckgo.com',
        'eclipse.org',
        'emeet.com',
        'epson.com',
        'eventideaudio.com',
        'expensify.com',
        'fcix.net',
        'figma.com',
        'foundry.com',
        'gaomon.net',
        'getutm.app',
        'gimp.org',
        'gitbutler.com',
        'github.io',
        'githubusercontent.com',
        'google.ca',
        'google.com',
        'grammarly.com',
        'granola.ai',
        'imazing.com',
        'integodownload.com',
        'irccloud.com',
        'jetbrains.com',
        'kagi.com',
        'kolide.com',
        'libreoffice.org',
        'live.com',
        'lmstudio.ai',
        'logitech.com',
        'loom.com',
        'macbartender.com',
        'macroplant.com',
        'maxon.net',
        'microsoft.com',
        'minecraft.net',
        'mirrors.serverside.com',
        'mirrorservice.org',
        'mm.cfix.net',
        'mm.fcix.net',
        'mojang.com',
        'mozilla.org',
        'mutedeck.com',
        'mysql.com',
        'notion-static.com',
        'notion.so',
        'notion.com',
        'obvdev.at',
        'ocf.berkeley.edu',
        'office.com',
        'oobesaas.adobe.com',
        'openra.net',
        'oracle.com',
        'osuosl.org',
        'overwolf.com',
        'pathofexile.com',
        'perforce.com',
        'plugable.com',
        'poecdn.com',
        'pqrs.org',
        'proxmox.com',
        'prusa3d.com',
        'raspberrypi.com',
        'reaper.fm',
        'redhat.com',
        'remarkable.com',
        'rewind.ai',
        's3.amazonaws.com',
        'securew2.com',
        'signal.org',
        'siliconmotion.com',
        'skype.com',
        'slack-edge.com',
        'slack.com',
        'stclairsoft.com',
        'steampowered.com',
        'synaptics.com',
        'tableplus.com',
        'talos.dev',
        'teams.cdn.office.net',
        'techsmith.com',
        'tweaknews.eu',
        'ubuntu.com',
        'ultimaker.com',
        'umd.edu',
        'usa.canon.com',
        'uubyte.com',
        'vc.logitech.com',
        'vimcal.com',
        'virtualbox.org',
        'viture.dev',
        'vmware.com',
        'warp.dev',
        'webex.com',
        'whatsapp.com',
        'xtom.com',
        'xx.fbcdn.net',
        'yubico.com',
        'zoo.dev',
        'zoom.us',
        'zoomgov.com',
        'zsa.io'
      )
      -- NOTE: Do not put all of storage.googleapis.com or similarly generic hosts here
      AND host NOT IN (
        'adoptium.net',
        'arc.net',
        'asana.com',
        'awscli.amazonaws.com',
        'balsamiq.com',
        'bearly.ai',
        'blyt.net',
        'brave.com',
        'calibre-ebook.com',
        'chatgpt.com',
        'cron.com',
        'discord.com',
        'dl.discordapp.net',
        'dl.google.com',
        'dl2.discordapp.net',
        'duckduckgo.com',
        'duetdownload.com',
        'dygma.com',
        'emacsformacosx.com',
        'emeet.com',
        'epson.com',
        'evernote.com',
        'fbcdn.net',
        'figma.com',
        'flipperzero.one',
        'fnord.com',
        'getkap.co',
        'gitbutler.com',
        'github.com',
        'go.dev',
        'imazing.com',
        'keybase.io',
        'kittycad.io',
        'krisp.ai',
        'mac.desktop.evernote.com',
        'macroplant.com',
        'mail.google.com',
        'mangoslab.blob.core.windows.net',
        'manual.canon',
        'manytricks.com',
        'maxon.net',
        'mimestream.com',
        'mnvoip.mm.fcix.net',
        'multipass.run',
        'mutedeck.com',
        'muteme.com',
        'new.expensify.com',
        'obdev.at',
        'obsidian.md',
        'obsproject.com',
        'opalcamera.com',
        'openai.com',
        'packages.openvpn.net',
        'persistent.oaistatic.com',
        'plugable.com',
        'plugable.com',
        'portswigger-cdn.net',
        'posit.co',
        'prerelease.keybase.io',
        'presenting.app',
        'proton.me',
        'rancherdesktop.io',
        'rectangleapp.com',
        's3.amazonaws.com',
        'scribehow.com',
        'shottr.cc',
        'sipapp.fra1.digitaloceanspaces.com',
        'sipapp.io',
        'sourceforge.net',
        'sourcegraph.com',
        'stclairsoft.s3.amazonaws.com',
        'store.steampowered.com',
        'superhuman.com',
        'superkey.app',
        'tableplus.com',
        'textexpander.com',
        'tosmediaserver.schwab.com',
        'transmissionbt.com',
        'ubuntu.com',
        'ultimaker.com',
        'universal-blue.discourse.group',
        'us.ankerwork.com',
        'warp-releases.storage.googleapis.com',
        'wavebox.io',
        'welcome.adguard.com',
        'www.google.com',
        'www.granola.ai',
        'www.messenger.com',
        'www.raycast.com',
        'www.talos.dev',
        'zed.dev',
        'zoo.dev',
        'zoom.us'
      )
      -- Yes, these are meant to be fairly broad.
      AND host NOT LIKE '%.cdn.%.com'
      AND host NOT LIKE '%.edu'
      AND host NOT LIKE '%.org'
      AND host NOT LIKE '%.s3.%.amazonaws.com'
      AND host NOT LIKE '%release%.storage.googleapis.com'
      AND host NOT LIKE '%teams.microsoft.com'
      AND host NOT LIKE '%teams.microsoft.us'
      AND host NOT LIKE 'cdn%'
      AND host NOT LIKE 'dl-%'
      AND host NOT LIKE 'dl.%'
      AND host NOT LIKE 'download%'
      AND host NOT LIKE 'driver.%'
      AND host NOT LIKE 'github-production-release-asset-%.s3.amazonaws.com'
      AND host NOT LIKE 'mirror%'
      AND host NOT LIKE 'raycast-releases.%.r2.cloudflarestorage.com'
      AND host NOT LIKE 's3.%.amazonaws.com'
      AND host NOT LIKE 'software%'
      AND host NOT LIKE 'support%'
      AND host NOT LIKE 'www.google.%'
      AND ea.value NOT LIKE 'https://storage.googleapis.com/copilot-mac-releases/%'
      AND ea.value NOT LIKE 'https://storage.googleapis.com/kolide-k2-production-downloads-f414/%'
    GROUP BY
      ea.value
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Unexpected Shell Parent Events"
  description: Unexpected process that spawns shell processes (event-based)
  query: |
    SELECT
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND pe.cmdline != ''
      AND pe.parent > 0
      AND p0_name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
      AND NOT (
        p1_name IN (
          'abrt-handle-eve',
          'alacritty',
          'at-spi-bus-launcher',
          'BambuStudio',
          'bash',
          'build-script-build',
          'chainctl',
          'chezmoi',
          'clang-11',
          'Code - Insiders Helper (Renderer)',
          'Code Helper (Renderer)',
          'code',
          'collect2',
          'com.docker.backend',
          'conmon',
          'containerd-shim-runc-v2',
          'containerd-shim',
          'cpptools',
          'dash',
          'dbus-run-session',
          'demoit',
          'direnv',
          'doas',
          'Docker Desktop',
          'docker-credential-desktop',
          'docker-credential-gcr',
          'docker',
          'dotnet',
          'dpkg',
          'Emacs-arm64-11',
          'env',
          'erl_child_setup',
          'find',
          'FinderSyncExtension',
          'fish',
          'gatherheaderdoc',
          'gdm-session-worker',
          'gdm-wayland-session',
          'gdm-x-session',
          'gdm3',
          'git',
          'gke-gcloud-auth-plugin',
          'gnome-session-binary',
          'gnome-shell',
          'gnome-terminal-server',
          'go',
          'goland',
          'gopls',
          'helm',
          'HP Diagnose & Fix',
          'i3bar',
          'i3blocks',
          'idea',
          'java',
          'jetbrains-toolbox',
          'kitty',
          'ko',
          'konsole',
          'kubectl',
          'lazygit',
          'lightdm',
          'local-path-provisioner',
          'login',
          'MacVim',
          'make',
          'mc',
          'monorail',
          'my_print_defaults',
          'ninja',
          'nix-build',
          'nix-daemon',
          'nix',
          'nm-dispatcher',
          'node',
          'nu',
          'nvim',
          'obs',
          'package_script_service',
          'pacman',
          'perl',
          'PK-Backend',
          'provisio',
          'pulumi',
          -- 'python' - do not include this, or you won't detect supply-chain attacks.
          'ression-arm64',
          'roxterm',
          'sddm-helper',
          'sdk',
          'sdzoomplugin',
          'sh',
          'ShellLauncher',
          'skhd',
          'snyk-macos',
          'snyk',
          'sshd',
          'stable',
          'Stream Deck',
          'su',
          'sudo',
          'swift',
          'systemd-sleep',
          'systemd',
          'terminator',
          'terraform-ls',
          'terraform',
          'test2json',
          'tmux:server',
          'tmux',
          'update-notifier',
          'vi',
          'vim.nox',
          'vim',
          'Vim',
          'watch',
          'wezterm-gui',
          'xargs',
          'xcrun',
          'xfce4-terminal',
          'xinit',
          'Xorg',
          'xterm',
          'yacls',
          'yay',
          'yum',
          'zed',
          'zellij',
          'zsh'
        )
        OR p1_name LIKE 'terraform-provider-%'
        OR p1_name LIKE 'iTermServer-%'
        -- Do not add shells to this list if you want your query to detect
        -- bad programs that were started from a shell.
        OR p2_name IN ('env', 'git')
        -- Homebrew, except we don't want to allow all of ruby
        OR p0_cmd IN (
          '/bin/bash /usr/bin/xdg-settings set default-url-scheme-handler slack Slack.desktop',
          '/bin/bash /usr/local/bin/mount-product-files',
          '/bin/sh -c black .',
          '/bin/sh -c ioreg -rd1 -c IOPlatformExpertDevice',
          '/bin/sh -c lsb_release -a --short',
          '/bin/sh -c ps ax -ww -o pid,ppid,uid,gid,args',
          '/bin/sh -c scutil --get ComputerName',
          '/bin/sh -c sysctl hw.model kern.osrelease',
          '/bin/sh -c uname -m 2>/dev/null',
          '/bin/sh /usr/bin/lsb_release -a --short',
          '/bin/sh /usr/bin/lsb_release -a',
          '/bin/zsh -c ls',
          '/usr/bin/python3 /usr/bin/terminator',
          'sh -c /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -find python3 2> /dev/null',
          'sh -c /bin/stty size 2>/dev/null',
          'sh -c /usr/bin/xcrun clang 2>&1',
          'sh -c cat /proc/sys/kernel/pid_max',
          'sh -c pactl --version',
          'sh -c python3.7 --version 2>&1',
          'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path 2>/dev/null',
          "/bin/sh -c defaults delete 'com.cisco.webexmeetingsapp'",
          "sh -c osascript -e 'user locale of (get system info)'",
          "sh -c pacmd list-sinks |grep 'name:\|module:'"
        )
        OR (
          p1_name = 'WhatsApp'
          -- WhatsApp grabs the serial number from people's machines :(
          AND p0_cmd = '/bin/sh -c ioreg -c IOPlatformExpertDevice -d 2'
        )
        OR (
          p1_name LIKE 'emacs-%'
          AND p1_path LIKE '%/bin/emacs%'
        )
        OR p1_cmd IN (
          '/usr/bin/python3 /usr/share/apport/apport-gtk',
          'php ./autodocs update images'
        )
        OR (
          p1_cmd LIKE '%Python% /opt/homebrew/bin/jupyter%'
          AND p0_cmd = '/bin/sh -c osascript'
        )
        OR (
          p1_name = 'osqueryd'
          AND p0_cmd LIKE '/bin/sh /etc/NetworkManager/dispatcher.d/%'
        )
        OR (
          p1_name = 'ssh'
          AND p0_cmd LIKE '%gcloud.py compute start-iap-tunnel%'
        )
        OR exception_key IN (
          'bash,0,auditd,launchd',
          'bash,0,etcd,containerd-shim-runc-v2',
          'bash,0,kube-apiserver,containerd-shim-runc-v2',
          'bash,0,mutter-x11-frames,gnome-shell',
          'bash,0,perl5.30,system_installd',
          'bash,0,pia-daemon,launchd',
          'bash,0,udevadm,udevadm',
          'bash,500,.man-wrapped,zsh',
          'bash,500,accounts-daemon,systemd',
          'bash,500,busybox,bwrap',
          'bash,500,bwrap,bwrap',
          'bash,500,com.docker.dev-envs,com.docker.backend',
          'bash,500,docker-builder,bash',
          'bash,500,Foxit PDF Reader,launchd',
          'bash,500,gdb,perl',
          'bash,500,gnome-session-binary,systemd',
          'bash,500,gpg-agent,launchd',
          'bash,500,Hyprland,gdm-wayland-session',
          'bash,500,incusd,incusd',
          'bash,500,lazygit,nvim',
          'bash,500,plasmashell,systemd',
          'bash,500,Private Internet Access,launchd',
          'bash,500,ruby,zsh',
          'bash,500,screen,screen',
          'bash,500,script,bash',
          'bash,500,steam,bash',
          'bash,500,xdg-desktop-portal,systemd',
          'bash,500,xdg-permission-store,systemd',
          'dash,0,anacron,systemd',
          'dash,0,dpkg,apt',
          'dash,0,dpkg,python3.10',
          'dash,0,kindnetd,containerd-shim-runc-v2',
          'dash,0,kube-proxy,containerd-shim-runc-v2',
          'dash,0,run-parts,dash',
          'dash,0,snapd,systemd',
          'dash,500,gdm-wayland-session,gdm-session-worker',
          'dash,500,python3.12,firefox-bin',
          'sh,0,auditd,launchd',
          'sh,0,Ecamm Live,launchd',
          'sh,0,expect,kandji-daemon',
          'sh,500,cloud_sql_proxy,zsh',
          'sh,500,docs,zsh',
          'sh,500,Google Drive,launchd',
          'sh,500,LogiTune,launchd',
          'sh,500,Meeting Center,launchd',
          'sh,500,snyk-macos,snyk',
          'sh,500,splunkd,splunkd',
          'sh,500,ssh,Code Helper (Plugin)',
          'sh,500,ssh,mosh-client',
          'sh,500,updater,Foxit PDF Reader',
          'sh,500,viddy,zsh',
          'sh,500,yabai,launchd',
          'zsh,500,Hyper,launchd',
          'zsh,500,old,launchd',
          'zsh,500,old,old',
          'zsh,500,OpenLens,launchd',
          'zsh,500,pycharm,launchd',
          'zsh,500,python3.10,gnome-shell',
          'zsh,500,rubymine,launchd',
          'zsh,500,stable,launchd'
        )
        OR p0_cmd LIKE '/bin/bash /Users/%/homebrew/Library/Homebrew/shims/shared/curl %'
        OR p0_cmd LIKE '/bin/bash /usr/bin/xdg-settings check %'
        OR p0_cmd LIKE '/bin/bash /usr/local/Homebrew/%'
        OR p0_cmd LIKE '/bin/bash %/opt/homebrew/%'
        OR p0_cmd LIKE '/bin/bash %git credential-osxkeychain get'
        OR p0_cmd LIKE '/bin/sh -c /Applications/%'
        OR p0_cmd LIKE '/bin/sh -c pkg-config %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-open %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings check %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings get %'
        OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings set %'
        OR p0_cmd LIKE '/bin/sh %/bin/gcloud%config config-helper%'
        OR p0_cmd LIKE '/bin/sh %/bin/xvim block %'
        OR p0_cmd LIKE '/bin/sh %/docker-credential-gcloud get'
        OR p0_cmd LIKE '/bin/sh %/google-cloud-sdk/bin/gcloud config get project'
        OR p0_cmd LIKE '%/bash -e%/bin/as -arch%'
        OR p0_cmd LIKE '%/google-chrome% --flag-switches-begin % --product-version'
        OR p0_cmd LIKE '%/usr/bin/python3 /usr/bin/terminator%'
        OR p0_cmd LIKE '%gcloud config config-helper --format=json'
        OR p0_cmd LIKE '%gcloud config get-value%'
        OR p0_cmd LIKE '%sh -c ntia-checker %'
        OR p1_cmd LIKE '/%google-cloud-sdk/lib/gcloud.py%'
        OR p1_cmd LIKE '/System/Library/Frameworks/Ruby.framework/Versions/2.6/usr/bin/ruby -W1 --disable=gems,rubyopt -- /Users/%/homebrew/Library/Homebrew/build.rb%'
        OR p1_cmd LIKE '%/bin/pipenv shell'
        OR p1_cmd LIKE '%/usr/bin/terminator%'
        OR p1_cmd LIKE 'gcloud% auth%login%'
        OR (
          exception_key IN ('sh,500,ruby,zsh', 'bash,500,ruby,zsh')
          AND p1_cmd LIKE '%brew.rb'
        )
        OR (
          exception_key = 'sh,500,ruby,ruby'
          AND p1_cmd LIKE '%homebrew%'
        )
        OR p1_cmd LIKE '%Python /opt/homebrew/bin/aws configure sso'
        OR p2_cmd LIKE '/bin/bash /usr/local/bin/brew%'
        OR p2_cmd LIKE '/usr/bin/python3 -m py_compile %'
      )
      AND NOT p0_cgroup LIKE '/system.slice/docker-%'
      AND NOT p1_cgroup LIKE '/system.slice/docker-%'
      AND NOT p2_cgroup LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Unexpected Shell Parents"
  description: Unexpected process that spawns shell processes (event based)
  query: |
    SELECT
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.name IN ('sh', 'fish', 'zsh', 'bash', 'dash')
      -- Ignore partial table joins
      AND p1_path != ''
      -- Editors & terminals mostly.
      -- I know it's tempting to list "electron" here but please find a more specific exclusion.
      AND p1.name NOT IN (
        'abrt-action-per',
        'abrt-handle-eve',
        'AGSService',
        'alacritty',
        'Alfred',
        'anacron',
        'arduino-cli',
        'auditd',
        'bash',
        'build-script-build',
        'buildkit-runc',
        'chezmoi',
        'clang-11',
        'Code - Insiders Helper (Renderer)',
        'Code - Insiders Helper',
        'Code Helper (Renderer)',
        'code',
        'collect2',
        'com.docker.back',
        'configure',
        'conmon',
        'containerd-shim',
        'Core Sync',
        'Cursor Helper',
        'Cursor',
        'dash',
        'demoit',
        'direnv',
        'dnf',
        'dnf-automatic',
        'doas',
        'Docker Desktop',
        'dumb-init',
        'elastic-security',
        'erl_child_setup',
        'find',
        'FinderSyncExtension',
        'fish',
        'i3',
        'flock',
        'gdm-wayland-ses',
        'gephi',
        'git',
        'git-remote-http',
        'git-remote-https',
        'GitKraken Helper (Renderer)',
        'gnome-session-b',
        'gnome-shell',
        'go',
        'goland',
        'GoogleSoftwareUpdateAgent',
        'GoogleUpdater',
        'gopls',
        'gosec',
        'helm',
        'Hyper',
        'i3bar',
        'i3blocks',
        'idea',
        'incusd',
        'inittool2',
        'java',
        'jetbrains_client',
        'just',
        'kandji-library-manager',
        'kitty',
        'ko',
        'konsole',
        'kubectl',
        'kue',
        'ld',
        'lightdm',
        'linux-sandbox',
        'LogiMgrDaemon',
        'LogiTune',
        'logrotate',
        'MacVim',
        'make',
        'Microsoft.VisualStudio.Reliability.Monitor',
        'monorail',
        'newgrp',
        'ninja',
        'nix',
        'nix-build',
        'nix-daemon',
        'node',
        'nu',
        'nvim',
        'OpenLens',
        'package_script_service',
        'pacman',
        'perl',
        'pia-daemon',
        'PK-Backend',
        'provisio',
        'ptyxis-agent',
        'pycharm',
        'qcalc',
        'Rancher Desktop',
        'roxterm',
        'rpmbuild',
        'Runner.Listener',
        'Runner.Worker',
        'screen',
        'sdk',
        'sdzoomplugin',
        'sh',
        'skhd',
        'ssh',
        'sshd',
        'sshd-session',
        'steam_osx',
        'swift',
        'systemd',
        'terminator',
        'terraform',
        'terraform-provi',
        'test2json',
        'timeout',
        'tmux',
        'tmux:server',
        'udev-worker',
        'unattended-upgr',
        'update-notifier',
        'vi',
        'vim',
        'vim-nox11',
        'VisualStudio',
        'watch',
        'waybar',
        'wezterm-gui',
        'xargs',
        'xcrun',
        'xfce4-session',
        'xfce4-terminal',
        'yum',
        'zed-editor',
        'zellij',
        'zsh'
      )
      AND p1_path NOT LIKE '/Applications/%.app/Contents/MacOS/%'
      AND p1_path NOT IN (
        '/Applications/Alfred 5.app/Contents/Preferences/Alfred Preferences.app/Contents/MacOS/Alfred Preferences',
        '/Applications/Amazon Photos.app/Contents/MacOS/Amazon Photos',
        '/Applications/DDPM/DDPM.app/Contents/MacOS/DDPM',
        '/Applications/Docker.app/Contents/MacOS/Docker',
        '/Applications/Docker.app/Contents/MacOS/install',
        '/Applications/Docker.app/Contents/Resources/bin/com.docker.cli',
        '/Applications/Docker.app/Contents/Resources/bin/docker-credential-desktop',
        '/Applications/Hyper.app/Contents/MacOS/Hyper',
        '/Applications/IntelliJ IDEA.app/Contents/MacOS/idea',
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/Applications/Parallels Desktop.app/Contents/MacOS/prl_update_helper',
        '/Applications/RStudio.app/Contents/Resources/app/bin/rsession-arm64',
        '/Applications/Visual Studio Code.app/Contents/MacOS/Electron',
        '/bin/dash',
        '/bin/sh',
        '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS/logioptionsplus_agent',
        '/Library/Developer/CommandLineTools/usr/bin/git',
        '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateDaemon',
        '/Library/Kandji/Kandji Agent.app/Contents/Helpers/Kandji Library Manager.app/Contents/MacOS/kandji-library-manager',
        '/Library/Kandji/Kandji Agent.app/Contents/MacOS/kandji-library-manager',
        '/opt/X11/libexec/launchd_startx',
        '/sbin/launchd',
        '/System/Library/Frameworks/Security.framework/authtrampoline',
        '/usr/bin/alacritty',
        '/usr/bin/apt-get',
        '/usr/bin/apt',
        '/usr/bin/bash',
        '/usr/bin/bwrap',
        '/usr/bin/crond',
        '/usr/bin/dash',
        '/usr/bin/dirname',
        '/usr/bin/less',
        '/usr/bin/login',
        '/usr/bin/make',
        '/usr/bin/man',
        '/usr/bin/networksetup',
        '/usr/bin/perl',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/sysdiagnose',
        '/usr/bin/xargs',
        '/usr/bin/zsh',
        '/usr/lib/xorg/Xorg',
        '/usr/libexec/gdm-x-session',
        '/usr/libexec/gnome-terminal-server',
        '/usr/libexec/periodic-wrapper',
        '/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent',
        '/usr/sbin/networksetup'
      )
      AND NOT p0.cmdline IN (
        -- npm run server
        'sh -c -- exec-bin node_modules/.bin/hugo/hugo server',
        'sh -c /usr/bin/defaults write us.zoom.xos NSQuitAlwaysKeepsWindows -bool false',
        '/bin/sh -c ioreg -rd1 -c IOPlatformExpertDevice',
        '/bin/sh -c system_profiler SPDisplaysDataType | grep "Chipset Model"',
        '/usr/bin/python3 /usr/bin/terminator',
        'sh -c echo zoomMute:disabled,zoomVideo:disabled,zoomStatus:closed,zoomShare:disabled,zoomRecord:disabled',
        '/bin/sh -c sysctl hw.model kern.osrelease',
        '/bin/sh /etc/security/audit_warn soft /var/audit',
        'sh -c hugo-installer --version otherDependencies.hugo --extended --destination node_modules/.bin/hugo',
        '/bin/bash -c ioreg -l -w 0 | grep SecureInput',
        "sh -c acpi -b | grep -v 'unavailable'",
        'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path 2>/dev/null',
        -- Brother printer
        'sh -c ps -xcocommand,pid | grep "LOGINserver"'
      )
      AND NOT (
        p1.name = 'sshd'
        AND p0.cmdline LIKE '%askpass%'
      )
      AND NOT (
        p1.name = '(udev-worker)'
        AND p0.cmdline LIKE '/bin/sh -c echo % > /sys/bus/usb/drivers/brcmfmac/new_id'
      )
      AND NOT (
        p1.name = 'steam'
        AND p0.cmdline LIKE 'sh -c %steamwebhelper.sh%'
      )
      AND NOT (
        p1.name = 'bash'
        AND p0.cmdline LIKE 'sh -s _hostname %'
      )
      AND NOT (
        p1.cmdline LIKE 'perl%/help2man%'
        AND p0.cmdline LIKE 'sh -c man/%'
      )
      AND NOT p0.cmdline LIKE '/bin/sh %/bin/docker-credential-gcloud get'
      AND NOT p1_path LIKE '/private/var/folders/%/T/go-build%.test'
      AND NOT p1_path LIKE '/Users/%/.vscode/extensions/stateful.runme-%/bin/runme'
      AND NOT p1_path LIKE '/private/tmp/PKInstallSandbox.%/tmp/Python/Python3.framework/Versions/%/Resources/Python.app/Contents/MacOS/Python'
      AND NOT p0.cmdline LIKE '%/Library/Apple/System/Library/InstallerSandboxes%'
      AND NOT p0.cmdline LIKE '%gcloud config config-helper%'
      AND NOT p0.cmdline LIKE '%hugo/hugo server%'
      AND NOT p1.cmdline LIKE '%/bin/pytest %'
      AND NOT p0.cmdline LIKE '%/bin/codeclimate %'
      AND NOT p0.cmdline LIKE '%/ChromeRecovery --browser-version=%'
      AND NOT p1.cmdline LIKE '/Applications/Warp.app/%'
      AND NOT p1.cmdline IN ('npm run start', 'npm install')
      AND NOT p1.cmdline LIKE '%brew.rb%'
      AND NOT p1.cmdline LIKE '%/Homebrew/build.rb%'
      AND NOT p1.cmdline LIKE '%Code Helper%'
      AND NOT p1.cmdline LIKE '%Code - Insiders Helper%'
      AND NOT p1.cmdline LIKE '%gcloud.py config config-helper%'
      AND NOT p1.cmdline LIKE '/usr/lib/electron19/electron /usr/lib/code/out/bootstrap-fork --type=ptyHost --logsPath /home/%/.config/Code - OSS/logs/%'
      AND NOT p1.name LIKE '%term%'
      AND NOT p1.name LIKE '%Term%'
      AND NOT p1.name LIKE 'Emacs%'
      AND NOT p1.name LIKE 'terraform-prov%'
      AND NOT p1.path LIKE '/Users/%/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS/GoogleSoftwareUpdateAgent'
      -- Oh, NixOS.
      AND NOT p1.name LIKE '%/bin/bash'
      AND NOT p1.name LIKE '%/bin/direnv'
      AND NOT p1_path LIKE '/nix/store/%sh'
      AND NOT p1_path LIKE '/opt/homebrew/%'
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p0.cgroup_path LIKE '/system.slice/system.slice:docker:%'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Unexpected Webmail Downloads"
  description: Surface webmail downloads of an unexpected sort
  query: |
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      s.authority,
      s.identifier,
      LOWER(
        REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1)
      ) AS extension
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN signature s ON file.path = s.path
    WHERE
      mdfind.query = 'kMDItemWhereFroms == ''*https://mail.google.com/*'''
      AND file.btime > (strftime('%s', 'now') -86400)
      -- Extensions that would not normally raise suspicion if sent by e-mail (excludes dmg, iso, lnk, exe)
      AND extension NOT IN (
        'ai',
        'avi',
        'cer',
        'csv',
        'doc',
        'Dockerfile',
        'docx',
        'dwg',
        'eml',
        'eps',
        'gif',
        'heic',
        'htm',
        'html',
        'icloud',
        'itermexport',
        'jfif',
        'jpeg',
        'jpg',
        'json',
        'key',
        'loaded_0',
        'loaded_1',
        'md',
        'mov',
        'mp3',
        'mp4',
        'mpeg',
        'mpg',
        'msg',
        'numbers',
        'ods',
        'odt',
        'pages',
        'pdf',
        'pem',
        'pgp',
        'pkpass',
        'png',
        'potx',
        'ppt',
        'pptx',
        'pub',
        'rtf',
        'svg',
        'tf',
        'tif',
        'tiff',
        'txt',
        'wav',
        'webp',
        'xls',
        'xlsb',
        'xlsm',
        'xlsx',
        'xml',
        'yaml',
        'yml',
        'zip'
      )
      AND file.path NOT LIKE '%/Dockerfile'
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Sketchy Download Name"
  description: Look for sketchy download files based on keywords
  query: |
    SELECT
      file.filename,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS extension,
      magic.data,
      hash.sha256,
      ea.value AS download_url,
      signature.authority AS s_auth,
      signature.identifier AS s_id
    FROM
      file
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN extended_attributes ea ON file.path = ea.path
      AND ea.key = "where_from"
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      file.path LIKE "/Users/%/Downloads/%"
      -- Frequently targetted extension for InfoStealer attacks
      AND extension IN ('dmg', 'exe', 'pkg', 'rar')
      AND (
        file.filename LIKE "%.app%"
        OR file.filename LIKE "%Adobe Photoshop%"
        OR file.filename LIKE "%Advertising%"
        OR file.filename LIKE "%agreement%"
        OR file.filename LIKE "%animated%"
        OR file.filename LIKE "%Brief%"
        OR file.filename LIKE "%confidential%"
        OR file.filename LIKE "%confidentiality%"
        OR file.filename LIKE "%conract%"
        OR file.filename LIKE "%contract%"
        OR file.filename LIKE "%cover%"
        OR file.filename LIKE "%crack%"
        OR file.filename LIKE "%curriculum%"
        OR file.filename LIKE "%cv"
        OR file.filename LIKE "%description%"
        OR file.filename LIKE "%Flash%"
        OR file.filename LIKE "%freyavr%"
        OR file.filename LIKE "%game%"
        OR file.filename LIKE "%immediate%"
        OR file.filename LIKE "%logos%"
        OR file.filename LIKE "%official%"
        OR file.filename LIKE "%pdf%"
        OR file.filename LIKE "%Player%"
        OR file.filename LIKE "%poster%"
        OR file.filename LIKE "%presentation%"
        OR file.filename LIKE "%receipt%"
        OR file.filename LIKE "%reference%"
        OR file.filename LIKE "%resume%"
        OR file.filename LIKE "%secret%"
        OR file.filename LIKE "%terms%"
        OR file.filename LIKE "%trading%"
        OR file.filename LIKE "%Update%"
        OR file.filename LIKE "%weed%"
        OR file.filename LIKE "cv%"
      )
      -- False positives
      AND NOT (
        file.filename = "googlesoftwareupdate.dmg"
        OR file.filename LIKE 'CalDigit_%_PD_Firmware_Updater_v%_Mac.dmg'
        OR file.filename LIKE 'PA Lottery Player Location Check%.dmg'
        OR file.filename LIKE 'TS%-Thunderbolt-Firmware-Updater-Uninstaller.dmg'
        OR file.filename LIKE "%MacVim%.dmg"
        OR file.filename LIKE "LogiPresentation%.dmg"
        OR file.filename LIKE "pdftk_server-%-win-setup.exe"
        OR file.filename LIKE "PioneerDriveUpdaterBDR%.dmg"
      )
      -- Likely-safe download sources
      AND NOT (
        download_url LIKE 'https://definitionupdates.microsoft.com/%' -- https://learn.microsoft.com/en-us/windows/privacy/manage-windows-11-endpoints#:~:text=TLSv1.2-,definitionupdates,-.microsoft.com
        OR download_url LIKE 'https://myaccount.draftkings.com/%'
        OR download_url LIKE 'https://prod-downloads.geocomply.com/%'
        OR download_url LIKE 'https://%.bose.com/%'
      )
    GROUP BY
      file.filename
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Sketchy Mounted Diskimage"
  description: Look for sketchy mounted disk images, inspired by Shlayer
  query: |
    SELECT
      RTRIM(file.path, '/') AS f,
      file.bsd_flags AS f_flags,
      file.gid AS f_gid,
      file.mode AS f_mode,
      file.size AS f_size,
      file.type AS f_type,
      REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS f_ext,
      file.uid AS f_uid,
      hash.sha256 AS f_sha256,
      magic.data AS f_data,
      mdfind.path AS probable_source,
      mdhash.sha256 AS probable_source_sha256,
      ea.value AS probable_url,
      REGEX_MATCH (file.path, '/Volumes/(.*?)/', 1) AS vol_name,
      signature.authority AS s_auth,
      signature.identifier AS s_id
    FROM
      file
      LEFT JOIN mdfind ON mdfind.query = "kMDItemFSName == '*" || REGEX_MATCH (file.path, '/Volumes/(\w+)', 1) || "*.dmg'"
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = 'where_from'
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN hash mdhash ON mdfind.path = mdhash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      file.path IN (
        SELECT DISTINCT
          file.path
        FROM
          block_devices
          JOIN mounts ON mounts.device = block_devices.name
          JOIN file ON file.directory = mounts.path
          OR file.directory LIKE mounts.path || "/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%.app/Contents/Resources/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Library/LaunchServices"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/MacOS/"
          OR file.directory LIKE mounts.path || "/%/%.app/Contents/Resources/"
        WHERE
          model = 'Disk Image'
          AND parent != ""
          AND mounts.path LIKE "/Volumes/%"
          -- osquery will traverse symlinks, this prevents following symlinks to /Applications (poorly)
          AND file.path NOT LIKE "/Volumes/%/Applications/%"
          AND file.path NOT LIKE "/Volumes/%/ /%"
          AND NOT (
            file.type != "regular"
            AND file.directory LIKE '%/Contents/Resources/'
          )
      )
      AND (
        --   Rule 0. App binaries that are hidden, like WnBJLaF/1302.app/Contents/MacOS/1302 (1302.app)
        (
          file.directory LIKE '/Volumes/%/Contents/MacOS'
          AND file.bsd_flags = "HIDDEN"
        ) --   Rule 1. App binaries that are a thin shell script wrapper for another resource (Player_009.app, 1302.app)
        OR (
          file.directory LIKE '/Volumes/%/Contents/MacOS'
          AND file.mode LIKE "%7%"
          AND file.type != 'directory'
          AND magic.data LIKE '%script%'
          AND signature.identifier != 'net.snowflake.snowsql'
          AND signature.authority NOT IN (
            'Developer ID Application: Allen Bai (97DN42T837)',
            'Developer ID Application: BlueStack Systems, Inc. (QX5T8D6EDU)',
            'Developer ID Application: Galvanix (5BRAQAFB8B)'
          )
          AND vol_name NOT LIKE 'BBEdit%'
        ) -- Rule 2. App binaries that have mixed-caps names such as LYwjtu0sc3XqkNVbQe_gM4YiRpmgUpRIew or yWnBJLaF (AdobeFlashPlayer_567.app)
        OR (
          file.mode LIKE "%7%"
          AND file.type != 'directory'
          AND REGEX_MATCH (file.filename, '([a-z]+[A-Z][A-Z]+[a-z]+)', 1) != ""
          AND magic.data LIKE "%executable%"
          -- Some people do weird things!
          AND signature.authority NOT IN (
            'Software Signing',
            'Developer ID Application: Atlassian Pty Ltd (UPXU4CQZ5P)',
            'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
            'Developer ID Application: MacroMates Ltd. (45TL96F76G)',
            'Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)'
          )
        ) -- Rule 3. App binaries with a numerical name, such as 2829030009 (Player_009.app)
        OR (
          file.mode LIKE "%7%"
          AND file.type != 'directory'
          AND REGEX_MATCH (file.filename, '^(\d)+$', 1) != ""
        ) --   4. App resources that are Mach-O binaries, such as 2829030009, or enc (Player_009.app, AdobeFlashPlayer_567.app)
        OR (
          file.directory LIKE '/Volumes/%/Resources'
          AND magic.data LIKE '%executable%'
          AND f_ext NOT IN ('py', 'sh', 'metallib', 'js')
        ) --   5. Volumes with a name containing suspicious names: Player, Flash, Update
        OR (
          (
            vol_name LIKE "Install%"
            -- The rest are synced with sketchy-download-names
            OR vol_name LIKE "%.app%"
            OR vol_name LIKE "%Advertising%"
            OR vol_name LIKE "%agreement%"
            OR vol_name LIKE "%animated%"
            OR vol_name LIKE "%AnyDesk%"
            OR vol_name LIKE "%Brief%"
            OR vol_name LIKE "%confidential%"
            OR vol_name LIKE "%confidentiality%"
            OR vol_name LIKE "%conract%"
            OR vol_name LIKE "%contract%"
            OR vol_name LIKE "%cover%"
            OR vol_name LIKE "%crack%"
            OR vol_name LIKE "%curriculum%"
            OR vol_name LIKE "%cv"
            OR vol_name LIKE "%description%"
            OR vol_name LIKE "%Flash%"
            OR vol_name LIKE "%freyavr%"
            OR vol_name LIKE "%game%"
            OR vol_name LIKE "%immediate%"
            OR vol_name LIKE "%logos%"
            OR vol_name LIKE "%official%"
            OR vol_name LIKE "%pdf%"
            OR vol_name LIKE "%Player%"
            OR vol_name LIKE "%poster%"
            OR vol_name LIKE "%presentation%"
            OR vol_name LIKE "%receipt%"
            OR vol_name LIKE "%reference%"
            OR vol_name LIKE "%resume%"
            OR vol_name LIKE "%secret%"
            OR vol_name LIKE "%terms%"
            OR vol_name LIKE "%trading%"
            OR vol_name LIKE "%Update%"
            OR vol_name LIKE "%weed%"
            OR vol_name LIKE "cv%"
          )
          AND file.directory LIKE "/Volumes/%/Contents/MacOS"
          AND signature.authority NOT IN (
            "Developer ID Application: Bookry Ltd (4259LE8SU5)",
            "Developer ID Application: Bose Corporation (QC9P7FKWH6)",
            "Developer ID Application: Cisco (DE8Y96K9QP)",
            "Developer ID Application: Geocomply USA, Inc. (6YPTSWJK4P)",
            "Developer ID Application: Google LLC (EQHXZ8M8AV)",
            "Developer ID Application: Justin Clift (C34AV33YLK)",
            "Developer ID Application: Logitech Inc. (QED4VVPZWA)",
            "Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)",
            "Developer ID Application: Oracle America, Inc. (VB5E2TV963)",
            "Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)",
            "Developer ID Application: Roblox Corporation (2CFABCH843)",
            "Developer ID Application: VideoLAN (75GAHG3SZQ)"
          )
        ) --   6. Volumes containing a hidden top-level folder or binary, such as yWnBJLaF (1302.app)
        OR (
          file.bsd_flags = "HIDDEN"
          AND (
            file.mode LIKE "%7%"
            OR file.mode LIKE "%5%"
            OR file.mode LIKE "%1%"
          )
          AND file.filename NOT IN (
            '.background',
            '.TemporaryItems',
            '.Trashes',
            '.VolumeIcon.icns'
          )
          -- Brother Printer Utilities
          AND f != '/Volumes/brotherwdswML_nonPanel/MacResources'
          AND file.filename NOT LIKE '%.previous'
          AND file.filename NOT LIKE '%.interrupted'
          AND signature.authority != 'Developer ID Application: Google LLC (EQHXZ8M8AV)'
          AND file.filename NOT LIKE '%.backup'
        ) --   7. Volumes containing a top-level symlink to something other than /Applications, such as yWnBJLaF (1302.app)
        OR (
          file.symlink = 1
          AND magic.data NOT IN (
            '/Library/Application Support/Apple/Safari/SafariForWebKitDevelopment',
            'symbolic link to ../Resources/public',
            'symbolic link to .',
            'symbolic link to /Applications',
            'symbolic link to /Applications/',
            'symbolic link to steam_osx'
          )
          -- emacs
          AND magic.data NOT LIKE 'symbolic link to bin-x86%'
          AND magic.data NOT LIKE 'symbolic link to /Users/%/My Drive'
          -- Docker
          AND magic.data NOT LIKE 'cannot open%'
        )
      )
    GROUP BY
      file.path;
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Unexpected Diskimage Name Macos"
  description: Surface ISO/DMG disk images that have suspicious names
  query: |
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      signature.identifier,
      signature.authority,
      ea.value AS url,
      REGEX_MATCH (ea.value, '/[\w_-]+\.([\w\._-]+)[:/]', 1) AS domain,
      REGEX_MATCH (ea.value, '/([\w_-]+\.[\w\._-]+)[:/]', 1) AS host
    FROM
      mdfind
      LEFT JOIN file ON mdfind.path = file.path
      LEFT JOIN hash ON mdfind.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      LEFT JOIN magic ON mdfind.path = magic.path
      LEFT JOIN signature ON mdfind.path = signature.path
    WHERE
      (
        mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.iso'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.dmg'"
        OR mdfind.query = "kMDItemWhereFroms != '' && kMDItemFSName == '*.pkg'"
      )
      AND ea.key = 'where_from'
      AND file.btime > (strftime('%s', 'now') -86400)
      AND (
        file.filename LIKE 'Installer.%'
        OR file.filename LIKE '%Player.%'
        OR file.filename LIKE '% AIR %'
        OR file.filename LIKE '%Flash%'
        OR file.filename LIKE '%Resume%'
      )
    GROUP BY
      ea.value
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Unexpected Volume Contents"
  description: Scan removable volumes for sketchy files
  query: |
    SELECT
      RTRIM(file.path, '/') AS trimpath,
      uid,
      filename,
      gid,
      mode,
      REGEX_MATCH (file.path, '(.*)/', 1) AS dirname,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*/(.*?)$', 1) AS basename,
      REGEX_MATCH (RTRIM(file.path, '/'), '.*\.(.*?)$', 1) AS extension,
      mtime,
      ctime,
      symlink,
      type,
      size,
      hash.sha256,
      magic.data,
      signature.identifier,
      signature.authority
    FROM
      file
      LEFT JOIN hash on file.path = hash.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN signature ON file.path = signature.path
    WHERE
      (
        file.path LIKE '/Volumes/%/%'
        OR file.path LIKE '/Volumes/%/.%'
      )
      AND file.path NOT LIKE '/Volumes/Macintosh HD%'
      AND file.path NOT LIKE '/Volumes/%/.com.apple.timemachine%'
      AND (
        extension IN (
          'command',
          'dmg',
          'gcode',
          'gz',
          'iso',
          'lnk',
          'mpkg',
          'pkg',
          'scpt',
          'sh',
          'sql'
        )
        OR file.symlink != 0
        OR basename LIKE '.%'
        OR basename LIKE '%.sql%'
        OR basename LIKE '%Chrome%'
        OR basename LIKE '%enforce%'
        OR basename LIKE '%Extension%'
        OR basename LIKE '%guard%'
        OR basename LIKE '%hidden%'
        OR basename LIKE '%Installer%'
        OR basename LIKE '%mono%'
        OR basename LIKE '%secret%'
        OR basename LIKE '%sql%'
        OR basename LIKE 'cg%'
      ) -- exceptions go here
      AND basename NOT IN (
        '.',
        '..',
        '._.apdisk',
        '._.TemporaryItems',
        '._.Trashes',
        '._AUTORUN.INF',
        '._Id.txt',
        '.actrc',
        '.angular-config.json',
        '.apdisk',
        '.background',
        '.background.png',
        '.background.tiff',
        '.bash_history',
        '.bashrc',
        '.CFUserTextEncoding',
        '.dbshell',
        '.disk_label',
        '.disk_label_2x',
        '.DS_Store',
        '.file',
        '.file-revisions-by-id',
        '.flyrc',
        '.gitconfig',
        '.iotest',
        '.keystone_install',
        '.lesshst',
        '.metadata_never_index_unless_rootfs',
        '.mysql_history',
        '.pdfbox.cache',
        '.shortcut-targets-by-id',
        '.TemporaryItems',
        '.Trashes',
        '.vol',
        '.VolumeIcon.icns',
        '.zsh_history',
        'GTechnologyFormatWizard_Installer.msi',
        'KBFS_NOT_RUNNING',
        'LogiPresentation Installer.app',
        'pve-installer.squashfs',
        'Seagate Dashboard Installer.exe',
        'UFRII_LT_LIPS_LX_Installer.pkg'
      )
      AND authority NOT IN (
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: BlueStack Systems, Inc. (QX5T8D6EDU)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: Cisco (DE8Y96K9QP)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Martijn Smit (GX645XXEAX)'
      ) -- Unsigned programs here
      AND trimpath NOT IN (
        '/Volumes/Garmin Express/Install Garmin Express.pkg',
        '/Volumes/Google Chrome Canary/.keystone_install',
        '/Volumes/Google Chrome/.keystone_install',
        '/Volumes/Jabra Direct Setup/JabraDirectSetup.pkg',
        '/Volumes/macFUSE/.engine_install',
        '/Volumes/macFUSE/Install macFUSE.pkg',
        '/Volumes/PMHOME_3601DL/PMH_INST.pkg'
      )
      AND trimpath NOT LIKE '/Volumes/Blackmagic DaVinci Resolve/Install Resolve %.pkg'
      AND trimpath NOT LIKE '/Volumes/Google Earth Pro%/Install Google Earth Pro%.pkg'
      AND trimpath NOT LIKE '/Volumes/JDK %/JDK %.pkg'
      AND trimpath NOT LIKE '/Volumes/mysql-shell-%/mysql-shell-%.pkg'
      AND trimpath NOT LIKE '/Volumes/Splunk %/Install Splunk'
      AND magic.data NOT LIKE 'ASCII text%'
      AND NOT (
        magic.data = 'AppleDouble encoded Macintosh file'
        AND basename LIKE '._%'
      )
      AND NOT (
        filename = ".install"
        AND size = 0
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Yara Recently Downloaded Miner"
  description: "[detection/initial_access] Yara Recently Downloaded Miner"
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.path LIKE '/home/%/Downloads/%'
            OR file.path LIKE '/home/%/Downloads/%/%'
            OR file.path LIKE '/Users/%/Downloads/%'
            OR file.path LIKE '/Users/%/Downloads/%/%'
            OR file.path LIKE '/tmp/%'
            OR file.path LIKE '/var/tmp/%'
          )
          AND file.type = "regular"
          AND file.size > 2000
          AND file.size < 400000
          AND (
            file.btime > (strftime('%s', 'now') -43200)
            OR file.ctime > (strftime('%s', 'now') -43200)
            OR file.mtime > (strftime('%s', 'now') -43200)
          )
      )
      AND yara.sigrule = '
        rule miner {
        strings:
            $tcp = "stratum+tcp://" ascii
            $tls = "stratum+tls://" ascii
            $ssl = "stratum+ssl://" ascii
            $stratum = "stratum://" ascii
            $normalhash = "\"normalHashing\": true,"
        condition:
            filesize < 10MB and 1 of them
    }'
      AND yara.count > 0
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Yara Recently Downloaded Packed"
  description: Flag packed binaries that have recently been downloaded
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.path LIKE '/home/%/Downloads/%'
            OR file.path LIKE '/home/%/Downloads/%/%'
            OR file.path LIKE '/Users/%/Downloads/%'
            OR file.path LIKE '/Users/%/Downloads/%/%'
            OR file.path LIKE '/tmp/%'
            OR file.path LIKE '/var/tmp/%'
          )
          AND file.type = "regular"
          AND file.size > 2000
          AND file.size < 400000
          AND (
            file.btime > (strftime('%s', 'now') -43200)
            OR file.ctime > (strftime('%s', 'now') -43200)
            OR file.mtime > (strftime('%s', 'now') -43200)
          )
      )
      AND yara.sigrule = '
    rule cxFreeze_Python_executable : high {
      meta:
        hash_2023_MacStealer_weed = "6a4f8b65a568a779801b72bce215036bea298e2c08ec54906bb3ebbe5c16c712"
      strings:
        $cxfreeze = "cx_Freeze"
      condition:
        filesize < 10485760 and $cxfreeze
    }
    import "math"
    
    rule obfuscated_elf : high {
      meta:
        description = "Obfuscated ELF binary (missing content)"
        hash_2023_APT31_1d60 = "1d60edb577641ce47dc2a8299f8b7f878e37120b192655aaf80d1cde5ee482d2"
        hash_2023_UPX_0c25 = "0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d"
        hash_2023_Earthwrom_1ae6 = "1ae62dbec330695d2eddc7cb9a65d47bad5f45af95e6c8a803f0780e0749a3ad"
      strings:
        $dlsym = "dlsym" fullword
        $gcc = "gcc" fullword
        $libstdc = "libstdc" fullword
        $glibc = "glibc" fullword
        $setsid = "setsid" fullword
        $gmon = "__gmon_start__"
        $glibc2 = "@GLIBC"
        $cxa = "__cxa_finalize"
        $dereg = "__deregister_frame_info"
        $symtab = ".symtab" fullword
        $__libc_start_main = "__libc_start_main"
      condition:
        uint32(0) == 1179403647 and none of them
    }
    
    rule high_entropy_header : high {
      meta:
        description = "Obfuscated ELF binary (high entropy content)"
        hash_2023_UPX_0c25 = "0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d"
        hash_2023_UPX_5a59 = "5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59"
        hash_2023_FontOnLake_38B09D690FAFE81E964CBD45EC7CF20DCB296B4D_elf = "f155fafa36d1094433045633741df98bbbc1153997b3577c3fa337cc525713c0"
      strings:
        $not_pyinst = "pyi-bootloader-ignore-signals"
        $not_go = "syscall_linux.go"
        $not_go2 = "vdso_linux.go"
      condition:
        uint32(0) == 1179403647 and math.entropy(1200, 4096) > 7 and none of ($not*)
    }
    import "math"
    
    private rule smallBinary {
    	condition:
    		// matches ELF or machO binary
    		filesize < 64MB and (uint32(0) == 1179403647 or uint32(0) == 4277009102 or uint32(0) == 3472551422 or uint32(0) == 4277009103 or uint32(0) == 3489328638 or uint32(0) == 3405691582 or uint32(0) == 3199925962)
    }
    
    rule high_entropy_7_5 : medium {
        meta:
            description = "higher entropy binary (>7.5)"
        condition:
    		smallBinary and math.entropy(1,filesize) >= 7.5
    }
    
    rule high_entropy_7_9 : high {
        meta:
            description = "high entropy binary (>7.9)"
    	strings:
    		// prevent bazel false positive
    		$bin_java = "bin/java"
        condition:
    		smallBinary and math.entropy(1,filesize) >= 7.9 and not $bin_java
    }
    rule kiteshield : high {
      meta:
        author = "Alex.Turing, Wang Hao"
        date = "2024-05-28"
        description = "Rule to identify files packed by Kiteshield"
        hash_amdc6766_1 = "2c80808b38140f857dc8b2b106764dd8"
        hash_amdc6766_2 = "909c015d5602513a770508fa0b87bc6f"
        hash_amdc6766_3 = "5ea33d0655cb5797183746c6a46df2e9"
        hash_gafgyt = "4afedf6fbf4ba95bbecc865d45479eaf"
        hash_winnti = "f5623e4753f4742d388276eaee72dea6"
        reference = "https://blog.xlab.qianxin.com/kiteshield_packer_is_being_abused_by_linux_cyber_threat_actors"
        tool = "Kiteshield"
        tool_repository = "https://github.com/GunshipPenguin/kiteshield"
    
      strings:
        $loader_jmp = {31 D2 31 C0 31 C9 31 F6 31 FF 31 ED 45 31 C0 45 31 C9 45 31 D2 45 31 DB 45 31 E4 45 31 ED 45 31 F6 45 31 FF 5B FF E3}
        // "/proc/%d/status"
        $loader_s1 = {ac f4 f7 e9 e4 a7 ac ee a4 ff f9 ef fb e5 e2}
        // "TracerPid:"
        $loader_s2 = {d7 f6 e4 e5 e2 fa d9 e3 ef b6}
        // "/proc/%d/stat"
        $loader_s3 = {ac f4 f7 e9 e4 a7 ac ee a4 ff f9 ef fb}
        // "LD_PRELOAD"
        $loader_s4 = {cf c0 da d6 d5 cd c5 c5 ca c8}
        // "LD_AUDIT"
        $loader_s5 = {cf c0 da c7 d2 cc c0 de}
        // "LD_DEBUG"
        $loader_s6 = {cf c0 da c2 c2 ca dc cd}
        // "0123456789abcdef"
        $loader_s7 = {b3 b5 b7 b5 b3 bd bf bd b3 b5 ec ec ec f4 f4 f4}
    
      condition:
        $loader_jmp and all of ($loader_s*) and
        // ELF Magic at offset 0
        uint32(0) == 0x464c457f and
        // ET_EXEC at offset 16
        uint16(16) == 0x0002 and
        (
            // x86_64 at offset 18
            uint16(18) == 0x003e or
            // aarch64 at offset 18
            uint16(18) == 0x00b7
        )
    }
    
    rule shc : high {
      meta:
        description = "Binary generated with SHC (Shell Script Compiler)"
        ref = "https://github.com/neurobin/shc"
        hash_2023_Linux_Malware_Samples_1328 = "1328f1c2c9fe178f13277c18847dd9adb9474f389985e17126fcb895aac035f2"
        hash_2023_Linux_Malware_Samples_77b8 = "77b881109c2141aef8a86263de75e041794556489055c1488f1d36feb7d70dd3"
        hash_2023_Linux_Malware_Samples_edbe = "edbee3b92100cc9a6a8a3c1a5fc00212627560c5e36d29569d497613ea3e3c16"
      strings:
        $ref = "argv[0] nor $_"
      condition:
        $ref
    }
    
    rule upx : high {
      meta:
        description = "Binary is packed with UPX"
        hash_2023_UPX_0c25 = "0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d"
        hash_2023_UPX_5a59 = "5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59"
        hash_2023_FontOnLake_38B09D690FAFE81E964CBD45EC7CF20DCB296B4D_elf = "f155fafa36d1094433045633741df98bbbc1153997b3577c3fa337cc525713c0"
      strings:
        $u_upx_sig = "UPX!"
        $u_packed = "executable packer"
        $u_is_packed = "This file is packed"
        $not_upx = "UPX_DEBUG_DOCTEST_DISABLE"
      condition:
        any of ($u*) in (0..1024) and none of ($not*)
    }
    
    rule upx_elf : high {
      meta:
        description = "Linux ELF binary packed with UPX"
        hash_2023_UPX_0c25 = "0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d"
        hash_2023_UPX_5a59 = "5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59"
        hash_2023_FontOnLake_1F52DB8E3FC3040C017928F5FFD99D9FA4757BF8_elf = "efbd281cebd62c70e6f5f1910051584da244e56e2a3228673e216f83bdddf0aa"
      strings:
        $proc_self = "/proc/self/exe"
        $prot_exec = "PROT_EXEC|PROT_WRITE failed"
      condition:
        uint32(0) == 1179403647 and $prot_exec and $proc_self
    }
    
    rule upx_elf_tampered : critical {
      meta:
        description = "Linux ELF binary packed with modified UPX"
        hash_2023_Unix_Trojan_DarkNexus_2527 = "2527fc4d6491bd8fc9a79344790466eaedcce8795efe540ac323ea93e59c5ab5"
        hash_2023_Unix_Trojan_DarkNexus_2e1d = "2e1d9acd6ab43d63f3eab9fc995080fc67a0a5bbdc66be3aff53ed3745c9e811"
        hash_2023_Unix_Trojan_DarkNexus_3a55 = "3a55dcda90c72acecb548f4318d41708bb73c4c3fb099ff65c988948dc8b216f"
      strings:
        $prot_exec = "PROT_EXEC|PROT_WRITE failed"
        $upx = "UPX!"
      condition:
        uint32(0) == 1179403647 and $prot_exec and not $upx
    }
      '
      AND yara.count > 0
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Yara Recently Downloaded Ransom"
  description: "[detection/initial_access] Yara Recently Downloaded Ransom"
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.path LIKE '/home/%/Downloads/%'
            OR file.path LIKE '/home/%/Downloads/%/%'
            OR file.path LIKE '/Users/%/Downloads/%'
            OR file.path LIKE '/Users/%/Downloads/%/%'
            OR file.path LIKE '/tmp/%'
            OR file.path LIKE '/var/tmp/%'
          )
          AND file.type = "regular"
          AND file.size > 2000
          AND file.size < 400000
          AND (
            file.btime > (strftime('%s', 'now') -43200)
            OR file.ctime > (strftime('%s', 'now') -43200)
            OR file.mtime > (strftime('%s', 'now') -43200)
          )
      )
      AND yara.sigrule = '
        rule ransomware {
        strings:
            $unfortunately = "unfortunately" ascii
            $crypted = "crypted" ascii
            $leaked = "leaked" ascii
            $recover = "recover your" ascii
            $leaks = "of leaks" ascii
            $decrypt = "will decrypt" ascii
    
            $onion = ".onion/" ascii
            $tor = "TOR Browser" ascii
    
            $esxcli = "esxcli" ascii
        condition:
            filesize < 10MB and 3 of them
    }'
      AND yara.count > 0
      AND file.path NOT LIKE "%.csv"
      AND file.path NOT LIKE "%.txt"
      AND file.path NOT LIKE "%.md"
      AND file.path NOT LIKE "%.xls"
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/initial_access] Yara Recently Downloaded Stealer"
  description: "[detection/initial_access] Yara Recently Downloaded Stealer"
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE -- Only scan recent downloads
      file.path IN (
        SELECT
          path
        FROM
          file
        WHERE
          (
            file.path LIKE '/home/%/Downloads/%'
            OR file.path LIKE '/home/%/Downloads/%/%'
            OR file.path LIKE '/Users/%/Downloads/%'
            OR file.path LIKE '/Users/%/Downloads/%/%'
            OR file.path LIKE '/tmp/%'
            OR file.path LIKE '/var/tmp/%'
          )
          AND file.type = "regular"
          AND file.size > 2000
          AND file.size < 400000
          AND (
            file.btime > (strftime('%s', 'now') -43200)
            OR file.ctime > (strftime('%s', 'now') -43200)
            OR file.mtime > (strftime('%s', 'now') -43200)
          )
      )
      AND yara.sigrule = '
    rule multiple_browser_credentials : suspicious {
      strings:
        $c_library_keychains = "/Library/Keychains"
        $c_cookies_sqlite = "cookies.sqlite"
        $c_moz_cookies = "moz_cookies"
        $c_opera_gx = "OperaGX"
        $c_keychain_db = "login.keychain-db"
        $c_dscl_local = "dscl /Local/Default"
        $c_osascript = "osascript"
        $c_find_generic_password = "find-generic-password"
        $not_security = "PROGRAM:security"
        $not_verbose = "system_verbose"
        $not_kandji = "com.kandji.profile.mdmprofile"
        $not_xul = "XUL_APP_FILE"
      condition:
        3 of ($c_*) and none of ($not_*)
    }
    
    rule multiple_browser_credentials_2 {
      strings:
        $a_google_chrome = "Google/Chrome"
        $a_app_support = "Application Support"
        $a_app_support_slash = "Application\\ Support"
        $a_cookies_sqlite = "cookies.sqlite"
        $a_cookies = "Cookies"
        $a_places_sqlite = "places.sqlite"
        $a_moz_cookies = "moz_cookies"
        $a_firefox_profiles = "Firefox/Profiles"
        $a_opera_gx = "OperaGX"
        $a_form_history = "formhistory.sqlite"
        $a_chrome_local_state = "Chrome/Local State"
        $a_brave_software = "BraveSoftware"
        $a_opera = "Opera Software"
        $not_osquery = "OSQUERY_WORKER"
        $not_private = "/System/Library/PrivateFrameworks/"
      condition:
        3 of ($a_*) and none of ($not_*)
    }
    
    
    rule multiple_browser_refs : notable {
      strings:
    	$d_config = ".config" fullword
    	$d_app_support = "Application Support" fullword
    
    	$h_http = "http" fullword
    	$h_POST = "POST" fullword
    
    	$z_zip = "zip" fullword
    	$z_ZIP = "ZIP" fullword
    	$z_ditto = "ditto" fullword
    	$z_tar = "tar" fullword
    
    	$b_Yandex = "Yandex"
    	$b_Brave = "Brave"
    	$b_Firefox = "Firefox"
    	$b_Safari = "Safari"
    	$b_Chrome = "Chrome"
      condition:
        any of ($d*) and any of ($h*) and any of ($z*) and 2 of ($b*)
    }
    '
      AND yara.count > 0
      AND file.path NOT LIKE "%.csv"
      AND file.filename != 'RIT_Wireless.dmg'
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Active Systemd Units"
  description: Unexpected systemd units, may be evidence of persistence
  query: |
    SELECT --  description AS 'desc',
      fragment_path,
      MAX(user, 'root') AS effective_user,
      following,
      hash.sha256,
      file.ctime,
      file.size,
      CONCAT (id, ',', description, ',', user) AS exception_key
    FROM
      systemd_units
      LEFT JOIN hash ON systemd_units.fragment_path = hash.path
      LEFT JOIN file ON systemd_units.fragment_path = file.path
    WHERE
      active_state != 'inactive'
      AND sub_state != 'plugged'
      AND sub_state != 'mounted'
      AND file.filename != ''
      -- Don't care about logical groupings.
      AND NOT file.filename LIKE '%.target'
      AND NOT fragment_path = '/usr/lib/systemd/system/systemd-fsck@.service'
      -- All of these are known good exceptions in known good paths
      AND NOT (
        (
          -- Only allow fragment paths in known good directories
          fragment_path LIKE '/etc/systemd/system/%'
          OR fragment_path LIKE '/lib/systemd/system/%'
          OR fragment_path LIKE '/run/systemd/generator.late/%.service'
          OR fragment_path LIKE '/run/systemd/generator/%'
          OR fragment_path LIKE '/run/systemd/transient/%'
          OR fragment_path LIKE '/usr/lib/systemd/system/%'
        )
        AND (
          exception_key IN (
            '-.slice,Root Slice,',
            'abrt-journal-core.service,ABRT coredumpctl message creator,',
            'abrt-journal-core.service,Creates ABRT problems from coredumpctl messages,',
            'abrt-oops.service,ABRT kernel log watcher,',
            'abrt-xorg.service,ABRT Xorg log watcher,',
            'abrtd.service,ABRT Automated Bug Reporting Tool,',
            'abrtd.service,ABRT Daemon,',
            'accounts-daemon.service,Accounts Service,',
            'acpid.path,ACPI Events Check,',
            'acpid.service,ACPI Daemon,',
            'acpid.service,ACPI event daemon,',
            'acpid.socket,ACPID Listen Socket,',
            'akmods.service,Builds and install new kmods from akmod packages,',
            'alsa-restore.service,Save/Restore Sound Card State,',
            'alsa-state.service,Manage Sound Card State (restore and store),',
            'alsa-store.service,Store Sound Card State,',
            'anacron.service,Run anacron jobs,',
            'anacron.timer,Trigger anacron every hour,',
            'apache-htcacheclean.service,Disk Cache Cleaning Daemon for Apache HTTP Server,www-data',
            'apache2.service,The Apache HTTP Server,',
            'apcupsd.service,APC UPS Power Control Daemon for Linux,',
            'apparmor.service,Load AppArmor profiles,',
            'apport-autoreport.path,Process error reports when automatic reporting is enabled (file watch),',
            'apport-autoreport.service,Process error reports when automatic reporting is enabled,',
            'apport-autoreport.timer,Process error reports when automatic reporting is enabled (timer based),',
            'apport.service,automatic crash report generation,',
            'apport.service,LSB: automatic crash report generation,',
            'apt-daily-upgrade.timer,Daily apt upgrade and clean activities,',
            'apt-daily.service,Daily apt download activities,',
            'apt-daily.timer,Daily apt download activities,',
            'archlinux-keyring-wkd-sync.service,Refresh existing keys of archlinux-keyring,',
            'archlinux-keyring-wkd-sync.timer,Refresh existing PGP keys of archlinux-keyring regularly,',
            'atd.service,Deferred execution scheduler,',
            'atop-rotate.timer,Daily atop restart,',
            'atop.service,Atop advanced performance monitor,',
            'atopacct.service,Atop process accounting daemon,',
            'audit.service,Kernel Auditing,',
            'auditd.service,Security Audit Logging Service,',
            'auditd.service,Security Auditing Service,',
            'augenrules.service,auditd rules generation,',
            'avahi-daemon.service,Avahi mDNS/DNS-SD Stack,',
            'avahi-daemon.socket,Avahi mDNS/DNS-SD Stack Activation Socket,',
            'backup-rpmdb.timer,Backup of RPM database,',
            'backup-sysconfig.timer,Backup of /etc/sysconfig,',
            'bazzite-hardware-setup.service,Configure Bazzite for current hardware,',
            'binfmt-support.service,Enable support for additional executable binary formats,',
            'blk-availability.service,Availability of block devices,',
            'bluetooth.service,Bluetooth service,',
            'bootc-status-updated.path,Monitor bootc for status changes,',
            'bolt.service,Thunderbolt system service,',
            'bootloader-update.service,Update bootloader on boot,',
            'bootupd.socket,bootupd.socket,',
            'brew-update.service,Auto update brew for mutable brew installs,1000',
            'brew-update.timer,Timer for brew update for mutable brew,',
            'brew-upgrade.service,Upgrade Brew packages,1000',
            'brew-upgrade.timer,Timer for brew upgrade for on image brew,',
            'btrfs-dedup@var-home.timer,Weekly Btrfs deduplication on /var/home,',
            'ca-certificates.path,Watch for changes in CA certificates,',
            'check-battery.timer,Check if mainboard battery is Ok,',
            'chrony.service,chrony, an NTP client/server',
            'chronyd.service,NTP client/server,',
            'cloud-config.service,Apply the settings specified in cloud-config,',
            'cloud-final.service,Execute cloud user/final scripts,',
            'cloud-init-hotplugd.socket,cloud-init hotplug hook socket,',
            'cloud-init-local.service,Initial cloud-init job (pre-networking),',
            'cloud-init.service,Initial cloud-init job (metadata service crawler),',
            'colord.service,Manage, Install and Generate Color Profiles,colord',
            'com.system76.PowerDaemon.service,System76 Power Daemon,',
            'com.system76.Scheduler.service,Automatically configure CPU scheduler for responsiveness on AC,',
            'console-setup.service,Set console font and keymap,',
            'containerd.service,containerd container runtime,',
            'cpufrequtils.service,LSB: set CPUFreq kernel parameters,',
            'cron.service,Regular background program processing daemon,',
            'crond.service,Command Scheduler,',
            'cronie.service,Periodic Command Scheduler,',
            'cups-browsed.service,Make remote CUPS printers available locally,',
            'cups-browsed.service,Make remote CUPS printers available locally,cups-browsed',
            'cups.path,CUPS Scheduler,',
            'cups.service,CUPS Scheduler,',
            'cups.socket,CUPS Scheduler,',
            'dbus-:1.2-org.pop_os.transition_system@0.service,dbus-:1.2-org.pop_os.transition_system@0.service,0',
            'dbus-broker.service,D-Bus System Message Bus,',
            'dbus.service,D-Bus System Message Bus,',
            'dbus.socket,D-Bus System Message Bus Socket,',
            'detect-part-label-duplicates.service,Detect if the system suffers from bsc#1089761,',
            'dhcpcd.service,DHCP Client,',
            'display-manager.service,Display Manager,',
            'display-manager.service,X11 Server,',
            'displaylink.service,DisplayLink Manager Service,',
            'dkms.service,Builds and install new kernel modules through DKMS,',
            'dm-event.socket,Device-mapper event daemon FIFOs,',
            'dnf-automatic-install.service,dnf automatic install updates,',
            'dnf-automatic-install.timer,dnf-automatic-install timer,',
            'dnf-makecache.service,dnf makecache,',
            'dnf-makecache.timer,dnf makecache --timer,',
            'docker.service,Docker Application Container Engine,',
            'docker.socket,Docker Socket for the API,',
            'dpkg-db-backup.timer,Daily dpkg database backup timer,',
            'dracut-shutdown.service,Restore /run/initramfs on shutdown,',
            'e2scrub_all.timer,Periodic ext4 Online Metadata Check for All Filesystems,',
            'elastic-agent.service,Elastic Agent is a unified agent to observe, monitor and protect your system.,',
            'ElasticEndpoint.service,ElasticEndpoint,',
            'finalrd.service,Create final runtime dir for shutdown pivot root,',
            'firewall.service,Firewall,',
            'firewalld.service,firewalld - dynamic firewall daemon,',
            'flatpak-system-helper.service,flatpak system helper,',
            'flatpak-system-update.timer,Flatpak Automatic Update Trigger,',
            'fprintd.service,Fingerprint Authentication Daemon,',
            'fstrim.service,Discard unused blocks on filesystems from /etc/fstab,',
            'fstrim.timer,Discard unused blocks once a week,',
            'fstrim.timer,Discard unused filesystem blocks once a week,',
            'fwupd-refresh.service,Refresh fwupd metadata and update motd,fwupd-refresh',
            'fwupd-refresh.timer,Refresh fwupd metadata regularly,',
            'fwupd.service,Firmware update daemon,',
            'gdm.service,GNOME Display Manager,',
            'geoclue.service,Location Lookup Service,geoclue',
            'geoipupdate.timer,Weekly GeoIP update,',
            'gitsign.service,Keyless Git signing with Sigstore!,',
            'gnome-remote-desktop.service,GNOME Remote Desktop,gnome-remote-desktop',
            'gssproxy.service,GSSAPI Proxy Daemon,',
            'haproxy.service,HAProxy Load Balancer,',
            'haveged.service,Entropy Daemon based on the HAVEGE algorithm,',
            'ifupdown-pre.service,Helper to synchronize boot up for ifupdown,',
            'iio-sensor-proxy.service,IIO Sensor Proxy service,',
            'import-state.service,Import network configuration from initramfs,',
            'incus-lxcfs.service,Incus - LXCFS daemon,',
            'incus-startup.service,Incus - Startup check,',
            'incus-user.socket,Incus - Daemon (user unix socket),',
            'incus.service,Incus - Daemon,',
            'incus.service,Incus - Main daemon,',
            'incus.socket,Incus - Daemon (unix socket),',
            'input-remapper.service,Service to inject keycodes without the GUI application,',
            'ir_agent.service,Rapid7 Insight Agent,root',
            'irqbalance.service,irqbalance daemon,',
            'iscsid.socket,Open-iSCSI iscsid Socket,',
            'iscsiuio.socket,Open-iSCSI iscsiuio Socket,',
            'issue-generator.path,Watch for changes in issue snippets,',
            'iwd.service,Wireless service,',
            'jeos-firstboot-snapshot.service,SUSE JeOS First Boot Wizard - create system snapshot,',
            'jeos-firstboot.service,SUSE JeOS First Boot Wizard,',
            'kbdsettings.service,Apply settings from /etc/sysconfig/keyboard,',
            'kde-sysmonitor-workaround.service,Workaround KDE System Monitor not having the correct caps,',
            'kdump.service,Crash recovery kernel arming,',
            'kerneloops.service,Tool to automatically collect and submit kernel crash signatures,kernoops',
            'keyboard-setup.service,Set the console keyboard layout,',
            'klog.service,Early Kernel Boot Messages,',
            'kmod-static-nodes.service,Create list of static device nodes for the current kernel,',
            'kmod-static-nodes.service,Create List of Static Device Nodes,',
            'kolide-launcher.service,Kolide launcher,',
            'launcher,/usr/local/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
            'launcher.kolide-k2.service,The Kolide Launcher,',
            'ldconfig.service,Rebuild Dynamic Linker Cache,',
            'libvirt-workaround.service,Workaround to relabel libvirt files and directories,',
            'libvirtd-admin.socket,Libvirt admin socket,',
            'libvirtd-ro.socket,Libvirt local read-only socket,',
            'libvirtd.service,Virtualization daemon,',
            'libvirtd.socket,Libvirt local socket,',
            'lightdm.service,Light Display Manager,',
            'lima-guestagent.service,lima-guestagent,',
            'livesys-late.service,SYSV: Late init script for live image.,',
            'livesys.service,LSB: Init script for live image.,',
            'lm_sensors.service,Hardware Monitoring Sensors,',
            'lm_sensors.service,Initialize hardware monitoring sensors,',
            'lm-sensors.service,Initialize hardware monitoring sensors,',
            'loadcpufreq.service,LSB: Load kernel modules needed to enable cpufreq scaling,',
            'logrotate-checkconf.service,Logrotate configuration check,',
            'logrotate.service,Rotate log files,',
            'logrotate.timer,Daily rotation of log files,',
            'logrotate.timer,logrotate.timer,',
            'low-memory-monitor.service,Low Memory Monitor,',
            'lvm2-lvmpolld.socket,LVM2 poll daemon socket,',
            'lvm2-monitor.service,Monitoring of LVM2 mirrors, snapshots etc. using dmeventd or progress polling,',
            'lxc-monitord.service,LXC Container Monitoring Daemon,',
            'lxc-net.service,LXC network bridge setup,',
            'lxc.service,LXC Container Initialization and Autoboot Code,',
            'lxcfs.service,FUSE filesystem for LXC,',
            'lxd-installer.socket,Helper to install lxd snap on demand,',
            'machine.slice,Virtual Machine and Container Slice,',
            'man-db.service,Daily man-db regeneration,root',
            'man-db.timer,Daily man-db regeneration,',
            'mcelog.service,Machine Check Exception Logging Daemon,',
            'mlocate-updatedb.timer,Updates mlocate database every day,',
            'ModemManager.service,Modem Manager,root',
            'modprobe@efi_pstore.service,Load Kernel Module efi_pstore,',
            'modprobe@pstore_blk.service,Load Kernel Module pstore_blk,',
            'modprobe@pstore_zone.service,Load Kernel Module pstore_zone,',
            'modprobe@ramoops.service,Load Kernel Module ramoops,',
            'monitorix.service,Monitorix,',
            'motd-news.timer,Message of the Day,',
            'mount-pstore.service,mount-pstore.service,',
            'multipathd.service,Device-Mapper Multipath Device Controller,',
            'multipathd.socket,multipathd control socket,',
            'nessusd.service,The Nessus Vulnerability Scanner,',
            'netcf-transaction.service,Rollback uncommitted netcf network config change transactions,',
            'network-local-commands.service,Extra networking commands.,',
            'network-setup.service,Networking Setup,',
            'networkd-dispatcher.service,Dispatcher daemon for systemd-networkd,',
            'networking.service,Raise network interfaces,',
            'NetworkManager-dispatcher.service,Network Manager Script Dispatcher Service,',
            'NetworkManager-wait-online.service,Network Manager Wait Online,',
            'NetworkManager.service,Network Manager,',
            'nginx.service,A high performance web server and a reverse proxy server,',
            'nginx.service,Nginx Web Server,nginx',
            'nis-domainname.service,Read and set NIS domainname from /etc/sysconfig/network,',
            'nix-daemon.service,Nix Daemon,',
            'nix-daemon.socket,Nix Daemon Socket,',
            'nix-gc.timer,nix-gc.timer,',
            'nscd.service,Name Service Cache Daemon (nsncd),nscd',
            'nscd.service,Name Service Cache Daemon,nscd',
            'nvidia-fallback.service,Fallback to nouveau as nvidia did not load,',
            'nvidia-persistenced.service,NVIDIA Persistence Daemon,',
            'nvidia-powerd.service,nvidia-powerd service,',
            'nvidia-suspend.service,NVIDIA system suspend actions,',
            'openvpn.service,OpenVPN service,',
            'orbit,/opt/orbit/bin/orbit/linux/stable/orbit,0',
            'orbit.service,Orbit osquery,',
            'ostree-finalize-staged-hold.service,Hold /boot Open for OSTree Finalize Staged Deployment,',
            'ostree-finalize-staged.path,OSTree Monitor Staged Deployment,',
            'ostree-finalize-staged.service,OSTree Finalize Staged Deployment,',
            'ostree-remount.service,OSTree Remount OS/ Bind Mounts,',
            'packagekit.service,PackageKit Daemon,root',
            'passim.service,Local Caching Server,passim',
            'pcscd.service,PC/SC Smart Card Daemon,',
            'pcscd.socket,PC/SC Smart Card Daemon Activation Socket,',
            'phpsessionclean.timer,Clean PHP session files every 30 mins,',
            'plocate-updatedb.service,Update the plocate database,',
            'plocate-updatedb.timer,Update the plocate database daily,',
            'plymouth-quit-wait.service,Hold until boot process finishes up,',
            'plymouth-quit.service,Terminate Plymouth Boot Screen,',
            'plymouth-read-write.service,Tell Plymouth To Write Out Runtime Data,',
            'plymouth-start.service,Show Plymouth Boot Screen,',
            'pmcd.service,Performance Metrics Collector Daemon,',
            'podman-auto-update.timer,Podman auto-update timer,',
            'podman-restart.service,Podman Start All Containers With Restart Policy Set To Always,',
            'podman.socket,Podman API Socket,',
            'polkit.service,Authorization Manager,',
            'polkit.service,Authorization Manager,polkitd',
            'postfix@-.service,Postfix Mail Transport Agent (instance -),',
            'power-profiles-daemon.service,Power Profiles daemon,',
            'proc-sys-fs-binfmt_misc.automount,Arbitrary Executable File Formats File System Automount Point,',
            'pulseaudio-enable-autospawn.service,LSB: Enable pulseaudio autospawn,',
            'pwrstatd.service,The monitor UPS software.,',
            'qemu-kvm.service,QEMU KVM preparation - module, ksm, hugepages,',
            'qualys-cloud-agent.service,Qualys cloud agent daemon,',
            'raid-check.timer,Weekly RAID setup health check,',
            'realmd.service,Realm and Domain Configuration,',
            'reflector.service,Refresh Pacman mirrorlist with Reflector.,',
            'reflector.timer,Refresh Pacman mirrorlist weekly with Reflector.,',
            'reload-systemd-vconsole-setup.service,Reset console on configuration changes,',
            'resolvconf-pull-resolved.path,resolvconf-pull-resolved.path,',
            'resolvconf.service,Nameserver information manager,',
            'resolvconf.service,resolvconf update,',
            'rngd.service,Hardware RNG Entropy Gatherer Daemon,',
            'rpc-statd-notify.service,Notify NFS peers of a restart,',
            'rpcbind.service,RPC Bind,',
            'rpcbind.socket,RPCbind Server Activation Socket,',
            'rpm-ostree-countme.service,Weekly rpm-ostree Count Me reporting,rpm-ostree',
            'rpm-ostree-countme.timer,Weekly rpm-ostree Count Me timer,',
            'rpm-ostreed-automatic.service,rpm-ostree Automatic Update,',
            'rpm-ostreed-automatic.timer,rpm-ostree Automatic Update Trigger,',
            'rpm-ostreed.service,rpm-ostree System Management Daemon,rpm-ostree',
            'rsyslog.service,System Logging Service,',
            'rtkit-daemon.service,RealtimeKit Scheduling Policy Service,',
            'schroot.service,Recover schroot sessions,',
            'sddm.service,Simple Desktop Display Manager,',
            'serial-getty@hvc0.service,Serial Getty on hvc0,',
            'serial-getty@ttyAMA0.service,Serial Getty on ttyAMA0,',
            'serial-getty@ttyS0.service,Serial Getty on ttyS0,',
            'setroubleshootd.service,SETroubleshoot daemon for processing new SELinux denial logs,setroubleshoot',
            'setvtrgb.service,Set console scheme,',
            'shadow.service,Verify integrity of password and group files,',
            'shadow.timer,Daily verification of password and group files,',
            'smartd.service,Self Monitoring and Reporting Technology (SMART) Daemon,',
            'smartmontools.service,Self Monitoring and Reporting Technology (SMART) Daemon,',
            'snap.canonical-livepatch.canonical-livepatchd.service,Service for snap application canonical-livepatch.canonical-livepatchd,',
            'snap.cups.cups-browsed.service,Service for snap application cups.cups-browsed,',
            'snap.cups.cupsd.service,Service for snap application cups.cupsd,',
            'snap.lxd.daemon.unix.socket,Socket unix for snap application lxd.daemon,',
            'snap.lxd.user-daemon.unix.socket,Socket unix for snap application lxd.user-daemon,',
            'snap.multipass.multipassd.service,Service for snap application multipass.multipassd,',
            'snap.yubioath-desktop.pcscd.service,Service for snap application yubioath-desktop.pcscd,',
            'snapd.apparmor.service,Load AppArmor profiles managed internally by snapd,',
            'snapd.seeded.service,Wait until snapd is fully seeded,',
            'snapd.service,Snap Daemon,',
            'snapd.socket,Socket activation for snappy daemon,',
            'ssh.service,OpenBSD Secure Shell server,',
            'ssh.socket,OpenBSD Secure Shell server socket,',
            'sshd-unix-local.socket,OpenSSH Server Socket (systemd-ssh-generator, AF_UNIX Local),',
            'sshd.service,OpenSSH Daemon,',
            'sshd.service,OpenSSH server daemon,',
            'sshd.service,SSH Daemon,',
            'sssd-kcm.service,SSSD Kerberos Cache Manager,',
            'sssd-kcm.service,SSSD Kerberos Cache Manager,sssd',
            'sssd-kcm.socket,SSSD Kerberos Cache Manager responder socket,',
            'supergfxd.service,SUPERGFX,',
            'swap.img.swap,/swap.img,',
            'swapfile.swap,/swapfile,',
            'switcheroo-control.service,Switcheroo Control Proxy service,',
            'swtpm-workaround.service,Workaround swtpm not having the correct label,',
            'syslog.socket,Syslog Socket,',
            'sysstat-collect.timer,Run system activity accounting tool every 10 minutes,',
            'sysstat-summary.timer,Generate summary of yesterday''s process accounting,',
            'sysstat.service,Resets System Activity Logs,root',
            'system-cups.slice,CUPS Slice,',
            'system.slice,System Slice,',
            'systemd-ask-password-console.path,Dispatch Password Requests to Console Directory Watch,',
            'systemd-ask-password-plymouth.path,Forward Password Requests to Plymouth Directory Watch,',
            'systemd-ask-password-wall.path,Forward Password Requests to Wall Directory Watch,',
            'systemd-binfmt.service,Set Up Additional Binary Formats,',
            'systemd-boot-random-seed.service,Update Boot Loader Random Seed,',
            'systemd-boot-update.service,Automatic Boot Loader Update,',
            'systemd-bootctl.socket,Boot Entries Service Socket,',
            'systemd-coredump.socket,Process Core Dump Socket,',
            'systemd-creds.socket,Credential Encryption/Decryption,',
            'systemd-fsck-root.service,File System Check on Root Device,',
            'systemd-fsckd.socket,fsck to fsckd communication Socket,',
            'systemd-growfs@-.service,Grow File System on /,',
            'systemd-homed-activate.service,Home Area Activation,',
            'systemd-homed.service,Home Area Manager,',
            'systemd-hostnamed.service,Hostname Service,',
            'systemd-hostnamed.socket,Hostname Service Socket,',
            'systemd-hwdb-update.service,Rebuild Hardware Database,',
            'systemd-initctl.socket,initctl Compatibility Named Pipe,',
            'systemd-journal-catalog-update.service,Rebuild Journal Catalog,',
            'systemd-journal-flush.service,Flush Journal to Persistent Storage,',
            'systemd-journald-audit.socket,Journal Audit Socket,',
            'systemd-journald-dev-log.socket,Journal Socket (/dev/log),',
            'systemd-journald.service,Journal Service,',
            'systemd-journald.socket,Journal Socket,',
            'systemd-journald.socket,Journal Sockets,',
            'systemd-localed.service,Locale Service,',
            'systemd-logind.service,User Login Management,',
            'systemd-machine-id-commit.service,Commit a transient machine-id on disk,',
            'systemd-machined.service,Virtual Machine and Container Registration Service,',
            'systemd-modules-load.service,Load Kernel Modules,',
            'systemd-mountfsd.socket,DDI File System Mounter Socket,',
            'systemd-network-generator.service,Generate network units from Kernel command line,',
            'systemd-networkd-wait-online.service,Wait for Network to be Configured,',
            'systemd-networkd.service,Network Configuration,systemd-network',
            'systemd-networkd.socket,Network Service Netlink Socket,',
            'systemd-nsresourced.service,Namespace Resource Manager,',
            'systemd-nsresourced.socket,Namespace Resource Manager Socket,',
            'systemd-oomd.service,Userspace Out-Of-Memory (OOM) Killer,systemd-oom',
            'systemd-oomd.socket,Userspace Out-Of-Memory (OOM) Killer Socket,',
            'systemd-pcrmachine.service,TPM2 PCR Machine ID Measurement,',
            'systemd-pcrphase-sysinit.service,TPM2 PCR Barrier (Initialization),',
            'systemd-pcrphase.service,TPM2 PCR Barrier (User),',
            'systemd-pstore.service,Platform Persistent Storage Archival,',
            'systemd-random-seed.service,Load/Save OS Random Seed,',
            'systemd-random-seed.service,Load/Save Random Seed,',
            'systemd-remount-fs.service,Remount Root and Kernel File Systems,',
            'systemd-resolved.service,Network Name Resolution,systemd-resolve',
            'systemd-rfkill.socket,Load/Save RF Kill Switch Status /dev/rfkill Watch,',
            'systemd-suspend.service,System Suspend,',
            'systemd-sysctl.service,Apply Kernel Variables,',
            'systemd-sysext.socket,System Extension Image Management (Varlink),',
            'systemd-sysext.socket,System Extension Image Management,',
            'systemd-sysusers.service,Create System Users,',
            'systemd-timedated.service,Time & Date Service,',
            'systemd-timesyncd.service,Network Time Synchronization,systemd-timesync',
            'systemd-tmpfiles-clean.timer,Daily Cleanup of Temporary Directories,',
            'systemd-tmpfiles-setup-dev-early.service,Create Static Device Nodes in /dev gracefully,',
            'systemd-tmpfiles-setup-dev.service,Create Static Device Nodes in /dev,',
            'systemd-tmpfiles-setup.service,Create System Files and Directories,',
            'systemd-tmpfiles-setup.service,Create Volatile Files and Directories,',
            'systemd-udev-load-credentials.service,Load udev Rules from Credentials,',
            'systemd-udev-settle.service,Wait for udev To Complete Device Initialization,',
            'systemd-udev-trigger.service,Coldplug All udev Devices,',
            'systemd-udevd-control.socket,udev Control Socket,',
            'systemd-udevd-kernel.socket,udev Kernel Socket,',
            'systemd-udevd.service,Rule-based Manager for Device Events and Files,',
            'systemd-update-done.service,Update is Completed,',
            'systemd-update-utmp.service,Record System Boot/Shutdown in UTMP,',
            'systemd-update-utmp.service,Update UTMP about System Boot/Shutdown,',
            'systemd-user-sessions.service,Permit User Sessions,',
            'systemd-userdbd.service,User Database Manager,',
            'systemd-userdbd.socket,User Database Manager Socket,',
            'systemd-vconsole-setup.service,Setup Virtual Console,',
            'systemd-vconsole-setup.service,Virtual Console Setup,',
            'tailscaled.service,Tailscale node agent,',
            'thermald.service,Thermal Daemon Service,',
            'tlp.service,TLP system startup/shutdown,',
            'touchegg.service,Touchgg Daemon,',
            'tuned-ppd.service,PPD-to-TuneD API Translation Daemon,',
            'tuned.service,Dynamic System Tuning Daemon,',
            'ua-timer.timer,Ubuntu Advantage Timer for running repeated jobs,',
            'ua-timer.timer,Ubuntu Pro Timer for running repeated jobs,',
            'ublue-system-setup.service,Configure system,',
            'ublue-update.service,Universal Blue Update Oneshot Service,',
            'ublue-update.timer,Auto Update System Timer For Universal Blue,',
            'ubuntu-fan.service,Ubuntu FAN network setup,',
            'udisks2.service,Disk Manager,',
            'ufw.service,Uncomplicated firewall,',
            'unattended-upgrades.service,Unattended Upgrades Shutdown,',
            'unbound-anchor.timer,daily update of the root trust anchor for DNSSEC,',
            'update-notifier-download.timer,Download data for packages that failed at package install time,',
            'update-notifier-motd.timer,Check to see whether there is a new version of Ubuntu available,',
            'updatedb.timer,Daily locate database update,',
            'upower.service,Daemon for power management,',
            'uresourced.service,User resource assignment daemon,',
            'usbmuxd.service,Socket daemon for the usbmux protocol used by Apple devices,',
            'user.slice,User and Session Slice,',
            'uuidd.service,Daemon for generating UUIDs,uuidd',
            'uuidd.socket,UUID daemon activation socket,',
            'v4l2-relayd.service,v4l2-relay daemon service,',
            'vboxautostart-service.service,vboxautostart-service.service,',
            'vboxballoonctrl-service.service,vboxballoonctrl-service.service,',
            'vboxdrv.service,VirtualBox Linux kernel module,',
            'vboxweb-service.service,vboxweb-service.service,',
            'velociraptor_client.service,Velociraptor linux client,',
            'velociraptor_server.service,Velociraptor server,velociraptor',
            'virtinterfaced-admin.socket,libvirt interface daemon admin socket,',
            'virtinterfaced-ro.socket,libvirt interface daemon read-only socket,',
            'virtinterfaced.socket,libvirt interface daemon socket,',
            'virtinterfaced.socket,Libvirt interface local socket,',
            'virtlockd-admin.socket,libvirt locking daemon admin socket,',
            'virtlockd.socket,libvirt locking daemon socket,',
            'virtlockd.socket,Virtual machine lock manager socket,',
            'virtlogd-admin.socket,libvirt logging daemon admin socket,',
            'virtlogd-admin.socket,Virtual machine log manager socket,',
            'virtlogd.service,Virtual machine log manager,',
            'virtlogd.socket,libvirt logging daemon socket,',
            'virtlogd.socket,Virtual machine log manager socket,',
            'virtlxcd-admin.socket,libvirt LXC daemon admin socket,',
            'virtlxcd-ro.socket,libvirt LXC daemon read-only socket,',
            'virtlxcd.socket,libvirt LXC daemon socket,',
            'virtnetworkd-admin.socket,libvirt network daemon admin socket,',
            'virtnetworkd-ro.socket,libvirt network daemon read-only socket,',
            'virtnetworkd.socket,libvirt network daemon socket,',
            'virtnetworkd.socket,Libvirt network local socket,',
            'virtnodedevd-admin.socket,libvirt nodedev daemon admin socket,',
            'virtnodedevd-ro.socket,libvirt nodedev daemon read-only socket,',
            'virtnodedevd.socket,libvirt nodedev daemon socket,',
            'virtnodedevd.socket,Libvirt nodedev local socket,',
            'virtnwfilterd-admin.socket,libvirt nwfilter daemon admin socket,',
            'virtnwfilterd-ro.socket,libvirt nwfilter daemon read-only socket,',
            'virtnwfilterd.socket,libvirt nwfilter daemon socket,',
            'virtnwfilterd.socket,Libvirt nwfilter local socket,',
            'virtproxyd-admin.socket,libvirt proxy daemon admin socket,',
            'virtproxyd-ro.socket,libvirt proxy daemon read-only socket,',
            'virtproxyd.socket,libvirt proxy daemon socket,',
            'virtproxyd.socket,Libvirt proxy local socket,',
            'virtqemud-admin.socket,Libvirt qemu admin socket,',
            'virtqemud-admin.socket,libvirt QEMU daemon admin socket,',
            'virtqemud-ro.socket,libvirt QEMU daemon read-only socket,',
            'virtqemud-ro.socket,Libvirt qemu local read-only socket,',
            'virtqemud.service,Virtualization qemu daemon,',
            'virtqemud.socket,libvirt QEMU daemon socket,',
            'virtqemud.socket,Libvirt qemu local socket,',
            'virtsecretd-admin.socket,libvirt secret daemon admin socket,',
            'virtsecretd-ro.socket,libvirt secret daemon read-only socket,',
            'virtsecretd.socket,libvirt secret daemon socket,',
            'virtsecretd.socket,Libvirt secret local socket,',
            'virtstoraged-admin.socket,libvirt storage daemon admin socket,',
            'virtstoraged-ro.socket,libvirt storage daemon read-only socket,',
            'virtstoraged.socket,libvirt storage daemon socket,',
            'virtstoraged.socket,Libvirt storage local socket,',
            'virtvboxd-admin.socket,libvirt VirtualBox daemon admin socket,',
            'virtvboxd-ro.socket,libvirt VirtualBox daemon read-only socket,',
            'virtvboxd.socket,libvirt VirtualBox daemon socket,',
            'vnstat.service,vnStat network traffic monitor,vnstat',
            'whoopsie.path,Start whoopsie on modification of the /var/crash directory,',
            'wicked.service,wicked managed network interfaces,',
            'wickedd-auto4.service,wicked AutoIPv4 supplicant service,',
            'wickedd-dhcp4.service,wicked DHCPv4 supplicant service,',
            'wickedd-dhcp6.service,wicked DHCPv6 supplicant service,',
            'wickedd-nanny.service,wicked network nanny service,',
            'wickedd.service,wicked network management service daemon,',
            'wpa_supplicant.service,WPA supplicant,',
            'zfs-import-cache.service,Import ZFS pools by cache file,',
            'zfs-load-key-rpool.service,Load ZFS key for rpool,',
            'zfs-load-module.service,Install ZFS kernel module,',
            'zfs-mount.service,Mount ZFS filesystems,',
            'zfs-scrub.service,ZFS pools scrubbing,',
            'zfs-scrub.timer,zfs-scrub.timer,',
            'zfs-share.service,ZFS file system shares,',
            'zfs-snapshot-daily.service,ZFS auto-snapshotting every day,',
            'zfs-snapshot-frequent.service,ZFS auto-snapshotting every 15 mins,',
            'zfs-snapshot-hourly.service,ZFS auto-snapshotting every hour,',
            'zfs-volume-wait.service,Wait for ZFS Volume (zvol) links in /dev,',
            'zfs-zed.service,ZFS Event Daemon (zed),',
            'znapzend.service,ZnapZend - ZFS Backup System,root',
            'zpool-trim.service,ZFS pools trim,',
            'zpool-trim.timer,zpool-trim.timer,'
          )
          OR exception_key LIKE 'boot-sysctl.service,Apply Kernel Variables for % from /boot,'
          OR exception_key LIKE 'dbus-:1.%-org.freedesktop.problems@%.service,dbus-:%.%-org.freedesktop.problems@%.service,0'
          OR exception_key LIKE 'drkonqi-coredump-processor@%.service,Pass systemd-coredump journal entries to relevant user for potential DrKonqi handling,'
          OR exception_key LIKE 'machine-qemu%.scope,Virtual Machine qemu%,'
          OR exception_key LIKE 'run-media-%.mount,run-media-%.mount,'
          OR exception_key LIKE 'snap-aws\x2dcli-%.mount,Mount unit for aws-cli, revision %'
          OR exception_key LIKE 'systemd-cryptsetup@%.service,Cryptography Setup for %,'
          OR exception_key LIKE 'zfs-snapshot-%.service,zfs-snapshot-%.service,'
          OR exception_key LIKE 'zfs-snapshot-%.timer,zfs-snapshot-%.timer,'
          OR id LIKE ''
          OR id LIKE 'akmods@%64.service'
          OR id LIKE 'dev-disk-by%.swap'
          OR id LIKE 'dev-mapper-%.swap'
          OR id LIKE 'dev-zram%.swap'
          OR id LIKE 'docker-%.scope'
          OR id LIKE 'getty@tty%.service'
          OR id LIKE 'home-manager-%.service'
          OR id LIKE 'lvm2-pvscan@%.service'
          OR id LIKE 'session-%.scope'
          OR id LIKE 'system-systemd%cryptsetup.slice'
          OR id LIKE 'systemd-backlight@%.service'
          OR id LIKE 'systemd-cryptsetup@luks%.service'
          OR id LIKE 'systemd-cryptsetup@nvme%.service'
          OR id LIKE 'systemd-fsck@dev-disk-by%service'
          OR id LIKE 'systemd-zram-setup@zram%.service'
          OR id LIKE 'user-runtime-dir@%.service'
          OR id LIKE 'user@%.service'
        )
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Chrome Extensions"
  description: Highlight chrome extensions with wide-ranging permissions that are not part of your whitelist
  query: |
    SELECT
      name,
      profile,
      chrome_extensions.description AS 'descr',
      persistent AS persists,
      CONCAT (
        "https://chromewebstore.google.com/detail/extension/",
        identifier
      ) AS ext_url,
      author,
      chrome_extensions.path,
      referenced AS in_config,
      file.ctime,
      file.btime,
      file.mtime,
      from_webstore AS in_store,
      TRIM(CAST(permissions AS text)) AS perms,
      state AS 'enabled',
      CONCAT (
        from_webstore,
        ',',
        author,
        ',',
        name,
        ',',
        identifier
      ) AS exception_key,
      hash.sha256
    FROM
      users
      CROSS JOIN chrome_extensions USING (uid)
      LEFT JOIN file ON chrome_extensions.path = file.path
      LEFT JOIN hash ON chrome_extensions.path = hash.path
    WHERE
      state = 1
      AND (
        (
          from_webstore != 'true'
          AND (
            perms LIKE '%bookmarks%'
            OR perms LIKE "%http%"
            OR perms LIKE "%nativeMessaging%"
            OR perms LIKE "%pageCapture%"
            OR perms LIKE "%session%" -- Sigstore
            OR perms LIKE "%webRequest%"
          )
        )
        -- Can make requests and see interesting information
        OR (
          perms like '%webRequest%'
          OR perms LIKE '%dns%'
          AND (
            perms LIKE '%://*/%'
            OR perms LIKE '%<all_urls>%'
            OR perms LIKE '%blockchain%'
            OR perms LIKE '%clipboardRead%'
            OR perms LIKE '%coinbase%'
            OR perms LIKE '%cookies%'
            OR perms LIKE '%github.com%'
            OR perms LIKE '%google.com%'
            OR perms LIKE '%pageCapture%'
            OR perms LIKE '%privacy%'
            OR perms LIKE '%tabCapture%'
            OR perms LIKE '%tabs%'
            OR perms LIKE '%webNavigation%'
          )
        )
        -- Unusual permissions
        OR perms LIKE "%contentSettings%"
        OR perms LIKE "%history%"
        OR perms LIKE "%management%"
        OR perms LIKE "%nativeMessaging%"
        OR perms LIKE "%proxy%"
        OR perms LIKE "%vpnProvider%"
        OR perms LIKE "%webAuthenticationProxy%"
        OR perms LIKE '%debugger%'
        OR perms LIKE '%declarativeNetRequestFeedback%'
        OR perms LIKE '%desktopCapture%'
      )
      AND NOT exception_key IN (
        "true,GEN Digital Inc.,I don't care about cookies,fihnjjcciajhdojfnbdddfaoknhalnja",
        "true,OhMyGuus and Community (originally Daniel Kladnik),I still don't care about cookies,edibdbjcniadpccecjdfdjjppcpchdlm",
        'false,eff.software.projects@gmail.com,Privacy Badger,mkejgcgkdlddbggjhhflekkondicpnop',
        'false,privacybadger-owner@eff.org,Privacy Badger,mkejgcgkdlddbggjhhflekkondicpnop',
        'true,,Adblock for Youtube,cmedhionkhpnakcndndgjdbohmhepckk',
        'true,,Adobe Acrobat: PDF edit, convert, sign tools,efaidnbmnnnibpcajpcglclefindmkaj',
        'true,,Allow CORS: Access-Control-Allow-Origin,lhobafahddgcelffkeicbaginigeejlf',
        'true,,Amplitude Event Explorer,acehfjhnmhbmgkedjmjlobpgdicnhkbp',
        'true,,Application Launcher For Drive (by Google),lmjegmlicamnimmfhcmpkclmigmmcbeh',
        'true,,Awesome Screen Recorder & Screenshot,nlipoenfbbikpbjkfpfillcgkoblgpmj',
        'true,,axe DevTools - Web Accessibility Testing,lhdoppojpmngadmnindnejefpokejbdd',
        'true,,Boomerang for Gmail,mdanidgdpmkimeiiojknlnekblgmpdll',
        'true,,Capital One Shopping: Save Now,nenlahapcbofgnanklpelkaejcehkggg',
        'true,,Chrome Capture - screenshot & GIF,ggaabchcecdbomdcnbahdfddfikjmphe',
        'true,,Chrome Remote Desktop,inomeogfingihgjfjlpeplalcfajhgai',
        'true,,Cisco Umbrella Chromebook client (Ext),jcdhmojfecjfmbdpchihbeilohgnbdci',
        'true,,Cisco Webex Extension,jlhmfgmfgeifomenelglieieghnjghma',
        'true,,Copper CRM for Gmail,hpfmedbkgaakgagknibnonpkimkibkla',
        'true,,Coupert - Automatic Coupon Finder & Cashback,mfidniedemcgceagapgdekdbmanojomk',
        'true,,CSP Evaluator,fjohamlofnakbnbfjkohkbdigoodcejf',
        'true,,DuckDuckGo Privacy Essentials,bkdgflcldnnnapblkhphbgpggdiikppg',
        'true,,DuckDuckGo Search & Tracker Protection,bkdgflcldnnnapblkhphbgpggdiikppg',
        'true,,EditThisCookie,fngmhnnpilhplaeedifhccceomclgfbg',
        'true,,Endpoint Verification,callobklhcbilhphinckomhgkigmfocg',
        'true,,Gem,bnbpceglddpnehbopmdjegpfinikcaoh',
        'true,,Go Links,gojgbkejhelijlkgpmlbbkklljgmfljj',
        'true,,Google Keep - Notes and Lists,hmjkmjkepdijhoojdojkdfohbdgmmhki',
        'true,,GoToTraining Screensharing,copcmbdalilphnaiajfmonkegedhkndd',
        'true,,Greenhouse Recruiting Chrome extension,naooopefdfeangnkgmjpklgblnfmbaea',
        'true,,Hippo Video: Video and Screen Recorder,cijidiollmnkegoghpfobabpecdkeiah',
        'true,,Honey: Automatic Coupons & Rewards,bmnlcjabgnpnenekpadlanbbkooimhnj',
        'true,,HubSpot Sales,oiiaigjnkhngdbnoookogelabohpglmd',
        'true,,iCloud Bookmarks,fkepacicchenbjecpbpbclokcabebhah',
        'true,,iCloud Passwords,pejdijmoenmkgeppbflobdenhhabjlaj',
        'true,,Kagi Privacy Pass,mendokngpagmkejfpmeellpppjgbpdaj',
        'true,,Kagi Search,cdglnehniifkbagbbombnjghhcihifij',
        'true,,Live Stream Downloader,looepbdllpjgdmkpdcdffhdbmpbcfekj',
        'true,,Loom  Screen Recorder & Screen Capture,liecbddmkiiihnedobmlmillhodjkdmb',
        'true,,Media Hint,akipcefbjlmpbcejgdaopmmidpnjlhnb',
        'true,,Mettl Tests : Enable Screen Sharing,hkjemkcbndldepdbnbdnibeppofoooio',
        'true,,Microsoft Single Sign On,ppnbnpeolgkicgegkbkbjmhlideopiji',
        'true,,Moesif Origin/CORS Changer & API Logger,digfbfaphojjndkpccljibejjbppifbc',
        'true,,Newsletter Creator for Gmail - Flashissue,cihaednhfbocfdiflmpccekcmjepcnmb',
        'true,,Nooks,kbbdibmbjngifdgbmlleelghocpeimhe',
        'true,,NordVPN - VPN proxy for privacy and security,fjoaledfpmneenckfbpdfhkmimnjocfa',
        'true,,NoScript,doojmbjmlfjjnbmnoijecmcbfeoakpjm',
        'true,,Okta Browser Plugin,glnpjglilkicbckjpbgcfkogebgllemb',
        'true,,OneLogin for Google Chrome,ioalpmibngobedobkmbhgmadaphocjdn',
        'true,,Outreach Optimization on LinkedIn & Gmail,ngeodglgpmplepchhghijjncnikifaed',
        'true,,Page Analytics (by Google),fnbdnhhicmebfgdgglcdacdapkcihcoh',
        'true,,Poshmark | PosherVA,ofacfijogapplfgkoolmdojoieiemihl',
        'true,,Privacy Badger,pkehgijcmpdhfbdbbnkijodmdjhbjlgp',
        'true,,ProctorU,goobgennebinldhonaajgafidboenlkl',
        'true,,Ramp for Chrome,idefohglmnkliiadgfofeokcpjobdeik',
        'true,,Reddit Pixel Helper,ebgpcjlgganlidigifggjjiglghjnjcj',
        'true,,Reflect,kljfphapkgkjaiiddfmfpbdmeaplojge',
        'true,,Salesforce,jjghhkepijgakdammjldcbnjehfkfmha',
        'true,,SalesLoft Connect - Legacy,cffgjgigjfgjkfdopbobbdadaelbhepo',
        'true,,Save to Google Drive,gmbmikajjgmnabiglmofipeabaddhgne',
        'true,,Screen Recorder,hniebljpgcogalllopnjokppmgbhaden',
        'true,,Screenshot & Screen Video Record by Screeny,djekgpcemgcnfkjldcclcpcjhemofcib',
        'true,,Secure Browser - Online Proctoring Extension,aeindiojndlokkemcgakgpgbcmgonifn',
        'true,,Selenium IDE,mooikfkahbdckldjjndioackbalphokd',
        'true,,Soapbox   Video Recorder,lmepjnndgdhcgphilomlfekmgnnmngbi',
        'true,,Solitaire,lkbhppfbabandkdmgjmifahoabeodiep',
        'true,,Surfshark VPN Extension,ailoabdmgclmfmhdagmlohpjlbpffblp',
        'true,,Talend API Tester - Free Edition,aejoelaoggembcahagimdiliamlcdmfm',
        'true,,Tamper Chrome (extension),hifhgpdkfodlpnlmlnmhchnkepplebkb',
        'true,,Tampermonkey,dhdgffkkebhmkfjojejmpbldmpobfkfo',
        'true,,TextExpander: Keyboard Shortcuts & Templates,mmfhhfjhpadoefoaahomoakamjcfcoil',
        'true,,Touch VPN - Secure and unlimited VPN proxy,bihmplhobchoageeokmgbdihknkjbknd',
        'true,,uBlock,epcnnfbjfcgphgdmggkamkmgojdagdnn',
        'true,,Video Downloader PLUS,njgehaondchbmjmajphnhlojfnbfokng',
        'true,,Video Downloader Professional,elicpjhcidhpjomhibiffojpinpmmpil',
        'true,,Vimium,dbepggeogbaibhgnhhndojpepiihcmeb',
        'true,,Web Developer,bfbameneiokkgbdmiekhjnmfkcnldhhm',
        'true,,WhatRuns,cmkdbmfndkfgebldhnkbfhlneefdaaip',
        'true,,Wistia Video Downloader,acbiaofoeebeinacmcknopaikmecdehl',
        'true,,Yesware Sales Engagement,gkjnkapjmjfpipfcccnjbjcbgdnahpjp',
        'true,,Zoom,hmbjbjdpkobdjplfobhljndfdfdipjhg',
        'true,,Zotero Connector,ekhagklcjbdpajgpjgmbionohlpdbjgc',
        'true,Adblock, Inc.,AdBlock  block ads across the web,gighmmpiobklfepjocnamgkkbiglidom',
        'true,Adguard Software Ltd,AdGuard AdBlocker,bgnkhhnnamicmpeenaelnjfhikgbkllg',
        'true,AgileBits,1Password Nightly  Password Manager,gejiddohjgogedgjnonbofjigllpkmbf',
        'true,AgileBits,1Password  Password Manager,aeblfdkhhhdcdjpifhhbdiojplfjncoa',
        'true,Aura,Aura,fjbgpaheigpmkbdkdfghmkbnkpeofmhh',
        'true,AwardWallet LLC,AwardWallet,lppkddfmnlpjbojooindbmcokchjgbib',
        'true,Benjamin Hollis,JSONView,gmegofmjomhknnokphhckolhcffdaihd',
        'true,BetterLogic <Dev@betterlogic>,Better History | Blacklist Mode,egehpkpgpgooebopjihjmnpejnjafefi',
        'true,BetterLogic <Dev@betterlogic>,Better History | Manage, Export & Delete History,egehpkpgpgooebopjihjmnpejnjafefi',
        'true,Bitwarden Inc.,Bitwarden - Free Password Manager,nngceckbapebfimnlniiiahkandclblb',
        'true,Bitwarden Inc.,Bitwarden Password Manager,nngceckbapebfimnlniiiahkandclblb',
        'true,Cartera,American Airlines AAdvantage eShopping,dcdiajifnnbipfljbggcbbheipfdmgpo',
        'true,Cartera,Delta Air Lines SkyMiles Shopping,mkgbnjpecbelajilbdeokhehjfbeglgf',
        'true,Cartera,United Airlines MileagePlus Shopping,apcjkhjbhapedgbekhlhdkidpohpkfne',
        'true,ExpressVPN,ExpressVPN: VPN proxy for a better internet,fgddmllnllkalaagkghckoinaemmogpe',
        'true,eyeo GmbH,Adblock Plus - free ad blocker,cfhdojbkjhnklbpkdaibdccddilifddb',
        'true,Franois Duprat,Mobile simulator - responsive testing tool,ckejmhbmlajgoklhgbapkiccekfoccmk',
        'true,Ghostery,Ghostery Tracker & Ad Blocker - Privacy AdBlock,mlomiejdfkolichcflejclcbmpeaniij',
        'true,GLIDER,Glider Proctoring,dcnidakmkbkbohdaelljpgdhmbbpbdbg',
        'true,GZ systems Ltd.,PureVPN Proxy - Best VPN for Chrome,bfidboloedlamgdmenmlbipfnccokknp',
        'true,https://metamask.io,MetaMask,nkbihfbeogaeaoehlefnkodbefgpgknn',
        'true,Kai Uwe Broulik <kde@privat.broulik.de>,Plasma Integration,cimiefiiaegbelhefglklhhakcgmhkai',
        'true,Keepa GmbH,Keepa - Amazon Price Tracker,neebplgakaahbhdphmkckjjcegoiijjo',
        'true,KeePassXC Team,KeePassXC-Browser,oboonakemofpalcgghocfoadofidjkkk',
        'true,Keeper Security, Inc.,Keeper Password Manager & Digital Vault,bfogiafebfohielmmehodmfbbebbbpei',
        'true,LastPass,LastPass: Free Password Manager,hdokiejnpimakedhajhdlcegeplioahd',
        'true,Lydian AI <_start@lydian.ai>,Ghostwrite: ChatGPT Email Assistant,fbjnnjochaopepfjpngghafgnafebkjh',
        'true,Microsoft Corporation,Microsoft Autofill,fiedbfgcleddlbcmgdigjgdfcggjcion',
        'true,modhader@,ModHeader - Modify HTTP headers,idgpnmonknjnojddfkpgkljpfnnfcklj',
        'true,Olav Morken, Jaime Perez, Thijs Kinkhorst, Jan Khler, Tim van Dijen,SAML-tracer,mpdajninpobndbfcldcmbpnnbhibjmch',
        'true,Opera Software AS,Rich Hints Agent,enegjkbbakeegngfapepobipndnebkdk',
        'true,Opera,Cashback Assistant,ompjkhnkeoicimmaehlcmgmpghobbjoj',
        'true,Quantier, LLC,Vim for Google Docs,aphmodfjbhofkpibocbggkdfnpbpjmpp',
        'true,Rakuten,Rakuten: Get Cash Back For Shopping,chhjbpecpncaggjpdakmflnfcopglcmi',
        'true,Raymond Hill & contributors,uBlock Origin,cjpalhdlnbpafiamejdnhcphjbkeiagm',
        'true,Reddit Enhancement Suite contributors,Reddit Enhancement Suite,kbmfpngjjgdllneeigpgjifpgocmfgmb',
        'true,Symantec Corporation,Norton Password Manager,admmjipmmciaobhojoghlmleefbicajg',
        'true,Thomas Rientjes,Decentraleyes,ldpochfccmkkmhdbclfhpagapcfdljkj',
        'true,Wappalyzer,Wappalyzer - Technology profiler,gppongmhjkpfnbhagpmjfkannfbllamg',
        'true,Yuri Konotopov <ykonotopov@gnome.org>,GNOME Shell integration,gphhapmejobijbbhgpjhcjognlahblep',
        'true,Zinlab <sebastian@Zinlab>,Better History,egehpkpgpgooebopjihjmnpejnjafefi'
      )
      AND NOT (
        exception_key IN (
          'false,,Onion Browser Button,joijkphhgidknnmmaabfgjhjmgjiepia',
          'false,AgileBits,1Password  Password Manager,dppgmdbiimibapkepcbdbmkaabgiofem'
        )
        AND chrome_extensions.path LIKE '%/Microsoft Edge/%'
      )
    GROUP BY
      exception_key
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Device Linux"
  description: Finds unexpected device names, sometimes used for communication to a rootkit
  query: |
    SELECT -- Remove numerals from device names
      -- Ugly, but better than dealing with multiple rounds of nesting COALESCE + REGEX_MATCH
      CONCAT (
        REPLACE(
          REPLACE(
            REPLACE(
              REPLACE(
                REPLACE(
                  REPLACE(
                    REPLACE(
                      REPLACE(REPLACE(REPLACE(path, "0", ""), "1", ""), "2", ""),
                      "3",
                      ""
                    ),
                    "4",
                    ""
                  ),
                  "5",
                  ""
                ),
                "6",
                ""
              ),
              "7",
              ""
            ),
            "8",
            ""
          ),
          "9",
          ""
        ),
        ",",
        file.type
      ) AS exception_key,
      file.*
    FROM
      file
    WHERE
      (
        path LIKE '/dev/%'
        OR directory LIKE '/dev/%'
        OR directory LIKE '/dev/%/.%'
        OR directory LIKE '/dev/.%'
      )
      AND path NOT LIKE '%/./%'
      AND path NOT LIKE '%/../%'
      AND exception_key NOT IN (
        '/dev/accel/,directory',
        '/dev/accel/accel,character',
        '/dev/acpi_thermal_rel,character',
        '/dev/autofs,character',
        '/dev/binder,character',
        '/dev/binderfs/,directory',
        '/dev/binderfs/binder-control,character',
        '/dev/binderfs/binder,character',
        '/dev/binderfs/features,directory',
        '/dev/binderfs/hwbinder,character',
        '/dev/binderfs/vndbinder,character',
        '/dev/block/,directory',
        '/dev/block/:,block',
        '/dev/bsg/,directory',
        '/dev/bsg/:::,character',
        '/dev/btrfs-control,character',
        '/dev/bus/,directory',
        '/dev/bus/usb,directory',
        '/dev/cdrom,block',
        '/dev/cec,character',
        '/dev/char/,directory',
        '/dev/char/:,character',
        '/dev/char/:,unknown',
        '/dev/console,character',
        '/dev/core,regular',
        '/dev/cpu_dma_latency,character',
        '/dev/cpu/,directory',
        '/dev/cpu/microcode',
        '/dev/cros_ec,character',
        '/dev/cuse,character',
        '/dev/data/,directory',
        '/dev/data/root,block',
        '/dev/dbc,character',
        '/dev/default/,directory',
        '/dev/disk/,directory',
        '/dev/gpt-auto-root,block',
        '/dev/ptp_kvm,character',
        '/dev/disk/by-diskseq,directory',
        '/dev/disk/by-dname,directory',
        '/dev/disk/by-id,directory',
        '/dev/disk/by-label,directory',
        '/dev/disk/by-loop-inode,directory',
        '/dev/disk/by-loop-ref,directory',
        '/dev/disk/by-partlabel,directory',
        '/dev/disk/by-partuuid,directory',
        '/dev/disk/by-path,directory',
        '/dev/disk/by-uuid,directory',
        '/dev/dm-,block',
        '/dev/dma_heap/,directory',
        '/dev/dma_heap/system,character',
        '/dev/dri/,directory',
        '/dev/dri/by-path,directory',
        '/dev/dri/card,character',
        '/dev/dri/renderD,character',
        '/dev/drm_dp_aux,character',
        '/dev/ecryptfs,character',
        '/dev/fb,character',
        '/dev/fd/,character',
        '/dev/fd/,directory',
        '/dev/fd/,fifo',
        '/dev/fd/,regular',
        '/dev/fd/,socket',
        '/dev/fd/,unknown',
        '/dev/full,character',
        '/dev/fuse,character',
        '/dev/gpiochip,character',
        '/dev/HID-SENSOR-e..auto,character',
        '/dev/hidraw,character',
        '/dev/hpet,character',
        '/dev/hugepages/,directory',
        '/dev/hugepages/libvirt,directory',
        '/dev/hwbinder,character',
        '/dev/hwrng,character',
        '/dev/ic-,character',
        '/dev/iio:device,character',
        '/dev/initctl,fifo',
        '/dev/infiniband/,directory',
        '/dev/input/,directory',
        '/dev/input/by-id,directory',
        '/dev/input/by-path,directory',
        '/dev/input/event,character',
        '/dev/input/js,character',
        '/dev/input/mice,character',
        '/dev/input/mouse,character',
        '/dev/iommu,character',
        '/dev/ipu-psys,character',
        '/dev/kfd,character',
        '/dev/kmsg,character',
        '/dev/kvm,character',
        '/dev/libmtp--,character',
        '/dev/libmtp--.,character',
        '/dev/log,socket',
        '/dev/loop-control,character',
        '/dev/loop,block',
        '/dev/lp,character',
        '/dev/mcelog,character',
        '/dev/media,character',
        '/dev/mei,character',
        '/dev/mem,character',
        '/dev/mqueue/,directory',
        '/dev/mtd,character',
        '/dev/mtd/,directory',
        '/dev/mtd/by-name,directory',
        '/dev/mtdro,character',
        '/dev/nbd,block',
        '/dev/nbdp,block',
        '/dev/net/,directory',
        '/dev/net/tun,character',
        '/dev/ngn,character',
        '/dev/ntsync,character',
        '/dev/null,character',
        '/dev/nvidia-caps/,directory',
        '/dev/nvidia-caps/nvidia-cap,character',
        '/dev/nvidia-modeset,character',
        '/dev/nvidia-uvm-tools,character',
        '/dev/nvidia-uvm,character',
        '/dev/nvidia,character',
        '/dev/nvidiactl,character',
        '/dev/nvme,character',
        '/dev/nvme-fabrics,character',
        '/dev/nvmen,block',
        '/dev/nvmenp,block',
        '/dev/nvram,character',
        '/dev/port,character',
        '/dev/ppp,character',
        '/dev/pps,character',
        '/dev/psaux,character',
        '/dev/ptmx,character',
        '/dev/ptp,character',
        '/dev/pts/,character',
        '/dev/pts/,directory',
        '/dev/pts/ptmx,character',
        '/dev/random,character',
        '/dev/rfkill,character',
        '/dev/rtc,character',
        '/dev/sda,block',
        '/dev/sdb,block',
        '/dev/sdc,block',
        '/dev/sdd,block',
        '/dev/sde,block',
        '/dev/sdf,block',
        '/dev/sdg,block',
        '/dev/sdh,block',
        '/dev/sdi,block',
        '/dev/serial/,directory',
        '/dev/serial/by-id,directory',
        '/dev/serial/by-path,directory',
        '/dev/sg,character',
        '/dev/sgx_provision',
        '/dev/shm/,directory',
        '/dev/shm/.org.chromium.Chromium.NjobT,regular',
        '/dev/shm/envoy_shared_memory_,regular',
        '/dev/shm/jack_db-,directory',
        '/dev/shm/libpod_lock,regular',
        '/dev/shm/libpod_rootless_lock_,regular',
        '/dev/shm/lttng-ust-wait--,regular',
        '/dev/shm/lttng-ust-wait-,regular',
        '/dev/snapshot,character',
        '/dev/snd/,directory',
        '/dev/snd/by-id,directory',
        '/dev/snd/by-path,directory',
        '/dev/snd/controlC,character',
        '/dev/snd/hwCD,character',
        '/dev/snd/pcmCDc,character',
        '/dev/snd/pcmCDp,character',
        '/dev/snd/seq,character',
        '/dev/snd/timer,character',
        '/dev/sr,block',
        '/dev/stderr,character',
        '/dev/stderr,fifo',
        '/dev/stdin,character',
        '/dev/stdin,fifo',
        '/dev/stdout,character',
        '/dev/stdout,fifo',
        '/dev/tee,character',
        '/dev/tpm,character',
        '/dev/tpmrm,character',
        '/dev/tty,character',
        '/dev/ttyUSB,character',
        '/dev/ttyACM,character',
        '/dev/ttyprintk,character',
        '/dev/ttyS,character',
        '/dev/ubuntu-vg/,directory',
        '/dev/udmabuf,character',
        '/dev/uhid,character',
        '/dev/uinput,character',
        '/dev/urandom,character',
        '/dev/usb/,directory',
        '/dev/usb/hiddev,character',
        '/dev/usbmon,character',
        '/dev/userfaultfd,character',
        '/dev/userio,character',
        '/dev/vcs,character',
        '/dev/vcsa,character',
        '/dev/vcsu,character',
        '/dev/vfio/,directory',
        '/dev/vfio/vfio,character',
        '/dev/vga_arbiter,character',
        '/dev/vgubuntu/,directory',
        '/dev/vgubuntu/incus-default,block',
        '/dev/vgubuntu/root,block',
        '/dev/vgubuntu/swap_,block',
        '/dev/vgubuntu/swap,block',
        '/dev/vhba_ctl,character',
        '/dev/vhci,character',
        '/dev/vhost-net,character',
        '/dev/vhost-net',
        '/dev/vhost-vsock,character',
        '/dev/vhost-vsock',
        '/dev/video,character',
        '/dev/vl-subdev,character',
        '/dev/vl/,directory',
        '/dev/vl/by-id,directory',
        '/dev/vl/by-path,directory',
        '/dev/vlloopback,character',
        '/dev/vndbinder,character',
        '/dev/vsock,character',
        '/dev/watchdog,character',
        '/dev/wwanat,character',
        '/dev/wwanmbim,character',
        '/dev/wwanqcdm,character',
        '/dev/zd,block',
        '/dev/zero,character',
        '/dev/zfs,character',
        '/dev/zram,block',
        '/dev/zvol/,directory',
        '/dev/zvol/rpool,directory'
      )
      AND NOT path LIKE '/dev/%-vg/%-lv'
      AND NOT path LIKE '/dev/mapper/%'
      AND NOT path LIKE '/dev/mqueue/us.zoom.aom.%'
      AND NOT path LIKE '/dev/shm/.com.google.Chrome.%'
      AND NOT path LIKE '/dev/shm/.com.microsoft.Edge.%'
      AND NOT path LIKE '/dev/shm/.org.chromium.Chromium.%'
      AND NOT path LIKE '/dev/shm/aomshm.%'
      AND NOT path LIKE '/dev/shm/%CefRaster%'
      AND NOT path LIKE '/dev/shm/xapp-tmp-%'
      AND NOT path LIKE '/dev/shm/byobu-%'
      AND NOT path LIKE '/dev/shm/lsp-catalog-%.lock'
      AND NOT path LIKE '/dev/shm/flatpak-com.brave.Browser-%'
      AND NOT path LIKE '/dev/shm/libv4l-%'
      AND NOT path LIKE '/dev/shm/sem.mp-%'
      AND NOT path LIKE '/dev/shm/sem.rpc%'
      AND NOT path LIKE '/dev/shm/u%-Shm_%'
      AND NOT path LIKE '/dev/shm/u%-ValveIPC%'
      AND NOT (
        directory = '/dev/shm/'
        AND type = 'regular'
        AND mode = '0666'
        AND uid IN (0, 1000, 1001)
        AND size IN (32, 4096)
      )
      AND NOT exception_key LIKE '/dev/vg%/,directory'
      AND NOT exception_key LIKE '/dev/vg%/root,block'
      AND NOT exception_key LIKE '/dev/vg%/swap%,block'
      AND NOT exception_key LIKE '/dev/%vg/,directory'
      AND NOT exception_key LIKE '/dev/%vg/root,block'
      AND NOT exception_key LIKE '/dev/%vg/swap%,block'
      AND NOT exception_key LIKE '/dev/default/%,block'
      AND NOT exception_key LIKE '/dev/shm/lsp-catalog-%.shm,regular'
    GROUP BY
      exception_key
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Global Lock"
  description: Find unexpected world readable run locks
  query: |
    SELECT
      *,
      CONCAT (
        MIN(file.uid, 500),
        ",",
        file.gid,
        ",",
        file.path,
        ",",
        file.type,
        ',',
        mode
      ) AS exception_key
    FROM
      file
    WHERE
      (
        path LIKE "/dev/mqueue/.%.lock"
        OR path LIKE "/dev/mqueue/%.lock"
        OR path LIKE "/dev/shm/.%.lock"
        OR path LIKE "/dev/shm/%.lock"
        OR path LIKE "/tmp/.%.lock"
        OR path LIKE "/tmp/%.lock"
        OR path LIKE "/var/run/.%.lock"
        OR path LIKE "/var/run/%.lock"
        OR path LIKE "/var/tmp/.%.lock"
        OR path LIKE "/var/tmp/%.lock"
      )
      AND exception_key NOT IN (
        '0,0,/var/run/apport.lock,regular,0600',
        '0,0,/var/run/dnf-metadata.lock,regular,0644',
        '0,0,/var/run/ublue-update.lock,regular,0755',
        '0,0,/var/run/ufw.lock,regular,0644',
        '0,0,/var/run/unattended-upgrades.lock,regular,0640',
        '0,0,/var/run/uupd.lock,regular,0644',
        '0,0,/var/run/xtables.lock,regular,0600',
        '0,1,/var/run/prl_desktop_services.lock,regular,0644',
        '0,1,/var/run/prl_desktop_services_foreground.lock,regular,0644',
        '0,1,/var/run/VMware Fusion Services.lock,regular,0600',
        '0,1,/var/run/xv-update-resolv-conf.lock,regular,0600',
        '0,1001,/var/run/keyd.socket.lock,regular,0600',
        '500,0,/tmp/mysql.sock.lock,regular,0600',
        '500,0,/tmp/mysqlx.sock.lock,regular,0600',
        '500,0,/tmp/write.lock,regular,0644',
        '500,1000,/tmp/1000-nwg-bar.lock,regular,0600',
        '500,1000,/tmp/golangci-lint.lock,regular,0600',
        '500,1000,/tmp/minecraftlauncher.1000.pid.lock,regular,0664',
        '500,1001,/tmp/nwg-dock.lock,regular,0600',
        '74,0,/tmp/mysql.sock.lock,regular,0600',
        '74,0,/tmp/mysqlx.sock.lock,regular,0600'
      )
      AND NOT exception_key LIKE '500,0,/tmp/.s.PGSQL.%.lock,regular,0600'
      AND NOT exception_key LIKE '500,1000,/tmp/keepassxc-%.lock,regular,0644'
      AND NOT exception_key LIKE '500,1000,/tmp/keepassxc-%.lock,regular,0664'
      AND NOT exception_key LIKE '500,1000,/tmp/vscode-remote-ssh-%-install.lock,regular,0664'
      AND NOT exception_key LIKE '500,1000,/tmp/%.eksctl.lock,regular,0600'
      AND NOT exception_key LIKE '500,1000,/dev/shm/lsp-catalog-%.lock,regular,0664'
      AND NOT exception_key LIKE '500,0,/tmp/uv-%.lock,regular,0777'
      AND NOT exception_key LIKE '500,1000,/tmp/uv-%.lock,regular,0777'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Listening Port Linux"
  description: Unexpected programs listening on a TCP port (state-based).
  query: |
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      p.euid,
      p.cgroup_path,
      p.parent,
      p.pid,
      p.name,
      p.path,
      p.cmdline AS p0_cmd,
      p_p.cmdline AS p1_cmd,
      p_p_p.cmdline AS p2_cmd,
      p.cgroup_path,
      datetime(file.mtime, 'unixepoch') AS mtime,
      p.cwd,
      hash.sha256,
      CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name
      ) AS exception_key
    FROM
      listening_ports lp
      LEFT JOIN processes p ON lp.pid = p.pid
      LEFT JOIN processes p_p ON p.parent = p_p.pid
      LEFT JOIN processes p_p_p ON p_p.parent = p_p_p.pid
      LEFT JOIN file ON p.path = file.path
      LEFT JOIN hash ON p.path = hash.path
    WHERE
      port != 0
      AND lp.address NOT IN ('224.0.0.251', '::1', '127.0.0.1', '127.1.1.1')
      AND lp.address NOT LIKE '127.0.0.%'
      AND lp.address NOT LIKE '172.1%'
      AND lp.address NOT LIKE 'fe80::%'
      AND lp.address NOT LIKE '::ffff:127.0.0.%'
      -- All outgoing UDP (protocol 17) sessions are 'listening'
      AND NOT (
        lp.protocol = 17
        AND lp.port > 1024
      )
      -- Random webservers
      AND NOT (
        p.uid > 500
        AND lp.port IN (8000, 8080)
        AND lp.protocol = 6
      )
      -- Filter out unmapped raw sockets
      AND NOT p.pid = ''
      -- Exceptions: the uid is capped at 500 to represent regular users versus system users
      -- port is capped at 32768 to represent transient ports
      AND NOT CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name
      ) IN (
        '1,1,500,ping',
        '1,255,500,mtr-packet',
        '1,255,500,ping',
        '10250,6,0,k3s-server',
        '10250,6,0,kubelet',
        '10250,6,500,kubelet',
        '10250,6,500,metrics-server',
        '10254,6,101,nginx-ingress-c',
        '10256,6,0,kube-proxy',
        '10256,6,500,kube-proxy',
        '1337,6,500,kdenlive',
        '1601,6,500,rsyslogd',
        '17,255,0,.tailscaled-wra',
        '17,255,0,dhcpcd',
        '17,255,0,tailscaled',
        '17,255,500,dhcpcd',
        '17,255,500,mtr-packet',
        '1716,6,500,daemon.js',
        '1716,6,500,gjs',
        '1716,6,500,kdeconnectd',
        '17500,6,500,dropbox',
        '18000,6,500,kourier',
        '22,6,0,sshd',
        '22,6,0,systemd',
        '22,6,500,sshd',
        '22,6,500,systemd',
        '22000,6,500,syncthing',
        '2222,6,500,qemu-system-x86',
        '2379,6,500,etcd',
        '2380,6,500,etcd',
        '24800,6,500,synergy-core',
        '24802,6,500,synergy-service',
        '25,6,500,master',
        '255,255,0,atop',
        '255,255,500,mtr-packet',
        '27036,6,500,steam',
        '27500,6,500,passimd',
        '3000,6,472,grafana-server',
        '3000,6,500,grafana',
        '3000,6,500,grafana-server',
        '3000,6,500,node',
        '32768,6,0,.tailscaled-wra',
        '32768,6,0,tailscaled',
        '32768,6,500,com.docker.back',
        '32768,6,500,com.docker.backend',
        '32768,6,500,dleyna-renderer',
        '32768,6,500,goland',
        '32768,6,500,java',
        '32768,6,500,jetbrains-toolb',
        '32768,6,500,pycharm',
        '32768,6,500,rootlesskit',
        '32768,6,500,spotify',
        '32768,6,500,writerside',
        '3551,6,0,apcupsd',
        '4143,6,500,linkerd2-proxy',
        '4191,6,500,linkerd2-proxy',
        '443,6,0,docker-proxy',
        '443,6,0,tailscaled',
        '443,6,500,jcef_helper',
        '4443,6,500,metrics-server',
        '5000,6,0,registry',
        '5000,6,500,ControlCenter',
        '5000,6,500,registry',
        '5001,6,0,registry',
        '5005,6,500,rootlesskit',
        '5050,6,500,rootlesskit',
        '5355,6,193,systemd-resolve',
        '5355,6,500,systemd-resolve',
        '5432,6,70,postgres',
        '546,17,500,dhcpcd',
        '5556,6,500,dex',
        '5556,6,500,openshot-qt',
        '5558,6,500,dex',
        '58,255,0,dhcpcd',
        '58,255,0,NetworkManager',
        '58,255,100,dhcpcd',
        '58,255,100,systemd-network',
        '58,255,500,dhcpcd',
        '58,255,500,dnsmasq',
        '58,255,500,mtr-packet',
        '58,255,500,ping',
        '58,255,500,systemd-network',
        '631,17,0,cups-browsed',
        '631,17,115,cups-browsed',
        '631,17,116,cups-browsed',
        '631,17,121,cups-browsed',
        '631,17,132,cups-browsed',
        '631,17,133,cups-browsed',
        '6379,6,500,redis-server',
        '6443,6,0,k3s-server',
        '6443,6,0,kube-apiserver',
        '6443,6,500,kube-apiserver',
        '68,17,0,dhclient',
        '68,17,100,dhcpcd',
        '68,17,100,systemd-network',
        '68,17,500,dhcpcd',
        '68,17,500,systemd-network',
        '7000,6,500,ControlCenter',
        '80,6,0,apache2',
        '80,6,0,docker-proxy',
        '80,6,101,nginx',
        '80,6,33,apache2',
        '80,6,60,nginx',
        '8001,6,500,__debug_bin,',
        '8008,6,500,activator',
        '8008,6,500,autoscaler',
        '8008,6,500,controlplane',
        '8008,6,500,resolvers',
        '8008,6,500,webhook',
        '8009,6,0,java',
        '8080,6,0,coredns',
        '8080,6,0,java',
        '8081,6,500,main',
        '8086,6,0,influxd',
        '8086,6,500,controller',
        '8086,6,500,influxd',
        '8090,6,500,linkerd-policy-',
        '8123,6,500,Brackets-node',
        '8181,6,0,coredns',
        '8181,6,500,coredns',
        '8443,6,0,kube-apiserver',
        '8443,6,101,nginx-ingress-c',
        '8443,6,500,controller',
        '8443,6,500,controlplane',
        '8443,6,500,traefik',
        '8443,6,500,webhook',
        '8834,6,0,nessusd',
        '9000,6,500,authentik-proxy',
        '9000,6,500,main',
        '9000,6,500,traefik',
        '9090,6,500,controlplane',
        '9153,6,0,coredns',
        '9153,6,500,coredns',
        '9300,6,500,authentik-proxy',
        '9880,6,500,rootlesskit',
        '9999,6,500,python3'
      )
      AND NOT (
        p.path LIKE '/ko-app/%'
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.path LIKE '%/rootlesskit'
        AND lp.port > 1024
        and lp.protocol = 6
      )
    
      AND NOT (
        p.name IN (
          'caddy',
          'com.docker.back',
          'controller',
          'crane',
          'docker-proxy',
          'hugo',
          'kubectl',
          'nginx-ingress-c',
          'node',
          'qemu-system-x86',
          'rootlessport',
          'webhook'
        )
        AND lp.port > 1024
        and lp.protocol = 6
      )
      -- Exclude common/default DNS talking
      AND NOT (
        p.name IN ('aardvark-dns', 'coredns', 'dnsmasq')
        AND lp.port IN (
          53, -- DNS
          67, -- DHCP/BOOTP
          547 -- DHCPv6 server
        )
        AND lp.protocol IN (
          6, -- TCP
          17 -- UDP
        )
      )
      -- Exclude processes running inside of Docker containers
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p.cgroup_path LIKE '/kubepods.slice/%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/docker-%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'
      AND NOT p.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'
      AND NOT p1_cmd LIKE 'bwrap --bind%'
    GROUP BY
      exception_key
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Systemctl Calls Linux"
  description: Suspicious calls to systemctl(event-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.time AS p0_time,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      uptime.total_seconds > 30 -- NOTE: The remainder of this query is synced with unexpected-fetcher-parents
      AND pe.path IN (
        '/bin/systemctl',
        '/sbin/systemctl',
        '/usr/bin/systemctl'
      )
      AND pe.cmdline != ''
      AND pe.time > (strftime('%s', 'now') -300)
      AND NOT exception_key IN (
        'systemctl,0,,containerd-shim-runc-v2',
        'systemctl,0,apt-helper,',
        'systemctl,0,bash,pacman',
        'systemctl,0,dash,logrotate',
        'systemctl,0,kubeadm,containerd-shim-runc-v2',
        'systemctl,0,pacman,pacman',
        'systemctl,0,pacman,sudo',
        'systemctl,0,snapd,systemd',
        'systemctl,0,tailscaled,',
        'systemctl,120,systemd-executor,systemd',
        'systemctl,127,snap,systemd',
        'systemctl,128,systemd,systemd',
        'systemctl,500,bash,gnome-terminal-server',
        'systemctl,500,snap,systemd',
        'systemctl,500,snap,update-notifier',
        'systemctl,500,snapd,systemd',
        'systemctl,500,strace,bash',
        'systemctl,500,systemd,',
        'systemctl,500,systemd,systemd',
        'systemctl,500,zsh,tmux'
      )
      AND NOT p0_cmd IN (
        '/bin/systemctl --quiet is-enabled whoopsie.path',
        '/bin/systemctl -q is-enabled whoopsie.path',
        '/bin/systemctl is-enabled -q whoopsie.path',
        '/bin/systemctl stop --no-block nvidia-persistenced',
        '/sbin/runlevel',
        '/usr/bin/systemctl --user is-active slack',
        '/usr/bin/systemctl is-system-running',
        '/usr/bin/systemctl try-reload-or-restart dbus',
        'systemctl --quiet is-enabled cups.service',
        'systemctl --system daemon-reexec',
        'systemctl --user import-environment DISPLAY XAUTHORITY',
        'systemctl --user is-active slack',
        'systemctl -p LoadState show cups.service',
        'systemctl -q is-enabled whoopsie',
        'systemctl is-active systemd-resolved.service',
        'systemctl is-enabled power-profiles-daemon.service',
        'systemctl is-enabled snapd.apparmor',
        'systemctl is-enabled systemd-rfkill.service',
        'systemctl is-enabled systemd-rfkill.socket',
        'systemctl is-enabled tlp.service',
        'systemctl is-system-running',
        'systemctl kill -s HUP rsyslog.service',
        'systemctl reboot',
        'systemctl restart cups.service',
        'systemctl restart NetworkManager.service',
        'systemctl restart reflector.service',
        'systemctl status kubelet',
        'systemctl stop kubelet',
        'systemctl stop libvirtd.service'
      ) -- apt-helper form
      AND NOT p0_cmd LIKE '/usr/bin/systemctl --user set-environment%'
      AND NOT p0_cmd LIKE '%systemctl --user set-environment DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%/bus'
      AND NOT p0_cmd LIKE '%systemctl % snap-kubectl-%.mount'
      AND NOT p0_cmd LIKE '%systemctl is-active -q %.service'
      AND NOT p0_cmd LIKE '%systemctl show --property=%'
    GROUP BY
      pe.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Uid0 Daemon Linux"
  description: Unexpected long-running processes running as root
  query: |
    SELECT
      CONCAT (
        p0.name,
        ',',
        REPLACE(
          p0.path,
          COALESCE(
            REGEX_MATCH (p0.path, "/nix/store/(.*?)/.*", 1),
            REGEX_MATCH (p0.path, "(\d[\.\d]+)", 1),
            "3.11"
          ),
          "__VERSION__"
        ),
        ',',
        -- This is intentionally not euid, as everything is euid 0
        p0.uid,
        ',',
        CONCAT (
          SPLIT (p0.cgroup_path, "/", 0),
          ",",
          SPLIT (p0.cgroup_path, "/", 1)
        ),
        ',',
        f.mode
      ) AS exception_key,
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid = 0
      AND p0.parent > 0
      AND p0.path != ""
      AND p0.start_time < (strftime('%s', 'now') - 3600)
      AND exception_key NOT IN (
        '(sd-pam),/usr/lib/systemd/systemd,0,user.slice,user-0.slice,0755',
        '(sd-pam),/usr/lib/systemd/systemd-executor,0,user.slice,user-0.slice,0755',
        '(udev-worker),/usr/bin/udevadm,0,system.slice,systemd-udevd.service,0755',
        '.tailscaled-wra,/nix/store/__VERSION__/bin/.tailscaled-wrapped,0,system.slice,tailscaled.service,0555',
        '/usr/bin/monito,/usr/bin/perl,0,system.slice,monitorix.service,0755',
        'abrt-dump-journ,/usr/bin/abrt-dump-journal-core,0,system.slice,abrt-journal-core.service,0755',
        'abrt-dump-journ,/usr/bin/abrt-dump-journal-oops,0,system.slice,abrt-oops.service,0755',
        'abrt-dump-journ,/usr/bin/abrt-dump-journal-xorg,0,system.slice,abrt-xorg.service,0755',
        'abrtd,/usr/bin/abrtd,0,system.slice,abrtd.service,0755',
        'abrtd,/usr/sbin/abrtd,0,system.slice,abrtd.service,0755',
        'accounts-daemon,/nix/store/__VERSION__/libexec/accounts-daemon,0,system.slice,accounts-daemon.service,0555',
        'accounts-daemon,/usr/lib/accounts-daemon,0,system.slice,accounts-daemon.service,0755',
        'accounts-daemon,/usr/libexec/accounts-daemon,0,system.slice,accounts-daemon.service,0755',
        'acpid,/usr/sbin/acpid,0,system.slice,acpid.service,0755',
        'agetty,/nix/store/__VERSION__/bin/agetty,0,system.slice,system-getty.slice,0555',
        'agetty,/usr/bin/agetty,0,system.slice,system-getty.slice,0755',
        'agetty,/usr/sbin/agetty,0,system.slice,system-getty.slice,0755',
        'agetty,/usr/sbin/agetty,0,system.slice,system-serial\x2dgetty.slice,0755',
        'alsactl,/usr/bin/alsactl,0,system.slice,alsa-state.service,0755',
        'alsactl,/usr/sbin/alsactl,0,system.slice,alsa-state.service,0755',
        'anacron,/usr/bin/anacron,0,system.slice,cronie.service,0755',
        'anacron,/usr/sbin/anacron,0,system.slice,anacron.service,0755',
        'anacron,/usr/sbin/anacron,0,system.slice,crond.service,0755',
        'apache2,/usr/sbin/apache2,0,system.slice,apache2.service,0755',
        'apcupsd,/usr/bin/apcupsd,0,system.slice,apcupsd.service,0755',
        'apt,/usr/bin/apt,0,user.slice,user-1000.slice,0755',
        'apt-get,/usr/bin/apt-get,0,system.slice,apt-daily.service,0755',
        'apt.systemd.dai,/usr/bin/dash,0,system.slice,apt-daily-upgrade.service,0755',
        'apt.systemd.dai,/usr/bin/dash,0,system.slice,apt-daily.service,0755',
        'atd,/usr/bin/atd,0,system.slice,atd.service,0755',
        'atd,/usr/sbin/atd,0,system.slice,atd.service,0755',
        'atop,/usr/bin/atop,0,system.slice,atop.service,0755',
        'atopacctd,/usr/sbin/atopacctd,0,system.slice,atopacct.service,0755',
        'auditd,/usr/bin/auditd,0,system.slice,auditd.service,0755',
        'auditd,/usr/sbin/auditd,0,system.slice,auditd.service,0750',
        'auditd,/usr/sbin/auditd,0,system.slice,auditd.service,0755',
        'authd,/usr/libexec/authd,0,system.slice,authd.service,0755',
        'bash,/usr/bin/bash,0,user.slice,user-1000.slice,0755',
        'blueman-mechani,/usr/bin/python__VERSION__,0,system.slice,blueman-mechanism.service,0755',
        'blueman-mechanism.service,Bluetooth management mechanism,,200',
        'bluetoothd,/usr/lib/bluetooth/bluetoothd,0,system.slice,bluetooth.service,0755',
        'bluetoothd,/usr/libexec/bluetooth/bluetoothd,0,system.slice,bluetooth.service,0755',
        'boltd,/usr/lib/boltd,0,system.slice,bolt.service,0755',
        'boltd,/usr/libexec/boltd,0,system.slice,bolt.service,0755',
        'bpfilter_umh,/bpfilter_umh,0,,,',
        'canonical-livep,/snap/canonical-livepatch/__VERSION__/canonical-livepatchd,0,system.slice,snap.canonical-livepatch.canonical-livepatchd.service,0755',
        'cat,/usr/bin/cat,0,user.slice,user-0.slice,0755',
        'chainctl,/usr/local/bin/chainctl,0,user.slice,user-1000.slice,0755',
        'containerd,/nix/store/__VERSION__/bin/containerd,0,system.slice,docker.service,0555',
        'containerd,/snap/docker/__VERSION__/bin/containerd,0,system.slice,snap.docker.dockerd.service,0755',
        'containerd,/usr/bin/containerd,0,system.slice,containerd.service,0755',
        'containerd,/usr/bin/containerd,0,system.slice,docker.service,0755',
        'containerd,/usr/sbin/containerd,0,system.slice,docker.service,0755',
        'containerd-shim,/usr/bin/containerd-shim-runc-v2,0,system.slice,containerd.service,0755',
        'containerd-shim,/usr/bin/containerd-shim-runc-v2,0,system.slice,docker.service,0755',
        'containerd,/snap/docker/__VERSION__/bin/containerd,0,system.slice,snap.docker.dockerd.service,0755',
        'cron,/usr/sbin/cron,0,system.slice,cron.service,0755',
        'crond,/usr/bin/crond,0,system.slice,crond.service,0755',
        'crond,/usr/bin/crond,0,system.slice,cronie.service,0755',
        'crond,/usr/sbin/crond,0,system.slice,crond.service,0755',
        'cups-browsed,/usr/sbin/cups-browsed,0,system.slice,cups-browsed.service,0755',
        'cups-proxyd,/snap/cups/__VERSION__/sbin/cups-proxyd,0,system.slice,snap.cups.cupsd.service,0755',
        'cupsd,/snap/cups/__VERSION__/sbin/cupsd,0,system.slice,snap.cups.cupsd.service,0700',
        'cupsd,/usr/bin/cupsd,0,system.slice,cups.service,0700',
        'cupsd,/usr/bin/cupsd,0,system.slice,system-cups.slice,0755',
        'cupsd,/usr/sbin/cupsd,0,system.slice,cups.service,0755',
        'cupsd,/usr/sbin/cupsd,0,system.slice,system-cups.slice,0700',
        'cupsd,/usr/sbin/cupsd,0,system.slice,system-cups.slice,0755',
        'daemon.start,/usr/bin/dash,0,,,0755',
        'dbus-broker,/usr/bin/dbus-broker,0,user.slice,user-0.slice,0755',
        'dbus-broker-lau,/usr/bin/dbus-broker-launch,0,user.slice,user-0.slice,0755',
        'dbus-daemon,/usr/bin/dbus-daemon,0,user.slice,user-0.slice,0755',
        'dbus-daemon,/usr/bin/dbus-daemon,0,user.slice,user-1000.slice,0755',
        'dbus-launch,/usr/bin/dbus-launch,0,user.slice,user-1000.slice,0755',
        'dconf-service,/usr/libexec/dconf-service,0,user.slice,user-1000.slice,0755',
        'determinate-nix,/usr/local/bin/determinate-nixd,0,system.slice,nix-daemon.service,0555',
        'dhclient,/usr/sbin/dhclient,0,system.slice,networking.service,0755',
        'dhcpcd,/nix/store/__VERSION__/bin/dhcpcd,0,system.slice,dhcpcd.service,0555',
        'dirmngr,/usr/bin/dirmngr,0,system.slice,archlinux-keyring-wkd-sync.service,0755',
        'dirmngr,/usr/bin/dirmngr,0,system.slice,system-dirmngr.slice,0755',
        'DisplayLinkMana,/usr/libexec/displaylink/DisplayLinkManager,0,system.slice,displaylink.service,0755',
        'dmeventd,/usr/sbin/dmeventd,0,system.slice,dm-event.service,0755',
        'dnf,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'dnsmasq,/usr/bin/dnsmasq,0,system.slice,libvirtd.service,0755',
        'dnsmasq,/usr/sbin/dnsmasq,0,system.slice,libvirtd.service,0755',
        'doas,/usr/bin/doas,1000,user.slice,user-1000.slice,4755',
        'docker,/usr/bin/docker,0,user.slice,user-1000.slice,0755',
        'docker,/usr/local/bin/docker,0,user.slice,user-1000.slice,0755',
        'docker-proxy,/usr/bin/docker-proxy,0,system.slice,docker.service,0755',
        'docker-proxy,/usr/libexec/docker/docker-proxy,0,system.slice,docker.service,0755',
        'dockerd,/nix/store/__VERSION__/libexec/docker/dockerd,0,system.slice,docker.service,0555',
        'dockerd,/snap/docker/__VERSION__/bin/dockerd,0,system.slice,snap.docker.dockerd.service,0755',
        'dockerd,/usr/bin/dockerd,0,system.slice,docker.service,0755',
        'dockerd,/usr/sbin/dockerd,0,system.slice,docker.service,0755',
        'dovecot,/usr/sbin/dovecot,0,system.slice,dovecot.service,0755',
        'dpkg,/usr/bin/dpkg,0,user.slice,user-1000.slice,0755',
        'elastic-endpoin,/opt/Elastic/Endpoint/elastic-endpoint,0,elasticendpoint,,0500',
        'elastic-endpoin,/opt/Elastic/Endpoint/elastic-endpoint,0,system.slice,ElasticEndpoint.service,0500',
        'elastic-endpoin,/var/opt/Elastic/Endpoint/elastic-endpoint,0,elasticendpoint,,0500',
        'execsnoop-bpfcc,/usr/bin/python__VERSION__,0,system.slice,com.system76.Scheduler.service,0755',
        'firewalld,/usr/bin/python__VERSION__,0,system.slice,firewalld.service,0755',
        'fish,/usr/bin/fish,0,user.slice,user-1000.slice,0755',
        'flatpak-system-,/usr/lib/flatpak-system-helper,0,system.slice,flatpak-system-helper.service,0755',
        'flatpak-system-,/usr/libexec/flatpak-system-helper,0,system.slice,flatpak-system-helper.service,0755',
        'flatpak-system-,/usr/libexec/flatpak-system-helper,0,user.slice,user-0.slice,0755',
        'flock,/usr/bin/flock,0,system.slice,system-btrfs\x2ddedup.slice,0755',
        'fprintd,/usr/libexec/fprintd,0,system.slice,fprintd.service,0755',
        'frontend,/usr/bin/perl,0,user.slice,user-1000.slice,0755',
        'fstrim,/usr/sbin/fstrim,0,system.slice,fstrim.service,0755',
        'fusermount,/usr/bin/fusermount,1000,user.slice,user-1000.slice,4755',
        'fwupd,/usr/lib/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'fwupd,/usr/libexec/fwupd/fwupd,0,system.slice,fwupd.service,0755',
        'gdisk,/usr/sbin/gdisk,0,user.slice,user-1000.slice,0755',
        'gdm,/usr/bin/gdm,0,system.slice,gdm.service,0755',
        'gdm,/usr/sbin/gdm,0,system.slice,display-manager.service,0755',
        'gdm,/usr/sbin/gdm,0,system.slice,gdm.service,0755',
        'gdm-session-wor,/usr/lib/gdm-session-worker,0,user.slice,user-1000.slice,0755',
        'gdm-session-wor,/usr/lib/gdm-session-worker,0,user.slice,user-120.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-1000.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-1001.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-120.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-128.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm-session-worker,0,user.slice,user-42.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm/gdm-session-worker,0,user.slice,user-1000.slice,0755',
        'gdm-session-wor,/usr/libexec/gdm/gdm-session-worker,0,user.slice,user-463.slice,0755',
        'gdm3,/usr/sbin/gdm3,0,system.slice,gdm.service,0755',
        'geoclue.service,Location Lookup Service,geoclue,500',
        'gjs,/snap/surfshark/__VERSION__/usr/bin/gjs-console,0,system.slice,snap.surfshark.surfsharkd.service,0755',
        'gjs,/snap/surfshark/__VERSION__/usr/bin/gjs-console,0,system.slice,snap.surfshark.surfsharkd2.service,0755',
        'glances,/usr/bin/python__VERSION__,0,system.slice,glances.service,0755',
        'gnome-keyring-d,/usr/bin/gnome-keyring-daemon,0,user.slice,user-1000.slice,0755',
        'google_guest_ag,/usr/bin/google_guest_agent,0,system.slice,google-guest-agent.service,0755',
        'google_guest_ag,/usr/bin/google_guest_agent_manager,0,system.slice,google-guest-agent-manager.service,0755',
        'gpg-agent,/usr/bin/gpg-agent,0,system.slice,fwupd.service,0755',
        'gpg-agent,/usr/bin/gpg-agent,0,system.slice,packagekit.service,0755',
        'gpg-agent,/usr/bin/gpg-agent,0,user.slice,user-1000.slice,0755',
        'greetd,/usr/sbin/greetd,0,system.slice,greetd.service,0755',
        'greetd,/usr/sbin/greetd,0,user.slice,user-1000.slice,0755',
        'group-admin-dae,/usr/libexec/group-admin-daemon,0,system.slice,group-admin-daemon.service,0755',
        'gssproxy,/usr/bin/gssproxy,0,system.slice,gssproxy.service,0755',
        'gssproxy,/usr/sbin/gssproxy,0,system.slice,gssproxy.service,0755',
        'gvfsd,/usr/libexec/gvfsd,0,user.slice,user-1000.slice,0755',
        'gvfsd-fuse,/usr/libexec/gvfsd-fuse,0,user.slice,user-1000.slice,0755',
        'haproxy,/usr/sbin/haproxy,0,system.slice,haproxy.service,0755',
        'iio-sensor-prox,/usr/lib/iio-sensor-proxy,0,system.slice,iio-sensor-proxy.service,0755',
        'iio-sensor-prox,/usr/libexec/iio-sensor-proxy,0,system.slice,iio-sensor-proxy.service,0755',
        'incusd,/opt/incus/bin/incusd,0,lxc.monitor.dashing-bat,,0755',
        'incusd,/opt/incus/bin/incusd,0,lxc.monitor.j1,,0755',
        'incusd,/opt/incus/bin/incusd,0,lxc.monitor.j1c,,0755',
        'incusd,/opt/incus/bin/incusd,0,system.slice,incus.service,0755',
        'incusd,/usr/libexec/incus/incusd,0,lxc.monitor.cheerful-parakeet,,0755',
        'incusd,/usr/libexec/incus/incusd,0,lxc.monitor.pure-dodo,,0755',
        'incusd,/usr/libexec/incus/incusd,0,system.slice,incus.service,0755',
        'indicator-cpufr,/usr/bin/python__VERSION__,0,system.slice,dbus.service,0755',
        'input-remapper-,/usr/bin/python__VERSION__,0,system.slice,input-remapper.service,0755',
        'iotop,/usr/sbin/iotop-c,0,user.slice,user-1000.slice,0755',
        'ipp-usb,/usr/sbin/ipp-usb,0,system.slice,ipp-usb.service,0755',
        'ir_agent,/opt/rapid7/ir_agent/components/insight_agent/__VERSION__/ir_agent,0,system.slice,ir_agent.service,',
        'ir_agent,/opt/rapid7/ir_agent/components/insight_agent/__VERSION__/ir_agent,0,system.slice,ir_agent.service,0700',
        'ir_agent,/opt/rapid7/ir_agent/ir_agent,0,system.slice,ir_agent.service,',
        'ir_agent,/opt/rapid7/ir_agent/ir_agent,0,system.slice,ir_agent.service,0700',
        'irqbalance,/usr/bin/irqbalance,0,system.slice,irqbalance.service,0755',
        'irqbalance,/usr/sbin/irqbalance,0,system.slice,irqbalance.service,0755',
        'iwd,/usr/lib/iwd/iwd,0,system.slice,iwd.service,0755',
        'journalctl,/usr/bin/journalctl,0,user.slice,user-1000.slice,0755',
        'just,/usr/bin/just,0,user.slice,user-1000.slice,0755',
        'keyd,/usr/local/bin/keyd,0,system.slice,keyd.service,0755',
        'launcher,/opt/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/opt/kolide-k2/bin/launcher-updates/__VERSION__/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/usr/lib/opt/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/usr/local/kolide-k2/bin/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/usr/local/kolide-k2/bin/launcher-updates/__VERSION__/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/var/kolide-k2/k2device.kolide.com/updates/launcher/__VERSION__/launcher,0,system.slice,launcher.kolide-k2.service,0755',
        'launcher,/var/vanta/launcher,0,system.slice,vanta.service,0755',
        'libvirtd,/usr/bin/libvirtd,0,system.slice,libvirtd.service,0755',
        'libvirtd,/usr/sbin/libvirtd,0,system.slice,libvirtd.service,0755',
        'lightdm,/nix/store/__VERSION__/bin/lightdm,0,system.slice,display-manager.service,0555',
        'lightdm,/nix/store/__VERSION__/bin/lightdm,0,user.slice,user-1000.slice,0555',
        'lightdm,/nix/store/__VERSION__/bin/lightdm,0,user.slice,user-78.slice,0555',
        'lightdm,/usr/bin/lightdm,0,system.slice,lightdm.service,0755',
        'lightdm,/usr/bin/lightdm,0,user.slice,user-1000.slice,0755',
        'lightdm,/usr/bin/lightdm,0,user.slice,user-974.slice,0755',
        'lightdm,/usr/sbin/lightdm,0,system.slice,lightdm.service,0755',
        'lightdm,/usr/sbin/lightdm,0,user.slice,user-1000.slice,0755',
        'lima-guestagent,/usr/local/bin/lima-guestagent,0,system.slice,lima-guestagent.service,0755',
        'login,/usr/bin/login,0,user.slice,user-1000.slice,0755',
        'low-memory-moni,/usr/libexec/low-memory-monitor,0,system.slice,low-memory-monitor.service,0755',
        'lxc-monitord,/usr/lib/x86_64-linux-gnu/lxc/lxc-monitord,0,system.slice,lxc-monitord.service,0755',
        'lxc-monitord,/usr/libexec/lxc/lxc-monitord,0,system.slice,lxc-monitord.service,0755',
        'lxcfs,/opt/incus/bin/lxcfs,0,system.slice,incus-lxcfs.service,0755',
        'lxcfs,/snap/lxd/__VERSION__/bin/lxcfs,0,,,0755',
        'lxcfs,/usr/bin/lxcfs,0,system.slice,lxcfs.service,',
        'lxcfs,/usr/bin/lxcfs,0,system.slice,lxcfs.service,0755',
        'lxd,/snap/lxd/__VERSION__/sbin/lxd,0,,,0755',
        'make,/usr/bin/make,0,user.slice,user-1000.slice,0755',
        'master,/usr/lib/postfix/sbin/master,0,system.slice,system-postfix.slice,0755',
        'mbim-proxy,/usr/libexec/mbim-proxy,0,system.slice,ModemManager.service,0755',
        'mc,/usr/bin/mc,0,user.slice,user-0.slice,0755',
        'mcelog,/usr/bin/mcelog,0,system.slice,mcelog.service,0755',
        'mcelog,/usr/sbin/mcelog,0,system.slice,mcelog.service,0755',
        'metalauncher,/var/vanta/metalauncher,0,system.slice,vanta.service,0755',
        'mintUpdate,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'ModemManager,/usr/bin/ModemManager,0,system.slice,ModemManager.service,0755',
        'ModemManager,/usr/sbin/ModemManager,0,system.slice,ModemManager.service,0755',
        'mount.ntfs,/usr/bin/ntfs-3g,0,system.slice,udisks2.service,0755',
        'mpris-proxy,/usr/bin/mpris-proxy,0,user.slice,user-0.slice,0755',
        'multipassd,/snap/multipass/__VERSION__/bin/multipassd,0,system.slice,snap.multipass.multipassd.service,0755',
        'multipathd,/usr/sbin/multipathd,0,system.slice,multipathd.service,0755',
        'ncdu,/usr/bin/ncdu,0,user.slice,user-1000.slice,0755',
        'nessus-service,/opt/nessus/sbin/nessus-service,0,system.slice,nessusd.service,0755',
        'nessusd,/opt/nessus/sbin/nessusd,0,system.slice,nessusd.service,0755',
        'netavark,/usr/lib/podman/netavark,0,system.slice,netavark-firewalld-reload.service,0755',
        'networkd-dispat,/usr/bin/python__VERSION__,0,system.slice,networkd-dispatcher.service,0755',
        'NetworkManager,/usr/bin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'NetworkManager,/usr/sbin/NetworkManager,0,system.slice,NetworkManager.service,0755',
        'newgrp,/usr/bin/newgrp,1000,user.slice,user-1000.slice,4755',
        'nix-daemon,/nix/store/__VERSION__/bin/nix,0,system.slice,nix-daemon.service,0555',
        'nm-dispatcher,/usr/lib/nm-dispatcher,0,system.slice,NetworkManager-dispatcher.service,0755',
        'nm-dispatcher,/usr/libexec/nm-dispatcher,0,system.slice,NetworkManager-dispatcher.service,0755',
        'nm-openvpn-serv,/usr/libexec/nm-openvpn-service,0,system.slice,NetworkManager.service,0755',
        'nvidia-powerd,/usr/bin/nvidia-powerd,0,system.slice,nvidia-powerd.service,0755',
        'ollama,/snap/ollama/__VERSION__/bin/ollama,0,system.slice,snap.ollama.listener.service,0755',
        'ollama_llama_se,/tmp/ollama__VERSION__/runners/cpu_avx2/ollama_llama_server,0,system.slice,snap.ollama.listener.service,',
        'orbit,/opt/orbit/bin/orbit/linux/stable/orbit,0,system.slice,orbit.service,0755',
        'osquery-extensi,/nix/store/__VERSION__/bin/osquery-extension.ext,0,system.slice,kolide-launcher.service,0555',
        'osquery-vanta.e,/var/vanta/osquery-vanta.ext,0,system.slice,vanta.service,0755',
        'osqueryd,/nix/store/__VERSION__/bin/osqueryd,0,system.slice,kolide-launcher.service,0555',
        'osqueryd,/opt/orbit/bin/osqueryd/linux/stable/osqueryd,0,system.slice,orbit.service,0755',
        'osqueryd,/usr/lib/opt/kolide-k2/bin/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/usr/local/kolide-k2/bin/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/usr/local/kolide-k2/bin/osqueryd-updates/__VERSION__/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/var/kolide-k2/k2device.kolide.com/updates/osqueryd/__VERSION__/osqueryd,0,system.slice,launcher.kolide-k2.service,0755',
        'osqueryd,/var/vanta/osqueryd,0,system.slice,vanta.service,0755',
        'osqueryi,/usr/bin/osqueryd,0,user.slice,user-1000.slice,0755',
        'osqueryi,/var/usrlocal/bin/osqueryi,0,user.slice,user-1000.slice,0755',
        'ostree,/usr/bin/ostree,0,system.slice,ostree-finalize-staged-hold.service,0755',
        'packagekitd,/usr/libexec/packagekitd,0,system.slice,packagekit.service,0755',
        'pacman,/usr/bin/pacman,0,user.slice,user-1000.slice,0755',
        'pcscd,/snap/yubioath-desktop/__VERSION__/usr/sbin/pcscd,0,system.slice,snap.yubioath-desktop.pcscd.service,0755',
        'pcscd,/usr/bin/pcscd,0,system.slice,pcscd.service,0755',
        'pcscd,/usr/sbin/pcscd,0,system.slice,pcscd.service,0755',
        'perl,/nix/store/__VERSION__/bin/perl,0,system.slice,znapzend.service,0555',
        'pmdakvm,/usr/libexec/pcp/pmdas/kvm/pmdakvm,0,system.slice,pmcd.service,0755',
        'pmdalinux,/usr/libexec/pcp/pmdas/linux/pmdalinux,0,system.slice,pmcd.service,0755',
        'pmdaproc,/usr/libexec/pcp/pmdas/proc/pmdaproc,0,system.slice,pmcd.service,0755',
        'pmdaroot,/usr/libexec/pcp/pmdas/root/pmdaroot,0,system.slice,pmcd.service,0755',
        'pmdaxfs,/usr/libexec/pcp/pmdas/xfs/pmdaxfs,0,system.slice,pmcd.service,0755',
        'podman,/usr/bin/podman,0,system.slice,podman.service,0755',
        'polkitd,/usr/libexec/polkitd,0,system.slice,polkit.service,0755',
        'pop-system-upda,/usr/bin/pop-system-updater,0,system.slice,com.system76.SystemUpdater.service,0755',
        'power-profiles-,/usr/lib/power-profiles-daemon,0,system.slice,power-profiles-daemon.service,0755',
        'power-profiles-,/usr/libexec/power-profiles-daemon,0,system.slice,power-profiles-daemon.service,0755',
        'pwrstatd,/usr/sbin/pwrstatd,0,system.slice,pwrstatd.service,0700',
        'python3,/usr/bin/python__VERSION__,0,system.slice,dbus.service,0755',
        'python3,/usr/bin/python__VERSION__,0,system.slice,system-dbus\x2d:1.1\x2dorg.pop_os.transition_system.slice,0755',
        'python3,/usr/bin/python__VERSION__,0,system.slice,system-dbus\x2d:1.2\x2dorg.pop_os.transition_system.slice,0755',
        'python3,/usr/bin/python__VERSION__,0,system.slice,ubuntu-advantage.service,0755',
        'python3.13,/usr/bin/python__VERSION__,0,system.slice,networkd-dispatcher.service,0755',
        'qemu-ga,/usr/bin/qemu-ga,0,system.slice,qemu-guest-agent.service,0755',
        'qemu-nbd,/usr/bin/qemu-nbd,0,user.slice,user-1000.slice,0755',
        'qualys-cloud-ag,/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent,0,system.slice,qualys-cloud-agent.service,0700',
        'rapid7_endpoint,/opt/rapid7/ir_agent/components/endpoint_broker/__VERSION__/rapid7_endpoint_broker,0,system.slice,ir_agent.service,0744',
        'rpm-ostree,/usr/bin/rpm-ostree,0,system.slice,rpm-ostreed.service,0755',
        'rsyslogd,/usr/bin/rsyslogd,0,system.slice,rsyslog.service,0755',
        'rsyslogd,/usr/sbin/rsyslogd,0,system.slice,rsyslog.service,0755',
        'run-cups-browse,/usr/bin/dash,0,system.slice,snap.cups.cups-browsed.service,0755',
        'run-cupsd,/usr/bin/dash,0,system.slice,snap.cups.cupsd.service,0755',
        'runc,/usr/bin/runc,0,system.slice,docker.service,0755',
        'scdaemon,/usr/libexec/scdaemon,0,system.slice,packagekit.service,0755',
        'scdaemon,/usr/libexec/scdaemon,0,user.slice,user-1000.slice,0755',
        'sddm,/usr/bin/sddm,0,system.slice,sddm.service,0755',
        'sddm-helper,/usr/lib/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/lib/x86_64-linux-gnu/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/lib/x__VERSION___64-linux-gnu/sddm/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sddm-helper,/usr/libexec/sddm-helper,0,user.slice,user-1000.slice,0755',
        'sedispatch,/usr/bin/sedispatch,0,system.slice,auditd.service,0755',
        'sedispatch,/usr/sbin/sedispatch,0,system.slice,auditd.service,0755',
        'sg,/usr/bin/newgrp,1000,user.slice,user-1000.slice,4755',
        'sh,/nix/store/__VERSION__/bin/bash,0,system.slice,znapzend.service,0555',
        'sleep,/usr/bin/sleep,0,system.slice,snap.cups.cups-browsed.service,0755',
        'sleep,/usr/bin/sleep,0,system.slice,system-btrfs\x2ddedup.slice,0755',
        'smartd,/usr/bin/smartd,0,system.slice,smartd.service,0755',
        'smartd,/usr/sbin/smartd,0,system.slice,smartd.service,0755',
        'smartd,/usr/sbin/smartd,0,system.slice,smartmontools.service,0755',
        'snapd,/snap/snapd/__VERSION__/usr/lib/snapd/snapd,0,system.slice,snapd.service,0755',
        'snapd,/usr/lib/snapd/snapd,0,system.slice,snapd.service,0755',
        'snapd,/usr/libexec/snapd/snapd,0,system.slice,snapd.service,0755',
        'solaar,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'ssh,/nix/store/__VERSION__/bin/ssh,0,system.slice,znapzend.service,0555',
        'sshd,/nix/store/__VERSION__/bin/sshd,0,system.slice,sshd.service,0555',
        'sshd,/nix/store/__VERSION__/bin/sshd,0,user.slice,user-1000.slice,0555',
        'sshd,/usr/bin/sshd,0,system.slice,sshd.service,0755',
        'sshd,/usr/bin/sshd,0,user.slice,user-1000.slice,0755',
        'sshd,/usr/sbin/sshd,0,system.slice,ssh.service,0755',
        'sshd,/usr/sbin/sshd,0,system.slice,sshd.service,0755',
        'sshd,/usr/sbin/sshd,0,user.slice,user-1000.slice,0755',
        'sshd,/usr/sbin/sshd,0,user.slice,user-501.slice,0755',
        'sshd-session,/usr/lib/openssh/sshd-session,0,user.slice,user-1000.slice,0755',
        'sshd-session,/usr/lib/ssh/sshd-session,0,system.slice,sshd.service,0755',
        'sssd_kcm,/usr/libexec/sssd/sssd_kcm,0,system.slice,sssd-kcm.service,0755',
        'su,/usr/bin/su,0,user.slice,user-0.slice,4755',
        'su,/usr/bin/su,0,user.slice,user-1000.slice,4755',
        'su,/usr/bin/su,1000,user.slice,user-0.slice,4755',
        'sudo,/usr/bin/sudo,1000,user.slice,user-0.slice,4111',
        'sudo,/usr/bin/sudo,1000,user.slice,user-0.slice,4755',
        'sudo,/usr/bin/sudo,1000,user.slice,user-1000.slice,4111',
        'sudo,/usr/bin/sudo,1000,user.slice,user-1000.slice,4755',
        'sudo,/usr/bin/sudo,1001,user.slice,user-0.slice,4111',
        'sudo,/usr/bin/sudo,1954428944,system.slice,sshd.service,4755',
        'supergfxd,/usr/bin/supergfxd,0,system.slice,supergfxd.service,0755',
        'swapspace,/usr/sbin/swapspace,0,system.slice,swapspace.service,0755',
        'switcheroo-cont,/usr/libexec/switcheroo-control,0,system.slice,switcheroo-control.service,0755',
        'system-tools-ba,/usr/sbin/system-tools-backends,0,system.slice,dbus.service,0755',
        'system76-power,/usr/bin/system76-power,0,system.slice,com.system76.PowerDaemon.service,0755',
        'system76-power,/usr/bin/system__VERSION__-power,0,system.slice,com.system76.PowerDaemon.service,0755',
        'system76-schedu,/usr/bin/system76-scheduler,0,system.slice,com.system76.Scheduler.service,0755',
        'system76-schedu,/usr/bin/system__VERSION__-scheduler,0,system.slice,com.system76.Scheduler.service,0755',
        'systemd,/usr/lib/systemd/systemd,0,user.slice,user-0.slice,0755',
        'systemd-coredum,/nix/store/__VERSION__/lib/systemd/systemd-coredump,0,,,0555',
        'systemd-homed,/usr/lib/systemd/systemd-homed,0,system.slice,systemd-homed.service,0755',
        'systemd-hostnam,/usr/lib/systemd/systemd-hostnamed,0,system.slice,systemd-hostnamed.service,0755',
        'systemd-journal,/nix/store/__VERSION__/lib/systemd/systemd-journald,0,system.slice,systemd-journald.service,0555',
        'systemd-journal,/usr/lib/systemd/systemd-journald,0,system.slice,systemd-journald.service,0755',
        'systemd-localed,/usr/lib/systemd/systemd-localed,0,system.slice,systemd-localed.service,0755',
        'systemd-logind,/nix/store/__VERSION__/lib/systemd/systemd-logind,0,system.slice,systemd-logind.service,0555',
        'systemd-logind,/usr/lib/systemd/systemd-logind,0,system.slice,systemd-logind.service,0755',
        'systemd-machine,/usr/lib/systemd/systemd-machined,0,system.slice,systemd-machined.service,0755',
        'systemd-nspawn,/usr/bin/systemd-nspawn,0,machine.slice,systemd-nspawn@chainguard-systembase.service,0755',
        'systemd-nspawn,/usr/bin/systemd-nspawn,0,machine.slice,systemd-nspawn@foo.service,0755',
        'systemd-nsresou,/usr/lib/systemd/systemd-nsresourced,0,system.slice,systemd-nsresourced.service,0755',
        'systemd-nsresou,/usr/lib/systemd/systemd-nsresourcework,0,system.slice,systemd-nsresourced.service,0755',
        'systemd-sleep,/usr/lib/systemd/systemd-sleep,0,system.slice,systemd-suspend.service,0755',
        'systemd-timedat,/usr/lib/systemd/systemd-timedated,0,system.slice,systemd-timedated.service,0755',
        'systemd-udevd,/nix/store/__VERSION__/bin/udevadm,0,system.slice,systemd-udevd.service,0555',
        'systemd-udevd,/usr/bin/udevadm,0,system.slice,systemd-udevd.service,0755',
        'systemd-userdbd,/usr/lib/systemd/systemd-userdbd,0,system.slice,systemd-userdbd.service,0755',
        'systemd-userwor,/usr/lib/systemd/systemd-userwork,0,system.slice,systemd-userdbd.service,0755',
        'SystemToolsBack,/usr/bin/perl,0,system.slice,dbus.service,0755',
        'tailscaled,/usr/bin/tailscaled,0,system.slice,tailscaled.service,0755',
        'tailscaled,/usr/sbin/tailscaled,0,system.slice,tailscaled.service,0755',
        'tcpdump,/usr/bin/tcpdump,0,user.slice,user-1000.slice,0755',
        'thermald,/usr/sbin/thermald,0,system.slice,thermald.service,0755',
        'touchegg,/usr/bin/touchegg,0,system.slice,touchegg.service,0755',
        'tuned,/usr/bin/python__VERSION__,0,system.slice,tuned.service,0755',
        'tuned-ppd,/usr/bin/python__VERSION__,0,system.slice,tuned-ppd.service,0755',
        'ubuntu-advantag,/usr/libexec/ubuntu-advantage-desktop-daemon,0,system.slice,ubuntu-advantage-desktop-daemon.service,0755',
        'udisksd,/nix/store/__VERSION__/libexec/udisks2/udisksd,0,system.slice,udisks2.service,0555',
        'udisksd,/usr/lib/udisks2/udisksd,0,system.slice,udisks2.service,0755',
        'udisksd,/usr/libexec/udisks2/udisksd,0,system.slice,udisks2.service,0755',
        'unattended-upgr,/usr/bin/python__VERSION__,0,system.slice,apt-daily-upgrade.service,0755',
        'unattended-upgr,/usr/bin/python__VERSION__,0,system.slice,unattended-upgrades.service,0755',
        'upowerd,/usr/lib/upowerd,0,system.slice,upower.service,0755',
        'upowerd,/usr/libexec/upower/upowerd,0,system.slice,upower.service,0755',
        'upowerd,/usr/libexec/upowerd,0,system.slice,upower.service,0755',
        'uresourced,/usr/libexec/uresourced,0,system.slice,uresourced.service,0755',
        'v4l2-relayd,/usr/bin/v4l2-relayd,0,system.slice,v4l2-relayd.service,0755',
        'velociraptor_cl,/usr/local/bin/velociraptor,0,system.slice,velociraptor_client.service,0700',
        'vim,/usr/bin/vim.basic,0,user.slice,user-1000.slice,0755',
        'virt-manager,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'virtiofsd,/opt/incus/bin/virtiofsd,0,system.slice,incus.service,0755',
        'virtlockd,/usr/sbin/virtlockd,0,system.slice,virtlockd.service,0755',
        'virtlogd,/usr/bin/virtlogd,0,system.slice,virtlogd.service,0755',
        'virtlogd,/usr/sbin/virtlogd,0,system.slice,virtlogd.service,0755',
        'whiptail,/usr/bin/whiptail,0,user.slice,user-1000.slice,0755',
        'wpa_supplicant,/usr/bin/wpa_supplicant,0,system.slice,wpa_supplicant.service,0755',
        'wpa_supplicant,/usr/sbin/wpa_supplicant,0,system.slice,wpa_supplicant.service,0755',
        'X,/nix/store/__VERSION__/bin/Xorg,0,system.slice,display-manager.service,0555',
        'xdg-desktop-por,/usr/lib/x__VERSION___64-linux-gnu/libexec/xdg-desktop-portal-kde,0,user.slice,user-1000.slice,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal,0,user.slice,user-1000.slice,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal-gnome,0,user.slice,user-1000.slice,0755',
        'xdg-desktop-por,/usr/libexec/xdg-desktop-portal-gtk,0,user.slice,user-1000.slice,0755',
        'xdg-document-po,/usr/libexec/xdg-document-portal,0,user.slice,user-1000.slice,0755',
        'xdg-permission-,/usr/libexec/xdg-permission-store,0,user.slice,user-0.slice,0755',
        'xdg-permission-,/usr/libexec/xdg-permission-store,0,user.slice,user-1000.slice,0755',
        'Xorg,/usr/lib/Xorg,0,system.slice,lightdm.service,0755',
        'Xorg,/usr/lib/Xorg,0,system.slice,sddm.service,0755',
        'Xorg,/usr/lib/xorg/Xorg,0,system.slice,lightdm.service,0755',
        'Xorg,/usr/lib/xorg/Xorg,0,system.slice,sddm.service,0755',
        'Xorg,/usr/libexec/Xorg,0,system.slice,lightdm.service,0755',
        'yum,/usr/bin/python__VERSION__,0,user.slice,user-1000.slice,0755',
        'zed,/nix/store/__VERSION__/bin/zed,0,system.slice,zfs-zed.service,0555',
        'zed,/usr/sbin/zed,0,system.slice,zfs-zed.service,0755',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,zfs-snapshot-frequent.service,0555',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,zfs-snapshot-hourly.service,0555',
        'zfs,/nix/store/__VERSION__/bin/zfs,0,system.slice,znapzend.service,0555',
        'zfs-auto-snapsh,/nix/store/__VERSION__/bin/ruby,0,system.slice,zfs-snapshot-frequent.service,0555',
        'zfs-auto-snapsh,/nix/store/__VERSION__/bin/ruby,0,system.slice,zfs-snapshot-hourly.service,0555'
      )
      AND NOT exception_key LIKE '%beat,%/opt/Elastic/Agent/data/elastic-%/components/%beat,0,system.slice,elastic-agent.service,%'
      AND NOT exception_key LIKE 'abrt-dbus,/usr/bin/abrt-dbus,0,system.slice,system-dbus%org.freedesktop.problems.slice,0755'
      AND NOT exception_key LIKE 'agetty,/usr/bin/agetty,0,system.slice,system-serial%getty.slice,0755'
      AND NOT exception_key LIKE 'abrt-dbus,/usr/sbin/abrt-dbus,0,system.slice,system-dbus%org.freedesktop.problems.slice,%'
      AND NOT exception_key LIKE 'containerd,/var/lib/rancher/k3s/data/%/bin/k3s,0,system.slice,k3s.service,0755'
      AND NOT exception_key LIKE 'containerd-shim,/var/lib/rancher/k3s/data/%/bin/containerd-shim-runc-v2,0,system.slice,k3s.service,0755'
      AND NOT exception_key LIKE 'dhcpcd,/usr/sbin/dhcpcd,0,system.slice,ifup@en%.service,0755'
      AND NOT exception_key LIKE 'elastic-agent,%/opt/Elastic/Agent/data/elastic-agent%/elastic-agent,0,system.slice,elastic-agent.service,%'
      AND NOT exception_key LIKE 'fusermount3,/usr/bin/fusermount3,%,user.slice,user-%.slice,4755'
      AND NOT exception_key LIKE 'incusd,%/bin/incusd,0,lxc.monitor.%,,0755'
      AND NOT exception_key LIKE 'incusd,/usr/libexec/incus/incusd,0,lxc.monitor.%,,0755'
      AND NOT exception_key LIKE 'k3s-server,/var/lib/rancher/k3s/data/%/bin/k3s,0,system.slice,k3s.service,0755'
      AND NOT exception_key LIKE 'osquery-extensi,/opt/Elastic/Agent/data/elastic-agent-%/components/osquery-extension.ext,0,system.slice,elastic-agent.service,0750'
      AND NOT exception_key LIKE 'osqueryd,/opt/Elastic/Agent/data/elastic-agent-%/components/osqueryd,0,system.slice,elastic-agent.service,0750'
      AND NOT exception_key LIKE 'server,/var/lib/rancher/k3s/data/%/bin/k3s,0,system.slice,k3s.service,0755'
      AND NOT exception_key LIKE 'tuned-ppd,/usr/bin/python3.%,system.slice,tuned-ppd.service,0755'
      AND NOT exception_key LIKE 'xcover,/%/xcover,0,user.slice,user-0.slice,0755'
      AND NOT p0.path IN ('/bin/bash', '/usr/bin/bash')
      AND NOT p0.cgroup_path LIKE '/kubepods.slice/kubepods-%'
      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT (
        p0.cgroup_path = '/system.slice/dovecot.service'
        AND p0.cwd = '/run/dovecot'
      )
    GROUP BY
      p0.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Listening From Unusual Location"
  description: Unexpected programs listening from /tmp or other weird directories
  query: |
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      REPLACE(f.directory, u.directory, '~') AS homepath,
      REPLACE(p0.cwd, u.directory, '~') AS homecwd,
      CONCAT (
        MIN(lp.port, 32768),
        ',',
        lp.protocol,
        ',',
        MIN(p0.uid, 500),
        ',',
        p0.name
      ) AS exception_key,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      listening_ports lp
      JOIN processes p0 ON lp.pid = p0.pid
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      lp.port != 0
      AND NOT lp.address IN ("127.0.0.1", "::1")
      AND (
        p0.path LIKE "/private/tmp%"
        OR p0.path LIKE "/private/var/tmp%"
        OR p0.path LIKE "/var/tmp%"
        OR p0.path LIKE "/tmp%"
        OR p0.path LIKE "/dev%"
        OR p0.path LIKE "/Users/Shared%"
        OR p0.path LIKE "%/.%"
        OR p0.cwd LIKE "/private/tmp%"
        OR p0.cwd LIKE "/private/var/tmp%"
        OR p0.cwd LIKE "/var/tmp%"
        OR p0.cwd LIKE "/tmp%"
        OR p0.cwd LIKE "/dev%"
        OR p0.cwd LIKE "%/.%"
        OR p0.cwd LIKE "/Users/Shared%"
      )
      AND NOT (
        p0.name IN (
          'aws',
          'caddy',
          'controller',
          'crane',
          'docker-proxy',
          'gopls',
          'hugo',
          'kubectl',
          'limactl',
          'nginx-ingress-c',
          'node',
          'nuclei',
          'ollama',
          'ping',
          'qemu-system-aarch64',
          'qemu-system-x86',
          'rootlessport',
          'webhook'
        )
        AND lp.port > 1024
        and lp.protocol = 6
      )
      -- Overly broad, but prevents a lot of false positives
      AND NOT homepath LIKE "~/.%"
      AND NOT homecwd LIKE "~/.%"
      AND NOT homecwd LIKE "~/src/%"
      AND NOT homecwd LIKE "~/repos/%"
      AND NOT homecwd LIKE '/Users/%/.gradle/daemon/%'
      AND NOT homecwd LIKE '/home/%/.gradle/daemon/%'
      AND NOT f.directory IN (
        '/Applications/Keybase.app/Contents/SharedSupport/bin',
        '/opt/docker-desktop/bin'
      )
      AND NOT exception_key IN (
        '16620,6,500,psi-bastion',
        '2112,6,500,rebuilder',
        '32768,6,500,java',
        '32768,6,500,logioptionsplus_agent',
        '32768,17,500,logioptionsplus_agent',
        '32768,6,500,Chromium',
        '32768,6,500,Code Helper (Plugin)',
        '24024,17,500,MTGA',
        '32768,6,500,Python',
        '32768,6,500,python3',
        '32768,17,499,viscosity_openvpn',
        '9867,6,500,bazel-remote',
        '1,1,500,ping'
      )
      AND NOT p0.path LIKE '/nix/store/%'
      AND NOT p0.path LIKE '/Users/Shared/Epic Games/%'
      AND NOT p0.path LIKE '/tmp/go-build%'
      AND NOT (
        exception_key = '32768,17,500,qemu-system-x86'
        AND homecwd LIKE '/tmp/wolfi-%'
      )
      AND NOT (
        exception_key = '32768,17,500,go'
        AND homecwd LIKE '%/.terraform/modules/%'
      )
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Low Fd Socket"
  description: Find programs where fd0 (stdin), fd1 (stdout), or fd2 (stderr) are connected to a socket
  query: |
    SELECT
      pos.protocol,
      pos.pid,
      pos.remote_address,
      pos.local_address,
      pos.local_port,
      pos.remote_port,
      pos.state,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      process_open_sockets pos
      JOIN processes p0 ON pos.pid = p0.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pos.fd < 3
      AND pos.family != 1
      AND p0.path NOT IN (
        '/Applications/NetSpot.app/Contents/MacOS/NetSpot',
        '/Applications/WiFiman Desktop.app/Contents/Resources/wifiman-desktopd',
        '/Library/Application Support/Viscosity/viscosity_openvpn',
        '/usr/bin/skopeo',
        '/usr/libexec/bootpd',
        '/usr/libexec/pcp/bin/pmcd',
        '/usr/local/bin/velociraptor'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Minimal Socket Client Linux"
  description: Slow query to find root programs with an open socket and few shared libraries
  query: |
    SELECT
      pos.protocol,
      pos.pid,
      pos.remote_address,
      pos.local_address,
      pos.local_port,
      pos.remote_port,
      pos.state,
      GROUP_CONCAT(DISTINCT pmm.path) AS libs,
      COUNT(DISTINCT pmm.path) AS lib_count,
      -- Child
      p0.path AS proc_path,
      p0.name AS proc_name,
      p0.start_time AS proc_start,
      p0.cmdline AS proc_cmd,
      p0.cwd AS porc_cwd,
      p0.cgroup_path AS proc_cgroup,
      p0.euid AS proc_euid,
      p0_hash.sha256 AS sha256
    FROM
      processes p0
      JOIN process_open_sockets pos ON p0.pid = pos.pid
      JOIN process_memory_map pmm ON p0.pid = pmm.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
    WHERE
      p0.path != '' -- optimization: focus on longer running processes
      AND p0.start_time < (strftime('%s', 'now') - 900)
      AND p0.path NOT IN (
        '/opt/bitnami/redis/bin/redis-server',
        '/opt/java/openjdk/bin/java',
        '/usr/bin/cat',
        '/usr/bin/containerd',
        '/usr/bin/dash',
        '/usr/bin/daprd',
        '/usr/bin/docker',
        '/usr/bin/docker-proxy',
        '/usr/bin/fusermount3',
        '/usr/bin/i3blocks',
        '/usr/bin/kas',
        '/usr/bin/k3s',
        '/usr/bin/vmalert',
        '/usr/lib/electron/chrome-sandbox',
        '/usr/lib/snapd/snapd',
        '/usr/libexec/docker/docker-proxy',
        '/usr/local/bin/containerd',
        '/usr/local/bin/gitary',
        '/usr/sbin/acpid',
        '/usr/sbin/mcelog'
      )
      AND p0.name NOT IN (
        'Brackets-node',
        'chrome_crashpad',
        'launcher',
        'dhcpcd',
        'gitsign-credent',
        'gitaly',
        'kas',
        'k9s',
        'redis-server',
        'stern'
      ) -- optimization: minimalistic daemons typically only run 1 pid per path
      AND p0.path NOT LIKE '/home/%/go/bin/%'
      AND pos.family != 1
      AND pos.pid > 0
      AND pos.state != 'LISTEN'
      AND pmm.path LIKE "%.so.%"
      AND NOT (
        pos.local_address = "127.0.0.1"
        AND pos.remote_address = "127.0.0.1"
      )
      AND NOT proc_cgroup in ('/system.slice/snapd.service')
      AND NOT proc_cgroup LIKE '/system.slice/docker-%'
    GROUP BY
      pos.pid -- libc.so, ld-linux
    HAVING
      lib_count IN (1, 2)
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Minimal Socket Client Macos"
  description: Slow query to find root programs with an open socket and few shared libraries
  query: |
    SELECT
      p.uid,
      p.euid,
      pos.protocol,
      pos.pid,
      pos.remote_address,
      pos.local_address,
      pos.local_port,
      pos.remote_port,
      p.name,
      p.start_time,
      p.parent,
      p.cgroup_path,
      p.path,
      pos.state,
      GROUP_CONCAT(DISTINCT pmm.path) AS libs,
      COUNT(DISTINCT pmm.path) AS lib_count,
      CONCAT (
        MIN(p.euid, 500),
        ',',
        p.name,
        ',',
        REPLACE(p.path, u.directory, '~'),
        s.authority
      ) AS exception_key
    FROM
      processes p
      JOIN process_memory_map pmm ON p.pid = pmm.pid
      JOIN process_open_sockets pos ON p.pid = pos.pid
      LEFT JOIN file f ON p.path = f.path
      LEFT JOIN users u ON f.uid = u.uid
      LEFT JOIN signature s ON p.path = s.path
    WHERE
      p.pid IN (
        SELECT
          processes.pid
        FROM
          process_open_sockets
          JOIN processes ON process_open_sockets.pid = processes.pid
          AND family != 1 -- The outer query is slow due to the use of process_memory_map, so narrow down our choices here
        WHERE
          processes.path NOT LIKE '/Library/Apple/%'
          AND processes.path NOT LIKE '/Library/Elastic/Agent/data/%'
          AND processes.path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'
          AND processes.path NOT LIKE '/private/var/kolide-k2/k2device.kolide.com/updates/%.app/Contents/MacOS/%'
          AND processes.path NOT LIKE '/sbin/%'
          AND processes.path NOT LIKE '/System/%'
          AND processes.path NOT LIKE '/usr/bin/%'
          AND processes.path NOT LIKE '/usr/libexec/%'
          AND processes.path NOT LIKE '/usr/sbin/%'
          AND NOT (
            processes.euid >= 500
            AND (
              processes.path LIKE '/Applications/%.app/Contents/Frameworks/%/Contents/MacOS/%'
              OR processes.path LIKE '/Applications/%.app/Contents/MacOS/%'
              OR processes.path LIKE '/nix/store/%/bin/nix'
              OR processes.path LIKE '/opt/%/bin/%'
              OR processes.path LIKE '/private/var/folders/%/X/com.google.Chrome.code_sign_clone/code_sign_clone%'
              OR processes.path LIKE '/Users/%/Applications/zoom.us.app/Contents/MacOS/zoom.us'
              OR processes.path LIKE '/Users/%/go/bin/%'
              OR processes.path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'
              OR processes.path LIKE '/Users/%/Library/Application Support/Figma/FigmaAgent.app/Contents/MacOS/figma_agent'
              OR processes.path LIKE '/Users/%/Library/Application Support/Steam/Steam.AppBundle/Steam/Contents/%'
              OR processes.path IN (
                '/Applications/AirBuddy.app/Contents/Library/LoginItems/AirBuddyHelper.app/Contents/XPCServices/MobileDevicesService.xpc/Contents/MacOS/MobileDevicesService',
                '/Applications/Elgato Stream Deck.app/Contents/Helpers/node20',
                '/Applications/GoLand.app/Contents/plugins/go-plugin/lib/dlv/macarm/dlv',
                '/Applications/Google Drive.app/Contents/Applications/FinderHelper.app/Contents/PlugIns/FinderSyncExtension.appex/Contents/MacOS/FinderSyncExtension',
                '/Applications/Google Drive.app/Contents/PlugIns/DFSFileProviderExtension.appex/Contents/MacOS/DFSFileProviderExtension',
                '/Applications/lghub.app/Contents/MacOS/lghub_updater.app/Contents/MacOS/lghub_updater',
                '/Applications/Loom.app/Contents/Resources/binaries/loom-recorder-production',
                '/Applications/Ollama.app/Contents/Resources/ollama',
                '/Applications/Rancher Desktop.app/Contents/Resources/resources/darwin/lima/bin/limactl.ventura',
                '/Applications/Rancher Desktop.app/Contents/Resources/resources/darwin/lima/bin/qemu-system-aarch64',
                '/Applications/Syncthing.app/Contents/Resources/syncthing/syncthing',
                '/Library/Application Support/Adobe/Adobe Desktop Common/ADS/Adobe Desktop Service.app/Contents/MacOS/Adobe Desktop Service',
                '/Library/Application Support/Adobe/Adobe Desktop Common/IPCBox/AdobeIPCBroker.app/Contents/MacOS/AdobeIPCBroker',
                '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS/Kandji Menu',
                '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/Frameworks/logioptionsplus_updater.app/Contents/MacOS/logioptionsplus_updater',
                '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS/logioptionsplus_agent',
                '/Library/Developer/CommandLineTools/Library/PrivateFrameworks/LLDB.framework/Versions/A/Resources/debugserver',
                '/Library/Frameworks/Python.framework/Versions/3.10/Resources/Python.app/Contents/MacOS/Python',
                '/Library/Kandji/Kandji Agent.app/Contents/Helpers/Kandji Daemon.app/Contents/MacOS/kandji-daemon',
                '/Library/Printers/Brother/Utilities/Server/NETserver.app/Contents/MacOS/NETserver',
                '/Library/Printers/Brother/Utilities/Server/USBAppControl.app/Contents/MacOS/USBAppControl',
                '/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/Contents/MacOS/WorkflowAppControl',
                '/usr/local/bin/node',
                '/Volumes/Google Chrome/Google Chrome.app/Contents/MacOS/Google Chrome',
                '/Volumes/Slack/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack Helper'
              )
            )
          ) -- uid0-499 exceptions
          AND NOT processes.path IN (
            '/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/Contents/MacOS/IPNExtension',
            '/Applications/WiFiman Desktop.app/Contents/service/wifiman-desktopd',
            '/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint',
            '/Library/Kandji/Kandji Agent.app/Contents/Helpers/Kandji Daemon.app/Contents/MacOS/kandji-daemon',
            '/Library/safeqclientcore/bin/safeqclientcore',
            '/usr/local/sbin/velociraptor'
          )
          AND processes.start_time < (strftime('%s', 'now') -600)
        GROUP BY
          processes.path
      )
      AND NOT exception_key = '500,Steam Helper,~/Library/Application Support/Steam/Steam.AppBundle/Steam/Contents/MacOS/Frameworks/Steam Helper.app/Contents/MacOS/Steam HelperDeveloper ID Application: Valve Corporation (MXGJJ98X76)'
      AND NOT exception_key LIKE '500,python3.%,~/miniconda/envs/skilljar-api/bin/python3.%'
      AND pmm.path LIKE "%.dylib"
    GROUP BY
      pos.pid
    HAVING
      lib_count IN (1, 2)
      AND libs NOT LIKE '/Applications/%/Contents/Frameworks/Electron Framework.framework/Versions/A/Libraries/libffmpeg.dylib,/usr/lib/libobjc-trampolines.dylib'
      AND libs NOT LIKE '/usr/lib/libobjc-trampolines.dylib,/Applications/%.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Libraries/libffmpeg.dylib'
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Shady Chrome Extension Author"
  description: Highlight potentially shady chrome extensions from documented spam authors
  query: |
    SELECT
      name,
      profile,
      chrome_extensions.description AS 'descr',
      persistent AS persists,
      CONCAT (
        "https://chromewebstore.google.com/detail/extension/",
        identifier
      ) AS ext_url,
      author,
      chrome_extensions.path,
      referenced AS in_config,
      file.ctime,
      file.btime,
      file.mtime,
      from_webstore AS in_store,
      TRIM(CAST(permissions AS text)) AS perms,
      state AS 'enabled',
      CONCAT (
        from_webstore,
        ',',
        author,
        ',',
        name,
        ',',
        identifier
      ) AS exception_key,
      hash.sha256
    FROM
      users
      CROSS JOIN chrome_extensions USING (uid)
      LEFT JOIN file ON chrome_extensions.path = file.path
      LEFT JOIN hash ON chrome_extensions.path = hash.path
    WHERE
      state = 1
      AND (
        (
          author LIKE '%BigMData%'
          OR author LIKE '%BroCode LTD%'
          OR author LIKE '%Chrome Extension Hub%'
          OR author LIKE '%ExtensionsBox%'
          OR author LIKE '%Free Business Apps%'
          OR author LIKE '%Infwiz%'
          OR author LIKE '%Karbon Project LP%'
          OR author LIKE '%Kodice LLC%'
          OR author LIKE '%Lazytech%'
          OR author LIKE '%NioMaker%'
          OR author LIKE '%PDF Toolbox cluster%'
          OR author LIKE '%Yue Apps%'
          OR author LIKE '%ZingDeck%'
          OR author LIKE '%ZingFront Software%'
        )
      )
    GROUP BY
      exception_key
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Suspicious Systemd Unit"
  description: Funky systemd units, may be evidence of persistence
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT DISTINCT
          (fragment_path)
        FROM
          systemd_units
        WHERE
          fragment_path LIKE "%.service"
          AND NOT fragment_path LIKE "/run/systemd/generator.late/%"
      )
      AND yara.sigrule = '
    rule systemd_execstart_danger_path_val : high {
      meta:
        ref = "https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/"
        description = "Starts from a dangerous-looking path"
      strings:
        $awkward = /ExecStart=\/(boot|var|tmp|dev|root)\/[\.\w\-\/]{0,32}/
      condition:
        filesize < 102400 and $awkward
    }
    
    rule systemd_execstart_elsewhere : medium {
      meta:
        description = "Starts from an unusual path"
        ref = "https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/"
        hash_2023_Downloads_kinsing = "05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0"
        hash_2023_articles_https_pberba_github_io_security_2022_02_07_linux_threat_hunting_for_persistence_systemd_generators = "8c227f67a16162ffd5b453a478ced2950eba4cbe3b004c5cc935fb9551dc2289"
        hash_2024_2024_Spinning_YARN_yarn_fragments = "723326f8551f2a92ccceeec93859f58df380a3212e7510bc64181f2a0743231c"
      strings:
        $execstart = /ExecStart=\/[\w\/]{1,128}/
        $not_bin = "ExecStart=/bin/"
        $not_bin_true = "ExecStart=/bin/true"
        $not_etc_rcd = "ExecStart=/etc/rc.d/rc.local"
        $not_etc_rc_local = "ExecStart=/etc/rc.local"
        $not_init_d = "ExecStart=/etc/init.d/"
        $not_lib = "ExecStart=/lib/"
        $not_motd = "ExecStart=/etc/update-motd.d/"
        $not_opt = "ExecStart=/opt/"
        $not_sbin = "ExecStart=/sbin/"
        $not_usr_bin = "ExecStart=/usr/bin/"
        $not_usr_libexec = "ExecStart=/usr/libexec/"
        $not_usr_lib = "ExecStart=/usr/lib/"
        $not_usr_local = "ExecStart=/usr/local/"
        $not_usr_sbin = "ExecStart=/usr/sbin/"
        $not_usr_share = "ExecStart=/usr/share/"
        $not_etckeeper = "ExecStart=/etc/etckeeper/"
      condition:
        filesize < 102400 and $execstart and none of ($not_*)
    }
    
    rule systemd_execstop_elsewhere : medium {
      meta:
        ref = "https://www.trendmicro.com/en_us/research/23/c/iron-tiger-sysupdate-adds-linux-targeting.html"
    	description = "Runs program from unexpected directory at stop"
      strings:
        $execstop = /ExecStop=\/[\w\.\_\-]{2,64}/
        $not_lib = "ExecStop=/lib/"
        $not_opt = "ExecStart=/opt/"
        $not_sbin = "ExecStop=/sbin/"
        $not_usr_libexec = "ExecStop=/usr/libexec/"
        $not_usr_lib = "ExecStop=/usr/lib/"
        $not_usr_local = "ExecStop=/usr/local/"
        $not_usr_sbin = "ExecStop=/usr/sbin/"
        $not_usr_share = "ExecStop=/usr/share/"
      condition:
        filesize < 384 and $execstop and none of ($not*)
    }
    
    rule systemd_small_no_blank_lines : high {
      meta:
        ref = "https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/"
        hash_2023_Downloads_kinsing = "05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0"
      strings:
        $execstart = "ExecStart"
        $blank = "\n\n"
        $not_dbus = "Type=dbus"
        $not_after = /After=\w/
        $not_before = /Before=\w{1,128}/
        $not_notify = "Type=notify"
      condition:
        filesize < 512 and $execstart and not $blank and none of ($not*)
    }
    
    rule systemd_small_multiuser_no_comments_or_documentation : high {
      meta:
        ref = "https://sandflysecurity.com/blog/log4j-kinsing-linux-malware-in-the-wild/"
    	description = "systemd unit is undocumented"
      strings:
        $execstart = "ExecStart="
        $multiuser = "multi-user.target"
        $not_comment = "# "
        $not_documentation = "Documentation="
        $not_requires_socket = /Requires=.{0,64}socket/
        $not_condition_path = "Condition"
        $not_after = "After="
        $not_systemd = "ExecStart=systemd-"
        $not_output = "StandardOutput="
        $not_part_of = "PartOf="
        $not_dbus = "Type=dbus"
        $not_oneshot = "Type=oneshot"
        $not_lima = "Description=lima-guestagent"
        $not_check_sb = "Description=Service to check for secure boot key enrollment"
        $not_waydroid = "waydroid"
        $not_keyd = "ExecStart=/usr/local/bin/keyd"
      condition:
        filesize < 384 and $execstart and $multiuser and none of ($not_*)
    }
    rule systemd_small_no_output : high {
      meta:
    	description = "Discards all logging output"
      strings:
        $output_null = "StandardOutput=null"
        $error_null = "StandardError=null"
        $not_input_null = "StandardInput=null"
        $not_syslog = "syslog"
        $not_before = "Before="
        $not_display = "WantedBy=display-manager.service"
      condition:
        filesize < 384 and ($output_null and $error_null) and none of ($not*)
    }
    
    rule systemd_small_multiuser_not_in_dependency_tree : high {
      meta:
        description = "Relies on nothing, nothing relies on it"
        hash_2023_Downloads_kinsing = "05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0"
      strings:
        $execstart = "ExecStart="
        $multiuser = "multi-user.target"
        $not_after = /After=\w/
        $not_before = /Before=\w{1,128}/
        $not_requires = /Requires=\w/
        $not_condition = "Condition"
        $not_oneshot = "Type=oneshot"
        $not_default = "DefaultDependencies=no"
        $not_env = "EnvironmentFile="
        $not_bus = "BusName="
        $not_idle = "Type=idle"
        $not_systemd = "ExecStart=systemd-"
        $not_lima = "Description=lima-guestagent"
        $not_check_sb = "Description=Service to check for secure boot key enrollment"
        $not_touchegg = /ExecStart=.*\/touchegg --/
        $not_keyd = "ExecStart=/usr/local/bin/keyd"
      condition:
        filesize < 384 and $execstart and $multiuser and none of ($not_*)
    }
    
    rule sytemd_small_type_forking_not_in_dep_tree : high {
      meta:
        hash_2023_Txt_Malware_Sustes_0e77 = "0e77291955664d2c25d5bfe617cec12a388e5389f82dee5ae4fd5c5d1f1bdefe"
        hash_2023_Unix_Malware_Kaiji_3e68 = "3e68118ad46b9eb64063b259fca5f6682c5c2cb18fd9a4e7d97969226b2e6fb4"
        hash_2023_Unix_Malware_Kaiji_f4a6 = "f4a64ab3ffc0b4a94fd07a55565f24915b7a1aaec58454df5e47d8f8a2eec22a"
      strings:
        $forking = "Type=forking"
        $not_after = /After=\w/
        $not_before = /Before=\w{1,128}/
        $not_condition = "ConditionPath"
        $not_oneshot = "Type=oneshot"
        $not_default_deps = "DefaultDependencies=no"
        $not_env = "EnvironmentFile="
        $not_bus = "BusName="
        $not_idle = "Type=idle"
        $not_systemd = "ExecStart=systemd-"
        $not_default_target = "WantedBy=default.target"
      condition:
        filesize < 384 and $forking and none of ($not_*)
    }
    
    rule systemd_small_restart_always : medium {
      meta:
        description = "service restarts no matter how many times it crashes"
        hash_2023_Downloads_kinsing = "05d02411668f4ebd576a24ac61cc84e617bdb66aa819581daa670c65f1a876f0"
      strings:
        $restart = "Restart=always"
        $not_syslog = "SyslogLevel="
        $not_gpl = "GPL-2.0-only"
        $not_after = /After=\w/
        $not_before = /Before=\w{1,128}/
        $not_notify = "Type=notify"
        $not_wanted_by = /WantedBy=\w{2,32}\.target/
      condition:
        filesize < 384 and $restart and none of ($not*)
    }
    
    rule systemd_small_short_description {
      meta:
        description = "Short or no description"
      strings:
        $execstart = "ExecStart="
        $short_desc = /Description=\n/
      condition:
        filesize < 384 and all of them
    }
    
    rule systemd_nice_execstart_restart_no_comment {
      meta:
        description = "Sets nice value and restarts always without comments, possible miner"
      strings:
        $has_execstart = "ExecStart="
        $has_restart = "Restart=always"
        $has_nice = "Nice="
        $not_comment = "#"
      condition:
        filesize < 4096 and all of ($has*) and none of ($not*)
    }
    
    rule usr_bin_execstop_shell : medium {
      meta:
        ref = "https://www.trendmicro.com/en_us/research/23/c/iron-tiger-sysupdate-adds-linux-targeting.html"
    	description = "Runs shell script at stop"
      strings:
        $execstop = /ExecStop=\/bin\/sh .{0,64}/
        $not_podman_logging = "/usr/bin/podman $LOGGING"
        $not_stderr = /ExecStop=\/bin\/sh .{0,64}set -eu/
        $not_nfs = /ExecStop=\/bin\/sh -c .\/usr\/sbin\/nfsdctl /
      condition:
        filesize < 4096 and $execstop and none of ($not*)
    }
    
    rule systemd_hidden_execstart : critical {
      meta:
      	description = "ExecStart references hidden file"
      strings:
        $path_top_bin = /ExecStart=\/\.[\w\/]+/
        $path_sub_bin = /ExecStart=\/\w[\w\/]*\/\.\w+/
        $path_arg_sub = /ExecStart=.* \/\w[\w\/]*\/\.\w+/
        $path_arg_top = /ExecStart=.* \/\.[\w\/]+/
        $not_autorelabel = "/.autorelabel"
        $not_exists = "ConditionPathExists"
        $not_ksysguard = "/.ksysguard/ksgrd_network_helper"
      condition:
      	any of ($path*) and none of ($not*)
    }
    
    rule systemd_hidden_execstop : critical {
      meta:
      	description = "ExecStop references hidden file"
      strings:
        $path_top_bin = /ExecStart=\/\.[\w\/]+/
        $path_sub_bin = /ExecStart=\/\w[\w\/]*\/\.\w+/
        $path_arg_sub = /ExecStart=.* \/\w[\w\/]*\/\.\w+/
        $path_arg_top = /ExecStart=.* \/\.[\w\/]+/
    
        $not_autorelabel = "/.autorelabel"
        $not_exists = "ConditionPathExists"
      condition:
      	any of ($path*) and none of ($not*)
    }
    
    rule systemd_hidden_working_directory : critical {
      meta:
      	description = "WorkingDirectory is a hidden"
      strings:
        $ref = /WorkingDirectory=.*\/\..*/
      condition:
    	any of them
    }
    '
      AND yara.count > 0
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Cron Entries"
  description: Unexpected crontab entries
  query: |
    SELECT
      *
    FROM
      crontab
    WHERE
      command NOT LIKE '%/usr/lib/php/sessionclean%'
      AND command NOT LIKE '%anacron start%'
      AND command NOT LIKE '%clamscan%'
      AND command NOT LIKE '%e2scrub%'
      AND command NOT LIKE '%freshclam%'
      AND command NOT LIKE '%gcloud compute instances stop%'
      AND command NOT LIKE '%git commit%'
      AND command NOT LIKE '%rsync%'
      AND command NOT LIKE '%zfs-linux%'
      AND command NOT LIKE 'docker run amouat/jocko%'
      AND command NOT LIKE 'gsutil %'
      AND command NOT LIKE 'root [ -d "/run/systemd/system" ] || /usr/share/atop/atop%'
      AND command NOT LIKE 'root command -v debian-sa1%'
      AND command NOT LIKE 'root test -x /usr/bin/geoipupdate % && /usr/bin/geoipupdate'
      AND command NOT LIKE 'root%run-parts%'
      AND command NOT LIKE '/opt/homebrew/bin/%'
      AND command NOT IN (
        "ps -A | grep at.obdev.littlesnitch.networkextension | grep -v 'grep' | awk '{print $1}' | xargs kill",
        'root [ -d "/run/systemd/system" ] && systemctl restart atop',
        'root test -x /etc/cron.daily/popularity-contest && /etc/cron.daily/popularity-contest --crond',
        'timeout --kill-after=10 100 mbsync -q -a',
        '~/scripts/gmail-token-refresh.py',
        '~/.dotfiles/git_auto_commit.sh',
        'osascript -e "set volume with output muted"'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Launchd Program Arguments"
  description: "Unexpected launchd scripts that use the 'program_arguments' field"
  query: |
    SELECT
      l.label,
      l.name,
      l.path,
      TRIM(REGEX_SPLIT (l.program_arguments, ' -', 0)) AS program_path,
      l.program_arguments,
      l.keep_alive,
      signature.authority AS program_authority,
      hash.sha256
    FROM
      launchd l
      LEFT JOIN signature ON program_path = signature.path
      LEFT JOIN hash ON program_path = hash.path
    WHERE
      (
        run_at_load = 1
        OR keep_alive = 1
      )
      AND (
        program IS NULL
        OR program = ''
      )
      AND l.path NOT LIKE '/Library/Apple/System/%'
      AND l.path NOT LIKE '/System/%'
      AND program_authority NOT IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: AtomicJar, Inc. (33C47PTHN6)',
        'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',
        'Developer ID Application: Canon U.S.A., Inc. (NC5A977249)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Canva Pty Ltd (5HD2ARTBFS)',
        'Developer ID Application: Cloudflare Inc. (68WVV388M8)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Daniel Georgiev (38RJ64N8CE)', -- Iris
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',
        'Developer ID Application: Expressco Services, LLC (TC292Y5427)', -- Express VPN
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Google, Inc. (EQHXZ8M8AV)',
        'Developer ID Application: Grammarly, Inc (W8F64X92K3)',
        'Developer ID Application: Hercules Labs Inc. (B8PC799ZGU)',
        'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Krisp Technologies, Inc. (U5R26XM5Z2)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Maxon Computer GmbH (4ZY22YGXQG)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mullvad VPN AB (CKG9MXH72F)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X)',
        'Developer ID Application: PaperCut Software International Pty Ltd (B5N3YV5P2H)',
        'Developer ID Application: Paragon Software GmbH (LSJ6YVK468)',
        'Developer ID Application: PFU LIMITED (XW4U7W2E9L)', -- Fujitsu
        'Developer ID Application: Plentycom Systems (UHEB36849R)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: Proton AG (2SB5Z68H26)',
        'Developer ID Application: Razer USA Ltd. (R2H967U7J8)',
        'Developer ID Application: Rewind AI Inc. (NFYJ9X64B5)',
        'Developer ID Application: Proton Technologies AG (6UN54H93QT)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        'Developer ID Application: Sanford, L.P. (N3S6676K3E)', -- DYMO
        'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: Ubiquiti Inc. (4P645293E8)',
        'Developer ID Application: X-Rite, Incorporated (2K7GT73B4R)',
        'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        'Software Signing', -- Apple
        'yabai-cert'
      )
      AND program_arguments NOT IN (
        '/Applications/AeroSpace.app/Contents/MacOS/AeroSpace --started-at-login',
        '/Applications/ExpressVPN.app/Contents/MacOS/expressvpnd',
        '/Applications/RODE Virtual Channels.app/Contents/MacOS/RODE Virtual Channels',
        '/Applications/Stream Deck.app/Contents/MacOS/Stream Deck --runinbk',
        '/Applications/Tunnelblick.app/Contents/Resources/launchAtLogin.sh',
        '/Library/Application Support/Sony Application Launcher/SonyAutoLauncher.app/Contents/MacOS/SonyAutoLauncher',
        '/Library/Application Support/WirelessAutoImport/WirelessImporterDaemon',
        '/Library/PrivilegedHelperTools/MHLinkServer.app/Contents/MacOS/MHLinkServer',
        '/opt/homebrew/bin/gitsign-credential-cache',
        '/opt/homebrew/opt/dnsmasq/sbin/dnsmasq --keep-in-foreground -C /opt/homebrew/etc/dnsmasq.conf -7 /opt/homebrew/etc/dnsmasq.d,*.conf',
        '/opt/homebrew/opt/emacs/bin/emacs --fg-daemon',
        '/opt/homebrew/opt/jenkins/bin/jenkins --httpListenAddress=127.0.0.1 --httpPort=8080',
        '/opt/homebrew/opt/libvirt/sbin/libvirtd -f /opt/homebrew/etc/libvirt/libvirtd.conf',
        '/opt/homebrew/opt/mariadb/bin/mysqld_safe',
        '/opt/homebrew/opt/nginx/bin/nginx -g daemon off;',
        '/Library/Application Support/com.canonical.multipass/bin/multipassd --verbosity debug',
        '/opt/homebrew/opt/pueue/bin/pueued --verbose',
        '/opt/homebrew/opt/skhd/bin/skhd',
        '/opt/homebrew/opt/tailscale/bin/tailscaled',
        '/opt/homebrew/opt/yubikey-agent/bin/yubikey-agent -l /opt/homebrew/var/run/yubikey-agent.sock',
        '/usr/local/MacGPG2/libexec/fixGpgHome'
      )
      AND program_arguments NOT LIKE '/opt/homebrew/opt/%/bin/%'
      AND program_arguments NOT LIKE '/opt/homebrew/opt/mongodb-community%/bin/mongod --config /opt/homebrew/etc/mongod.conf'
      AND program_arguments NOT LIKE '/opt/homebrew/opt/socket_vmnet/bin/socket_vmnet --vmnet-gateway=% /opt/homebrew/var/run/socket_vmnet'
      AND program_arguments NOT LIKE '/Users/%/Library/Application Support/com.grammarly.ProjectLlama/Scripts/Grammarly Uninstaller'
      AND program_arguments NOT LIKE '/Users/%/Library/Application Support/com.grammarly.ProjectLlama/Scripts/post-uninstall.sh'
      AND program_arguments NOT LIKE '%/mysqld_safe --datadir=%'
      AND program_arguments NOT LIKE '/Users/%/.local/ActiveState/StateTool/release/State Service.app'
      AND program_arguments NOT LIKE '/Users/%/gitsign-credential-cache'
      AND NOT l.label IN ('org.sigstore.gitsign-credential-cache')
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Launchd Program Macos"
  description: "Unexpected launchd scripts that use the 'program' field"
  query: |
    SELECT
      l.label,
      l.name,
      l.path,
      l.program,
      l.program_arguments,
      l.keep_alive,
      signature.authority AS program_authority,
      signature.identifier AS program_identifier,
      hash.sha256
    FROM
      launchd l
      LEFT JOIN signature ON l.program = signature.path
      LEFT JOIN hash ON l.path = hash.path
    WHERE
      (
        run_at_load = 1
        OR keep_alive = 1
      )
      AND l.path NOT LIKE '/System/%'
      AND program IS NOT NULL
      AND program_authority NOT IN (
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Bjango Pty Ltd (Y93TK974AT)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Creative Labs Pte. Ltd. (5Q3552844F)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: EA Swiss Sarl (TSTV75T6Q5)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Expressco Services, LLC (TC292Y5427)', -- ExpressVPN, bleh.
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: Hercules Labs Inc. (B8PC799ZGU)',
        'Developer ID Application: Ilya Parniuk (ACC5R6RH47)',
        'Developer ID Application: iMobie Inc. (2QJGLWL8Y6)',
        'Developer ID Application: Jonathan Bullard (Z2SG5H3HC8)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: Louis Pontoise (QXD7GW8FHY)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Nordvpn S.A. (W5W395V82Y)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
        'Developer ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Rogue Amoeba Software, Inc. (7266XEXAPM)',
        'Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',
        'Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T)',
        'Developer ID Application: Universal Audio (4KAC9AX6CG)',
        'Developer ID Application: Valve Corporation (MXGJJ98X76)',
        'Developer ID Application: Wireshark Foundation (7Z6EMTD2C6)',
        'Developer ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',
        'Developer ID Application: Y Soft Corporation, a.s. (3CPED8WGS9)',
        'Developer ID Application: Yufu Fan (S3YBM9ALKM)',
        'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',
        'Software Signing'
      )
      AND program NOT IN (
        '/usr/local/bin/warsaw/core',
        '/usr/local/MacGPG2/libexec/shutdown-gpg-agent'
      )
      -- Special case: Docker does not consistently sign their plist files (security fail)
      AND NOT (
        l.path = '/Library/LaunchDaemons/com.docker.socket.plist'
        AND program_authority = 'Software Signing'
        AND program_identifier IN ('com.apple.ln', 'com.apple.link')
        AND program_arguments LIKE '/bin/ln -s -f /Users/%/run/docker.sock /var/run/docker.sock'
      )
      AND NOT (
        l.path = '/Library/LaunchDaemons/com.docker.socket.plist'
        AND program_identifier = 'com.docker'
        AND program_authority = NULL
        AND program = '/Library/PrivilegedHelperTools/com.docker.socket'
      )
      AND NOT (
        l.path = '/Library/LaunchDaemons/com.docker.vmnetd.plist'
        AND program_identifier = 'com.docker.vmnetd'
        AND program_authority = NULL
        AND program = '/Library/PrivilegedHelperTools/com.docker.vmnetd'
      )
      AND NOT l.label IN ('org.nix-community.home.sops-nix','com.github.domt4.homebrew-autoupdate')
    GROUP BY
      l.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Listening Port Macos"
  description: Unexpected programs listening on a TCP port.
  query: |
    SELECT
      lp.address,
      lp.port,
      lp.protocol,
      p.uid,
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      p.cwd,
      hash.sha256,
      signature.authority AS program_authority,
      CONCAT (
        MIN(lp.port, 49152),
        ',',
        lp.protocol,
        ',',
        MIN(p.uid, 500),
        ',',
        p.name,
        ',',
        signature.authority
      ) AS exception_key
    FROM
      listening_ports lp
      LEFT JOIN processes p ON lp.pid = p.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN signature ON p.path = signature.path
    WHERE
      port != 0
      AND lp.address NOT IN ('224.0.0.251', '::1')
      AND lp.address NOT LIKE '127.0.0.%'
      AND lp.address NOT LIKE '172.1%'
      AND lp.address NOT LIKE 'fe80::%'
      AND lp.address NOT LIKE '::ffff:127.0.0.%' -- All outgoing UDP (protocol 17) sessions are 'listening'
      AND NOT (
        lp.protocol = 17
        AND lp.port > 1024
      ) -- Random webservers
      AND NOT (
        p.uid > 500
        AND lp.port IN (8000, 8080)
        AND lp.protocol = 6
      ) -- Filter out unmapped raw sockets
      AND NOT (p.pid = '') -- Exceptions: the uid is capped at 500 to represent regular users versus system users
      -- port is capped at 49152 to represent transient ports
      AND NOT exception_key IN (
        '10011,6,0,launchd,Software Signing',
        '10011,6,0,webfilterproxyd,Software Signing',
        '1024,6,0,systemmigrationd,Software Signing',
        '111,17,1,rpcbind,Software Signing',
        '111,6,1,rpcbind,Software Signing',
        '1144,6,500,fuscript,',
        '1234,6,500,qemu-system-aarch64,',
        '1313,6,500,hugo,',
        '1338,6,500,ec2-metadata-mock,',
        '1338,6,500,registry,',
        '13618,6,500,BambuStudio,Developer ID Application: Shanghai Lunkuo Technology Co., Ltd (T3UBR9Y3B2)',
        '137,17,0,launchd,Software Signing',
        '137,17,222,netbiosd,',
        '137,17,222,netbiosd,Software Signing',
        '138,17,0,launchd,Software Signing',
        '138,17,222,netbiosd,Software Signing',
        '2112,6,500,fake,',
        '2112,6,500,rekor-server,',
        '2112,6,500,timestamp-server,',
        '22,6,0,launchd,Software Signing',
        '22,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '22000,6,500,syncthing,',
        '2345,6,500,dlv,',
        '24678,6,500,node,',
        '24800,6,500,deskflow-server,',
        '25565,6,500,java,',
        '3306,6,500,mariadbd,',
        '33333,6,500,Ultimate,',
        '4001,6,500,ipfs,',
        '41949,6,500,IPNExtension,Apple Mac OS Application Signing',
        '43398,6,500,IPNExtension,Apple Mac OS Application Signing',
        '443,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '443,6,500,crc,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        '443,6,500,limactl,',
        '443,6,500,OrbStack Helper,Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
        '443,6,500,ssh,Software Signing',
        '45972,6,500,IPNExtension,Apple Mac OS Application Signing',
        '49152,6,0,AirPlayXPCHelper,Software Signing',
        '49152,6,0,launchd,Software Signing',
        '49152,6,0,remoted,Software Signing',
        '49152,6,0,remotepairingdeviced,Software Signing',
        '49152,6,0,webfilterproxyd,Software Signing',
        '49152,6,500,AUHostingServiceXPC_arrow,Software Signing',
        '49152,6,500,barrier',
        '49152,6,500,ChatGPT,Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)',
        '49152,6,500,ContinuityCaptureAgent,Software Signing',
        '49152,6,500,curl,Software Signing',
        '49152,6,500,GarageBand,Apple Mac OS Application Signing',
        '49152,6,500,git-daemon,',
        '49152,6,500,HP Smart,Apple Mac OS Application Signing',
        '49152,6,500,IPNExtension,Apple Mac OS Application Signing',
        '49152,6,500,java,',
        '49152,6,500,java,Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR)',
        '49152,6,500,Logic Pro X,Apple Mac OS Application Signing',
        '49152,6,500,Music,Software Signing',
        '49152,6,500,node,',
        '49152,6,500,OmniFocus,Apple Mac OS Application Signing',
        '49152,6,500,org.mozilla.updater,Developer ID Application: Mozilla Corporation (43AQ936H96)',
        '49152,6,500,pCloud Drive,Developer ID Application: PCLOUD LTD (KSTWHH4JHP)',
        '49152,6,500,qemu-system-aarch64,',
        '49152,6,500,rapportd,Software Signing',
        '49152,6,500,siriactionsd,Software Signing',
        '49152,6,500,telepresence,',
        '49152,6,65,mDNSResponder,Software Signing',
        '5000,6,500,ControlCenter,Software Signing',
        '5001,6,500,crane,',
        '5001,6,500,Record It,Apple Mac OS Application Signing',
        '5060,6,500,CommCenter,Software Signing',
        '53,17,500,dnsmasq,',
        '53,17,500,server,',
        '53,17,65,mDNSResponder,',
        '53,17,65,mDNSResponder,Software Signing',
        '53,6,500,dnsmasq,',
        '53,6,65,mDNSResponder,Software Signing',
        '5432,6,500,postgres',
        '5433,6,500,postgres',
        '546,17,0,configd,Software Signing',
        '547,17,500,dhcp6d,',
        '547,17,500,dhcp6d,Software Signing',
        '5900,6,0,launchd,Software Signing',
        '5900,6,0,screensharingd,Software Signing',
        '6000,6,500,X11.bin,Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',
        '631,6,0,cupsd,Software Signing',
        '6650,6,500,java,',
        '67,17,0,bootpd,Software Signing',
        '67,17,0,launchd,Software Signing',
        '68,17,0,configd,Software Signing',
        '7000,6,500,ControlCenter,Software Signing',
        '773,17,0,startupdiskhelper,Software Signing',
        '80,6,500,com.docker.backend,',
        '80,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',
        '80,6,500,crc,',
        '80,6,500,crc,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
        '80,6,500,limactl,',
        '80,6,500,OrbStack Helper,Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
        '80,6,500,ssh,Software Signing',
        '8055,6,500,java,',
        '8081,6,500,crane,',
        '8082,6,500,java,',
        '81,6,500,nginx,',
        '8770,6,500,sharingd,Software Signing',
        '8771,6,500,sharingd,Software Signing',
        '88,17,0,kdc,Software Signing',
        '88,6,0,kdc,Software Signing',
        '8888,6,500,otel-desktop-viewer,',
        '9101,6,500,github_actions_exporter,'
      )
      AND NOT exception_key LIKE '%,0,rpc.%,Software Signing'
      AND NOT (
        lp.port > 1024
        AND lp.protocol = 6
        -- NOTE: Do not include 'Software Signing' in this list, as it may
        -- hide unanticipated uses of system utilities, like Screen Saharing.
        AND signature.authority IN (
          'Apple Development: Jakub Gluszkiewicz (2LC3SFDY52)',
          'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
          'Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',
          'Developer ID Application: ARDUINO SA (7KT7ZWMCJT)',
          'Developer ID Application: Astro HQ LLC (8356ZZ8Y5K)',
          'Developer ID Application: Blackmagic Design Inc (9ZGFBWLSYP)',
          'Developer ID Application: Bohemian Coding (WUGMZZ5K46)',
          'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',
          'Developer ID Application: Canon Electronics Inc. (MKRQ6AC8Z5)',
          'Developer ID Application: Capture One A/S (5WTDB5F65L)',
          'Developer ID Application: Cisco (DE8Y96K9QP)',
          'Developer ID Application: CORE.AI SCIENTIFIC TECHNOLOGIES PRIVATE LIMITED (8F632A866K)',
          'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
          'Developer ID Application: Cypress.Io, Inc. (7D655LWGLY)',
          'Developer ID Application: DBeaver Corporation (42B6MDKMW8)',
          'Developer ID Application: Docker Inc (9BNSXJN65R)',
          'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
          'Developer ID Application: Duet, Inc. (J6L96W8A86)',
          'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
          'Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',
          'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',
          'Developer ID Application: EXAFUNCTION, INC. (83Z2LHX6XW)',
          'Developer ID Application: Focusrite Audio Engineering Ltd. (7VYBQV3T2Q)',
          'Developer ID Application: Jakob Borg (LQE5SYM783)',
          'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',
          'Developer ID Application: Kastelo AB (LQE5SYM783)',
          'Developer ID Application: Linear Orbit, Inc. (7VZ2S3V9RV)',
          'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
          'Developer ID Application: Loupedeck Oy (M24R8BN5BK)',
          'Developer ID Application: Martijn Smit (GX645XXEAX)',
          'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
          'Developer ID Application: Node.js Foundation (HX7739G8FX)',
          'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',
          'Developer ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',
          'Developer ID Application: Postdot Technologies, Inc (H7H8Q7M5CK)',
          'Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',
          'Developer ID Application: Raycast Technologies Inc (SY64MV22J9)',
          'Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',
          'Developer ID Application: Remo Tech Co.,Ltd. (7GJANK3822)',
          'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',
          'Developer ID Application: Roon Labs LLC (WU8DGC424P)',
          'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',
          'Developer ID Application: Shenzhen Arashi Vision Co., Ltd. (847R5ZLN8S)',
          'Developer ID Application: Signal Messenger, LLC (U68MSDN6DR)',
          'Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',
          'Developer ID Application: Sonos, Inc. (2G4LW83Q3E)',
          'Developer ID Application: SOURCEGRAPH INC (74A5FJ7P96)',
          'Developer ID Application: Spotify (2FNC3A47ZF)',
          'Developer ID Application: Symless Ltd (4HX897Y6GJ)',
          'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
          'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
          'Developer ID Application: Universal Audio (4KAC9AX6CG)',
          'Developer ID Application: Ubiquiti Inc. (4P645293E8)',
          'Developer ID Application: Valve Corporation (MXGJJ98X76)',
          'Developer ID Application: X-Rite, Incorporated (2K7GT73B4R)'
        )
      )
      AND NOT (
        exception_key LIKE '%,6,500,IPNExtension,Apple Mac OS Application Signing'
        AND lp.port > 5000
      )
      AND NOT (
        exception_key LIKE '3%,6,500,java,'
        AND p.cwd LIKE '/Users/%'
      )
      AND NOT (
        p.path LIKE ',ko-app,%'
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        (
          p.name IN (
            'caddy',
            'com.docker.backend',
            'controller',
            'crane',
            'crc',
            'curl',
            'docker-proxy',
            'gvproxy',
            'hugo',
            'kubectl',
            'node',
            'OrbStack Helper',
            'ssh',
            'webhook'
          )
          OR p.name LIKE 'kubectl.%'
          OR p.name LIKE '__%_go'
          OR p.name LIKE 'python3.%'
          OR p.name LIKE 'python2.7%'
        )
        AND lp.port > 1024
        and lp.protocol = 6
      )
      AND NOT (
        p.path LIKE '/private/var/folders/%/go-build%/exe/%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
      AND NOT (
        p.path LIKE '/Users/%/Library/Caches/go-build%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
      AND NOT (
        (
          p.cwd LIKE '/Users/%/src/%'
          OR p.cwd LIKE '/Users/%/dev/%'
        )
        AND p.cmdline LIKE './%'
        AND lp.port > 1024
        AND lp.protocol = 6
      )
      AND NOT (
        (
          p.path = '/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent'
          AND lp.port = 3283
          AND lp.protocol = 6
        )
      )
      AND NOT (
        p.path = '/System/Library/CoreServices/UniversalControl.app/Contents/MacOS/UniversalControl'
        AND lp.port > 5000
      )
      AND NOT (
        (
          exception_key LIKE '80,6,500,ssh,Software Signing'
          AND p.cmdline LIKE '%/.colima/_lima/colima-docker/ssh.sock%'
        )
      )
    GROUP BY
      exception_key
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Lock Opener"
  description: Find unexpected programs with open lock files
  query: |
    SELECT
      CONCAT (
        MIN(p0.euid, 500),
        ',',
        COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path),
        ',',
        COALESCE(
          REGEX_MATCH (REPLACE(pof.path, u.directory, '~'), '(.*)/.*', 1),
          REPLACE(pof.path, u.directory, '~')
        )
      ) AS exception_key,
      pof.path AS lock,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN users u ON p0.euid = u.uid
      LEFT JOIN process_open_files pof ON p0.pid = pof.pid
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      pof.path LIKE "%.lock"
      AND NOT pof.path NOT LIKE "/run/user/%/%.lock"
      AND NOT p0.path LIKE '/System/%'
      AND NOT exception_key IN (
        '0,com.apple.MobileSoftwareUpdate.CryptegraftService,/private/var/db/softwareupdate/SplunkHistory',
        '0,snapd,/var/lib/snapd',
        '120,gnome-shell,/run/user/120',
        '120,pipewire,/run/user/120',
        '127,pipewire,/run/user/127',
        '200,NRDUpdated,/private~/SplunkHistory',
        '200,softwareupdated,/private~/SplunkHistory',
        '500,Adobe Premiere Pro 2023,~/Library/Caches/Adobe/Premiere Pro/23.0/SentryIO-db',
        '500,Beeper,~/Library/Application Support/Beeper/EventStore',
        '500,bridge,~/Library/Application Support/protonmail/bridge-v3/sentry_cache',
        '500,bridge,~/Library/Caches/protonmail/bridge-v3',
        '500,bridge-gui,~/Library/Application Support/protonmail/bridge-v3/sentry_cache',
        '500,bridge-gui,~/Library/Caches/protonmail/bridge-v3',
        '500,buildkitd,~/.local/share/buildkit',
        '500,Clipy,~/Library/Application Support/com.clipy-app.Clipy',
        '500,com.docker.backend,~/Library/Containers/com.docker.docker',
        '500,com.docker.build,~/.docker/desktop-build',
        '500,Craft,~/Library/Containers/com.lukilabs.lukiapp/Data/Library/Application Support/com.lukilabs.lukiapp',
        '500,Ecamm Live Stream Deck Plugin,~/Library/Application Support/com.elgato.StreamDeck/Sentry',
        '500,firefox,/run/user/1000/snap.firefox',
        '500,flyctl,~/.fly',
        '500,gnome-shell,/run/user/1000',
        '500,Hyprland,/run/user/1000',
        '500,iMovie,~/Movies/iMovie Library.imovielibrary',
        '500,kwin_wayland_wrapper,/run/user/1000',
        '500,Opera,~/Library/Application Support/com.operasoftware.Opera',
        '500,photolibraryd,~/Library/Photos/Libraries/Syndication.photoslibrary/database',
        '500,photolibraryd,~/Pictures/Photos Library.photoslibrary/database',
        '500,pipewire,/run/user/1000',
        '500,reMarkable,~/Library/Application Support/remarkable/desktop',
        '500,Stream Deck,~/Library/Application Support/com.elgato.StreamDeck/Sentry',
        '500,sway,/run/user/1000',
        '500,TwitchStudioStreamDeck,~/Library/Application Support/com.elgato.StreamDeck/Sentry'
      )
      AND NOT exception_key LIKE '%,gnome-shell,/run/user/%'
      AND NOT exception_key LIKE '%,pipewire%,/run/user/%'
      AND NOT exception_key LIKE '0,prl_disp_service,/Users/%/Parallels/%.pvm'
      AND NOT exception_key LIKE '500,%,/private/var/folders/%/T/Sentry_StreamDeck'
      AND NOT exception_key LIKE '500,com.apple.Virtualization.VirtualMachine,/private/var/folders/%'
      AND NOT exception_key LIKE '500,com.apple.Virtualization.VirtualMachine,~/%'
      AND NOT exception_key LIKE '500,com.docker.backend,/private/var/folders/%/go/pkg/mod/cache/%'
      AND NOT exception_key LIKE '500,gnome-software,/var/tmp/flatpak-cache-%'
      AND NOT exception_key LIKE '500,go,~/go/pkg/mod/cache/download/%'
      AND NOT exception_key LIKE '500,golangci-lint,/private/var/folders/%/T'
      AND NOT exception_key LIKE '500,iMovie,%.imovielibrary'
      AND NOT exception_key LIKE '500,iTermServer-%,~/Library/Application Support/iTerm2'
      AND NOT exception_key LIKE '500,lua-language-server,~/%'
      AND NOT exception_key LIKE '500,remindd,/private/var/folders/%/T/.AddressBookLocks'
      AND NOT exception_key LIKE '500,ykman-gui,/private/var/folders/%/T'
    GROUP BY
      p0.path,
      pof.path
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Uid0 Daemon Macos"
  description: Unexpected long-running processes running as root
  query: |
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      DATETIME(f.ctime, 'unixepoch') AS p0_changed,
      DATETIME(f.mtime, 'unixepoch') AS p0_modified,
      (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN file f ON p0.path = f.path
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE -- Focus on longer-running programs
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid = 0
          AND start_time < (strftime('%s', 'now') - 900)
          AND parent != 0 -- Assume STP
          AND path NOT IN (
            '/Applications/ExpressVPN.app/Contents/MacOS/expressvpnd',
            '/Applications/Foxit PDF Reader.app/Contents/MacOS/FoxitPDFReaderUpdateService.app/Contents/MacOS/FoxitPDFReaderUpdateService',
            '/Applications/OneDrive.app/Contents/StandaloneUpdaterDaemon.xpc/Contents/MacOS/StandaloneUpdaterDaemon',
            '/Applications/Opal.app/Contents/Library/LaunchServices/com.opalcamera.cameraExtensionShim',
            '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service.app/Contents/MacOS/prl_disp_service',
            '/Applications/Parallels Desktop.app/Contents/MacOS/prl_naptd',
            '/Applications/Slack.app/Contents/Frameworks/Squirrel.framework/Resources/ShipIt',
            '/Applications/Tailscale.app/Contents/Frameworks/Sparkle.framework/Versions/B/Autoupdate',
            '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx',
            '/Applications/WiFiman Desktop.app/Contents/service/wifiman-desktopd',
            '/bin/bash',
            '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/MacOS/XProtect',
            '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/XPCServices/XProtectPluginService.xpc/Contents/MacOS/XProtectPluginService',
            '/Library/Application Support/Adobe/Adobe Desktop Common/ElevationManager/Adobe Installer',
            '/Library/Application Support/Fortinet/FortiClient/bin/fcconfig',
            '/Library/Application Support/Fortinet/FortiClient/bin/fctservctl',
            '/Library/Application Support/iStat Menus 7/com.bjango.istatmenus.daemon',
            '/Library/Application Support/Objective Development/Little Snitch/Components/at.obdev.littlesnitch.daemon.bundle/Contents/MacOS/at.obdev.littlesnitch.daemon',
            '/Library/Application Support/Paragon Software/com.paragon-software.extfsd',
            '/Library/Application Support/Paragon Software/com.paragon-software.ntfsd',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmnet-bridge',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmnet-dhcpd',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmnet-natd',
            '/Library/Application Support/VMware/VMware Fusion/Services/Contents/Library/vmware-usbarbitrator',
            '/Library/Application Support/X-Rite/Frameworks/XRiteDevice.framework/Versions/B/Resources/xrdd',
            '/Library/Audio/Plug-Ins/HAL/SolsticeDesktopSpeakers.driver/Contents/XPCServices/RelayXpc.xpc/Contents/MacOS/RelayXpc',
            '/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Resources/Java Updater.app/Contents/MacOS/Java Updater',
            '/Library/Nessus/run/sbin/nessus-service',
            '/Library/Nessus/run/sbin/nessusd',
            '/Library/PrivilegedHelperTools/com.adobe.acc.installer.v2',
            '/Library/PrivilegedHelperTools/com.docker.vmnetd',
            '/Library/PrivilegedHelperTools/com.fortinet.forticlient.macos.PrivilegedHelper',
            '/Library/PrivilegedHelperTools/com.kairos.awdltool.xpc',
            '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent',
            '/Library/PrivilegedHelperTools/com.prosofteng.DRInstaller',
            '/Library/PrivilegedHelperTools/keybase.Helper',
            '/Library/PrivilegedHelperTools/licenseDaemon.app/Contents/MacOS/licenseDaemon',
            '/Library/PrivilegedHelperTools/MHLinkServer.app/Contents/MacOS/MHLinkServer',
            '/Library/SystemExtensions/0FDB5206-860F-465C-B4D3-D6A0F43F4302/com.google.one.NetworkExtension.systemextension/Contents/MacOS/com.google.one.NetworkExtension',
            '/Library/SystemExtensions/2DA71D8A-7905-4012-A7D5-0B246D5AA77B/at.obdev.littlesnitch.networkextension.systemextension/Contents/MacOS/at.obdev.littlesnitch.networkextension',
            '/Library/SystemExtensions/49C3C4AF-624C-4E94-992A-4B2B25ED328E/ch.protonvpn.mac.WireGuard-Extension.systemextension/Contents/MacOS/ch.protonvpn.mac.WireGuard-Extension',
            '/Library/SystemExtensions/4D1BF33A-9817-45D7-A242-8C39810C7F11/com.redcanary.agent.securityextension.systemextension/Contents/MacOS/com.redcanary.agent.securityextension',
            '/Library/SystemExtensions/CC9A335C-A6D0-4C87-B902-45EBDF4BFD85/com.google.one.NetworkExtension.systemextension/Contents/MacOS/com.google.one.NetworkExtension',
            '/opt/colima/bin/socket_vmnet',
            '/opt/homebrew/Cellar/telepresence-arm64/2.7.6/bin/telepresence',
            '/opt/osquery/lib/osquery.app/Contents/MacOS/osqueryd',
            '/opt/socket_vmnet/bin/socket_vmnet',
            '/opt/finch/bin/socket_vmnet',
            '/sbin/launchd',
            '/System/Library/CoreServices/backupd.bundle/Contents/Resources/backupd',
            '/System/Library/CoreServices/backupd.bundle/Contents/Resources/backupd-helper',
            '/System/Library/CoreServices/CrashReporterSupportHelper',
            '/System/Library/CoreServices/iconservicesagent',
            '/System/Library/CoreServices/launchservicesd',
            '/System/Library/CoreServices/logind',
            '/System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow',
            '/System/Library/CoreServices/osanalyticshelper',
            '/System/Library/CoreServices/powerd.bundle/powerd',
            '/System/Library/CoreServices/ReportCrash',
            '/System/Library/CoreServices/sharedfilelistd',
            '/System/Library/CoreServices/Software Update.app/Contents/Resources/suhelperd',
            '/System/Library/CoreServices/SubmitDiagInfo',
            '/System/Library/CryptoTokenKit/com.apple.ifdreader.slotd/Contents/MacOS/com.apple.ifdreader',
            '/System/Library/CryptoTokenKit/com.apple.ifdreader.slotd/Contents/XPCServices/com.apple.ifdbundle.xpc/Contents/MacOS/com.apple.ifdbundle',
            '/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/HIServices.framework/Versions/A/XPCServices/com.apple.hiservices-xpcservice.xpc/Contents/MacOS/com.apple.hiservices-xpcservice',
            '/System/Library/Frameworks/AudioToolbox.framework/AudioComponentRegistrar',
            '/System/Library/Frameworks/AudioToolbox.framework/XPCServices/CAReportingService.xpc/Contents/MacOS/CAReportingService',
            '/System/Library/Frameworks/AudioToolbox.framework/XPCServices/com.apple.audio.SandboxHelper.xpc/Contents/MacOS/com.apple.audio.SandboxHelper',
            '/System/Library/Frameworks/ColorSync.framework/Versions/A/XPCServices/com.apple.ColorSyncXPCAgent.xpc/Contents/MacOS/com.apple.ColorSyncXPCAgent',
            '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/com.apple.cmio.registerassistantservice',
            '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/iOSScreenCapture.plugin/Contents/Resources/iOSScreenCaptureAssistant',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/Support/coreservicesd',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/CarbonCore.framework/Versions/A/XPCServices/csnameddatad.xpc/Contents/MacOS/csnameddatad',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/FSEvents.framework/Versions/A/Support/fseventsd',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mds',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mds_stores',
            '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mdsync',
            '/System/Library/Frameworks/CryptoTokenKit.framework/ctkahp.bundle/Contents/MacOS/ctkahp',
            '/System/Library/Frameworks/GSS.framework/Helpers/GSSCred',
            '/System/Library/Frameworks/LocalAuthentication.framework/Support/coreauthd',
            '/System/Library/Frameworks/Metal.framework/Versions/A/XPCServices/MTLCompilerService.xpc/Contents/MacOS/MTLCompilerService',
            '/System/Library/Frameworks/NetFS.framework/Versions/A/XPCServices/PlugInLibraryService.xpc/Contents/MacOS/PlugInLibraryService',
            '/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/CVMServer',
            '/System/Library/Frameworks/PCSC.framework/Versions/A/XPCServices/com.apple.ctkpcscd.xpc/Contents/MacOS/com.apple.ctkpcscd',
            '/System/Library/Frameworks/PreferencePanes.framework/Versions/A/XPCServices/cacheAssistant.xpc/Contents/MacOS/cacheAssistant',
            '/System/Library/Frameworks/Security.framework/Versions/A/XPCServices/authd.xpc/Contents/MacOS/authd',
            '/System/Library/Frameworks/Security.framework/Versions/A/XPCServices/com.apple.CodeSigningHelper.xpc/Contents/MacOS/com.apple.CodeSigningHelper',
            '/System/Library/Frameworks/SystemExtensions.framework/Versions/A/Helpers/sysextd',
            '/System/Library/PrivateFrameworks/AccountPolicy.framework/XPCServices/com.apple.AccountPolicyHelper.xpc/Contents/MacOS/com.apple.AccountPolicyHelper',
            '/System/Library/PrivateFrameworks/AmbientDisplay.framework/Versions/A/XPCServices/com.apple.AmbientDisplayAgent.xpc/Contents/MacOS/com.apple.AmbientDisplayAgent',
            '/System/Library/PrivateFrameworks/AppleCredentialManager.framework/AppleCredentialManagerDaemon',
            '/System/Library/PrivateFrameworks/AppleNeuralEngine.framework/XPCServices/ANECompilerService.xpc/Contents/MacOS/ANECompilerService',
            '/System/Library/PrivateFrameworks/AppleNeuralEngine.framework/XPCServices/ANEStorageMaintainer.xpc/Contents/MacOS/ANEStorageMaintainer',
            '/System/Library/PrivateFrameworks/ApplePushService.framework/apsd',
            '/System/Library/PrivateFrameworks/AppSSO.framework/Support/AppSSODaemon',
            '/System/Library/PrivateFrameworks/AppStoreDaemon.framework/Versions/A/XPCServices/com.apple.AppStoreDaemon.StorePrivilegedTaskService.xpc/Contents/MacOS/com.apple.AppStoreDaemon.StorePrivilegedTaskService',
            '/System/Library/PrivateFrameworks/AssetCacheServicesExtensions.framework/Versions/A/XPCServices/AssetCacheManagerService.xpc/Contents/MacOS/AssetCacheManagerService',
            '/System/Library/PrivateFrameworks/AssetCacheServicesExtensions.framework/Versions/A/XPCServices/AssetCacheTetheratorService.xpc/Contents/MacOS/AssetCacheTetheratorService',
            '/System/Library/PrivateFrameworks/AuthKit.framework/Versions/A/Support/akd',
            '/System/Library/PrivateFrameworks/BackgroundTaskManagement.framework/Versions/A/Resources/backgroundtaskmanagementd',
            '/System/Library/PrivateFrameworks/BridgeOSInstallReporting.framework/Versions/A/Resources/bosreporter',
            '/System/Library/PrivateFrameworks/CacheDelete.framework/deleted_helper',
            '/System/Library/PrivateFrameworks/CloudKitDaemon.framework/Support/cloudd',
            '/System/Library/PrivateFrameworks/CoreAccessories.framework/Support/accessoryd',
            '/System/Library/PrivateFrameworks/CoreDuetContext.framework/Versions/A/Resources/contextstored',
            '/System/Library/PrivateFrameworks/CoreKDL.framework/Support/corekdld',
            '/System/Library/PrivateFrameworks/CoreSymbolication.framework/coresymbolicationd',
            '/System/Library/PrivateFrameworks/FamilyControls.framework/Versions/A/Resources/parentalcontrolsd',
            '/System/Library/PrivateFrameworks/FindMyMac.framework/Versions/A/Resources/FindMyMacd',
            '/System/Library/PrivateFrameworks/GenerationalStorage.framework/Versions/A/Support/revisiond',
            '/System/Library/PrivateFrameworks/GeoServices.framework/Versions/A/XPCServices/com.apple.geod.xpc/Contents/MacOS/com.apple.geod',
            '/System/Library/PrivateFrameworks/Heimdal.framework/Helpers/kdc',
            '/System/Library/PrivateFrameworks/InstallerDiagnostics.framework/Versions/A/Resources/installerdiagd',
            '/System/Library/PrivateFrameworks/InstallerDiagnostics.framework/Versions/A/Resources/installerdiagwatcher',
            '/System/Library/PrivateFrameworks/MediaRemote.framework/Support/mediaremoted',
            '/System/Library/PrivateFrameworks/MobileInstallation.framework/XPCServices/com.apple.MobileInstallationHelperService.xpc/Contents/MacOS/com.apple.MobileInstallationHelperService',
            '/System/Library/PrivateFrameworks/MobileSoftwareUpdate.framework/Versions/A/XPCServices/com.apple.MobileSoftwareUpdate.CleanupPreparePathService.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.CleanupPreparePathService',
            '/System/Library/PrivateFrameworks/Noticeboard.framework/Versions/A/Resources/nbstated',
            '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/installd',
            '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/system_installd',
            '/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service',
            '/System/Library/PrivateFrameworks/SiriInference.framework/Support/siriinferenced',
            '/System/Library/PrivateFrameworks/SkyLight.framework/Versions/A/Resources/WindowServer',
            '/System/Library/PrivateFrameworks/StorageKit.framework/Versions/A/Resources/storagekitd',
            '/System/Library/PrivateFrameworks/SystemAdministration.framework/XPCServices/writeconfig.xpc/Contents/MacOS/writeconfig',
            '/System/Library/PrivateFrameworks/SystemMigration.framework/Versions/A/Resources/systemmigrationd',
            '/System/Library/PrivateFrameworks/SystemStatusServer.framework/Support/systemstatusd',
            '/System/Library/PrivateFrameworks/TCC.framework/Support/tccd',
            '/System/Library/PrivateFrameworks/Uninstall.framework/Versions/A/Resources/uninstalld',
            '/System/Library/PrivateFrameworks/ViewBridge.framework/Versions/A/XPCServices/ViewBridgeAuxiliary.xpc/Contents/MacOS/ViewBridgeAuxiliary',
            '/System/Library/PrivateFrameworks/WiFiPolicy.framework/XPCServices/WiFiCloudAssetsXPCService.xpc/Contents/MacOS/WiFiCloudAssetsXPCService',
            '/System/Library/PrivateFrameworks/WirelessDiagnostics.framework/Support/awdd',
            '/System/Library/PrivateFrameworks/XprotectFramework.framework/Versions/A/XPCServices/XProtectBehaviorService.xpc/Contents/MacOS/XProtectBehaviorService',
            '/System/Library/PrivateFrameworks/XprotectFramework.framework/Versions/A/XPCServices/XprotectService.xpc/Contents/MacOS/XprotectService',
            '/usr/bin/login',
            '/usr/bin/sudo',
            '/usr/bin/sysdiagnose',
            '/usr/libexec/AirPlayXPCHelper',
            '/usr/libexec/airportd',
            '/usr/libexec/amfid',
            '/usr/libexec/aned',
            '/usr/libexec/apfsd',
            '/usr/libexec/applessdstatistics',
            '/usr/libexec/ApplicationFirewall/socketfilterfw',
            '/usr/libexec/ASPCarryLog',
            '/usr/libexec/autofsd',
            '/usr/libexec/automountd',
            '/usr/libexec/batteryintelligenced',
            '/usr/libexec/biokitaggdd',
            '/usr/libexec/biometrickitd',
            '/usr/libexec/bootinstalld',
            '/usr/libexec/colorsync.displayservices',
            '/usr/libexec/colorsyncd',
            '/usr/libexec/configd',
            '/usr/libexec/containermanagerd',
            '/usr/libexec/corebrightnessd',
            '/usr/libexec/coreduetd',
            '/usr/libexec/corestoraged',
            '/usr/libexec/cryptexd',
            '/usr/libexec/dasd',
            '/usr/libexec/dirhelper',
            '/usr/libexec/diskarbitrationd',
            '/usr/libexec/diskmanagementd',
            '/usr/libexec/dprivacyd',
            '/usr/libexec/endpointsecurityd',
            '/usr/libexec/findmydeviced',
            '/usr/libexec/firmwarecheckers/ethcheck/ethcheck',
            '/usr/libexec/InternetSharing',
            '/usr/libexec/IOMFB_bics_daemon',
            '/usr/libexec/ioupsd',
            '/usr/libexec/kernelmanagerd',
            '/usr/libexec/keybagd',
            '/usr/libexec/logd',
            '/usr/libexec/logd_helper',
            '/usr/libexec/lsd',
            '/usr/libexec/mdmclient',
            '/usr/libexec/memoryanalyticsd',
            '/usr/libexec/microstackshot',
            '/usr/libexec/misagent',
            '/usr/libexec/mobileactivationd',
            '/usr/libexec/mobileassetd',
            '/Library/Application Support/com.canonical.multipass/bin/multipassd',
            '/usr/libexec/multiversed',
            '/usr/libexec/nehelper',
            '/usr/libexec/nesessionmanager',
            '/usr/libexec/online-authd',
            '/usr/libexec/opendirectoryd',
            '/usr/libexec/PerfPowerServices',
            '/usr/libexec/periodic-wrapper',
            '/usr/libexec/powerdatad',
            '/usr/libexec/PowerUIAgent',
            '/usr/libexec/remoted',
            '/usr/libexec/rtcreportingd',
            '/usr/libexec/runningboardd',
            '/usr/libexec/sandboxd',
            '/usr/libexec/searchpartyd',
            '/usr/libexec/secinitd',
            '/usr/libexec/securityd_service',
            '/usr/libexec/smd',
            '/usr/libexec/storagekitd',
            '/usr/libexec/symptomsd-diag',
            '/usr/libexec/sysmond',
            '/usr/libexec/syspolicyd',
            '/usr/libexec/tailspind',
            '/usr/libexec/taskgated',
            '/usr/libexec/thermald',
            '/usr/libexec/thermalmonitord',
            '/usr/libexec/TouchBarServer',
            '/usr/libexec/trustdFileHelper',
            '/usr/libexec/tzd',
            '/usr/libexec/tzlinkd',
            '/usr/libexec/usbd',
            '/usr/libexec/UserEventAgent',
            '/usr/libexec/usermanagerd',
            '/usr/libexec/warmd',
            '/usr/libexec/watchdogd',
            '/usr/libexec/wifianalyticsd',
            '/usr/libexec/wifip2pd',
            '/usr/libexec/wifivelocityd',
            '/usr/local/bin/warsaw/core',
            '/usr/local/kolide-k2/bin/osquery-extension.ext',
            '/usr/local/sbin/velociraptor',
            '/usr/sbin/aslmanager',
            '/usr/sbin/audioclocksyncd',
            '/usr/sbin/auditd',
            '/usr/sbin/BlueTool',
            '/usr/sbin/bluetoothd',
            '/usr/sbin/BTLEServer',
            '/usr/sbin/cfprefsd',
            '/usr/sbin/distnoted',
            '/usr/sbin/filecoordinationd',
            '/usr/sbin/KernelEventAgent',
            '/usr/sbin/mDNSResponderHelper',
            '/usr/sbin/notifyd',
            '/usr/sbin/securityd',
            '/usr/sbin/spindump',
            '/usr/sbin/sshd',
            '/usr/sbin/syslogd',
            '/usr/sbin/systemsoundserverd',
            '/usr/sbin/systemstats',
            '/usr/sbin/WirelessRadioManagerd'
          )
          AND NOT path LIKE '/nix/store/%/bin/%'
          AND NOT path LIKE '/opt/homebrew/Cellar/btop/%/bin/btop'
          AND NOT path LIKE '/opt/homebrew/Cellar/htop/%/bin/htop'
          AND NOT path LIKE '/opt/homebrew/Cellar/mtr/%/sbin/%'
          AND NOT path LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
          AND NOT path LIKE '/usr/local/Cellar/btop/%/bin/btop'
          AND NOT path LIKE '/usr/local/Cellar/htop/%/bin/htop'
          AND NOT path LIKE '/opt/homebrew/Cellar/cloud-provider-kind/%/bin/cloud-provider-kind'
          AND NOT path LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'
          AND NOT path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'
        GROUP BY
          path
      )
      AND NOT s.authority IN (
        'Apple Mac OS Application Signing',
        'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)',
        'Developer ID Application: Adobe Inc. (JQ525L2MZD)',
        'Developer ID Application: AMZN Mobile LLC (94KV3E626L)',
        'Developer ID Application: AVM Software, Inc (72D53DS677)',
        'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',
        'Developer ID Application: Bjango Pty Ltd (Y93TK974AT)',
        'Developer ID Application: Canonical Group Limited (X4QN7LTP59)',
        'Developer ID Application: Cloudflare Inc. (68WVV388M8)',
        'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',
        'Developer ID Application: Creative Labs Pte. Ltd. (5Q3552844F)',
        'Developer ID Application: Determinate Systems, Inc. (X3JQ4VPJZ6)',
        'Developer ID Application: Docker Inc (9BNSXJN65R)',
        'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',
        'Developer ID Application: EA Swiss Sarl (TSTV75T6Q5)',
        'Developer ID Application: Ecamm Network, LLC (5EJH68M642)',
        'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',
        'Developer ID Application: Evernote Corporation (Q79WDW8YH9)',
        'Developer ID Application: Focusrite Audio Engineering Ltd. (7VYBQV3T2Q)',
        'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',
        'Developer ID Application: Foxit Corporation (8GN47HTP75)',
        'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',
        'Developer ID Application: Google LLC (EQHXZ8M8AV)',
        'Developer ID Application: Ilya Parniuk (ACC5R6RH47)',
        'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',
        'Developer ID Application: Keybase, Inc. (99229SGT5K)',
        'Developer ID Application: Kolide Inc (YZ3EM74M78)',
        'Developer ID Application: Kolide, Inc (X98UFR7HA3)',
        'Developer ID Application: Justin Johnson (A3W62KZY8Z)',
        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',
        'Developer ID Application: MacPaw Inc. (S8EX82NJP6)',
        'Developer ID Application: Razer USA Ltd. (R2H967U7J8)',
        'Developer ID Application: Mersive Technologies (63B5A5WDNG)',
        'Developer ID Application: Metric Halo Distribution, Inc. (X7EY8SFM86)',
        'Developer ID Application: Microsoft Corporation (UBF8T346G9)',
        'Developer ID Application: Mullvad VPN AB (CKG9MXH72F)',
        'Developer ID Application: Nordvpn S.A. (W5W395V82Y)',
        'Developer ID Application: Objective Development Software GmbH (MLZF7K7B5R)',
        'Developer ID Application: Objective-See, LLC (VBG97UB4TA)',
        'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',
        'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',
        'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',
        'Developer ID Application: PaperCut Software International Pty Ltd (B5N3YV5P2H)',
        'Developer ID Application: Parallels International GmbH (4C6364ACXT)',
        'Developer ID Application: Private Internet Access, Inc. (5357M5NW9W)',
        'Developer ID Application: PROSOFT Engineering, Inc. (L2JPZL6629)',
        'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',
        'Developer ID Application: Razer USA Ltd. (R2H967U7J8)',
        'Developer ID Application: Ryan Hanson (XSYZ3E4B7D)',
        'Developer ID Application: SLACK TECHNOLOGIES L.L.C. (BQR82RBBHL)',
        'Developer ID Application: Slack Technologies, Inc. (BQR82RBBHL)',
        'Developer ID Application: SparkLabs Pty Ltd (34XR7GXFPX)',
        'Developer ID Application: SURFSHARK LTD (YHUG37CKN8)',
        'Developer ID Application: SUSE LLC (2Q6FHJR3H3)',
        'Developer ID Application: Tailscale Inc. (W5364U7YZB)',
        'Developer ID Application: Tenable, Inc. (4B8J598M7U)',
        'Developer ID Application: TomTom (9VXS83DNQ8)',
        'Developer ID Application: Ubiquiti Inc. (4P645293E8)',
        'Developer ID Application: X-Rite, Incorporated (2K7GT73B4R)',
        'Developer ID Application: Y Soft Corporation, a.s. (3CPED8WGS9)',
        'Software Signing'
      )
      AND NOT (
        p0.path = '/Library/Printers/DYMO/Utilities/pnpd'
        AND s.identifier = 'pnpd'
        AND s.authority = 'Developer ID Application: Sanford, L.P. (N3S6676K3E)'
      )
      AND NOT p0_cmd = './perflock -daemon'
    GROUP BY
      p0.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Fake Apple Launchd"
  description: Find launchd entries which purport to be by Apple, but point to binaries that are not signed by Apple.
  query: |
    SELECT
      *
    FROM
      launchd
      LEFT JOIN file ON launchd.path = file.path
      LEFT JOIN signature ON launchd.program_arguments = signature.path
    WHERE
      launchd.name LIKE 'com.apple.%'
      -- Optimization, assumes SIP
      AND file.directory NOT IN (
        '/Library/Apple/System/Library/LaunchAgents',
        '/Library/Apple/System/Library/LaunchDaemons',
        '/System/Library/LaunchAgents',
        '/System/Library/LaunchDaemons'
      )
      AND launchd.run_at_load = 1
      AND signature.authority != 'Software Signing'
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Suspicious Udev Runner Linux"
  description: Look for sketchy udev entries, inspired by sedexp
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      hash.sha256,
      yara.*
    FROM
      file
      JOIN yara ON file.path = yara.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      file.path IN (
        SELECT
          file.path
        FROM
          file
        WHERE
          file.path LIKE '/etc/udev/rules.d/%'
          OR file.path LIKE '/usr/lib/udev/rules.d/%'
          OR file.path LIKE '/lib/udev/rules.d/%'
          OR file.path LIKE '/usr/local/lib/udev/rules.d/%'
        GROUP BY
          file.inode
      )
      AND yara.sigrule = '
    rule udev_memory_device_runner : critical {
        meta:
            description = "runs program once built-in memory device is created"
        strings:
            $action_add = "ACTION==\"add\""
            $major = "ENV{MAJOR}==\"1\""
            $run = "RUN+="
        condition:
            all of them
    }
    
    rule udev_at_runner : critical {
        meta:
            description = "runs program via at"
            reference = "https://ch4ik0.github.io/en/posts/leveraging-Linux-udev-for-persistence/"
        strings:
            $add = "ACTION==\"add\""
            $run_at = "RUN+=\"/usr/bin/at "
            $run_at2 = "RUN+=\"at "
        condition:
            $add and any of ($run*)
    }
    
    rule udev_unusual_small_runner : high {
        meta:
            description = "small udev entry that runs program based on unusual parameters"
        strings:
            $action_run = "RUN+="
            $not_attrs = "ATTRS{"
            $not_kernel = "KERNEL=="
            $not_block = "SUBSYSTEM==\"block\""
            $not_bridge = "RUN+=\"bridge-network-interface\""
        condition:
            filesize < 96 and all of ($action*) and none of ($not*)
    }
    
    rule udev_major_runner : high {
        meta:
            description = "runs program once major device number is created, may have false-positives"
        strings:
            $action_add = "ACTION==\"add\""
            $major = "ENV{MAJOR}=="
            $run = "RUN+="
        condition:
            all of them
    }'
      AND yara.count > 0
      AND NOT (
        matches = "udev_unusual_small_runner"
        AND file.path IN ('/usr/lib/udev/rules.d/99-cec-bluetooth.rules')
        AND file.size = 74
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Unexpected Ssh Authorized Keys"
  description: Find unexpected SSH authorized keys
  query: |
    SELECT
      file.path,
      file.uid,
      file.gid,
      file.atime,
      file.mtime,
      file.ctime,
      file.size,
      hash.sha256,
      users.username,
      users.uid AS u_uid
    FROM
      users
      JOIN file ON file.path = users.directory || "/.ssh/authorized_keys"
      JOIN hash ON file.path = hash.path
    WHERE
      file.size > 0
      AND (
        file.uid != u_uid
        OR file.uid < 500
        OR (
          file.path NOT LIKE '/home/%'
          AND file.path NOT LIKE '/Users/%'
        )
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Yara Libtomcrypt Process"
  description: Linux program uses LibTomCrypt (rare)
  query: |
    SELECT
      yara.strings,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 3600)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '    
          rule redflags {
          strings:
              $email = "tomstdenis@gmail.com"
              $libtomcrypt = "LibTomCrypt"
          condition:
              filesize < 10MB and 1 of them
      }'
      AND yara.count > 0
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/persistence] Yara Suspicious Strings Process Linux"
  description: Currently running program with Linux red flags
  query: |
    SELECT
      yara.strings,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.start_time AS p0_start,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1.start_time AS p1_start,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.start_time AS p2_start,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      JOIN yara ON p0.path = yara.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          start_time > (strftime('%s', 'now') - 7200)
          AND path != ""
        GROUP BY
          path
      )
      AND yara.sigrule = '
        rule redflags {
        strings:
            $avahi = "avahi-daemon:"
            $bash_history = ".bash_history"
            $bin_sh = "/bin/sh"
            $cron = "cron"
            $dev_mqueue = "/dev/mqueue"
            $dev_shm = "/dev/shm"
            $dev_tcp = "/dev/tcp"
            $dev_udp = "/dev/udp"
            $google_chrome = "google-chrome"
            $iptables = "iptables"
            $ld_so = "ld.so.conf"
            $pickup = "pickup -l"
            $proc = "/proc"
            $redhat4 = "Red Hat 4"
            $sudo = "sudo"
            $systemctl = "systemctl"
            $useradd = "useradd"
            $var_run = "/var/run"
            $var_tmp = "/var/tmp"
        condition:
            filesize < 25MB and 5 of them
    }'
      AND yara.count > 0
      AND p0.name NOT IN (
        'chrome_crashpad',
        'X',
        'emacs',
        'git',
        'systemd',
        'NetworkManager',
        'systemd-journal',
        'Xorg',
        'slirp4netns',
        'nacl_helper'
      )
      AND p0.path NOT LIKE '%/google/chrome/%'
      AND p0.path NOT LIKE '%/chrome_crashpad_handler'
      AND p0.path NOT LIKE '/nix/store/%/bin/%'
      AND p0.path NOT LIKE '/nix/store/%/libexec/%'
      AND p0.path NOT LIKE '/usr/local/aws-cli/%/aws'
      AND p0.path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/launcher'
      AND p0.path NOT IN (
        '/bin/bash',
        '/bin/containerd-shim-runc-v2',
        '/bin/dash',
        '/bin/fish',
        '/bin/sh',
        '/opt/Elastic/Endpoint/elastic-endpoint',
        '/usr/bin/bash',
        '/usr/bin/containerd-shim-runc-v2',
        '/usr/bin/docker',
        '/usr/bin/docker-proxy',
        '/usr/bin/fish',
        '/usr/bin/gnome-software',
        '/usr/bin/gpg-agent',
        '/usr/bin/ibus-daemon',
        '/usr/bin/make',
        '/usr/bin/NetworkManager',
        '/usr/bin/nvidia-persistenced',
        '/usr/bin/nvim',
        '/usr/bin/pulseaudio',
        '/usr/bin/snap',
        '/usr/bin/sshd',
        '/usr/bin/sudo',
        '/usr/bin/udevadm',
        '/usr/bin/update-notifier',
        '/usr/bin/Xwayland',
        '/usr/lib/bluetooth/bluetoothd',
        '/usr/lib/bluetooth/obexd',
        '/usr/libexec/accounts-daemon',
        '/usr/libexec/bluetooth/bluetoothd',
        '/usr/libexec/bluetooth/obexd',
        '/usr/libexec/flatpak-system-helper',
        '/usr/libexec/sssd/sssd_kcm',
        '/usr/libexec/xdg-desktop-portal',
        '/usr/lib/opt/kolide-k2/bin/launcher',
        '/usr/lib/snapd/snapd',
        '/usr/lib/systemd/systemd',
        '/usr/lib/systemd/systemd-executor',
        '/usr/lib/systemd/systemd-journald',
        '/usr/lib/systemd/systemd-machined',
        '/usr/local/bin/rootlesskit',
        '/usr/local/kolide-k2/bin/launcher',
        '/usr/sbin/acpid',
        '/usr/sbin/auditd',
        '/usr/sbin/cron',
        '/usr/sbin/crond',
        '/usr/sbin/gdm',
        '/usr/sbin/gssproxy',
        '/usr/sbin/mcelog',
        '/usr/sbin/NetworkManager',
        '/usr/sbin/rsyslogd',
        '/usr/sbin/smartd'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Setxid Env Overflow Attempt"
  description: Find setuid process events with large environment sizes
  query: |
    SELECT
      file.mode AS p0_binary_mode,
      pe.env AS p0_env,
      pe.time AS p0_time,
      pe.env_size AS p0_env_size,
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.euid AS p0_euid,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file ON pe.path = file.path
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -60)
      AND file.mode NOT LIKE '0%'
      AND pe.env_size > 3500
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Unexpected Privileged Containers"
  description: Detect the execution of privileged Docker containers which can be used to escape to the host.
  query: |
    SELECT
      command,
      image_id,
      path,
      security_options,
      started_at,
      image,
      COALESCE(REGEX_MATCH (image, '(.*?):', 1), image) AS image_name
    FROM
      docker_containers
    WHERE
      privileged = 1
      AND image_name NOT IN (
        'distroless.dev/melange',
        'docker.io/library/registry',
        'docker.io/rancher/k3s',
        'gcr.io/k8s-minikube/kicbase',
        'jdk-crac',
        'kindest/node',
        'ligfx/k3d-registry-dockerd',
        'moby/buildkit',
        'wolfi'
      )
      AND image NOT LIKE 'cgr.dev/chainguard%'
      AND image NOT LIKE 'ghcr.io/k3d-io/k3d-%'
      AND image NOT LIKE 'ghcr.io/wolfi-dev/%'
      AND image NOT LIKE 'k3d-k3d.localhost:%'
      AND image NOT LIKE 'melange-%'
      AND command NOT LIKE '/usr/bin/melange build %'
      AND command != '/bin/k3s server'
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Unexpected Setxid Process"
  description: Processes running that originate from setuid/setgid programs
  query: |
    SELECT
      p.pid,
      p.name,
      p.path,
      p.cmdline,
      f.ctime,
      p.cwd,
      p.uid,
      f.mode,
      hash.sha256
    FROM
      processes p
      JOIN file f ON p.path = f.path
      JOIN hash ON p.path = hash.path
    WHERE
      f.mode NOT LIKE '0%'
      AND f.path NOT IN (
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx',
        '/bin/ps',
        '/Library/Application Support/Google/GoogleUpdater/Current/GoogleUpdater.app/Contents/Helpers/launcher',
        '/Library/Application Support/org.pqrs/Karabiner-Elements/bin/karabiner_session_monitor',
        '/Library/DropboxHelperTools/Dropbox_u501/dbkextd',
        '/opt/1Password/1Password-BrowserSupport',
        '/opt/1Password/1Password-KeyringHelper',
        '/opt/Blockbench/chrome-sandbox',
        '/opt/google/chrome/chrome-sandbox',
        '/opt/IRCCloud/chrome-sandbox',
        '/opt/zoom/cef/chrome-sandbox',
        '/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent',
        '/usr/bin/bwrap',
        '/usr/bin/crontab',
        '/usr/bin/doas',
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/bin/keybase-redirector',
        '/usr/bin/login',
        '/usr/bin/mount',
        '/usr/bin/newgrp',
        '/usr/bin/op',
        '/usr/bin/passwd',
        '/usr/bin/schroot',
        '/usr/bin/ssh-agent',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/lib/electron/chrome-sandbox',
        '/usr/lib/electron22/chrome-sandbox',
        '/usr/lib/opt/1Password/1Password-BrowserSupport',
        '/usr/lib/polkit-1/polkit-agent-helper-1',
        '/usr/lib/slack/chrome-sandbox',
        '/usr/lib/xf86-video-intel-backlight-helper',
        '/usr/lib/Xorg.wrap',
        '/usr/sbin/traceroute'
      )
      AND f.filename != 'chrome-sandbox'
      AND f.path NOT LIKE '/Library/Application Support/Google/GoogleUpdater/1%/GoogleUpdater.app/Contents/Helpers/launcher'
      AND f.path NOT LIKE '/opt/homebrew/Cellar/dnsmasq/%/sbin/dnsmasq'
      AND f.path NOT LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
      AND f.path NOT LIKE '/Users/%/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'
      AND f.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Docker Container Mounting Root"
  description: Detect the execution of a Docker containing mounting the root filesystem
  query: |
    SELECT
      command,
      image_id,
      path,
      source,
      destination,
      security_options,
      started_at,
      image
    FROM
      docker_container_mounts AS dcm
      LEFT JOIN docker_containers dc ON dcm.id = dc.id
    WHERE
      dcm.source = "/"
      AND image NOT IN (
        "ghcr.io/ublue-os/bluefin-cli",
        "ghcr.io/ublue-os/ubuntu-toolbox"
      )
      AND image NOT LIKE '%wolfi-sdk-toolbox:latest'
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Setxid Cmdline Overflow Attempt"
  description: Find setuid events with large cmdlines
  query: |
    SELECT
      file.mode AS p0_binary_mode,
      pe.cmdline_size AS p0_cmd_size,
      pe.time AS p0_time,
      -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.euid AS p0_euid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file ON pe.path = file.path
      LEFT JOIN processes p ON pe.pid = p.pid
      -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND file.mode NOT LIKE '0%'
      AND pe.cmdline_size > 2048
      AND p0_cmd NOT LIKE '%sudo dpkg %'
      AND p0_cmd NOT LIKE '%bwrap --bind %'
      AND p0_cmd NOT LIKE '%sudo %--vmodule=% --audit-policy-file=%kube%'
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Unexpected Elevated Children Events Linux"
  description: Find processes that run with a lower effective UID than their parent (event-based)
  query: |
    SELECT
      file.mode AS p0_binary_mode,
      -- Child
      pe.path AS p0_path,
      pe.time AS p0_time,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.uid AS p0_uid,
      pe.euid AS p0_euid,
      pe.pid AS p0_pid,
      p.cgroup_path AS p0_cgroup,
      -- Parent
      pe.parent AS p1_pid,
      p1.cgroup_path AS p1_cgroup,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name
    FROM
      process_events pe
      LEFT JOIN file ON pe.path = file.path
      LEFT JOIN processes p ON pe.pid = pe.pid -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
    WHERE
      pe.pid IN (
        SELECT
          pid
        FROM
          process_events
        WHERE
          time > (strftime('%s', 'now') -600)
          AND syscall = "execve"
          AND euid < 500
          AND (
            uid = 0
            OR euid < uid
          )
      )
      AND pe.time > (strftime('%s', 'now') -600)
      AND pe.syscall = "execve"
      AND pe.euid < 500
      AND (
        pe.euid < pe.uid
        OR pe.euid < p1_euid
        OR pe.euid < pe1.euid
      )
      AND pe.path NOT IN (
        '/bin/ps',
        '/opt/1Password/1Password-KeyringHelper',
        '/usr/bin/doas',
        '/usr/bin/fusermount',
        '/usr/bin/fusermount3',
        '/usr/bin/gpg',
        '/usr/bin/gpgconf',
        '/usr/bin/gpgsm',
        '/usr/bin/i3lock',
        '/usr/bin/login',
        '/usr/bin/nvidia-modprobe',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/bin/unix_chkpwd',
        '/usr/lib/slack/chrome-sandbox',
        '/usr/lib/snapd/snap-confine',
        '/usr/lib/snapd/snap-update-ns',
        '/usr/lib/systemd/systemd',
        '/usr/lib/Xorg.wrap',
        '/usr/lib/xorg/Xorg.wrap'
      )
      AND pe.path NOT LIKE '/nix/store/%/bin/dhcpcd'
      AND pe.path NOT LIKE '/nix/store/%/bin/sudo'
      AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'
      AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns'
      AND NOT p1_cmd IN (
        '/bin/sh -c /usr/bin/pkexec /usr/share/apport/apport-gtk',
        '/usr/lib/systemd/systemd --user'
      )
      AND NOT p0_cmd = '/usr/bin/pkexec /usr/lib/update-notifier/package-system-locked'
      AND NOT (
        p0_name = 'polkit-agent-helper-1'
        AND p1_path IN (
          '/usr/bin/gnome-shell',
          '/usr/lib/gvfsd',
          '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1'
        )
      )
      AND NOT (
        p0_name = 'fusermount3'
        AND p1_path = '/usr/lib/xdg-document-portal'
      )
      AND NOT (
        p0_name IN ('dash', 'pkexec')
        AND p1_path = '/usr/bin/update-notifier'
      ) -- A bizarro persistent false-positive from an Arch linux host
      AND NOT (
        p.cgroup_path = "/init.scope"
        AND p1.cgroup_path != "/init.scope"
      )
      AND NOT p.cgroup_path LIKE '/system.slice/docker-%'
      AND NOT p1.cgroup_path LIKE '/system.slice/docker-%'
    GROUP BY
      pe.pid
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Unexpected Elevated Children Events Macos"
  description: Find processes that run with a lower effective UID than their parent (event-based)
  query: |
    SELECT -- Child
      pe.path AS p0_path,
      REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,
      TRIM(pe.cmdline) AS p0_cmd,
      pe.cwd AS p0_cwd,
      pe.pid AS p0_pid,
      pe.uid AS p0_uid,
      pe.euid AS p0_euid,
      s.authority AS p0_authority,
      -- Parent
      pe.parent AS p1_pid,
      TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,
      COALESCE(p1.path, pe1.path) AS p1_path,
      COALESCE(p1.euid, pe1.euid) AS p1_euid,
      COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,
      REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,
      pe_sig1.authority AS p1_authority,
      -- Grandparent
      COALESCE(p1.parent, pe1.parent) AS p2_pid,
      TRIM(
        COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)
      ) AS p2_cmd,
      COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,
      COALESCE(
        p1_p2_hash.path,
        pe1_p2_hash.path,
        pe1_pe2_hash.path
      ) AS p2_hash,
      REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS p2_name,
      COALESCE(
        p1_p2_sig.authority,
        pe1_p2_sig.authority,
        pe1_pe2_sig.authority
      ) AS p2_authority,
      -- Exception key
      REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (
        COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),
        '.*/(.*)',
        1
      ) AS exception_key
    FROM
      process_events pe,
      uptime
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN signature s ON pe.path = s.path -- Parents (via two paths)
      LEFT JOIN processes p1 ON pe.parent = p1.pid
      AND p1.start_time <= pe.time
      LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path
      LEFT JOIN process_events pe1 ON pe.parent = pe1.pid
      AND pe1.time <= pe.time
      AND pe1.cmdline != ''
      LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path
      LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path -- Grandparents (via 3 paths)
      LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid
      AND p1_p2.start_time <= p1.start_time
      LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid
      AND pe1_p2.start_time <= pe1.time
      LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid
      AND pe1_pe2.cmdline != '' -- Past grandparent via parent events
      LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path
      LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path
      LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path
      LEFT JOIN signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path
      LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path
      LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path
    WHERE
      pe.time > (strftime('%s', 'now') -300)
      AND p0_euid < p1_euid
      AND pe.status = 0
      AND pe.parent > 0
      AND pe.cmdline != ''
      AND pe.cmdline IS NOT NULL
      AND p1_path NOT IN (
        '/Applications/LogiTune.app/Contents/MacOS/LogiTune',
        '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/XPCServices/XProtectPluginService.xpc/Contents/MacOS/XProtectPluginService',
        '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mdworker_shared',
        '/System/Library/PrivateFrameworks/AOSKit.framework/Versions/A/XPCServices/com.apple.iCloudHelper.xpc/Contents/MacOS/com.apple.iCloudHelper',
        '/usr/bin/login',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/libexec/mdmclient',
        '/usr/libexec/PerfPowerServicesExtended',
        '/usr/local/bin/doas'
      ) -- Exclude weird bad data we've seen due to badly recorded macOS parent/child relationships, fixable by reboot
      AND NOT p0_cmd IN (
        '/System/Library/CoreServices/iconservicesd',
        '/System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/A/Support/mdworker_shared -s mdworker -c MDSImporterWorker -m com.apple.mdworker.shared',
        '/System/Library/PrivateFrameworks/CoreSymbolication.framework/coresymbolicationd',
        '/System/Library/PrivateFrameworks/InstallCoordination.framework/Support/installcoordinationd',
        '/usr/libexec/mdmclient daemon',
        '/usr/libexec/PerfPowerServicesExtended',
        '/usr/libexec/wifip2pd',
        '/usr/sbin/cfprefsd agent',
        '/usr/sbin/cupsd -l'
      )
      AND NOT exception_key IN (
        'amfid,0,com.docker.backend,Docker',
        'biometrickitd,0,LogiTune,launchd',
        'bioutil,0,callservicesd,launchd',
        'CAReportingService,0,LogiTune,launchd',
        'com.apple.AccountPolicyHelper,0,LogiTune,launchd',
        'com.apple.geod,0,fmfd,launchd',
        'com.apple.geod,262,com.docker.backend,Docker',
        'com.apple.WebKit.WebContent,200,zsh,Emacs-arm64-11',
        'containermanagerd,262,com.docker.backend,Docker',
        'dprivacyd,0,com.docker.backend,Docker',
        'efilogin-helper,0,containermanagerd,launchd',
        'SCHelper,0,com.docker.backend,Docker',
        'suhelperd,0,LogiTune,launchd',
        'sysextd,0,LogiTune,launchd',
        'system_profiler,0,callservicesd,launchd',
        'trustd,205,trustd,launchd'
      )
      AND NOT (
        pe.euid = 262 -- core media helper id
        AND pe.path = '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/AppleCamera.plugin/Contents/Resources/AppleCameraAssistant'
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Unexpected Privilege Escalation Linux"
  description: Find processes that run with a lower effective UID than their parent (state-based)
  query: |
    SELECT
      p0.uid AS p0_uid,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.cgroup_path AS p0_cgroup,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.pid IN (
        SELECT
          pid
        FROM
          processes
        WHERE
          euid < uid
          AND NOT path IN (
            '/bin/ps',
            '/opt/1Password/1password',
            '/usr/bin/doas',
            '/usr/bin/fusermount',
            '/usr/bin/fusermount3',
            '/usr/bin/login',
            '/usr/bin/newgrp',
            '/usr/bin/passwd',
            '/usr/bin/su',
            '/usr/bin/sudo',
            '/usr/bin/top',
            '/usr/lib/polkit-1/polkit-agent-helper-1',
            '/usr/lib/xorg/Xorg',
            '/usr/libexec/Xorg'
          ) -- doas may be in the process of being upgraded
          AND NOT path LIKE '/nix/store/%/bin/dhcpcd'
          AND NOT path LIKE '/nix/store/%/bin/sudo'
          AND NOT path LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'
          AND NOT name IN ('doas', 'sudo')
      )
      AND NOT (
        p0.cmdline LIKE '%pacman%'
        AND p1.cmdline LIKE 'yay%'
      )
      AND NOT (
        p0.path LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns'
        AND p1.path LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'
      )
      AND NOT (
        p0.name = 'polkit-agent-he'
        AND p1.path IN (
          '/usr/bin/gnome-shell',
          '/usr/lib/x86_64-linux-gnu/libexec/polkit-kde-authentication'
        )
      )
      AND NOT (
        p0.name = 'fusermount3'
        AND p1.path IN (
          '/usr/lib/xdg-document-portal',
          '/usr/libexec/xdg-document-portal'
        )
      )
      AND NOT (
        p0.path = '/usr/bin/pkexec'
        AND p1.path = '/usr/bin/update-notifier'
      )
      AND NOT (
        p0.path = '/usr/libexec/xdg-permission-store'
        AND p1.path = '/usr/lib/systemd/systemd'
      )
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Unexpected Privilege Escalation Macos"
  description: Find processes that run with a lower effective UID than their parent (state-based)
  query: |
    SELECT
      s.authority AS p0_auth,
      s.identifier AS p0_id,
      p0.uid AS p0_uid,
      -- Child
      p0.pid AS p0_pid,
      p0.path AS p0_path,
      p0.name AS p0_name,
      p0.cmdline AS p0_cmd,
      p0.cwd AS p0_cwd,
      p0.euid AS p0_euid,
      p0_hash.sha256 AS p0_sha256,
      -- Parent
      p0.parent AS p1_pid,
      p1.path AS p1_path,
      p1.name AS p1_name,
      p1_f.mode AS p1_mode,
      p1.euid AS p1_euid,
      p1.cmdline AS p1_cmd,
      p1_hash.sha256 AS p1_sha256,
      -- Grandparent
      p1.parent AS p2_pid,
      p2.name AS p2_name,
      p2.path AS p2_path,
      p2.cmdline AS p2_cmd,
      p2_hash.sha256 AS p2_sha256
    FROM
      processes p0
      LEFT JOIN signature s ON p0.path = s.path
      LEFT JOIN hash p0_hash ON p0.path = p0_hash.path
      LEFT JOIN processes p1 ON p0.parent = p1.pid
      LEFT JOIN file p1_f ON p1.path = p1_f.path
      LEFT JOIN hash p1_hash ON p1.path = p1_hash.path
      LEFT JOIN processes p2 ON p1.parent = p2.pid
      LEFT JOIN hash p2_hash ON p2.path = p2_hash.path
    WHERE
      p0.euid < p0.uid
      AND p0.path NOT IN (
        '',
        '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels Service',
        '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx',
        '/bin/ps',
        '/Library/Application Support/Google/GoogleUpdater/Current/GoogleUpdater.app/Contents/Helpers/launcher',
        '/Library/Application Support/org.pqrs/Karabiner-Elements/bin/karabiner_session_monitor',
        '/Library/Application Support/AdGuard Software/com.adguard.mac.adguard/kext/adguard-tcpkill',
        '/Library/DropboxHelperTools/Dropbox_u501/dbkextd',
        '/Library/DropboxHelperTools/Dropbox_u502/dbkextd',
        '/usr/bin/login',
        '/usr/bin/su',
        '/usr/bin/sudo',
        '/usr/bin/top',
        '/usr/local/bin/doas'
      )
      AND NOT (
        p0.path LIKE '/var/folders/%/T/CanonOFI_TEMP/Data/Software/Install/UniversalInstaller.app/Contents/Frameworks/UIx.framework/Resources/relay'
        AND s.authority = 'Developer ID Application: Canon Inc. (XE2XNRRXZ5)'
      )
      AND NOT (
        p0.path = '/Applications/Adguard.app/Contents/MacOS/Adguard'
        AND s.authority = 'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)'
      )
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[detection/privesc] Sketchy Docker Image Creator"
  description: Detect the execution of a Docker containing mounting the root filesystem
  query: |
    SELECT
      *
    FROM
      docker_image_history
    WHERE
      created > (strftime('%s', 'now') -86400)
      -- This signature is used by Traitor: https://github.com/liamg/traitor/
      AND created_by LIKE '%/bin/sh%/lol%';
  platform: linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[policy] Gcp Service Account Keys Mdfind"
  description: Indicative of stored GCP service account keys just sitting around unencrypted
  query: |
    SELECT
      file.path,
      file.size,
      file.btime,
      file.ctime,
      file.mtime,
      magic.data,
      hash.sha256,
      u.username,
      ea.value AS url
    FROM
      mdfind
      JOIN file ON mdfind.path = file.path
      LEFT JOIN users u ON file.uid = u.uid
      LEFT JOIN hash ON mdfind.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = 'where_from'
      LEFT JOIN magic ON mdfind.path = magic.path
      LEFT JOIN signature ON mdfind.path = signature.path
    WHERE
      mdfind.query = "kMDItemFSName == '*.json'"
      AND (
        file.filename LIKE "%-%-%.json"
        OR file.filename LIKE '%service%.json'
        OR file.filename LIKE '%acct%.json'
        OR file.filename LIKE '%key%.json'
        OR file.filename LIKE '%account%.json'
        OR file.filename LIKE '%-sa.json'
        OR file.filename LIKE 'sa%.json'
        OR file.filename LIKE '%s%r%v%acc%t%json'
        OR file.filename LIKE '%prod.json'
        OR file.filename LIKE 'prod%.json'
      )
      AND file.size BETWEEN 2311 AND 2385 -- Don't alert on tokens that begin with the username-, as they may be personal
      AND NOT INSTR(file.filename, CONCAT (u.username, "-")) == 1 -- Don't alert on tokens that begin with the users full name and a dash
      AND NOT (
        LENGTH(u.username) > 4
        AND INSTR(file.filename, SUBSTR(u.username, 3, 8)) > 0
      )
      AND NOT INSTR(
        file.filename,
        REPLACE(LOWER(TRIM(u.description)), " ", "-")
      ) == 1
      -- Common locations of test or demo keys
      AND NOT file.filename = 'keys.json'
      AND NOT file.directory = "/Users/Shared/LGHUB"
      AND NOT file.directory LIKE '%/pkg/%'
      AND NOT file.directory LIKE '%/go/src/%'
      AND NOT file.directory LIKE '%/pkg/mod/%'
      AND NOT file.directory LIKE '%/aws-sdk/apis'
      AND NOT file.directory LIKE '%/mock-infras/%'
      AND NOT file.directory LIKE '%/testdata%'
      AND NOT file.directory LIKE '%/conformance/%'
      AND NOT file.directory LIKE '%/third_party/%'
      AND NOT file.directory LIKE '%/generated/%'
      AND NOT file.directory LIKE '%/output/%'
      AND NOT file.directory LIKE '%/tests%'
      AND NOT file.directory LIKE '%/validation%'
      AND NOT file.directory LIKE '%/data/%'
      AND NOT file.directory LIKE '%/json%'
      AND NOT file.directory LIKE '%/specs%'
      AND NOT file.directory LIKE '%/schemas'
      AND NOT file.directory LIKE '/Users/%/Library/Application Support/%'
      AND NOT file.directory LIKE '%demo'
      AND NOT file.filename LIKE 'ntia-conformance-%'
      AND NOT file.filename LIKE '%-test.json'
      AND NOT file.filename LIKE '%package%'
      AND NOT file.filename LIKE '%expected%'
      AND NOT file.filename LIKE '%.pom.%'
      AND NOT file.filename LIKE '%latest%'
      AND NOT file.filename LIKE '%2022%'
      AND NOT file.filename LIKE '%2023%'
      AND NOT file.filename LIKE 'host-project-%'
      AND NOT file.filename LIKE '%spdx%'
      AND NOT file.filename LIKE '%-v1%'
      AND NOT file.filename LIKE 'libopenblas-%'
      -- Well known demo keys
      AND NOT hash.sha256 IN (
        '11ffc5141b4b0071c0796914deef68d012c4f4c289931c5587fe89d7d6dca0a1',
        '2d330d059f4af4d314a85418fb031ee628f41dcf3e31fbce46858e52e73180c4',
        '4b4be8c1bc7e3bc7ea1f02932a024466db5faf3eaad885cf31ac7383484b1b1c',
        '6e55f3eccad59a615189c82cbcbd1133ce94509f7c5d42e3e7fbd00e65f0731f',
        'e99b4e6dfbbefa19c9ec9c82bb0c3445a443702f960c2a05f882bb5577a59ef8',
        '421899fb9bfa0252ce7921969339918a5bbacbc7b9cd500e03a88f9c4e33bae4',
        '81bce2313cd00ffc42303fbf7c08e4d068fccc9c0076867903ef94616d795e12',
        '8d740893c1f9163ddfd8c193d9a95caf15da3740b42f2739c4b107ad12661809',
        '998ddcb7d1a7c2931c8546576873e47b399f23cef719227052f245c8240c6528',
        'af1a2f8e9d581bb1504e3d8801d15d962fdf12ee7ebcf2bb9c475c8b92da6472',
        'b68896dc8e8c23ade371cf8b5c9d25853d81b4cfa5baa2bc0200d9242a903d80',
        'bc4c0ad21d79fea9050e75e80f13dd54bfdc867236342ede901d15d815f31988',
        'cea85342377ef1bce115629c3d9d3ec405964a43545805c9f7ace98940aa0be2',
        'a0f925d91d2ae1d38c13305572b2bf027e09f39e8bea575d55e8fcd5f3bf8b32',
        'ef2c928c69403e023a332002d8c5c430e1022850b12f834563f6aec111d99f14'
      )
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[policy] Gcp Service Account Keys"
  description: Indicative of stored GCP service account keys just sitting around unencrypted
  query: |
    SELECT
      file.path,
      file.filename,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN users u ON file.uid = u.uid
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.directory LIKE '/Users/%/Downloads/%'
        OR file.directory LIKE '/home/%/%'
        OR file.directory LIKE '/home/%/'
        OR file.directory LIKE '/home/%/.%'
        OR file.directory LIKE '/home/%/Downloads/%'
        OR file.directory LIKE '/tmp/%'
        OR file.directory LIKE '/tmp/'
        OR file.directory LIKE '/Users/%/%'
        OR file.directory LIKE '/Users/%/'
        OR file.directory LIKE '/Users/%/.%'
        OR file.directory LIKE '/var/tmp/%'
        OR file.directory LIKE '/var/tmp/'
      )
      AND file.directory NOT LIKE "%/../%"
      AND file.directory NOT LIKE "%/./%"
      AND filename LIKE "%-%-%.json"
      AND size BETWEEN 2311 AND 2385
      -- Don't alert on tokens that begin with the username-, as they may be personal
      AND NOT INSTR(filename, CONCAT (u.username, "-")) == 1
      -- Don't alert on tokens that begin with the users full name and a dash
      AND NOT INSTR(
        filename,
        REPLACE(LOWER(TRIM(description)), " ", "-")
      ) == 1
      -- Demo keys
      AND NOT file.filename LIKE 'host-project-%'
      AND NOT file.filename LIKE 'ulabs-%'
      AND NOT file.filename LIKE 'test-%'
      AND NOT file.filename LIKE 'demo-%'
      AND NOT file.filename LIKE 'example-%'
      AND NOT hash.sha256 IN (
        "c7d6bac8e942511e25973889ac38656d4d46f68044650d694721017fda23716e",
        "386bd767a15daa0659519bcb0b178826ef1579d1f0ec32f63ae01efc68e7889d",
        "bd5f4c01ebb5636b94584ee4ae42514b27d371859f7344f6aa5a37332ee714ba"
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[policy] Unexpected Rsa Keys Mdfind"
  description: Indicative of stored RSA keys just sitting around unencrypted
  query: |
    SELECT
      file.path,
      file.size,
      datetime(file.btime, 'unixepoch') AS file_created,
      magic.data,
      hash.sha256,
      ea.value AS url
    FROM
      mdfind
      JOIN file ON mdfind.path = file.path
      JOIN users u ON file.uid = u.uid
      LEFT JOIN hash ON mdfind.path = hash.path
      LEFT JOIN extended_attributes ea ON mdfind.path = ea.path
      AND ea.key = 'where_from'
      LEFT JOIN magic ON mdfind.path = magic.path
      LEFT JOIN signature ON mdfind.path = signature.path
    WHERE
      mdfind.query = "kMDItemFSName == '*.rsa'"
      AND file.filename NOT IN ('local-melange.rsa', 'melange.rsa')
      AND size BETWEEN 128 AND 8192
      -- Don't alert on tokens that begin with the username-, as they may be personal
      AND NOT INSTR(filename, CONCAT (u.username, "-")) == 1
      -- Don't alert on tokens that begin with the users full name and a dash
      AND NOT INSTR(
        filename,
        REPLACE(LOWER(TRIM(description)), " ", "-")
      ) == 1
      -- Common filenames that are non-controversial
      AND NOT file.filename LIKE '%example.com%'
      AND NOT file.filename LIKE 'local-%.rsa'
      AND NOT file.filename LIKE 'test-%.rsa'
      AND NOT file.filename LIKE 'demo-%.rsa'
      AND NOT file.path LIKE "%/testdata/%"
    GROUP BY
      file.path
  platform: darwin
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[policy] Unexpected Rsa Keys"
  description: Indicative of stored RSA keys just sitting around unencrypted
  query: |
    SELECT
      file.path,
      file.type,
      file.size,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      magic.data
    FROM
      file
      LEFT JOIN hash ON file.path = hash.path
      LEFT JOIN users u ON file.uid = u.uid
      LEFT JOIN magic ON file.path = magic.path
    WHERE
      (
        file.directory LIKE '/Users/%/Downloads/%'
        OR file.directory LIKE '/home/%/%'
        OR file.directory LIKE '/home/%/'
        OR file.directory LIKE '/home/%/.%'
        OR file.directory LIKE '/home/%/Downloads/%'
        OR file.directory LIKE '/tmp/%'
        OR file.directory LIKE '/tmp/'
        OR file.directory LIKE '/Users/%/%'
        OR file.directory LIKE '/Users/%/'
        OR file.directory LIKE '/Users/%/.%'
        OR file.directory LIKE '/var/tmp/%'
        OR file.directory LIKE '/var/tmp/'
      )
      AND file.directory NOT LIKE "%/../%"
      AND file.directory NOT LIKE "%/./%"
      AND filename LIKE "%.rsa"
      AND size BETWEEN 128 AND 8192
      -- Don't alert on tokens that begin with the username-, as they may be personal
      AND NOT INSTR(filename, CONCAT (u.username, "-")) == 1
      -- Don't alert on tokens that begin with the users full name and a dash
      AND NOT INSTR(
        filename,
        REPLACE(LOWER(TRIM(description)), " ", "-")
      ) == 1
      -- Common filenames that are non-controversial
      AND NOT INSTR(file.filename, 'melange.rsa') > 0
      AND NOT INSTR(file.filename, 'local-melange-enterprise.rsa') > 0
      -- Demo keys
      AND NOT sha256 IN (
        'a68b29401730a9c5f3e06099f6703a43797ee5c6ad6c741961c6eb8ab39786de'
      )
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[policy] Unusually Long Uptime Likely Missing Patches"
  description: Indicative of a machine that probably needs a reboot for operating-system patches
  query: |
    SELECT
      os_version.name AS os_name,
      os_version.version AS os_version,
      kernel_info.version AS kernel,
      days AS uptime_days
    FROM
      kernel_info,
      os_version,
      uptime
    WHERE
      uptime.days > 89;
  platform: darwin,linux
  logging: differential
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Account Policy Data Macos"
  description: Retrieves account policy data, such as creation time
  query: |
    SELECT
      *
    FROM
      account_policy_data;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf"
  description: Retrieves the configuration values for the Application Layer Firewall for OSX.
  query: |
    SELECT
      *
    FROM
      alf;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf Exceptions Macos"
  description: Retrieves the exceptions for the Application Layer Firewall in OSX.
  query: |
    SELECT
      *
    FROM
      alf_exceptions;
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf Explicit Auths Macos"
  description: Retrieves the list of processes with explicit authorization for the Application Layer Firewall.
  query: |
    SELECT
      *
    FROM
      alf_explicit_auths;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Alf Services"
  description: Retrieves the services for the Application Layer Firewall in OSX.
  query: |
    SELECT
      *
    FROM
      alf_services;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] App Schemes"
  description: Retrieves the list of application scheme/protocol-based IPC handlers.
  query: |
    SELECT
      *
    FROM
      app_schemes;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Apps"
  description: Retrieves all the currently installed applications in the target OSX system.
  query: |
    SELECT
      *
    FROM
      apps;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Authorization Mechanisms Macos"
  description: Retrieves entries from the macOS authorization mechanisms db
  query: |
    SELECT
      *
    FROM
      authorization_mechanisms;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Authorizations Macos"
  description: Retrieves entries from the macOS authorization rights db
  query: |
    SELECT
      *
    FROM
      authorizations;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Authorized Keys"
  description: Retrieves all the currently installed authorized keys on a system
  query: |
    SELECT
      authorized_keys.*
    FROM
      users
      JOIN authorized_keys ON users.uid = authorized_keys.uid;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Block Devices"
  description: Retrieves all block devices known to the system
  query: |
    SELECT
      *
    FROM
      block_devices
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Certificates"
  description: Retrieves all the currently installed certificates on a system
  query: |
    SELECT
      *
    FROM
      certificates;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Chrome Extension Content Scripts"
  description: Retrieves chrome extension cotent scripts that execute on a broad set of URLs.
  query: |
    SELECT
      chrome_extension_content_scripts.*
    FROM
      users
      JOIN chrome_extension_content_scripts ON users.uid = chrome_extension_content_scripts.uid
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Chrome Extensions"
  description: Retrieves chrome extensions that execute on a broad set of URLs.
  query: |
    SELECT
      chrome_extensions.*
    FROM
      users
      JOIN chrome_extensions ON users.uid = chrome_extensions.uid
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Crashes Macos"
  description: Retrieves crash log info per user
  query: |
    SELECT
      *
    FROM
      users
      JOIN crashes USING (uid);
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Crontab"
  description: Crontab entries
  query: |
    SELECT
      *
    FROM
      crontab
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Deb Packages"
  description: Retrieves a list of debian packages
  query: |
    SELECT
      *
    FROM
      deb_packages;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Disk Encryption"
  description: Retrieves the current disk encryption status for the target system.
  query: |
    SELECT
      *
    FROM
      disk_encryption;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Disk Events Macos"
  description: Retrieves disk image (DMG) events
  query: |
    SELECT
      *
    FROM
      disk_events;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Dns Resolvers"
  description: Return the list of configured DNS servers on this system
  query: |
    SELECT
      *
    FROM
      dns_resolvers;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Container Mounts"
  description: Return the list of mounts for Docker containers
  query: |
    SELECT
      *
    FROM
      docker_container_mounts;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Container Ports"
  description: Return the list of ports for Docker containers
  query: |
    SELECT
      *
    FROM
      docker_container_ports;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Container Processes"
  description: Return the list of processes for Docker containers
  query: |
    SELECT
      docker_container_processes.*,
      docker_containers.name
    FROM
      docker_containers
      JOIN docker_container_processes ON docker_containers.id = docker_container_processes.id;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Containers"
  description: Return the list of running Docker containers on this machine
  query: |
    SELECT
      *
    FROM
      docker_containers
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Image History"
  description: Return the Docker image history on a machine
  query: |
    SELECT
      *
    FROM
      docker_image_history
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Docker Images"
  description: Return the list of Docker images
  query: |
    SELECT
      *
    FROM
      docker_images;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Es Process Events"
  description: Dump a list of process execution events from EndpointSecurity
  query: |
    SELECT
      *
    FROM
      es_process_events;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Etc Hosts"
  description: Retrieves all the entries in the target system /etc/hosts file.
  query: |
    SELECT
      *
    FROM
      etc_hosts;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Event Taps Macos"
  description: Retrieves software packages with access to listening in on keyboard/mouse events
  query: |
    SELECT
      *
    FROM
      event_taps;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] File Events"
  description: Return the list of watched file events (must be configured)
  query: |
    SELECT
      *
    FROM
      file_events
    WHERE
      time > (strftime('%s', 'now') -900)
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Dev"
  description: Returns a list of file information from /dev (non-hidden only)
  query: |
    SELECT
      file.*,
      magic.data
    FROM
      file
      JOIN magic ON file.path = magic.path
    WHERE
      file.path LIKE "/dev/%%";
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Downloads"
  description: Returns a list of file information from Downloads directories
  query: |
    SELECT
      file.*,
      magic.data,
      hash.sha256
    FROM
      file
      LEFT JOIN magic ON file.path = magic.path
      LEFT JOIN hash ON file.path = hash.path
    WHERE
      (
        file.path LIKE "/home/%/Downloads/%"
        OR file.path LIKE "/Users/%/Downloads/%"
      )
      AND (
        mtime > (strftime('%s', 'now') -3600)
        OR ctime > (strftime('%s', 'now') -3600)
        OR btime > (strftime('%s', 'now') -3600)
      )
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Etc"
  description: Returns a list of file information from /etc (non-hidden only)
  query: |
    SELECT
      *
    FROM
      file
      JOIN hash ON file.path = hash.path
    WHERE
      file.path LIKE "/etc/%%";
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Files Recently Written"
  description: Returns a list of recently written files
  query: |
    SELECT
      *
    FROM
      file
    WHERE
      (
        path LIKE "/var/tmp/%"
        OR path LIKE "/var/tmp/%/%"
        OR path LIKE "/Applications/%"
        OR path LIKE "/Applications/%/%"
        OR path LIKE "/home/%/%"
        OR path LIKE "/home/%/.%/%"
        OR path LIKE "/home/%/.%/%/%"
        OR path LIKE "/home/%/.config/%"
        OR path LIKE "/home/%/.config/%/%"
        OR path LIKE "/Library/%/%"
        OR path LIKE "/Library/.%"
        OR path LIKE "/Library/Application Support/%"
        OR path LIKE "/Library/Application Support/.%"
        OR path LIKE "/tmp/%"
        OR path LIKE "/tmp/%/%"
        OR path LIKE "/tmp/.%/%%"
        OR path LIKE "/Users/%/%"
        OR path LIKE "/Users/%/%/%"
        OR path LIKE "/Users/%/.%/%"
        OR path LIKE "/Users/%/.%/%/%"
        OR path LIKE "/Users/Library/%"
        OR path LIKE "/Users/Library/%/%"
        OR path LIKE "/Users/Library/.%"
        OR path LIKE "/Users/Library/Application Support/%"
        OR path LIKE "/Users/Library/Application Support/%/%"
        OR path LIKE "/Users/Library/Application Support/.%"
        OR path LIKE "/var/%"
        OR path LIKE "/var/%/%"
      )
      AND (
        mtime > (strftime('%s', 'now') -3600)
        OR (
          atime > (strftime('%s', 'now') -3600)
          AND file.type = "regular"
        )
        OR ctime > (strftime('%s', 'now') -3600)
        OR btime > (strftime('%s', 'now') -3600)
      )
      AND NOT path LIKE "%/../%"
    GROUP BY
      inode;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Firefox Addons"
  description: Return the list of installed Firefox addons
  query: |
    SELECT
      firefox_addons.*
    FROM
      users
      JOIN firefox_addons ON users.uid = firefox_addons.uid;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Gatekeeper Approved Apps Macos"
  description: Retrieves all the gatekeeper exceptions on a macOS host
  query: |
    SELECT
      gap.ctime,
      gap.mtime,
      gap.path,
      file.mtime,
      file.uid,
      file.ctime,
      file.gid,
      hash.sha256,
      signature.identifier,
      signature.authority
    FROM
      gatekeeper_approved_apps AS gap
      LEFT JOIN file ON gap.path = file.path
      LEFT JOIN hash ON gap.path = hash.path
      LEFT JOIN signature ON gap.path = signature.path
    GROUP BY
      gap.requirement
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Groups"
  description: Return the list of POSIX groups on the system
  query: |
    SELECT
      *
    FROM
      groups;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Hardware Events"
  description: Return hardware events
  query: |
    SELECT
      *
    FROM
      hardware_events;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Homebrew Packages Macos"
  description: Dump a list of homebrew packages
  query: |
    SELECT
      *
    FROM
      homebrew_packages;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Interface Addresses"
  description: Return the list of interface addresses
  query: |
    SELECT
      *
    FROM
      interface_addresses;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Interface Details"
  description: Return stats on network interfaces
  query: |
    SELECT
      *
    FROM
      interface_details
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Interface Ipv6"
  description: Return the list of interface addresses (IPv6)
  query: |
    SELECT
      *
    FROM
      interface_ipv6;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Iokit Registry Macos"
  description: Retrieves IOKit registry
  query: |
    SELECT
      *
    FROM
      iokit_registry;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Ip Forwarding"
  description: Retrieves the current status of IP/IPv6 forwarding.
  query: |
    SELECT
      *
    FROM
      system_controls
    WHERE
      oid = '4.30.41.1'
    UNION
    SELECT
      *
    FROM
      system_controls
    WHERE
      oid = '4.2.0.1';
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Iptables"
  description: Retrieves the current filters and chains per filter in the target system.
  query: |
    SELECT
      *
    FROM
      iptables;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kernel Info"
  description: Return basic kernel information
  query: |
    SELECT
      *
    FROM
      kernel_info;
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kernel Modules Linux"
  description: Retrieves all the information for the current kernel modules in the target Linux system.
  query: |
    SELECT
      *
    FROM
      kernel_modules;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kernel Panics Macos"
  description: Retrieves entries from the macOS kernel panic logs
  query: |
    SELECT
      *
    FROM
      kernel_panics;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Kextstat Macos"
  description: Retrieves all the information about the current kernel extensions for the target OSX system.
  query: |
    SELECT
      *
    FROM
      kernel_extensions;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Known Hosts"
  description: Retrieves chrome extensions that execute on a broad set of URLs.
  query: |
    SELECT
      known_hosts.*
    FROM
      users
      JOIN known_hosts ON users.uid = known_hosts.uid
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Last"
  description: Retrieves the list of the latest logins with PID, username and timestamp.
  query: |
    SELECT
      *
    FROM
      last;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Launchd Macos"
  description: macOS launchd entries
  query: |
    SELECT
      *
    FROM
      launchd;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Launchd Overrides Macos"
  description: Retrieves launchd override keys per user
  query: |
    SELECT
      *
    FROM
      launchd_overrides;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Listening Ports"
  description: Retrieves all the listening ports in the target system.
  query: |
    SELECT
      lp.*,
      p.name AS p_name,
      p.start_time AS p_time,
      p.path AS p_path,
      p.euid AS p_euid
    FROM
      listening_ports AS lp
      LEFT JOIN processes p ON lp.pid = p.pid;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Logged In Users"
  description: Retrieves the list of all the currently logged in users in the target system.
  query: |
    SELECT
      liu.*,
      p.name,
      p.cmdline,
      p.cwd,
      p.start_time,
      p.root
    FROM
      logged_in_users liu,
      processes p
    WHERE
      liu.pid = p.pid;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow1"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      key,
      subkey,
      value
    from
      plist
    where
      path = '/Library/Preferences/com.apple.loginwindow.plist';
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow2"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      key,
      subkey,
      value
    from
      plist
    where
      path = '/Library/Preferences/loginwindow.plist';
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow3"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      username,
      key,
      subkey,
      value
    from
      plist p,
      (
        select
          *
        from
          users
        where
          directory like '/Users/%'
      ) u
    where
      p.path = u.directory || '/Library/Preferences/com.apple.loginwindow.plist';
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Loginwindow4"
  description: Retrieves all the values for the loginwindow process in the target OSX system.
  query: |
    select
      username,
      key,
      subkey,
      value
    from
      plist p,
      (
        select
          *
        from
          users
        where
          directory like '/Users/%'
      ) u
    where
      p.path = u.directory || '/Library/Preferences/loginwindow.plist';
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Memory Map"
  description: Returns the OS memory region map.
  query: |
    SELECT
      *
    FROM
      memory_map;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Mounts"
  description: Retrieves the current list of mounted drives in the target system.
  query: |
    SELECT
      *
    FROM
      mounts;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Npm Packages"
  description: Return the list of npm packages
  query: |
    SELECT
      *
    FROM
      npm_packages;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Nvram Macos"
  description: Retrieves entries from the macOS nvram database
  query: |
    SELECT
      *
    FROM
      nvram;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Open Files"
  description: Retrieves all the open files per process in the target system.
  query: |
    SELECT DISTINCT
      pof.pid,
      pof.path,
      pof.fd,
      p.name,
      p.start_time,
      p.euid,
      p.parent,
      p.uid,
      p.cmdline
    FROM
      process_open_files pof
      LEFT JOIN processes p ON pof.pid = p.pid
    WHERE
      pof.path NOT LIKE '/private/var/folders%'
      AND pof.path NOT LIKE '/System/Library/%'
      AND pof.path NOT IN ('/dev/null', '/dev/urandom', '/dev/random');
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Open Sockets"
  description: Retrieves all the open sockets per process in the target system.
  query: |
    SELECT DISTINCT
      pid,
      family,
      protocol,
      local_address,
      local_port,
      remote_address,
      remote_port,
      path
    FROM
      process_open_sockets
    WHERE
      path <> ''
      or remote_address <> '';
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Os Version"
  description: Return the OS version including patch level
  query: |
    SELECT
      *
    FROM
      os_version;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Package Install History Macos"
  description: Return macOS package install history
  query: |
    SELECT
      *
    FROM
      package_install_history;
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Package Receipts Macos"
  description: Return macOS package receipts
  query: |
    SELECT
      *
    FROM
      package_receipts;
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Platform Info"
  description: Return hardware platform info (UEFI)
  query: |
    SELECT
      *
    FROM
      platform_info
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Preferences Macos"
  description: Retrieves entries from the macOS preferences database
  query: |
    SELECT
      *
    FROM
      preferences;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Env"
  description: Retrieves all the environment variables per process in the target system.
  query: |
    SELECT
      *
    FROM
      process_envs;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Events"
  description: Recently executed programs
  query: |
    SELECT
      pe.*,
      -- pe.cwd is often blank
      p.cwd AS delayed_proc_cwd,
      pp.cwd AS delayed_parent_cwd,
      pp.path AS parent_path,
      pp.name AS delayed_parent_name
    FROM
      process_events pe
      LEFT JOIN processes p ON pe.pid = p.pid
      LEFT JOIN processes pp ON pe.parent = pp.pid
    WHERE
      pe.time > (strftime('%s', 'now') -600)
      -- Filter out commands generated by osquery/kolide
      AND pe.cmdline NOT LIKE '/bin/ps -x -o%'
      AND parent_path NOT LIKE '/usr/local/kolide-k2/%/launcher'
    GROUP BY
      pe.pid,
      pe.eid
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Memory Map"
  description: Retrieves the memory map per process
  query: |
    SELECT
      pid,
      permissions,
    offset
    ,
      inode,
      path,
      pseudo
    FROM
      process_memory_map
    WHERE
      path != ""
    GROUP BY
      pid,
      permissions,
    offset
    ,
      inode,
      path,
      pseudo;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Open Files"
  description: Return the list of open files by process
  query: |
    SELECT
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline,
      pof.*
    FROM
      process_open_files AS pof
      LEFT JOIN processes p ON pof.pid = p.pid;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Open Pipes"
  description: Return the list of open pipes per process
  query: |
    SELECT
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline,
      pop.*
    FROM
      process_open_pipes AS pop
      LEFT JOIN processes p ON pop.pid = p.pid;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Process Open Sockets"
  description: Return the list of open sockets per process
  query: |
    SELECT
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline,
      pos.*
    FROM
      process_open_sockets AS pos
      LEFT JOIN processes p ON pos.pid = p.pid;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Processes"
  description: Currently running programs, only the columns that are not constantly changing
  query: |
    SELECT
      pid,
      name,
      path,
      cmdline,
      state,
      cwd,
      root,
      uid,
      gid,
      euid,
      egid,
      suid,
      sgid,
      on_disk,
      start_time,
      parent,
      pgroup,
      threads,
      nice,
      cgroup_path
    FROM
      processes
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Recent Items Macos"
  description: Retrieves the list of recent items opened in OSX by parsing the plist per user.
  query: |
    select
      username,
      key,
      value
    from
      plist p,
      (
        select
          *
        from
          users
        where
          directory like '/Users/%'
      ) u
    where
      p.path = u.directory || '/Library/Preferences/com.apple.recentitems.plist';
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Rpm Packages"
  description: Retrieves a list of RPM packages
  query: |
    SELECT
      *
    FROM
      rpm_packages;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Running Apps Macos"
  description: Retrieves currently running applications
  query: |
    SELECT
      *
    FROM
      running_apps;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Safari Extensions Macos"
  description: Return the list of installed Safari extensions
  query: |
    SELECT
      safari_extensions.*
    FROM
      users
      JOIN safari_extensions ON users.uid = safari_extensions.uid;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Sandboxes Macos"
  description: Lists the application bundle that owns a sandbox label.
  query: |
    SELECT
      *
    FROM
      sandboxes;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Seccomp Events"
  description: Return the list of seccomp events
  query: |
    SELECT
      *
    FROM
      seccomp_events;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Selinux Events"
  description: Return the list of SELinux events
  query: |
    SELECT
      *
    FROM
      selinux_events;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Shadow"
  description: Return user data from /etc/shadow
  query: |
    SELECT
      *
    FROM
      shadow;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Shared Memory"
  description: Return shared memory info
  query: |
    SELECT
      shm.*,
      p.path AS p_path,
      p.name AS p_name,
      p.start_time AS p_time,
      p.euid AS p_euid,
      p.uid AS p_uid,
      p.cmdline AS p_cmdline
    FROM
      shared_memory AS shm
      LEFT JOIN processes p ON shm.pid = p.pid;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Shell History"
  description: Retrieves the command history, per user, by parsing the shell history files.
  query: |
    SELECT
      *
    FROM
      users
      JOIN shell_history USING (uid);
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Sip Config"
  description: Retrieves System Integrity Protection Settings data
  query: |
    SELECT
      *
    FROM
      sip_config;
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Socket Events"
  description: Return the list of socket events
  query: |
    SELECT
      *
    FROM
      socket_events
    WHERE
      time > (strftime('%s', 'now') -600)
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Ssh Configs"
  description: Retrieves the ssh configs per user
  query: |
    SELECT
      *
    FROM
      users
      JOIN ssh_configs USING (uid);
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Startup Items"
  description: Retrieve most programs that are part of a systems startup (multi-platform)
  query: |
    SELECT
      *
    FROM
      startup_items;
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Suid Bin"
  description: Retrieves setuid-enabled executables in well-known paths
  query: |
    SELECT
      *
    FROM
      suid_bin;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Syslog Events"
  description: Return the list of syslog events
  query: |
    SELECT
      *
    FROM
      syslog_events;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] System Controls"
  description: Return the list of sysctl values
  query: |
    SELECT
      *
    FROM
      system_controls;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Systemd Units"
  description: Returns a list of systemd units
  query: |
    SELECT
      *
    FROM
      systemd_units;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Unified Log Macos"
  description: Retrieves recent entries from the macOS unified log
  query: |
    SELECT
      timestamp,
      pid,
      process,
      category,
      subsystem,
      message
    FROM
      unified_log
    WHERE
      timestamp > (strftime('%s', 'now') - 1800)
  platform: darwin
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Usb Devices"
  description: Return the list of USB devices
  query: |
    SELECT
      *
    FROM
      usb_devices;
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] User Events"
  description: Return the list of audit user events
  query: |
    SELECT
      *
    FROM
      user_events;
  platform: linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] User Ssh Keys"
  description: Retrieves the ssh keys per user
  query: |
    SELECT
      *
    FROM
      users
      JOIN user_ssh_keys USING (uid);
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Users"
  description: Returns a list of users
  query: |
    SELECT
      *
    FROM
      users
  platform: darwin,linux
  logging: snapshot
---
apiVersion: v1
kind: query
spec:
  name: "[incident_response] Xprotect Reports"
  description: Returns a list of malware matches from macOS XProtect
  query: |
    SELECT
      *
    FROM
      xprotect_reports;
  platform: darwin
  logging: snapshot
